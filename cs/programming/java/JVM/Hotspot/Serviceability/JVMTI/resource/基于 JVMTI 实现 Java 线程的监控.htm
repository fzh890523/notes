<!DOCTYPE html>
<!-- saved from url=(0054)https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/ -->
<html lang="zh-CN" class="applicationcache geolocation history postmessage svg websockets localstorage sessionstorage websqldatabase webworkers hashchange pointerevents canvas audio canvastext video webgl cssgradients multiplebgs opacity rgba inlinesvg hsla supports svgclippaths smil no-touchevents fontface generatedcontent textshadow cssanimations backgroundsize borderimage borderradius boxshadow csscolumns csscolumns-width csscolumns-span csscolumns-fill csscolumns-gap csscolumns-rule csscolumns-rulecolor csscolumns-rulestyle csscolumns-rulewidth csscolumns-breakbefore csscolumns-breakafter csscolumns-breakinside flexbox flexboxlegacy cssreflections csstransforms csstransforms3d csstransitions indexeddb indexeddb-deletedatabase hires js mac chrome chrome5 webkit webkit5 ibm-grid-xlarge greater-china-imt"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
<meta name="viewport" content="width=device-width, initial-scale=1">      
<link rel="icon" href="https://www.ibm.com/favicon.ico">
<link rel="canonical" href="http://www.ibm.com/developerworks/cn/java/j-lo-jvmti/index.html">
<meta name="geo.country" content="CN">
<meta name="dcterms.rights" content="© Copyright IBM Corporation 2009">
<meta name="dcterms.date" content="2009-12-10">
<meta name="description" content="随着多核 CPU 的日益普及，越来越多的 Java 应用程序使用多线程并行计算来充分发挥整个系统的性能。多线程的使用也给应用程序开发人员带来了巨大的挑战，不正确地使用多线程可能造成线程死锁或资源竞争，导致系统瘫痪。因此，需要一种运行时线程监控工具来帮助开发人员诊断和跟踪 Java 线程状态的切换。JDK 1.5 及其后续版本提供了监控虚拟机运行状态的接口 JVMTI。本文深入分析了 JVM 中的 Java 线程模型，设计了用于监控线程状态切换的模型，并基于 JVMTI 实现了对 Java 线程切换进行监控的代理程序。">	
<meta name="keywords" content="JVMTI, 线程切换 , Java, Monitor, Agent, tttjca">
<meta name="robots" content="index,follow">
<title>基于 JVMTI 实现 Java 线程的监控</title>
    
<script type="text/javascript" async="" charset="utf-8" id="ebOneTagUrlId" src="./基于 JVMTI 实现 Java 线程的监控_files/ebOneTag.js"></script><script type="text/javascript" async="" charset="utf-8" id="utag_27" src="./基于 JVMTI 实现 Java 线程的监控_files/up_loader.1.1.0.js"></script><script type="text/javascript" async="" charset="utf-8" id="utag_53" src="./基于 JVMTI 实现 Java 线程的监控_files/js"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_cormetrics2" src="./基于 JVMTI 实现 Java 线程的监控_files/eluminate.js"></script><script type="text/javascript" async="" defer="" src="./基于 JVMTI 实现 Java 线程的监控_files/piwik.js"></script><script type="text/javascript" async="" charset="utf-8" id="dle_api_34c89300d9fb71c6d22bf2ec19be78d57f8f7398d28f2834b8b20e9aaffc479a" src="./基于 JVMTI 实现 Java 线程的监控_files/p_34c89300d9fb71c6d22bf2ec19be78d57f8f7398d28f2834b8b20e9aaffc479a.js"></script><script src="./基于 JVMTI 实现 Java 线程的监控_files/utag.js" type="text/javascript" async=""></script><script> 
    digitalData = {
        "page":{
            "category":{
                "primaryCategory":"SOFDCJVACN"
            },
            "pageInfo":{
                "effectiveDate":"2009-12-10",
                "language":"zh-CN",
                "publishDate":"2009-12-10",
                "publisher":"IBM Corporation",
                "version":"v18",
                "ibm":{ 
                    "contentDelivery":"IBM developerWorks template",
                    "contentProducer":"IBM developerWorks",
                    "country":"CN",
                    "owner":"developerWorks/China/IBM",
                    "subject":"TT300",
                    "type":"CT316",
                    "topic":"应用开发,调试,JVM (Java Virtual Machine)",
                    "topicId":"263,27,180",
                    "contentArea":"java",
                    "contentAreaId":"1",
                    "contentType":"article",
                    "contentId":"455723",
                },
                "keywords":"JVMTI, 线程切换 , Java, Monitor, Agent, tttjca",
                "description":"随着多核 CPU 的日益普及，越来越多的 Java 应用程序使用多线程并行计算来充分发挥整个系统的性能。多线程的使用也给应用程序开发人员带来了巨大的挑战，不正确地使用多线程可能造成线程死锁或资源竞争，导致系统瘫痪。因此，需要一种运行时线程监控工具来帮助开发人员诊断和跟踪 Java 线程状态的切换。JDK 1.5 及其后续版本提供了监控虚拟机运行状态的接口 JVMTI。本文深入分析了 JVM 中的 Java 线程模型，设计了用于监控线程状态切换的模型，并基于 JVMTI 实现了对 Java 线程切换进行监控的代理程序。"
            }
        }
    };
    window._analytics = {
        "segment_key":'HU3dbkAG5wE0F1IkRf9S1RexlAqo3jby'
    };
</script>
	
    <meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@developerworks">
<meta property="og:title" content="基于 JVMTI 实现 Java 线程的监控">
<meta property="og:description" content="随着多核 CPU 的日益普及，越来越多的 Java 应用程序使用多线程并行计算来充分发挥整个系统的性能。多线程的使用也给应用程序开发人员带来了巨大的挑战，不正确地使用多线程可能造成线程死锁或资源竞争，导致系统瘫痪。因此，需要一种运行时线程监控工具来帮助开发人员诊断和跟踪 Java 线程状态的切换。JDK 1.5 及其后续版本提供了监控虚拟机运行状态的接口 JVMTI。本文深入分析了 JVM 中的 Java 线程模型，设计了用于监控线程状态切换的模型，并基于 JVMTI 实现了对 Java 线程切换进行监控的代理程序。">
    <meta property="og:image" content="http://www.ibm.com/developerworks/i/dw-social-201508.png">
<!-- Segment meta tag -->
<meta name="segment" property="Java Chinese (developerWorks)" producttitle="developerWorks" value="基于 JVMTI 实现 Java 线程的监控">
<!-- SITE MON : START (DO NOT DELETE) -->
<!-- developerWorks monitoring token -->
<!-- SITE MON : END (DO NOT DELETE) -->

<!-- HEADER_SCRIPTS_AND_CSS_INCLUDE -->
<!-- <script src="//cdn.optimizely.com/js/5399420604.js"></script> -->
<!-- BEGIN: Use this section to set page specific variables for the Page Tag -->
<script language="JavaScript">var NTPT_PGEXTRA="ibmSkillLevel=3&ibmCmaId=455723&ibmContentAreas=java";</script>
<!--END -->
<script src="./基于 JVMTI 实现 Java 线程的监控_files/ida_stats.js"></script>
<link href="./基于 JVMTI 实现 Java 线程的监控_files/www.css" rel="stylesheet">
<link href="./基于 JVMTI 实现 Java 线程的监控_files/syntaxhighlighter.css" rel="stylesheet">
<script src="./基于 JVMTI 实现 Java 线程的监控_files/www.js"></script><style></style>
<script src="./基于 JVMTI 实现 Java 线程的监控_files/syntaxhighlighter.js"></script>    
<link href="./基于 JVMTI 实现 Java 线程的监控_files/tables.css" rel="stylesheet">
<script src="./基于 JVMTI 实现 Java 线程的监控_files/tables.js"></script>   
<!--  Masthead/footer  -->
<link href="./基于 JVMTI 实现 Java 线程的监控_files/dw-mf-v18.css" rel="stylesheet">
<!-- <link href="//dw1.s81c.com/developerworks/css/dw-mf/v18/alt-signedin-ux.css" rel="stylesheet" /> -->   
<!--[if lt IE 9]>
    <link href="//dw1.s81c.com/developerworks/css/dw-mf/v18/dw-mf-ie8fix.css?v=022216" rel="stylesheet" />
<![endif]-->
<link href="./基于 JVMTI 实现 Java 线程的监控_files/dw-article.css" rel="stylesheet">
<script src="./基于 JVMTI 实现 Java 线程的监控_files/dw-auth-properties.js"></script>
<script src="./基于 JVMTI 实现 Java 线程的监控_files/dw-auth.js"></script>
<script src="./基于 JVMTI 实现 Java 线程的监控_files/dw-mf.js"></script>
<script src="./基于 JVMTI 实现 Java 线程的监控_files/dw-auto-links.js"></script> 
<script src="./基于 JVMTI 实现 Java 线程的监控_files/dw-include.js"></script>     
<script src="./基于 JVMTI 实现 Java 线程的监控_files/dw-article.js"></script>
<script src="./基于 JVMTI 实现 Java 线程的监控_files/tactic.js"></script>
<script src="./基于 JVMTI 实现 Java 线程的监控_files/tacticbindlinks.js"></script>

<!-- 
<PageMap>
    <DataObject type="document">
        <Attribute name="topic">应用开发,调试,JVM (Java Virtual Machine)</Attribute>
        <Attribute name="topicId">263,27,180</Attribute>
        <Attribute name="contentArea">java</Attribute>
        <Attribute name="contentAreaId">1</Attribute>
        <Attribute name="abstract">随着多核 CPU 的日益普及，越来越多的 Java 应用程序使用多线程并行计算来充分发挥整个系统的性能。多线程的使用也给应用程序开发人员带来了巨大的挑战，不正确地使用多线程可能造成线程死锁或资源竞争，导致系统瘫痪。因此，需要一种运行时线程监控工具来帮助开发人员诊断和跟踪 Java 线程状态的切换。JDK 1.5 及其后续版本提供了监控虚拟机运行状态的接口 JVMTI。本文深入分析了 JVM 中的 Java 线程模型，设计了用于监控线程状态切换的模型，并基于 JVMTI 实现了对 Java 线程切换进行监控的代理程序。</Attribute>
        <Attribute name="pub.date">2009-12-10</Attribute>
        <Attribute name="contentType">article</Attribute>
    </DataObject>
</PageMap>
-->        

<style id="ibm-masthead-hidelinks">@media screen and (max-width: 557px) { .ibm-masthead-categories,#ibm-megamenu-sections{display:none} }@media screen and (max-width: 557px) { .ibm-mh-marketplace-link{display:none} }</style><script type="text/javascript" async="" charset="utf-8" id="utag_ibm.web_53" src="./基于 JVMTI 实现 Java 线程的监控_files/utag.53.js"></script><script type="text/javascript" async="" charset="utf-8" id="utag_ibm.web_44" src="./基于 JVMTI 实现 Java 线程的监控_files/utag.44.js"></script><script type="text/javascript" async="" charset="utf-8" id="utag_ibm.web_46" src="./基于 JVMTI 实现 Java 线程的监控_files/utag.46.js"></script><script type="text/javascript" async="" charset="utf-8" id="utag_ibm.web_45" src="./基于 JVMTI 实现 Java 线程的监控_files/utag.45.js"></script><style id="ibm-sitenav-menu-hidelinks">@media screen and (max-width: 602px) { .ibm-sitenav-menu-list{display:none} } @media screen and (min-width: 603px) { .ibm-mobilemenu-sitenavmenu {display:none} }</style><script type="text/javascript" async="" charset="utf-8" id="tiqapp" src="./基于 JVMTI 实现 Java 线程的监控_files/utag.v.js"></script><script type="text/javascript" async="" charset="utf-8" id="utag_ibm.web_27" src="./基于 JVMTI 实现 Java 线程的监控_files/utag.27.js"></script><script type="text/javascript" async="" charset="utf-8" id="LOTCC_10026" src="./基于 JVMTI 实现 Java 线程的监控_files/cc.js"></script><script type="text/javascript" async="" charset="utf-8" id="utag_ibm.web_52" src="./基于 JVMTI 实现 Java 线程的监控_files/utag.52.js"></script><script language="javascript" type="text/javascript" src="./基于 JVMTI 实现 Java 线程的监控_files/50200000.js"></script><style type="text/css" class="jquery-comments-css">.jquery-comments ul.navigation li.active:after {background: #2793e6 !important;</style><style type="text/css" class="jquery-comments-css">.jquery-comments ul.navigation ul.dropdown li.active {background: #2793e6 !important;</style><style type="text/css" class="jquery-comments-css">.jquery-comments .highlight-background {background: #2793e6 !important;</style><style type="text/css" class="jquery-comments-css">.jquery-comments .highlight-font {color: #2793e6 !important;}</style><style type="text/css" class="jquery-comments-css">.jquery-comments .highlight-font-bold {color: #2793e6 !important;font-weight: bold;}</style><script language="javascript" type="text/javascript" src="./基于 JVMTI 实现 Java 线程的监控_files/rules_50200000.js"></script><script language="javascript" type="text/javascript" src="./基于 JVMTI 实现 Java 线程的监控_files/dispatcher-v3.js"></script><script src="./基于 JVMTI 实现 Java 线程的监控_files/yahoo-min.js" type="text/javascript"></script><script src="./基于 JVMTI 实现 Java 线程的监控_files/cp-v3.js" type="text/javascript"></script><script src="./基于 JVMTI 实现 Java 线程的监控_files/json-min.js" type="text/javascript"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_setTTDid" src="./基于 JVMTI 实现 Java 线程的监控_files/i.js"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_setTTDid" src="./基于 JVMTI 实现 Java 线程的监控_files/i.js"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_visitor_service_45main" src="./基于 JVMTI 实现 Java 线程的监控_files/015a6a839457000d606a0ffb81ed04078006807000bd0"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_visitor_service_45main" src="./基于 JVMTI 实现 Java 线程的监控_files/015a6a839457000d606a0ffb81ed04078006807000bd0(1)"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_setTTDid" src="./基于 JVMTI 实现 Java 线程的监控_files/i.js"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_visitor_service_45main" src="./基于 JVMTI 实现 Java 线程的监控_files/015a6a839457000d606a0ffb81ed04078006807000bd0(2)"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_setTTDid" src="./基于 JVMTI 实现 Java 线程的监控_files/i.js"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_visitor_service_45main" src="./基于 JVMTI 实现 Java 线程的监控_files/015a6a839457000d606a0ffb81ed04078006807000bd0(3)"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_visitor_service_45main" src="./基于 JVMTI 实现 Java 线程的监控_files/015a6a839457000d606a0ffb81ed04078006807000bd0(4)"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_visitor_service_45main" src="./基于 JVMTI 实现 Java 线程的监控_files/015a6a839457000d606a0ffb81ed04078006807000bd0(5)"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_visitor_service_45main" src="./基于 JVMTI 实现 Java 线程的监控_files/015a6a839457000d606a0ffb81ed04078006807000bd0(6)"></script><script type="text/javascript" async="" charset="utf-8" id="tealium_visitor_service_45main" src="./基于 JVMTI 实现 Java 线程的监控_files/015a6a839457000d606a0ffb81ed04078006807000bd0(7)"></script></head>
<body id="ibm-com" class="ibm-type ibm-sitenav-menu ibm-sitenav-menu-sticky ibm-masthead-sticky">
	
<div id="ibm-top" class="ibm-landing-page dw-sitenav">

<!-- MASTHEAD_BEGIN -->
<div id="ibm-masthead" role="banner" aria-label="IBM" class="ibm-mhtype-minimal hastransition">
    <div id="ibm-universal-nav" class="">    
  
        <nav role="navigation" aria-label="IBM">
            <div id="ibm-home"><a href="https://www.ibm.com/cn/zh/?lnk=m">IBM®</a></div>
            <ul id="ibm-menu-links" role="toolbar" aria-label="Site map" class="ibm-hide">
                <li><a href="https://www.ibm.com/sitemap/cn/zh/">站点地图</a></li>
            </ul><div class="ibm-masthead-rightside"><p class="ibm-mh-marketplace-link ibm-button-link ibm-fleft ibm-padding-bottom-0"><a class="ibm-btn-small ibm-btn-sec ibm-btn-blue-50" href="http://www.ibm.com/marketplace/?lnk=mp">市场</a></p><div id="ibm-search-module" role="search" aria-labelledby="ibm-masthead" class="ibm-has-scope">
            <div class="ibm-masthead-search-close"><p class="ibm-ind-link ibm-icononly ibm-padding-bottom-0"><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#" class="ibm-close-link ibm-nospacing">关闭</a></p></div><form id="ibm-search-form" action="https://www.ibm.com/Search/" method="get">
                <p>
                    <label for="q">IBM</label>
                    <input type="text" maxlength="100" value="" placeholder="搜索" name="q" id="q" aria-label="搜索 developerWorks" autocomplete="off" role="combobox" aria-autocomplete="list" aria-expanded="true" aria-owns="ibm-search-typeahead-container"><input name="lnk" type="hidden" value="mhsrch">
                    <input type="hidden" value="18" name="v">
                    <input type="hidden" value="utf" name="en">
                    <input type="hidden" value="zh" name="lang">
                    <input type="hidden" value="cn" name="cc">
                    <input type="hidden" name="sn" value="dw">
                    <input type="hidden" name="dws" value="cndw">
                    <input type="hidden" name="hpp" value="20">
                    <span class="ibm-search-scope ibm-fadeout"><input class="ibm-styled-checkbox" data-init="false" type="checkbox" name="sn" value="" id="ibm-mh-scopeoption"> <label for="ibm-mh-scopeoption">In Marketplace</label></span><button role="button" type="submit" id="ibm-search" class="ibm-search-link" value="提交"><span class="ibm-access">提交</span></button>
                </p>
            </form><form class="ibm-hide" id="ibm-default-scope-form" action="https://www.ibm.com/marketplace/search/cn/zh-cn/" method="get"><input name="terms" type="text"><input name="lnk" type="hidden" value="mhmpsrch"></form>
        </div><div id="ibm-search-typeahead-container" class="ibm-search-typeahead-container ibm-fadeout"></div><ul aria-label="Tools" role="menubar" class="ibm-masthead-iconsonly"><li role="presentation" class="ibm-masthead-item-signin"><button role="menubutton" class="ibm-profile-link">我的 IBM</button><ul id="ibm-signin-minimenu-container" role="menu" aria-label="Profile" class="ibm-dropdown-menu">		<li class="ibm-dropdown-menu-primary" role="presentation" data-linktype="notifications"> 			<a class="" href="https://myibm.ibm.com/dashboard/?lnk=mmi" tabindex="0">我的 IBM</a> 		</li>		<li class="ibm-dropdown-menu-primary menu-heading" role="presentation">				<span tabindex="0">developerWorks</span>			</li>		<li class="ibm-dropdown-menu-primary ibm-signin-alt" role="presentation">			<a href="https://www.ibm.com/developerworks/dwwi/jsp/ssologin.jsp?d=https%3A%2F%2Fwww.ibm.com%2Fdeveloperworks%2Fcn%2Fjava%2Fj-lo-jvmti%2F&amp;lang=zh&amp;a=dwmav" role="menuitem">登录</a>		</li>		<li class="ibm-dropdown-menu-primary dw-register-alt" role="presentation">			<a href="https://www.ibm.com/developerworks/dwwi/jsp/ssoregister.jsp?d=https%3A%2F%2Fwww.ibm.com%2Fdeveloperworks%2Fcn%2Fjava%2Fj-lo-jvmti%2F&amp;lang=zh&amp;a=dwmav" role="menuitem">注册</a>		</li></ul></li><li role="presentation" class="ibm-masthead-item-menu"><button role="menubutton" class="ibm-menu-link">站点导航</button></li></ul></div> 
        </nav>
  
        
       
    </div>
</div><div class="ibm-mobilemenu ibm-hide" aria-labelledby="ibm-burgermenu-a11y" role="dialog" tabindex="0"><p class="ibm-hide" id="ibm-burgermenu-a11y">站点导航</p><div class="ibm-mobilemenu-close"><p class="ibm-icononly ibm-fright ibm-ind-link ibm-nospacing"><a class="ibm-close-link" href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/?lnk=hm#">关闭</a></p></div><div class="ibm-mobilemenu-section ibm-mobilemenu-sitenavmenu"><ul role="menubar"><li class="ibm-mobile-section-heading ibm-mobile-sitename">
        <a href="https://www.ibm.com/developerworks/cn/?lnk=hm">
            <img width="186" height="24" alt="developerWorks®" src="./基于 JVMTI 实现 Java 线程的监控_files/dw-mf-wordmark.svg">
        </a>
    </li>
                            <li class="dw-navpage-learn" role="presentation">
                    <a href="https://www.ibm.com/developerworks/cn/topics/?lnk=hm" role="menuitem" tabindex="0">学习</a>
                </li>
                    
                <li class="dw-navpage-develop" role="presentation">
                    <a href="https://www.ibm.com/developerworks/cn/downloads/?lnk=hm" role="menuitem" tabindex="-1">开发</a>
                </li>                    

                <li class="dw-navpage-connect" role="presentation">
                    <a href="https://www.ibm.com/developerworks/cn/community/?lnk=hm" role="menuitem" tabindex="-1">社区</a>
                </li>  
        </ul></div><div class="ibm-mobilemenu-section"><ul class="ibm-mobilemenu-mhlinks" aria-label="发现 IBM"><li><a href="http://www.ibm.com/marketplace/?lnk=hmmp">市场</a></li><li><div data-widget="showhide" data-type="panel" class="ibm-show-hide ibm-widget-processed"><h2><a href="javascript:void();">产品</a></h2><div class="ibm-container-body" style="display: none;"><ul><li><a href="https://www.ibm.com/products/cn/zh/?lnk=hmhmpr_cnzh"><span>所有产品</span></a></li><li><a href="https://www.ibm.com/analytics/cn/zh/?lnk=hmmpr_bua_cnzh&amp;lnk2=learn"><span>大数据与分析</span></a></li><li><a href="https://www.ibm.com/cloud-computing/cn/zh?lnk=hmmpr_bucl_cnzh&amp;lnk2=learn"><span>云计算</span></a></li><li><a href="https://www.ibm.com/ibm/cn/cognitive/outthink/?lnk=hmmpr_buce_cnzh&amp;lnk2=learn"><span>认知</span></a></li><li><a href="https://www.ibm.com/commerce/cn-zh/?lnk=hmmpr_bucom_cnzh&amp;lnk2=learn"><span>商务</span></a></li><li><a href="https://www.ibm.com/internet-of-things/cn-zh/?lnk=hmmpr_iot_cnzh&amp;lnk2=learn"><span>物联网</span></a></li><li><a href="https://www.ibm.com/solutions/cn/zh/index.html?lnk=hm"><span>行业解决方案</span></a></li><li><a href="https://www.ibm.com/it-infrastructure/cn-zh/?lnk=hmmpr_buit_cnzh&amp;lnk2=learn"><span>IT 基础架构</span></a></li><li><a href="https://www.ibm.com/mobilefirst/cn/zh/?lnk=hmmpr_bumf_cnzh&amp;lnk2=learn"><span>移动</span></a></li><li><a href="https://www.ibm.com/security/cn-zh/?lnk=hmmpr_buse_cnzh&amp;lnk2=learn"><span>安全</span></a></li><li><a href="https://www.ibm.com/social-business/cn-zh/?lnk=hm"><span>社交协作与人才管理</span></a></li><li><a href="https://www.ibm.com/services/cn/zh/watson/explorer.html?lnk=hm"><span>Watson</span></a></li></ul></div></div></li><li><div data-widget="showhide" data-type="panel" class="ibm-show-hide ibm-widget-processed"><h2><a href="javascript:void();">服务</a></h2><div class="ibm-container-body" style="display: none;"><ul><li><a href="https://www.ibm.com/services/cn/gbs/consulting/?lnk=hmmse_bc_cnzh&amp;lnk2=learn"><span>业务咨询</span></a></li><li><a href="https://www.ibm.com/technologyservices/cn/zh/?lnk=hmmse_ts_cnzh&amp;lnk2=learn"><span>技术服务</span></a></li><li><a href="https://www.ibm.com/financing/cn/zh/index.html?lnk=hmmse_fin_cnzh&amp;lnk2=learn"><span>融资</span></a></li><li><a href="https://www.ibm.com/solutions/cn/zh/index.html?lnk=hm"><span>行业解决方案</span></a></li><li><a href="https://www.ibm.com/training/?lnk=hm"><span>培训与技能 (US)</span></a></li></ul></div></div></li><li><div data-widget="showhide" data-type="panel" class="ibm-show-hide ibm-widget-processed"><h2><a href="javascript:void();">开发人员</a></h2><div class="ibm-container-body" style="display: none;"><ul><li><a href="https://www.ibm.com/developerworks/cn/?lnk=hmmdev_dw_cnzh&amp;lnk2=learn"><span>developerWorks</span></a></li><li><a href="https://www.ibm.com/partnerworld?lnk=hmmdev_pw_cnzh&amp;lnk2=learn"><span>PartnerWorld</span></a></li></ul></div></div></li><li><a href="https://www.ibm.com/support/cn/zh/?lnk=hmmsu_cnzh">支持</a></li><li><a href="https://www.ibm.com/employment/cn/?lnk=hmmca_cnzh">工作机会</a></li></ul></div></div><div class="ibm-mhplaceholder"></div><!-- MASTHEAD_END -->
	    
<!-- LAYOUT -->
<div id="ibm-content-wrapper">
    <!-- LEADSPACE_BEGIN -->
    <header role="banner" aria-labelledby="ibm-pagetitle-h1">
        
        <!-- MASTHEAD_SITENAV_BEGIN -->
        <div class="ibm-sitenav-menu-container" data-widgetprocessed="true">
    <div class="ibm-sitenav-menu-name">
        <a href="https://www.ibm.com/developerworks/cn/">
            <img width="186" height="24" alt="developerWorks®" src="./基于 JVMTI 实现 Java 线程的监控_files/dw-mf-wordmark.svg">
        </a>
    </div>
    <div class="ibm-sitenav-menu-list">
        <ul role="menubar">
                            <li class="dw-navpage-learn" role="presentation">
                    <a href="https://www.ibm.com/developerworks/cn/topics/" role="menuitem" tabindex="0">学习</a>
                </li>
                    
                <li class="dw-navpage-develop" role="presentation">
                    <a href="https://www.ibm.com/developerworks/cn/downloads/" role="menuitem" tabindex="-1">开发</a>
                </li>                    

                <li class="dw-navpage-connect" role="presentation">
                    <a href="https://www.ibm.com/developerworks/cn/community/" role="menuitem" tabindex="-1">社区</a>
                </li>  
        </ul>
    </div>
</div>        <!-- MASTHEAD_SITENAV_END -->
        
        <!-- NAVIGATION_TRAIL_BEGIN -->
        <div id="ibm-leadspace-head" class="ibm-alternate">
            <div id="ibm-leadspace-body">
                <nav aria-label="Breadcrumb" role="navigation">                     
                            <ul id="dw-navigation-trail" itemscope="" itemtype="http://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="http://www.ibm.com/developerworks/cn/topics/"><span itemprop="name">学习</span></a><meta itemprop="position" content="1"></li><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="http://www.ibm.com/developerworks/cn/java/"><span itemprop="name">Java technology</span></a><meta itemprop="position" content="2"></li></ul>
                </nav>
            </div>
        </div>
        <!-- NAVIGATION_TRAIL_END -->
        
    </header>
    <!-- LEADSPACE_END -->
    
    <!-- MAIN_CONTENT_BEGIN -->
    <main role="main" aria-label=""> 
        <div id="ibm-pcon">
            <!-- BEGIN_IBM-CONTENT -->
            <div id="ibm-content">
                <!-- BEGIN_IBM-CONTENT-BODY -->
                <div id="ibm-content-body">
                    <!-- BEGIN_IBM-CONTENT-MAIN -->
                    <div id="ibm-content-main" class="dw-article">                        
                        <!-- BEGIN_INTERIOR-COLUMNS -->
                                <div class="ibm-columns dw-article-toc">
                                    <!-- LEFT_6_2_CONTENT_COLUMN_BEGIN -->  
                                    <div id="dw-article-toc-container" class="ibm-col-6-2">
                                        <div id="dw-article-toc-body" data-widget="scrollable" data-height="502" style="width: 380px; height: 502px;" class=""><div class="nano-content" tabindex="-1">
                                            <h2>内容</h2><div class="ibm-alternate-rule"><hr></div><ul role="directory" aria-label="内容" class="ibm-plain-list"><li class=""><a onclick="tocLink(&#39;#ibm-pagetitle-h1&#39;)" role="link" tabindex="0">概览</a></li><li class=""><a onclick="tocLink(&#39;#major1&#39;)" role="link" tabindex="0">JVMTI 工具接口</a></li><li class=""><a onclick="tocLink(&#39;#major2&#39;)" role="link" tabindex="0">Java 线程模型</a></li><li class=""><a onclick="tocLink(&#39;#major3&#39;)" role="link" tabindex="0">Java 线程切换的上下文信息</a></li><li class=""><a onclick="tocLink(&#39;#major4&#39;)" role="link" tabindex="0">Java 线程切换的监控模型</a></li><li class=""><a onclick="tocLink(&#39;#major5&#39;)" role="link" tabindex="0">实现 Java 线程监控代理</a></li><li class=""><a onclick="tocLink(&#39;#major6&#39;)" role="link" tabindex="0">测试监控代理</a></li><li class="dw-highlight"><a onclick="tocLink(&#39;#major7&#39;)" role="link" tabindex="0">总结</a></li><li class=""><a onclick="tocLink(&#39;#artdownload&#39;)" role="link" tabindex="0">下载资源</a></li><li><a onclick="tocLink(&#39;#artrelatedtopics&#39;)" role="link" tabindex="0">相关主题</a></li><li><a onclick="tocLink(&#39;#icomments&#39;)" role="link" tabindex="0">评论</a></li></ul>
                                        </div><div class="nano-pane" style="display: none; opacity: 1; visibility: visible;"><div class="nano-slider" style="height: 502px; transform: translate(0px, 0px);"></div></div></div>
                                    </div>
                                    <!-- LEFT_6_2_CONTENT_COLUMN_END -->
                                    
                                    <!-- CENTER_6_4_CONTENT_COLUMN_BEGIN -->
                                    <div class="ibm-col-6-4">
                                        <h1 id="ibm-pagetitle-h1" class="ibm-h1">基于 JVMTI 实现 Java 线程的监控</h1>
                                        <!-- Article Top Bar -->
                                                <div class="ibm-columns dw-article-topbar">
                                                    <!-- Author and article info. -->
                                                    <div class="ibm-col-6-2 ibm-col-medium-6-4 dw-article-metadata">
                                                        <div class="dw-article-avatar"><img width="42" height="42" src="./基于 JVMTI 实现 Java 线程的监控_files/dw-author.png" alt=""></div><div class="dw-article-authordate">李 凌<br><span class="dw-article-pubdate">2009 年 12 月 10 日发布</span></div>
                                                    </div>
                                                    <!-- Social -->
                                                    <div class="ibm-col-6-2 ibm-col-medium-6-4 ibm-col-small-6-2 dw-article-social">
                                                        <!-- Sharing links -->
                                                        <div id="dw-article-share-inline">
                                                            <div class="dw-article-sharelink-inline">
                                                                <div class="ibm-sharethispage"><h4 class="ibm-bold">分享此页面</h4><p class="ibm-icononly"><a class="ibm-weibo-encircled-link" href="http://service.weibo.com/share/share.php?url=http%3A%2F%2Fwww.ibm.com%2Fdeveloperworks%2Fcn%2Fjava%2Fj-lo-jvmti%2Findex.html%&amp;title=%E5%9F%BA%E4%BA%8E%20JVMTI%20%E5%AE%9E%E7%8E%B0%20Java%20%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%9B%91%E6%8E%A7&amp;language=zh_cn" data-id="weibo" onclick="return IBMCore.common.module.sharethispage.gotoUrl(window.open(), this);">Weibo</a><a class="ibm-googleplus-encircled-link" href="https://plus.google.com/share?url=http%3A%2F%2Fwww.ibm.com%2Fdeveloperworks%2Fcn%2Fjava%2Fj-lo-jvmti%2Findex.html&amp;t=%E5%9F%BA%E4%BA%8E%20JVMTI%20%E5%AE%9E%E7%8E%B0%20Java%20%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%9B%91%E6%8E%A7" data-id="googleplus" onclick="return IBMCore.common.module.sharethispage.gotoUrl(window.open(), this);">Google+</a><a class="ibm-email-encircled-link" href="mailto:?subject=%E5%9F%BA%E4%BA%8E%20JVMTI%20%E5%AE%9E%E7%8E%B0%20Java%20%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%9B%91%E6%8E%A7&amp;body=http%3A%2F%2Fwww.ibm.com%2Fdeveloperworks%2Fcn%2Fjava%2Fj-lo-jvmti%2Findex.html" data-id="email" onclick="">用电子邮件发送本页面</a></p></div>
                                                            </div>
                                                        </div>
                                                        <!-- Number of comments and link to comments -->
                                                        <div id="dw-article-cmts">
                                                            <div class="dw-article-cmtslink">
                                                                <a onclick="tocLink(&#39;#icomments&#39;)" href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#icomments" role="link" tabindex="0" aria-label="Comments">
                                                                    <img src="./基于 JVMTI 实现 Java 线程的监控_files/dw-article-cmt-icon.png" width="29" height="29" alt="Comments">
                                                                </a>
                                                            </div>
                                                            <div class="dw-article-cmtslink">
                                                                <a onclick="tocLink(&#39;#icomments&#39;)" href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#icomments" role="link" tabindex="0">
                                                                    <div id="nCmts">2</div>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                        <!-- Article Body -->
                                        
                                        <h2 id="major1" class="ibm-h2">JVMTI 工具接口</h2><p>随着多核 CPU 技术的发展，多线程编程技术被广泛地应用，从而充分发挥整个系统的性能。Java 语言对多线程编程提供了语言级的支持，可以方便地创建、运行、销毁线程。然而，多线程的使用也给应用程序开发人员带来了巨大的挑战，不正确地使用多线程可能造成线程死锁或资源竞争，导致系统瘫痪。</p><p>为了帮助 Java 开发人员诊断和跟踪 Java 线程状态的切换，Sun 公司在 Java 开发工具包（Java2 Software Development Kit, JDK）1.5.0 版本中引进了 Java 虚拟机工具接口（Java Virtual Machine Toolkit Interface，JVMTI），用于替代在先前的 JDK 版本中作为试验功能存在的 Java 虚拟机剖析接口（Java Virtual Machine Profiling Interface，JVMPI）和 Java 虚拟机调试接口（Java Virtual Machine Debugging Interface，JVMDI）。通过 JVMTI 接口可以创建代理程序（Agent）以监视和控制 Java 应用程序，包括剖析、调试、监控、分析线程等等，其架构模型如图 1 所示。</p><h5 id="fig1" class="ibm-h5">图 1. JVMTI 架构模型</h5><img src="./基于 JVMTI 实现 Java 线程的监控_files/image001.jpg" class="ibm-downsize" alt="图 1. JVMTI 架构模型" height="156" width="298"><p class="ibm-ind-link ibm-hide"><a class="ibm-popup-link" onclick="IBMCore.common.widget.overlay.show(&#39;N10050&#39;);return false;" href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#N10050">点击查看大图</a></p><div class="overlayrp"></div><p>
				Agent 可以向运行中的虚拟机实例订阅感兴趣的事件，当这些事件发生的时候，会以事件回调函数的方式激活代理程序，同时 JVMTI 提供了众多的功能函数，以查询和控制 Java 应用程序的运行状态。Agent 通过 JVMTI 所提供的接口与虚拟机进行通信，并同步监控虚拟机的运行状态，它与运行中的 Java 应用程序是相对独立的，不会干扰程序的正常运行。Agent 可以用任何支持 C 语言标准的本地语言来编写，并以动态链接库的方式存在；Java 程序启动的时候可以加载这个动态链接库。</p><p>基于 JVMTI 接口构建的 Agent 可以方便地实现对 Java 线程状态切换的跟踪，从而使开发人员能够在运行时清楚地了解多线程应用程序中线程的工作情况，方便进行调试和除错。本文后续部分将介绍如何基于 JVMTI 接口构建 Java 线程切换监控代理。</p><h2 id="major2" class="ibm-h2">Java 线程模型</h2><a id="OLE_LINK5"></a><p>要对 Java 线程的切换进行监控，必须先了解 JVM 中的 Java 线程模型。Java 线程模型可以用图 2 所示的 Java 线程生命周期来描述。Java 线程的生命周期包括创建，就绪，运行，阻塞，死亡 5 个状态。一个 Java 线程总是处于这 5 个生命周期状态之一，并在一定条件下可以在不同状态之间进行转换 。</p><h5 id="fig2" class="ibm-h5">图 2. Java 线程模型</h5><img src="./基于 JVMTI 实现 Java 线程的监控_files/image002.gif" class="ibm-downsize" alt="图 2. Java 线程模型" height="215" width="556"><p class="ibm-ind-link ibm-hide"><a class="ibm-popup-link" onclick="IBMCore.common.widget.overlay.show(&#39;N10066&#39;);return false;" href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#N10066">点击查看大图</a></p><div class="overlayrp"></div><ul class="ibm-bullet-list"><li>创建状态 (New Thread)<br>在 Java 语言中使用 new 操作符创建一个线程后，该线程仅仅是一个空对象，它具备了线程的一些特征，但此时系统没有为其分配资源，这时的线程处于创建状态。</li><li>就绪状态 (Runnable)<br>使用 start() 方法启动一个线程后，系统为该线程分配了除 CPU 外的所需资源，使该线程处于就绪状态。此外，如果某个线程执行了 yield() 方法，那么该线程会被暂时剥夺 CPU 资源，重新进入就绪状态。</li><li>运行状态 (Running)<br>Java 运行系统通过调度选中一个处于就绪状态的线程，使其占有 CPU 并转为运行状态。此时，系统真正执行线程的 run() 方法。</li><li>阻塞状态 (Blocked)<br>一个正在运行的线程因某些原因不能继续运行时，它就进入阻塞状态。这些原因包括：当执行了某个线程对象的 suspend()、sleep() 等阻塞类型的方法时，该线程对象会被置入一个阻塞集（Blocked Pool）内，等待被唤醒（执行 resume() 方法）或是因为超时而时自动苏醒；当多个线程试图进入某个同步区域（synchronized）时，没能进入该同步区域的线程会被置入锁定集（Lock Pool），直到获得该同步区域的锁，进入就绪状态；当线程执行了某个对象的 wait() 方法时，线程会被置入该对象的等待集（Wait Pool）中，直到执行了该对象的 notify() 方法，wait()/notify() 方法的执行要求线程首先获取到该对象的锁。</li><li>死亡状态 (Dead)<br>线程在 run() 方法执行结束后进入死亡状态。此外，如果线程执行了 interrupt() 或 stop() 方法，那么它也会以异常退出的方式进入死亡状态。</li></ul><h2 id="major3" class="ibm-h2">Java 线程切换的上下文信息</h2><p>通过对 Java 线程模型的分析，可以将 Java 线程切换所涉及的上下文信息分为显式线程切换信息和隐式线程切换信息。在 Java 线程切换时通过 JVMTI 接口捕获线程切换的上下文信息，即可实现对 Java 线程切换的监控。</p><ul class="ibm-bullet-list"><li>
					显式线程切换信息 <br>显式线程切换是指一个线程对象显式地对另一个线程对象进行操作（调用线程方法），使目标线程的状态发生变换；其上下文信息可以用三元组 &lt; 操作线程，动作，被操作线程 &gt; 来描述。例如，Java 线程的启动上下文就可以描述为 &lt;Thread-Caller, start, Thread-Callee&gt;。从 Java 线程模型可知，Java 中线程的创建是通过派生 Thread 类或 Runnable 接口来实现的，并通过调用 Thread 类中的 start() 方法来启动新建立的线程对象；因此，通过监控 start() 方法的调用，并结合对 Java 方法调用堆栈的分析，就可以分析出线程启动的上下文信息。根据 Java 线程模型可知，显式线程切换共涉及到 start()、interrupt()、join()、resume()、suspend()、sleep()、yield() 和 stop() 这几个线程方法。</li><li>
隐式线程切换信息 <br>在某些情况下，线程的切换并不是通过线程之间直接调用线程方法进行的，而是通过线程间通信的方式进行。这种由线程间通信产生的上下文信息，称之为隐式线程切换信息。一个典型的例子就是 Java 线程池。通常，线程池内存储了若干个预先创建好的线程，这项线程处于阻塞状态，并不处理任务；当某个任务到来的时候，负责任务调度的线程会唤醒线程池中某个处于阻塞状态的空闲线程处理这个任务；一旦任务完成，执行该任务的线程不会被撤销，而是继续处于阻塞状态，并被重新置回线程池中，等待下一次调度。虽然 Java 线程池的实现方式不尽相同，但究其本质都是通过 Java 中 Object 类的线程通信原语 wait() 和 notify()/notifyAll() 方法来实现的。wait() 方法会使线程在指定目标上等待，而 notify() 方法则使等待在指定目标上的某个线程苏醒，具体哪个线程真正被唤醒取决于虚拟机的实现方式， notifyAll() 方法则是使所有的线程都苏醒。隐式线程切换信息同样可以用三元组 &lt; 操作线程，动作，被操作线程 &gt; 来描述，但该三元组的确立比显式线程切换要复杂，需要通过分析线程通信原语执行的上下文信息来得到。</li></ul><p>下一节将介绍如何获取线程切换的上下文信息。</p><h2 id="major4" class="ibm-h2">Java 线程切换的监控模型</h2><p>根据 Java 线程切换机制设计的 Java 线程监控模型如图 3 所示。线程监控代理 Agent 通过 JVMTI 在方法调用者和被调用者之间注册一个事件监听器，用于监听线程切换事件（即引起线程切换的方法调用）。当某个线程方法即将被调用的时候，监听器发送方法进入事件（Method Entry）到 Agent 的 Before Advice 回调方法；当某个线程方法返回的时候，监听器发送方法返回（Method Exit）事件到 Agent 的 After Advice 回调方法。Before Advice 和 After Advice 分别负责处理线程方法调用前的线程状态和线程方法调用后的线程状态。这样，线程监控代理就能够监控到 Java 线程的状态切换情况。</p><h5 id="fig3" class="ibm-h5">图 3. Java 线程监控模型</h5><img src="./基于 JVMTI 实现 Java 线程的监控_files/image003.gif" class="ibm-downsize" alt="图 3. Java 线程监控模型" height="275" width="436"><p class="ibm-ind-link ibm-hide"><a class="ibm-popup-link" onclick="IBMCore.common.widget.overlay.show(&#39;N1009D&#39;);return false;" href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#N1009D">点击查看大图</a></p><div class="overlayrp"></div><p><strong><em>获取显式线程切换的上下文信息</em></strong></p><p>在 Java 方法调用发生的时候，通过 JVMTI 接口能够很轻易的获取到方法名称和执行该方法的线程标识。因此，确定线程切换上下文三元组 &lt; 操作线程，动作，被操作线程 &gt; 的关键在于，如何获取被操作线程对象标识，而这需要对 Java 方法的调用机制进行分析。</p><p>每当启动一个新线程的时候，Java 虚拟机会为它分配一个 Java 栈。Java 栈以帧（Frame）为单位保存线程的运行状态。虚拟机只会对 Java 栈执行两种操作：以帧为单位的入栈和出栈。</p><p>当线程调用一个 Java 方法时，虚拟机会在该线程所在的 Java 栈压入一个新的栈帧（Stack Frame），用于存储该 Java 方法的地址；该方法被称为当前方法，该栈帧被成为当前栈帧。栈帧通常由局部变量区、操作数栈和帧数据区组成。在执行当前方法时，它使用当前栈帧来存储参数、局部变量、中间运算结果等等数据。栈帧在方法调用的时候被创建，并在方法完成的时候销毁。</p><p>通过对栈帧的进一步研究发现，当一个对象的某个实例方法执行时，Java 虚拟机会隐式地在该方法的当前栈帧的局部变量区加入一个指向该对象的引用。尽管在方法源代码中并没有显式声明这个参数，但这个参数对于任何一个实例方法都是由 JVM 隐含加入的，而且它始终在局部变量区的首位。局部变量区是根据索引进行寻址的，第一个局部变量的索引是 0，因此可以使用局部变量区索引 0 的方式来访问这个对象引用，如表 1 所示。</p><h5 id="N100B4" class="ibm-h5">表 1. 局部变量区</h5><div id="DataTables_Table_0_wrapper" class="dataTables_wrapper no-footer"><table border="0" cellpadding="0" cellspacing="0" class="ibm-data-table display dataTable no-footer dtr-inline" data-widget="datatable" id="DataTables_Table_0" role="grid" style="width: 780px;"><thead xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><tr role="row"><th class="ibm-background-neutral-white-30 sorting_disabled" rowspan="1" colspan="1" style="width: 255px;">索引</th><th class="ibm-background-neutral-white-30 sorting_disabled" rowspan="1" colspan="1" style="width: 445px;">参数</th></tr></thead><tbody xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><tr role="row" class="odd"><td tabindex="0">
 0 
</td><td>
对象引用
</td></tr><tr role="row" class="even"><td tabindex="0">
 1 
</td><td>
局部变量 1 
</td></tr><tr role="row" class="odd"><td tabindex="0">
 2 
</td><td>
局部变量 2 
</td></tr><tr role="row" class="even"><td tabindex="0">
……
</td><td>
……
</td></tr></tbody></table></div><p>如此一来，当被操作线程对象执行某个线程方法的时候，可以通过分析当前操作线程的当前栈帧的本地方法区获取到被操作线程对象的引用。这样，就可以完整地确定显式线程切换的三元组 &lt; 操作线程，动作，被操作线程 &gt; 信息。</p><p>需要注意的是，有一些线程方法，例如 sleep() 和 yield() 方法，它们是作为本地方法（Native Method）来实现的，它们在被调用的过程中不会生成 Java 栈中的当前方法帧，而是将信息保存在本地方法栈（Native Stack）内。因此，对这些方法引起的线程切换不能直接采用上述分析方法，而是应该分析本地方法栈。</p><p><strong><em>获取隐式线程切换的上下文信息</em></strong></p><p>类似的，获取隐式线程切换上下文信息的关键也是确定三元组 &lt; 操作线程，动作，被操作线程 &gt; 中的被操作线程对象标识，而这需要对 Java 线程的同步机制进行分析。</p><p>Java 使用名为监视器（Monitor）的同步机制来调节多个线程的活动和共享数据，如图 4 所示。Java 中，每个对象都对应一个监视器，即使在多线程的情况下，该监视器监视的区域同一时间只会被一个线程执行。一个线程想要执行监视区域的代码，唯一的途径就是获得该区域对应的监视器。当一个线程到达了一个监视区域的开始处（Entry Point），它就会被置入该监视器的请求集（Entry Pool）。如果此时没有其他线程在请求集中等待，并且也没有其它线程正持有该监视器（Monitor Hold），那么该线程就可以获得监视器，并继续执行监视区域中的代码。当这个线程执行完监视区域代码后，它就会退出并释放该监视器（Release Monitor）。如果线程在执行监视区域代码的过程中，执行了 wait() 方法，那么该线程会暂时释放该监视器，并被置入等待集（Wait Pool），等待被唤醒；如果线程在这个过程中执行了 notify() 方法，那么在等待集中的某个线程就会被标记为即将苏醒，这个即将苏醒的线程将在某个监视器空闲的时刻获取该监视器，并执行该监视区域代码，具体哪个线程被唤醒视虚拟机的实现方式而定。notifyAll() 方法会将等待集中的所有线程标记为即将苏醒，并接受虚拟机的调度。一个线程只有在它已经持有监视器时才能执行 wait() 方法，并且它只能通过再次成为监视器的持有者才能离开等待集。</p><h5 id="fig4" class="ibm-h5">图 4. Java 线程的同步机制</h5><img src="./基于 JVMTI 实现 Java 线程的监控_files/image004.gif" class="ibm-downsize" alt="图 4. Java 线程的同步机制" height="233" width="518"><p class="ibm-ind-link ibm-hide"><a class="ibm-popup-link" onclick="IBMCore.common.widget.overlay.show(&#39;N100E5&#39;);return false;" href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#N100E5">点击查看大图</a></p><div class="overlayrp"></div><p>根据上述对 Java 线程同步机制的分析，如果能够在执行 wait()/notify()/notifyAll() 方法的前后分别获取其监视器等待集的状态快照并加以比较，就可以得出是哪个或者是哪些线程被唤醒，而这些线程就是这次隐式线程切换的被操作线程。这样，就可以确定线程切换的三元组 &lt; 操作线程，动作，被操作线程 &gt; 信息。</p><p>此外，由于一个线程可能同时拥有多个对象监视器，因此必须对每个监视器上的等待集进行分析，以确定当前执行的 wait()/notify()/notifyAll() 方法所真正作用的监视器。</p><h2 id="major5" class="ibm-h2">实现 Java 线程监控代理</h2><p>本节介绍了如何依据 Java 线程切换监控模型，实现 Java 线程监控代理（Agent）。</p><p>线程监控代理是一个基于 JVMTI 的 C 语言实现，它可以从虚拟机运行时实例中捕获运行中的 Java 应用程序的线程切换信息，同时不影响该程序的运行。</p><h3 id="N100F7" class="ibm-h3">初始化监控代理</h3><p>首先，监控代理必须包括一个 JVMTI 的头文件，主要代码片段如清单 1 所示。该头文件包含 JVMTI 必须的一些定义，通常它存在于 JDK 安装目录的 include 目录下。</p><p>其次，需要对代理进行初始化，这个工作由 Agent_OnLoad() 方法完成。这个方法主要用于在初始化 Java 虚拟机之前设置所需的功能（Capabilities）、注册事件通知（Event Notification）和指定事件回调函数（Callback Method）。其中，GetEnv() 方法用于获取当前的虚拟机运行环境；AddCapabilities() 方法用于设置线程监控代理所需要的功能，包括方法的调用和返回事件、访问方法局部变量、获取对象或线程拥有的监视器信息；SetEventNotificationMode() 方法用于捕获每个实例方法的调用和返回的事件通知；SetEventCallbacks() 方法用于注册相应的方法进入回调函数和方法退出回调函数。</p><h5 id="listing1" class="ibm-h5">清单 1. 初始化 Agent</h5><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_454460" class="syntaxhighlighter  htmlscript "><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">include "jvmti.h"</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">JNIEXPORT jint JNICALL Agent_OnLoad(JavaVM *jvm, char *options, void *reserved) { </code></div><div class="line number3 index2 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">jvm-&gt;GetEnv((void **) &amp;gb_jvmti, JVMTI_VERSION_1_0); </code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_capa.can_generate_method_exit_events = 1; </code></div><div class="line number6 index5 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_capa.can_access_local_variables=1; </code></div><div class="line number7 index6 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_capa.can_get_monitor_info=1; </code></div><div class="line number8 index7 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;AddCapabilities(&amp;gb_capa); </code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">callbacks.MethodEntry = &amp;callbackMethodEntry; </code></div><div class="line number11 index10 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">callbacks.MethodExit = &amp;callbackMethodExit; </code></div><div class="line number12 index11 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;SetEventCallbacks(&amp;callbacks, sizeof(callbacks)); </code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE,JVMTI_EVENT_METHOD_ENTRY,NULL); </code></div><div class="line number15 index14 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE,JVMTI_EVENT_METHOD_EXIT,NULL); </code></div><div class="line number16 index15 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">return JNI_OK; </code></div><div class="line number17 index16 alt2"><code class="htmlscript plain">}</code></div></div></td></tr></tbody></table></div></div></div></span><h3 id="N10107" class="ibm-h3">监控显式线程切换</h3><p>显式线程切换的监控通过 callbackMethodEntry() 回调方法完成，主要代码片段如清单 2 所示。该回调方法使用 RawMonitorEntry() 和 RawMonitorExit() 方法设定原始监视器的监视区域，监视引起显式线程切换的线程方法，例如 start()、interrupt()、join()、resume() 等。</p><p>当上述某个线程方法即将被调用时，先用 GetObjectHashCode() 方法计算当前操作线程的哈希值，籍此唯一标识这个线程对象；然后使用 GetLocalObject() 方法获取操作线程 Java 栈中当前方法帧的对象引用，这个引用指向了被操作线程对象。这样就可以获得一个显式线程切换的上下文信息，可以被描述为：&lt;Thread-A, start, Thread-B&gt;、&lt;Thread-B, resume, Thread-C&gt; 等等。</p><h5 id="listing2" class="ibm-h5">清单 2. 监控显式线程切换</h5><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_396994" class="syntaxhighlighter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">static void JNICALL callbackMethodEntry(jvmtiEnv *jvmti_env, JNIEnv* env, </code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">jthread thr, jmethodID method) { </code></div><div class="line number3 index2 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;RawMonitorEnter(gb_lock); </code></div><div class="line number4 index3 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">if (strcmp(name,"start")==0||strcmp(name,"interrupt")==0|| </code></div><div class="line number5 index4 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">strcmp(name,"join")==0||strcmp(name,"stop")==0|| </code></div><div class="line number6 index5 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">strcmp(name,"suspend")==0||strcmp(name,"resume")==0){ </code></div><div class="line number7 index6 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;GetLocalObject(thr,0,0,&amp;thd_ptr); </code></div><div class="line number8 index7 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;GetObjectHashCode(thd_ptr, &amp;hash_code); </code></div><div class="line number9 index8 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">} </code></div><div class="line number10 index9 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;RawMonitorExit(gb_lock); </code></div><div class="line number11 index10 alt2"><code class="htmlscript plain">}</code></div></div></td></tr></tbody></table></div></div></div></span><h3 id="N10117" class="ibm-h3">监控隐式线程切换</h3><p>隐式线程切换的监控通过捕获 wait()/notify()/notifyAll() 方法调用前和调用后的等待集信息来实现。</p><p>以 notify() 方法为例，当 notify() 方法即将被调用时，在 callbackMethodEntry() 方法中首先使用 GetOwnedMonitorInfo() 方法获取当前操作线程所拥有的监视器，然后用 GetObjectMonitorUsage() 方法获取每个监视器上等待的线程对象，并将它们保存在隐式线程切换信息链表中等待分析，主要代码片段如清单 3 所示。</p><h5 id="listing3" class="ibm-h5">清单 3. 获取 notify 方法调用前的等待集</h5><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_968425" class="syntaxhighlighter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">static void JNICALL callbackMethodEntry(jvmtiEnv *jvmti_env, JNIEnv* env, </code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">jthread thr, jmethodID method){ </code></div><div class="line number3 index2 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">if(strcmp(name,"notify")==0||strcmp(name,"notifyAll")==0) { </code></div><div class="line number4 index3 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;GetOwnedMonitorInfo(thr,&amp;owned_monitor_count,&amp;owned_monitors_ptr); </code></div><div class="line number5 index4 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">for(int index=0;index&lt;</code><code class="htmlscript plain">owned_monitor_count</code><code class="htmlscript plain">;index++){ </code></div><div class="line number6 index5 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">jvmtiMonitorUsage *</code><code class="htmlscript color1">info_ptr</code><code class="htmlscript plain">=</code><code class="htmlscript plain">NULL</code><code class="htmlscript plain">; </code></div><div class="line number7 index6 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">info_ptr=(jvmtiMonitorUsage*)malloc(sizeof(jvmtiMonitorUsage)); </code></div><div class="line number8 index7 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">gb_jvmti-&gt;GetObjectMonitorUsage(*(owned_monitors_ptr+index),info_ptr); </code></div><div class="line number9 index8 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">insertElem(&amp;inf_head,&amp;inf_tail,info_ptr); </code></div><div class="line number10 index9 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">} </code></div><div class="line number11 index10 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">} </code></div><div class="line number12 index11 alt1"><code class="htmlscript plain">}</code></div></div></td></tr></tbody></table></div></div></div></span><p>当 notify() 方法即将完成调用时，在 callbackMethodExit() 方法中，同样获取当前操作线程的等待集（notify_waiters），然后与之前记录的等待集进行比较，其中有差异的对象即为被操作线程对象。这样就能确定隐式线程切换的上下文信息，它可以被描述为：&lt;Thread-A, notify, Thread-B&gt;。其主要代码片段如清单 4 所示。</p><h5 id="listing4" class="ibm-h5">清单 4. 分析 notify 方法调用前后的等待集</h5><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_981505" class="syntaxhighlighter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">static void JNICALL callbackMethodExit(jvmtiEnv *jvmti_env, JNIEnv* env, </code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">jthread thr, jmethodID method){ </code></div><div class="line number3 index2 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">//compare the two wait pools </code></div><div class="line number4 index3 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">if(info_ptr-&gt;notify_waiter_count!=inf_head-&gt;info_ptr-&gt;notify_waiter_count){ </code></div><div class="line number5 index4 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">for(int i=0;i&lt;</code><code class="htmlscript plain">inf_head-</code><code class="htmlscript plain">&gt;info_ptr-&gt;notify_waiter_count;i++){ </code></div><div class="line number6 index5 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">for(int j=0;j&lt;</code><code class="htmlscript plain">info_ptr-</code><code class="htmlscript plain">&gt;notify_waiter_count;j++){ </code></div><div class="line number7 index6 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">if(inf_head-&gt;info_ptr-&gt;notify_waiters+i!=info_ptr-&gt;notify_waiters+j){ </code></div><div class="line number8 index7 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">isObj=false; </code></div><div class="line number9 index8 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">break; </code></div><div class="line number10 index9 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">} </code></div><div class="line number11 index10 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">} </code></div><div class="line number12 index11 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">if(isObj==true) { </code></div><div class="line number13 index12 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">GetObjectHashCode(*(inf_head-&gt;info_ptr-&gt;notify_waiters+i), &amp;hash_code); </code></div><div class="line number14 index13 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">insertElem(&amp;ctx_head,&amp;ctx_tail,thr_hash_code,hash_code,name); </code></div><div class="line number15 index14 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">} </code></div><div class="line number16 index15 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">} </code></div><div class="line number17 index16 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">} </code></div><div class="line number18 index17 alt1"><code class="htmlscript plain">}</code></div></div></td></tr></tbody></table></div></div></div></span><h2 id="major6" class="ibm-h2">测试监控代理</h2><p>线程监控代理可以用任何 C 语言编译器编译，并以动态连接库的形式加载到 Java 虚拟机中，监控正在运行的 Java 程序。使用下列命令行加载代理库并运行目标 Java 应用程序：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_395561" class="syntaxhighlighter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">java -agentlib:ThreadMonitor JavaThreadPoolApp</code></div></div></td></tr></tbody></table></div></div></div></span><p>或者：</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_533611" class="syntaxhighlighter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">java -agentpath:/&lt;</code><code class="htmlscript plain">Path</code><code class="htmlscript plain">&gt;/ThreadMonitor JavaThreadPoolApp</code></div></div></td></tr></tbody></table></div></div></div></span><a id="OLE_LINK14"></a><p>为了演示对线程切换的监控，JavaThreadPoolApp 这个样例程序实现了一个 Java 线程池，其中涉及到大量的线程状态的切换。这个应用启动的时候会初始化一个线程池，池内初始化两个子线程，并让它们处于 wait 状态；当有客户端程序需要使用线程池中的某个线程时，使用 notify 将池内的某个线程唤醒；使用完毕后，该线程重新进入 wait 状态等待下一次调度。这些线程切换活动都可以被监控代理所监控，并产生如下输出。结合应用程序的相关信息，可以进一步得出 JavaThreadPoolApp 客户端应用程序使用了线程池中的 Thread-60934352 线程并执行了 3068 毫秒。</p><span class="dw-code-nohighlight"><div class="ibm-syntax-container"><div><div id="highlighter_300307" class="syntaxhighlighter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="htmlscript plain">Thread-32452561, start, Thread-60934352 </code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">Thread-32452561, start, Thread-89877242 </code></div><div class="line number3 index2 alt2"><code class="htmlscript plain">Thread-60934352, wait, Thread-60934352, active 8 ms </code></div><div class="line number4 index3 alt1"><code class="htmlscript plain">Thread-89877242, wait, Thread-89877242, active 9 ms </code></div><div class="line number5 index4 alt2"><code class="htmlscript plain">Thread-32452561, notify, Thread-60934352 </code></div><div class="line number6 index5 alt1"><code class="htmlscript plain">Thread-60934352, wait, Thread-60934352, active 3068 ms</code></div></div></td></tr></tbody></table></div></div></div></span><p>使用线程监控代理可以实时监控 JVM 中线程运行情况，帮助开发人员诊断多线程应用中可能存在的线程调度问题。</p><h2 id="major7" class="ibm-h2">总结</h2><p>多线程应用程序的开发存在着诸多挑战，例如线程死锁、资源竞争等。因此，开发人员需要一种运行时线程监控工具来协助诊断和跟踪 Java 线程状态的切换。Sun 公司在 JDK 1.5.0 版本中引进了 JVMTI 接口用于实时监控和分析 JVM 运行状态。</p><a id="OLE_LINK21"></a><p>本文首先介绍了 JVMTI接口；然后详细分析了 Java 线程模型，并提出了 Java 线程的监控模型；最后基于 JVMTI 接口实现了 Java 线程监控代理，以协助诊断多线程应用中可能存在的线程调度问题。</p><!--CMA ID: 455723--><!--Site ID: 10--><!--XSLT stylesheet used to transform this file: dw-document-html-8.0.xsl--> 
                                        <!-- Article Resources -->
                                        <div class="ibm-alternate-rule"><hr></div><h4 id="artdownload" class="ibm-h4">下载资源</h4><ul class="ibm-link-list"><li><a class="ibm-download-link" href="http://www.ibm.com/developerworks/apps/download/index.jsp?contentid=455723&amp;filename=TMonDemo913.zip&amp;method=http&amp;locale=zh_CN%3Ca%20href=%22http://www.ibm.com/developerworks/apps/download/index.jsp?contentid=455723&amp;filename=TMonDemo913.zip&amp;method=ftp&amp;locale=zh_CN%22%3ETMonDemo913.zip%3C/a%3E">样例代码</a> (TMonDemo913.zip | 535 KB)</li></ul><div class="ibm-alternate-rule"><hr></div><h4 id="artrelatedtopics" class="ibm-h4">相关主题</h4><ul><li>“<a href="http://www.ibm.com/developerworks/cn/java/j-lo-jpda2/">深入 Java 调试体系，第 2 部分：JVMTI 和 Agent 实现</a>”（developerWorks，2009 年 3 月）：本文介绍强大的虚拟机接口 - JVMTI，以及如何使用 JVMTI 编写用户自定义的 Java 调试和诊断程序。</li><li>访问 <a href="http://java.sun.com/j2se/1.5.0/docs/guide/jvmti/jvmti.html#whatIs">JVM Tool Interface 页面</a>，了解 JVMTI 的特性和功能。</li><li><a href="http://harmony.apache.org/subcomponents/drlvm/index.html">Apache Harmony DRLVM</a> 提供了 JVMTI 的开源实现。
			</li><li>
				通过 <a href="http://harmony.apache.org/subcomponents/drlvm/index.html">JDWP</a> 提供了 JVMTI 的开源实现。
			</li><li><a href="http://www.ibm.com/developerworks/cn/java/">developerWorks Java 技术专区</a>：查找数百篇有关 Java 编程各方面的文章。
			</li></ul>
                                        <!-- Commenting -->
<!-- INLINE_COMMENTS_BEGIN: -->
<div class="ibm-alternate-rule"><hr></div>
<div id="dw-article-cmts-top" class="ibm-columns">
    <div class="ibm-col-6-2">
        <h4 id="icomments" class="ibm-h4">评论</h4>
        <div id="dw-article-cmts-login">
            <p>添加或订阅评论，请先<a onclick="window.location=userLinks[0].url;" tabindex="0" role="link">登录</a>或<a onclick="window.location=userLinks[1].url;" tabindex="0" role="link">注册</a>。</p>
        </div>
    </div>    
    <div class="ibm-col-6-2" id="dw-notify"> 
        <input type="checkbox" value="1" name="comment_notification" id="comment_notification" disabled="">
        <label for="comment_notification" style="color: rgb(204, 204, 204);">有新评论时提醒我</label>	   
    </div>
</div>

<div class="dw-article-cmts-container">       
    <div class="ibm-no-print jquery-comments read-only" id="dw-icomments-container"><div class="commenting-field main"><img src="./基于 JVMTI 实现 Java 线程的监控_files/user-icon.png" alt="" class="profile-picture round by-current-user"><div class="textarea-wrapper"><span class="close" style="display: none;"><span class="left"></span><span class="right"></span></span><div class="textarea" data-placeholder="添加评论" contenteditable="true" style="height: 3.65em;"></div><div class="control-row" style="display: none;"><span class="send save highlight-background">提交</span></div></div></div><ul class="navigation"><div class="navigation-wrapper"><li data-sort-key="newest" data-container-name="comments" class="active">最新的</li><li data-sort-key="oldest" data-container-name="comments">历史</li><li data-sort-key="popularity" data-container-name="comments">热门</li></div><div class="navigation-wrapper responsive"><li class="title active"><header>最新的</header></li><ul class="dropdown"><li data-sort-key="newest" data-container-name="comments" class="active">最新的</li><li data-sort-key="oldest" data-container-name="comments">历史</li><li data-sort-key="popularity" data-container-name="comments">热门</li></ul></div></ul><div class="data-container" data-container="comments"><ul id="comment-list" class="main"><li data-id="27204" class="comment"><div class="comment-wrapper"><img src="./基于 JVMTI 实现 Java 线程的监控_files/user-icon.png" alt="" class="profile-picture round"><time data-original="1498706517563">2017 年 06 月 29 日</time><div class="name"><a href="https://www.ibm.com/developerworks/community/profiles/user/MagicOrder">MagicOrder</a></div><div class="wrapper"><div class="content">Access Denied！！下载不能用啊</div><span class="actions"><button class="action reply" type="button">回复</button><span class="separator">·</span><button class="action upvote"><span class="upvote-count">0</span><i class="fa fa-thumbs-up"></i></button><span class="separator">·</span><a class="action reply" href="https://www.ibm.com/developerworks/community/report?lang=cn&amp;referingURL=https%3A%2F%2Fwww.ibm.com%2Fdeveloperworks%2Fcn%2Fjava%2Fj-lo-jvmti%2F&amp;mymessage=%E8%AF%84%E8%AE%BA%3A%20Access%20Denied%EF%BC%81%EF%BC%81%E4%B8%8B%E8%BD%BD%E4%B8%8D%E8%83%BD%E7%94%A8%E5%95%8A%0D%E7%94%B1%20MagicOrder%20%20%E4%BA%8E%202017%20%E5%B9%B4%2006%20%E6%9C%88%2029%20%E6%97%A5%20%0D%0D---%20%E5%9C%A8%E4%B8%8B%E6%96%B9%E6%B7%BB%E5%8A%A0%E8%AF%84%E8%AE%BA%20---" target="_blank">报告滥用<i class="fa image" style="background-image: url(&quot;/developerworks/maverick/image/report-abuse.png&quot;);"></i></a></span></div></div><ul class="child-comments"></ul></li><li data-id="21896" class="comment"><div class="comment-wrapper"><img src="./基于 JVMTI 实现 Java 线程的监控_files/user-icon.png" alt="" class="profile-picture round"><time data-original="1416038539131">2014 年 11 月 15 日</time><div class="name"><a href="https://www.ibm.com/developerworks/community/profiles/user/360P_Shine_Liu">360P_Shine_Liu</a></div><div class="wrapper"><div class="content">TMonDemo913.zip could not be downloaded.</div><span class="actions"><button class="action reply" type="button">回复</button><span class="separator">·</span><button class="action upvote"><span class="upvote-count">0</span><i class="fa fa-thumbs-up"></i></button><span class="separator">·</span><a class="action reply" href="https://www.ibm.com/developerworks/community/report?lang=cn&amp;referingURL=https%3A%2F%2Fwww.ibm.com%2Fdeveloperworks%2Fcn%2Fjava%2Fj-lo-jvmti%2F&amp;mymessage=%E8%AF%84%E8%AE%BA%3A%20TMonDemo913.zip%20could%20not%20be%20downloaded.%0D%E7%94%B1%20360P_Shine_Liu%20%20%E4%BA%8E%202014%20%E5%B9%B4%2011%20%E6%9C%88%2015%20%E6%97%A5%20%0D%0D---%20%E5%9C%A8%E4%B8%8B%E6%96%B9%E6%B7%BB%E5%8A%A0%E8%AF%84%E8%AE%BA%20---" target="_blank">报告滥用<i class="fa image" style="background-image: url(&quot;/developerworks/maverick/image/report-abuse.png&quot;);"></i></a></span></div></div><ul class="child-comments"></ul></li></ul><div class="no-comments no-data"><i class="fa fa-comments fa-2x"></i><br>第一个评论</div></div></div>
</div>
<!-- INLINE_COMMENTS_END -->                                        <!-- CENTER_6_4_CONTENT_COLUMN_END -->
                                    </div>   
                                </div>
                        <!--Rating_Meta_BEGIN--><div class="metavalue">static.content.url=http://www.ibm.com/developerworks/js/artrating/</div><div class="metavalue">SITE_ID=10</div><div class="metavalue">Zone=Java technology</div><div class="metavalue">ArticleID=455723</div><div class="metavalue">ArticleTitle=基于 JVMTI 实现 Java 线程的监控</div><div class="metavalue">publish-date=12102009</div><script language="javascript" type="text/javascript">document.write('<div class="metavalue">url='+location.href.replace(/</g,  '%3C')+'</div>');</script><div class="metavalue">url=https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/</div><!--Rating_Meta_END-->
                    <p class="ibm-ind-link ibm-nospacing ibm-icononly ibm-btt-auto ibm-hidden-small ibm-active"><a class="ibm-nospacing ibm-chevron-up-link" href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#top" tabindex="0">回页首</a></p></div>
                    <!-- END_IBM-CONTENT-MAIN -->
                </div>
                <!-- END_IBM-CONTENT-BODY -->
            </div>
            <!-- END_IBM-CONTENT -->
        </div>
        <!-- END_IBM-PCON -->
    </main>
    <!-- MAIN_CONTENT_END -->
    
    <!-- END_CONTENT-WRAPPER -->	
</div>
<!-- FOOTER_BEGIN -->
<footer role="contentinfo" aria-label="IBM developerWorks">
    <div id="dw-footer-module" class="dw-footer-home">
        <section aria-label="参考资料" role="contentinfo">
            <div class="ibm-columns">
                <div class="ibm-col-6-1 dw-footer-col-1">
                    <ul>
                        <li class="dw-footer-heading" aria-label="developerWorks">developerWorks</li>
                        <li><a href="https://www.ibm.com/developerworks/secure/feedback.jsp?domain=dwchina">站点反馈</a></li>
                        <li class="dw-footer-newline"><a href="https://www.ibm.com/developerworks/secure/myideas2.jsp?domain=dwchina">我要投稿</a></li>
                        <li class="dw-footer-newline"><a href="https://www.ibm.com/developerworks/cn/author/">投稿指南</a></li>
                        <li class="dw-footer-newline"><a href="https://www.ibm.com/developerworks/community/report?lang=zh">报告滥用</a></li>
                        <li class="dw-footer-newline"><a href="https://www.ibm.com/developerworks/cn/community/terms/thirdparty/">第三方提示</a></li>
                    </ul>
                    <ul>
                        <li class="dw-footer-newline"><a href="https://weibo.com/ibmdw/">关注微博</a></li>
                    </ul>
                </div>
                <div class="ibm-col-6-1 dw-footer-col-2">
                    <ul>
                        <li class="dw-footer-heading" aria-label="加入">加入</li>
                        <li class="dw-footer-newline"><a href="https://www.ibm.com/partnerworld/isv/">ISV 资源 (英语)</a></li>
                    </ul>
                    <ul class="dw-footer-lang" aria-label="选择语言">
                        <li class="dw-footer-heading">选择语言</li>
                        <li><a href="https://www.ibm.com/developerworks/">English</a></li>
                        <li><a href="https://www.ibm.com/developerworks/cn/" lang="zh">中文</a></li>
                        <li><a href="https://www.ibm.com/developerworks/jp/" lang="ja">日本語</a></li>
                        <li><a href="https://www.ibm.com/developerworks/ru/" lang="ru">Русский</a></li>
                        <li class="dw-footer-newline"><a href="https://www.ibm.com/developerworks/br/" lang="pt">Português (Brasil)</a></li>
                        <li><a href="https://www.ibm.com/developerworks/ssa/" lang="es">Español</a></li>
                        <li><a href="https://developer.ibm.com/kr/" lang="kr">한글</a></li>
                    </ul>
                </div>
                <div class="ibm-col-6-1 dw-footer-col-3"> </div>
                <div class="ibm-col-6-1 dw-footer-col-4">
                    <ul class="dw-footer-categories">
                        <li class="dw-footer-category">
                            <a href="https://www.ibm.com/developerworks/cn/views/global/libraryview.jsp">技术文档库</a>
                        </li>
                        <li class="dw-footer-category">
                            <a href="https://www.ibm.com/developerworks/cn/rss/">订阅源</a>  
                        </li>
                    </ul>
                </div>
                <div class="ibm-col-6-1 dw-footer-col-5">
                    <ul class="dw-footer-categories">
                        <li class="dw-footer-category">
                            <a href="https://www.ibm.com/developerworks/cn/community/">社区</a>  
                        </li>
                        <li class="dw-footer-category">
                            <a href="http://ibmdeveloperworks.mkt6741.com/developerWorksChina-NewsletterSubscriptionPage/">dW 中国时事通讯</a>  
                        </li>
                    </ul>
                </div>
                <div class="ibm-col-6-1 dw-footer-col-6">
                    <ul class="dw-footer-categories">
                        <li class="dw-footer-category">
                            <a href="https://www.ibm.com/developerworks/cn/downloads/">软件下载</a>  
                        </li>
                    </ul>
                </div>
            </div>
        </section>
    </div>
    <div id="dw-footer" class="ibm-padding-normal ibm-alternate">
        <div class="ibm-columns">
            <div class="ibm-col-1-1">
                <div class="dw-footer-corporate-links">
                <ul>
                    <li><a href="https://www.ibm.com/contact/cn/zh/">联系 IBM</a></li>
                    <li><a href="https://www.ibm.com/privacy/cn/zh/">隐私条约</a></li>
                    <li><a href="https://www.ibm.com/developerworks/community/terms?lang=zh">使用条款</a></li>
                    <li><a href="https://www.ibm.com/accessibility/cn/zh/">信息无障碍选项</a></li>
                    <li class="ibm-feedbacklink"><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#">反馈</a></li>
                    <li id="ibm-truste-cp"><a onclick="truste.eu.clickListener();return false;" href="https://www.ibm.com/developerworks/cn/java/j-lo-jvmti/#">Cookie 首选项</a></li>
                </ul>                 
                </div>    
            </div>
        </div>
    </div>        
</footer> <!-- FOOTER_END -->

<!-- END_IBM-TOP -->
</div>

<!-- SCRIPTS_INCLUDE_BEGIN -->
<!-- Styles -->
<link rel="stylesheet" type="text/css" href="./基于 JVMTI 实现 Java 线程的监控_files/jquery-comments.css">
<link rel="stylesheet" href="./基于 JVMTI 实现 Java 线程的监控_files/font-awesome.min.css">

<!-- Libraries -->
<script type="text/javascript" src="./基于 JVMTI 实现 Java 线程的监控_files/jquery-comments.min.js"></script>
<script type="text/javascript" src="./基于 JVMTI 实现 Java 线程的监控_files/moment-with-locales.js"></script>
<script type="text/javascript" src="./基于 JVMTI 实现 Java 线程的监控_files/ContentComments.js"></script>
<script type="text/javascript" src="./基于 JVMTI 实现 Java 线程的监控_files/ContentCommentsFormatter.js"></script>
<script type="text/javascript" language="JavaScript">

	IBMCore.common.module.masthead.subscribe("ready", "customjs", setupCommentsPlugin).runAsap(setupCommentsPlugin);

	function setupCommentsPlugin(){
		//debugger;
			//alert(userLinks);
			var commentsInitInfo = {
				contentId : $("div[class=metavalue]:contains('ArticleID=')").text().split("=")[1],
				siteId :  $("div[class=metavalue]:contains('SITE_ID=')").text().split("=")[1],
				pluginDivId : '#dw-icomments-container',
				notifyElementId : "#comment_notification",
				loginMessageDivId : "#dw-article-cmts-login",
				totalCommentsDivId : "#nCmts"
			};				
								
			ContentComments.Setup(commentsInitInfo);
	}
</script>
<!-- Piwik -->
<script type="text/javascript">
    var _paq = _paq || [];
    _paq.push(["setDomains", ["*.www.ibm.com/developerworks","*.www.ibm.com/developerworks"]]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
    var u="//developer.ibm.com/piwik/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 7]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
    })();
</script>
<noscript>&lt;p&gt;&lt;img src="//developer.ibm.com/piwik/piwik.php?idsite=7" style="border:0;" alt="" /&gt;&lt;/p&gt;</noscript>
<!-- End Piwik Code -->
<!-- SCRIPTS_INCLUDE_END -->



<div id="ibm-overlay-backdrop"></div><div class="ibm-common-overlay ibm-overlay-alt-three" id="ibm-overlaywidget-N10050" role="dialog" aria-describedby="ibm-overlaywidget-N10050-content" aria-label="Overlay content" data-widget="overlay container" data-name=""><div class="ibm-overlay-heading-con"><p class="ibm-icononly"><a href="javascript:void(0);" class="ibm-close-link" role="button">关闭</a></p></div><div id="ibm-overlaywidget-N10050-content" class="content"><div class="" data-widget="overlay" id="N10050"><img alt="图 1. JVMTI 架构模型" src="./基于 JVMTI 实现 Java 线程的监控_files/image001.jpg" width="298"></div></div></div><div class="ibm-common-overlay ibm-overlay-alt-three" id="ibm-overlaywidget-N10066" role="dialog" aria-describedby="ibm-overlaywidget-N10066-content" aria-label="Overlay content" data-widget="overlay container" data-name=""><div class="ibm-overlay-heading-con"><p class="ibm-icononly"><a href="javascript:void(0);" class="ibm-close-link" role="button">关闭</a></p></div><div id="ibm-overlaywidget-N10066-content" class="content"><div class="" data-widget="overlay" id="N10066"><img alt="图 2. Java 线程模型" src="./基于 JVMTI 实现 Java 线程的监控_files/image002.gif" width="556"></div></div></div><div class="ibm-common-overlay ibm-overlay-alt-three" id="ibm-overlaywidget-N1009D" role="dialog" aria-describedby="ibm-overlaywidget-N1009D-content" aria-label="Overlay content" data-widget="overlay container" data-name=""><div class="ibm-overlay-heading-con"><p class="ibm-icononly"><a href="javascript:void(0);" class="ibm-close-link" role="button">关闭</a></p></div><div id="ibm-overlaywidget-N1009D-content" class="content"><div class="" data-widget="overlay" id="N1009D"><img alt="图 3. Java 线程监控模型" src="./基于 JVMTI 实现 Java 线程的监控_files/image003.gif" width="436"></div></div></div><div class="ibm-common-overlay ibm-overlay-alt-three" id="ibm-overlaywidget-N100E5" role="dialog" aria-describedby="ibm-overlaywidget-N100E5-content" aria-label="Overlay content" data-widget="overlay container" data-name=""><div class="ibm-overlay-heading-con"><p class="ibm-icononly"><a href="javascript:void(0);" class="ibm-close-link" role="button">关闭</a></p></div><div id="ibm-overlaywidget-N100E5-content" class="content"><div class="" data-widget="overlay" id="N100E5"><img alt="图 4. Java 线程的同步机制" src="./基于 JVMTI 实现 Java 线程的监控_files/image004.gif" width="518"></div></div></div><div id="ibm-mobilemenu-screen"></div><iframe id="LOTCCFrameWed Jul 19 2017 17:59:28 GMT+0800 (CST)" src="./基于 JVMTI 实现 Java 线程的监控_files/rt=ifr.html" title="empty" tabindex="-1" role="presentation" style="border: 0px; width: 0px; height: 0px; display: block;"></iframe><div id="ttdUniversalPixelTag14a49df88763436db0795df4fc90e6a7" style="display:none"><iframe id="universal_pixel" allowtransparency="true" height="0" width="0" style="visibility:hidden;" src="./基于 JVMTI 实现 Java 线程的监控_files/up.html"></iframe></div><div id="ttdUniversalPixelTagaf477d928c164ae0b8f3e1717b910617" style="display:none"><iframe id="universal_pixel" allowtransparency="true" height="0" width="0" style="visibility:hidden;" src="./基于 JVMTI 实现 Java 线程的监控_files/up(1).html"></iframe></div><script type="text/javascript" src="./基于 JVMTI 实现 Java 线程的监控_files/Serving" async=""></script><script src="./基于 JVMTI 实现 Java 线程的监控_files/js(1)" id="mm_pp_background"></script></body></html>