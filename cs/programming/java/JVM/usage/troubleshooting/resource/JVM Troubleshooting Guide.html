
<!-- saved from url=(0165)http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&cd=31&hl=en&ct=clnk -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style>body{margin-left:0;margin-right:0;margin-top:0}#bN015htcoyT__google-cache-hdr{background:#f5f5f5;font:13px arial,sans-serif;text-align:left;color:#202020;border:0;margin:0;border-bottom:1px solid #cecece;line-height:16px;padding:16px 28px 24px 28px}#bN015htcoyT__google-cache-hdr *{display:inline;font:inherit;text-align:inherit;color:inherit;line-height:inherit;background:none;border:0;margin:0;padding:0;letter-spacing:0}#bN015htcoyT__google-cache-hdr a{text-decoration:none;color:#1a0dab}#bN015htcoyT__google-cache-hdr a:hover{text-decoration:underline}#bN015htcoyT__google-cache-hdr a:visited{color:#609}#bN015htcoyT__google-cache-hdr div{display:block;margin-top:4px}#bN015htcoyT__google-cache-hdr b{font-weight:bold;display:inline-block;direction:ltr}</style></head><body bgcolor="#ffffff" vlink="blue" link="blue"><div id="bN015htcoyT__google-cache-hdr"><div><span>This is the html version of the file <a href="http://enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf">http://enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf</a>. Google automatically generates html versions of documents as we crawl the web.</span></div><span style="display:inline-block;margin-top:8px;color:#717171"><span>Tip: To quickly find your search term on this page, press <b>Ctrl+F</b> or <b>⌘-F</b> (Mac) and use the find bar.</span></span></div><div style="position:relative;">


<meta name="Creator" content="Writer">
<meta name="Producer" content="OpenOffice.org 3.4.1">
<meta name="CreationDate" content="D:20130529004454+03&#39;00&#39;">
<title>JVM Troubleshooting Guide</title>

<table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="1"><b>Page 1</b></a></font></td></tr></tbody></table><font size="5" face="Times"><span style="font-size:34px;font-family:Times">
<div style="position:absolute;top:197;left:145"><nobr><i>Troubleshoot the JVM like never before</i></nobr></div>
</span></font>
<font size="9" color="#000000" face="Times"><span style="font-size:70px;font-family:Times;color:#000000">
<div style="position:absolute;top:841;left:141"><nobr>JVM Troubleshooting</nobr></div>
<div style="position:absolute;top:923;left:371"><nobr>Guide</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:25px;font-family:Times">
<div style="position:absolute;top:1173;left:482"><nobr><i>Pierre-Hugues Charbonneau</i></nobr></div>
<div style="position:absolute;top:1204;left:675"><nobr><i>Ilias Tsagklis</i></nobr></div>
</span></font>

<div style="position:absolute;top:1363;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="2"><b>Page 2</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:1449;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:1452;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:1497;left:85"><nobr><b>Table of Contents</b></nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:1524;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#3">Oracle HotSpot JVM Memory...................................................................................................................3 </a></nobr></div>
<div style="position:absolute;top:1545;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#3">Java HotSpot VM Heap space...............................................................................................................3 </a></nobr></div>
<div style="position:absolute;top:1566;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#4">Java HotSpot VM PermGen space........................................................................................................4 </a></nobr></div>
<div style="position:absolute;top:1586;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#6">IBM JVM Memory....................................................................................................................................6 </a></nobr></div>
<div style="position:absolute;top:1607;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#7">Oracle JRockit JVM Memory....................................................................................................................7 </a></nobr></div>
<div style="position:absolute;top:1628;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#8">Tips for proper Java Heap size...................................................................................................................8 </a></nobr></div>
<div style="position:absolute;top:1648;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#14">Java Threading: JVM Retained memory analysis....................................................................................14 </a></nobr></div>
<div style="position:absolute;top:1669;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#21">Java 8: From PermGen to Metaspace.......................................................................................................21 </a></nobr></div>
<div style="position:absolute;top:1690;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#26">HPROF - Memory leak analysis with Eclipse Memory Analyzer Tool (MAT).......................................26 </a></nobr></div>
<div style="position:absolute;top:1710;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#33">JVM verbose GC output tutorial..............................................................................................................33 </a></nobr></div>
<div style="position:absolute;top:1731;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#40">Analyzing thread dumps..........................................................................................................................40 </a></nobr></div>
<div style="position:absolute;top:1752;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#40">Introduction to thread dump analysis..................................................................................................40 </a></nobr></div>
<div style="position:absolute;top:1773;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#47">Thread Dump: Thread Stack Trace analysis........................................................................................47 </a></nobr></div>
<div style="position:absolute;top:1793;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#49">Java Thread CPU analysis on Windows...................................................................................................49 </a></nobr></div>
<div style="position:absolute;top:1814;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#54">Case Study - Too many open files............................................................................................................54 </a></nobr></div>
<div style="position:absolute;top:1835;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#58">GC overhead limit exceeded – Analysis and Patterns..............................................................................58 </a></nobr></div>
<div style="position:absolute;top:1855;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#69">Java deadlock troubleshooting and analysis............................................................................................69 </a></nobr></div>
<div style="position:absolute;top:1876;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#73">Java Thread deadlock - Case Study.........................................................................................................73 </a></nobr></div>
<div style="position:absolute;top:1897;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#79">Java concurrency: the hidden thread deadlocks.......................................................................................79 </a></nobr></div>
<div style="position:absolute;top:1917;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#85">OutOfMemoryError patterns....................................................................................................................85 </a></nobr></div>
<div style="position:absolute;top:1938;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#86">OutOfMemoryError: Java heap space - what is it?.............................................................................86 </a></nobr></div>
<div style="position:absolute;top:1959;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#87">OutOfMemoryError: Out of swap space - Problem Patterns..............................................................87 </a></nobr></div>
<div style="position:absolute;top:1980;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#89">OutOfMemoryError: unable to create new native thread....................................................................89 </a></nobr></div>
<div style="position:absolute;top:2000;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#93">ClassNotFoundException: How to resolve..............................................................................................93 </a></nobr></div>
<div style="position:absolute;top:2021;left:85"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#99">NoClassDefFoundError Problem patterns...............................................................................................99 </a></nobr></div>
<div style="position:absolute;top:2042;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#103">NoClassDefFoundError – How to resolve........................................................................................103 </a></nobr></div>
<div style="position:absolute;top:2062;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#105">NoClassDefFoundError problem case 1 - missing JAR file.............................................................105 </a></nobr></div>
<div style="position:absolute;top:2083;left:107"><nobr><a href="http://webcache.googleusercontent.com/search?q=cache:1ZGFrRWsn8UJ:enos.itcollege.ee/~jpoial/allalaadimised/reading/JVM_Troubleshooting_Guide.pdf+&amp;cd=31&amp;hl=en&amp;ct=clnk#113">NoClassDefFoundError problem case 2 - static initializer failure....................................................113 </a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:2446;left:773"><nobr>2 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:2551;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="3"><b>Page 3</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:2637;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:2640;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:2703;left:85"><nobr><b>Oracle HotSpot JVM Memory</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:2757;left:85"><nobr><i><b>Java HotSpot VM Heap space</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:2809;left:85"><nobr>This section will provide you with a high level overview of the different Java Heap memory spaces of</nobr></div>
<div style="position:absolute;top:2828;left:85"><nobr>the Oracle Java HotSpot VM. This understanding is quite important for any individual involved in</nobr></div>
<div style="position:absolute;top:2847;left:85"><nobr>production support given how frequent memory problems are observed. Proper knowledge of the Java</nobr></div>
<div style="position:absolute;top:2866;left:85"><nobr>VM Heap Space is critical.</nobr></div>
<div style="position:absolute;top:2904;left:85"><nobr>Your Java VM is basically the foundation of your Java program which provides you with dynamic</nobr></div>
<div style="position:absolute;top:2923;left:85"><nobr>memory management services, garbage collection, Threads, IO and native operations and more.</nobr></div>
<div style="position:absolute;top:2961;left:85"><nobr>The Java Heap Space is the memory "container" of you runtime Java program which provides to your</nobr></div>
<div style="position:absolute;top:2980;left:85"><nobr>Java program the proper memory spaces it needs (Java Heap, Native Heap) and managed by the</nobr></div>
<div style="position:absolute;top:2999;left:85"><nobr>JVM itself.</nobr></div>
<div style="position:absolute;top:3037;left:89"><nobr>The JVM HotSpot memory is split between 3 memory spaces:</nobr></div>
<div style="position:absolute;top:3059;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:3057;left:139"><nobr>The Java Heap</nobr></div>
<div style="position:absolute;top:3080;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:3078;left:139"><nobr>The PermGen (permanent generation) space</nobr></div>
<div style="position:absolute;top:3100;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:3099;left:139"><nobr>The Native Heap (C-Heap)</nobr></div>
<div style="position:absolute;top:3137;left:85"><nobr>Here is the breakdown for each one of them:</nobr></div>
<div style="position:absolute;top:3179;left:120"><nobr><b>Memory Space</b></nobr></div>
<div style="position:absolute;top:3179;left:290"><nobr><b>Start-up arguments</b></nobr></div>
<div style="position:absolute;top:3198;left:324"><nobr><b>and tuning</b></nobr></div>
<div style="position:absolute;top:3179;left:469"><nobr><b>Monitoring strategies</b></nobr></div>
<div style="position:absolute;top:3179;left:694"><nobr><b>Description</b></nobr></div>
<div style="position:absolute;top:3225;left:89"><nobr>Java Heap</nobr></div>
<div style="position:absolute;top:3225;left:276"><nobr>-Xmx (maximum Heap</nobr></div>
<div style="position:absolute;top:3244;left:276"><nobr>space)</nobr></div>
<div style="position:absolute;top:3282;left:276"><nobr>-Xms (minimum Heap</nobr></div>
<div style="position:absolute;top:3301;left:276"><nobr>size)</nobr></div>
<div style="position:absolute;top:3339;left:276"><nobr>EX:</nobr></div>
<div style="position:absolute;top:3358;left:276"><nobr>-Xmx1024m</nobr></div>
<div style="position:absolute;top:3377;left:276"><nobr>-Xms1024m</nobr></div>
<div style="position:absolute;top:3225;left:463"><nobr>- verbose GC</nobr></div>
<div style="position:absolute;top:3244;left:463"><nobr>- JMX API</nobr></div>
<div style="position:absolute;top:3263;left:463"><nobr>- JConsole</nobr></div>
<div style="position:absolute;top:3282;left:463"><nobr>- Other monitoring tools</nobr></div>
<div style="position:absolute;top:3225;left:650"><nobr>The Java Heap is</nobr></div>
<div style="position:absolute;top:3244;left:650"><nobr>storing your primary</nobr></div>
<div style="position:absolute;top:3263;left:650"><nobr>Java program Class</nobr></div>
<div style="position:absolute;top:3282;left:650"><nobr>instances.</nobr></div>
<div style="position:absolute;top:3404;left:89"><nobr>PermGen</nobr></div>
<div style="position:absolute;top:3404;left:276"><nobr>-XX:MaxPermSize</nobr></div>
<div style="position:absolute;top:3423;left:276"><nobr>(maximum size)</nobr></div>
<div style="position:absolute;top:3461;left:276"><nobr>-XX:PermSize</nobr></div>
<div style="position:absolute;top:3480;left:276"><nobr>(minimum size)</nobr></div>
<div style="position:absolute;top:3537;left:276"><nobr>EX:</nobr></div>
<div style="position:absolute;top:3556;left:276"><nobr>-</nobr></div>
<div style="position:absolute;top:3575;left:276"><nobr>XX:MaxPermSize=512</nobr></div>
<div style="position:absolute;top:3404;left:463"><nobr>- verbose GC</nobr></div>
<div style="position:absolute;top:3423;left:463"><nobr>- JMX API</nobr></div>
<div style="position:absolute;top:3442;left:463"><nobr>- JConsole</nobr></div>
<div style="position:absolute;top:3461;left:463"><nobr>- Other monitoring tools</nobr></div>
<div style="position:absolute;top:3404;left:650"><nobr>The Java HotSpot VM</nobr></div>
<div style="position:absolute;top:3423;left:650"><nobr>permanent generation</nobr></div>
<div style="position:absolute;top:3442;left:650"><nobr>space is the JVM</nobr></div>
<div style="position:absolute;top:3461;left:650"><nobr>storage used mainly to</nobr></div>
<div style="position:absolute;top:3480;left:650"><nobr>store your Java Class</nobr></div>
<div style="position:absolute;top:3499;left:650"><nobr>objects such as names</nobr></div>
<div style="position:absolute;top:3518;left:650"><nobr>and method of the</nobr></div>
<div style="position:absolute;top:3537;left:650"><nobr>Classes, internal JVM</nobr></div>
<div style="position:absolute;top:3556;left:650"><nobr>objects and other JIT</nobr></div>
<div style="position:absolute;top:3575;left:650"><nobr>optimization related</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:3634;left:773"><nobr>3 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:3739;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="4"><b>Page 4</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:3825;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:3828;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:3876;left:276"><nobr>m</nobr></div>
<div style="position:absolute;top:3895;left:276"><nobr>-XX:PermSize=256m</nobr></div>
<div style="position:absolute;top:3876;left:650"><nobr>data.</nobr></div>
<div style="position:absolute;top:3923;left:89"><nobr>Native Heap</nobr></div>
<div style="position:absolute;top:3942;left:89"><nobr>(C-Heap)</nobr></div>
<div style="position:absolute;top:3923;left:276"><nobr>Not configurable</nobr></div>
<div style="position:absolute;top:3942;left:276"><nobr>directly.</nobr></div>
<div style="position:absolute;top:3980;left:276"><nobr>For a 32-bit VM, the C-</nobr></div>
<div style="position:absolute;top:3999;left:276"><nobr>Heap capacity = 4 Gig –</nobr></div>
<div style="position:absolute;top:4018;left:276"><nobr>Java Heap - PermGen</nobr></div>
<div style="position:absolute;top:4056;left:276"><nobr>For a 64-bit VM, the C-</nobr></div>
<div style="position:absolute;top:4074;left:276"><nobr>Heap capacity =</nobr></div>
<div style="position:absolute;top:4094;left:276"><nobr>Physical server total</nobr></div>
<div style="position:absolute;top:4112;left:276"><nobr>RAM &amp; virtual memory</nobr></div>
<div style="position:absolute;top:4131;left:276"><nobr>– Java Heap - PermGen</nobr></div>
<div style="position:absolute;top:3923;left:463"><nobr>- Total process size</nobr></div>
<div style="position:absolute;top:3942;left:463"><nobr>check in Windows and</nobr></div>
<div style="position:absolute;top:3961;left:463"><nobr>Linux</nobr></div>
<div style="position:absolute;top:3980;left:463"><nobr>- pmap command on</nobr></div>
<div style="position:absolute;top:3999;left:463"><nobr>Solaris &amp; Linux</nobr></div>
<div style="position:absolute;top:4018;left:463"><nobr>- svmon command on</nobr></div>
<div style="position:absolute;top:4037;left:463"><nobr>AIX</nobr></div>
<div style="position:absolute;top:3923;left:650"><nobr>The C-Heap is storing</nobr></div>
<div style="position:absolute;top:3942;left:650"><nobr>objects such as MMAP</nobr></div>
<div style="position:absolute;top:3961;left:650"><nobr>file, other JVM and third</nobr></div>
<div style="position:absolute;top:3980;left:650"><nobr>party native code</nobr></div>
<div style="position:absolute;top:3999;left:650"><nobr>objects.</nobr></div>
<div style="position:absolute;top:4174;left:85"><nobr>Java Heap Space - Overview &amp; life cycle</nobr></div>
<div style="position:absolute;top:4212;left:89"><nobr>Your Java program life cycle typically looks like this:</nobr></div>
<div style="position:absolute;top:4253;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:4251;left:139"><nobr>Java program coding (via Eclipse IDE etc.) e.g. HelloWorld.java</nobr></div>
<div style="position:absolute;top:4273;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:4272;left:139"><nobr>Java program compilation (Java compiler or third party build tools such as Apache Ant, Apache</nobr></div>
<div style="position:absolute;top:4291;left:139"><nobr>Maven..) e.g. HelloWord.class</nobr></div>
<div style="position:absolute;top:4313;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:4311;left:139"><nobr>Java program start-up and runtime execution e.g. via your HelloWorld.main() method</nobr></div>
<div style="position:absolute;top:4349;left:85"><nobr>Now let's dissect your HelloWorld.class program so you can better understand.</nobr></div>
<div style="position:absolute;top:4390;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:4389;left:139"><nobr>At start-up, your JVM will load and cache some of your static program and JDK libraries to the</nobr></div>
<div style="position:absolute;top:4408;left:139"><nobr>Native Heap, including native libraries, Mapped Files such as your program Jar file(s), Threads</nobr></div>
<div style="position:absolute;top:4427;left:139"><nobr>such as the main start-up Thread of your program etc.</nobr></div>
<div style="position:absolute;top:4449;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:4447;left:139"><nobr>Your JVM will then store the "static" data of your HelloWorld.class Java program to the</nobr></div>
<div style="position:absolute;top:4466;left:139"><nobr>PermGen space (Class metadata, descriptors, etc.).</nobr></div>
<div style="position:absolute;top:4488;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:4487;left:139"><nobr>Once your program is started, the JVM will then manage and dynamically allocate the memory</nobr></div>
<div style="position:absolute;top:4506;left:139"><nobr>of your Java program to the Java Heap (YoungGen &amp; OldGen). This is why it is so important</nobr></div>
<div style="position:absolute;top:4525;left:139"><nobr>that you understand how much memory your Java program needs to you can properly fine-</nobr></div>
<div style="position:absolute;top:4544;left:139"><nobr>tuned the capacity of your Java Heap controlled via -Xms &amp; -Xmx JVM parameters. Profiling,</nobr></div>
<div style="position:absolute;top:4563;left:139"><nobr>Heap Dump analysis allow you to determine your Java program memory footprint.</nobr></div>
<div style="position:absolute;top:4585;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:4583;left:139"><nobr>Finally, the JVM has to also dynamically release the memory from the Java Heap Space that</nobr></div>
<div style="position:absolute;top:4602;left:139"><nobr>your program no longer need; this is called the garbage collection process. This process can</nobr></div>
<div style="position:absolute;top:4621;left:139"><nobr>be easily monitored via the JVM verbose GC or a monitoring tool of your choice such as</nobr></div>
<div style="position:absolute;top:4640;left:139"><nobr>Jconsole.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:4696;left:85"><nobr><i><b>Java HotSpot VM PermGen space</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:4748;left:85"><nobr>The Java HotSpot VM permanent generation space is the JVM storage used mainly to store your Java</nobr></div>
<div style="position:absolute;top:4767;left:85"><nobr>Class objects.  The Java Heap is the primary storage that is storing the actual short and long term</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:4822;left:773"><nobr>4 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:4927;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="5"><b>Page 5</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:5013;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:5016;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:5060;left:85"><nobr>instances of your PermGen Class objects.</nobr></div>
<div style="position:absolute;top:5098;left:85"><nobr>The PermGen space is fairly static by nature unless using third party tool and/or Java Reflection API</nobr></div>
<div style="position:absolute;top:5117;left:85"><nobr>which relies heavily on dynamic class loading.</nobr></div>
<div style="position:absolute;top:5155;left:85"><nobr>It is important to note that this memory storage is applicable only for a Java HotSpot VM; other JVM</nobr></div>
<div style="position:absolute;top:5174;left:85"><nobr>vendors such as IBM and Oracle JRockit do not have such fixed and configurable PermGen storage</nobr></div>
<div style="position:absolute;top:5193;left:85"><nobr>and are using other techniques to manage the non Java Heap memory (native memory).</nobr></div>
<div style="position:absolute;top:5231;left:85"><nobr>Find below a graphical view of a JVM HotSpot Java Heap vs. PermGen space breakdown along with</nobr></div>
<div style="position:absolute;top:5250;left:85"><nobr>its associated attributes and capacity tuning arguments.</nobr></div>
<div style="position:absolute;top:5928;left:85"><nobr>Apart from the Oracle HotSpot JVM, there are other virtual machines provided by differented vendors.</nobr></div>
<div style="position:absolute;top:5947;left:85"><nobr>The following sections examine the memory configurations used by other JVMs. Understanding those</nobr></div>
<div style="position:absolute;top:5966;left:85"><nobr>is quite important given the implementation and naming convention differences between HotSpot and</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:6010;left:773"><nobr>5 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:6115;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="6"><b>Page 6</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:6201;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:6204;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:6248;left:85"><nobr>the other JVMs.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:6304;left:85"><nobr><b>IBM JVM Memory</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:6360;left:85"><nobr>The IBM VM memory is split between 2 memory spaces:</nobr></div>
<div style="position:absolute;top:6401;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:6399;left:139"><nobr>The Java Heap (nursery and tenured spaces)</nobr></div>
<div style="position:absolute;top:6422;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:6420;left:139"><nobr>The Native Heap (C-Heap)</nobr></div>
<div style="position:absolute;top:6458;left:85"><nobr>Here is the breakdown for each one of them:</nobr></div>
<div style="position:absolute;top:6500;left:120"><nobr><b>Memory Space</b></nobr></div>
<div style="position:absolute;top:6500;left:290"><nobr><b>Start-up arguments</b></nobr></div>
<div style="position:absolute;top:6519;left:324"><nobr><b>and tuning</b></nobr></div>
<div style="position:absolute;top:6500;left:469"><nobr><b>Monitoring strategies</b></nobr></div>
<div style="position:absolute;top:6500;left:694"><nobr><b>Description</b></nobr></div>
<div style="position:absolute;top:6546;left:89"><nobr>Java Heap</nobr></div>
<div style="position:absolute;top:6546;left:276"><nobr>-Xmx (maximum Heap</nobr></div>
<div style="position:absolute;top:6565;left:276"><nobr>space)</nobr></div>
<div style="position:absolute;top:6603;left:276"><nobr>-Xms (minimum Heap</nobr></div>
<div style="position:absolute;top:6622;left:276"><nobr>size)- verbose GC</nobr></div>
<div style="position:absolute;top:6641;left:276"><nobr>- JMX API</nobr></div>
<div style="position:absolute;top:6660;left:276"><nobr>- IBM monitoring tools</nobr></div>
<div style="position:absolute;top:6717;left:276"><nobr>EX:</nobr></div>
<div style="position:absolute;top:6736;left:276"><nobr>-Xmx1024m</nobr></div>
<div style="position:absolute;top:6755;left:276"><nobr>-Xms1024m</nobr></div>
<div style="position:absolute;top:6793;left:276"><nobr>GC policy Ex:</nobr></div>
<div style="position:absolute;top:6812;left:276"><nobr>-Xgcpolicy:gencon</nobr></div>
<div style="position:absolute;top:6831;left:276"><nobr>(enable gencon GC</nobr></div>
<div style="position:absolute;top:6850;left:276"><nobr>policy)</nobr></div>
<div style="position:absolute;top:6546;left:463"><nobr>- verbose GC</nobr></div>
<div style="position:absolute;top:6565;left:463"><nobr>- JMX API</nobr></div>
<div style="position:absolute;top:6584;left:463"><nobr>- IBM monitoring tools</nobr></div>
<div style="position:absolute;top:6546;left:650"><nobr>The IBM Java Heap is</nobr></div>
<div style="position:absolute;top:6565;left:650"><nobr>typically split between</nobr></div>
<div style="position:absolute;top:6584;left:650"><nobr>the nursery and tenured</nobr></div>
<div style="position:absolute;top:6603;left:650"><nobr>space (YoungGen,</nobr></div>
<div style="position:absolute;top:6622;left:650"><nobr>OldGen).</nobr></div>
<div style="position:absolute;top:6660;left:650"><nobr>The gencon GC policy</nobr></div>
<div style="position:absolute;top:6679;left:650"><nobr>(combo of concurrent</nobr></div>
<div style="position:absolute;top:6698;left:650"><nobr>and generational GC) is</nobr></div>
<div style="position:absolute;top:6717;left:650"><nobr>typically used for Java</nobr></div>
<div style="position:absolute;top:6736;left:650"><nobr>EE platforms in order to</nobr></div>
<div style="position:absolute;top:6755;left:650"><nobr>minimize the GC pause</nobr></div>
<div style="position:absolute;top:6774;left:650"><nobr>time.</nobr></div>
<div style="position:absolute;top:6877;left:89"><nobr>Native Heap</nobr></div>
<div style="position:absolute;top:6896;left:89"><nobr>(C-Heap)</nobr></div>
<div style="position:absolute;top:6877;left:276"><nobr>Not configurable</nobr></div>
<div style="position:absolute;top:6896;left:276"><nobr>directly.</nobr></div>
<div style="position:absolute;top:6934;left:276"><nobr>For a 32-bit VM, the C-</nobr></div>
<div style="position:absolute;top:6953;left:276"><nobr>Heap capacity = 4 Gig –</nobr></div>
<div style="position:absolute;top:6972;left:276"><nobr>Java Heap</nobr></div>
<div style="position:absolute;top:7010;left:276"><nobr>For a 64-bit VM, the C-</nobr></div>
<div style="position:absolute;top:7029;left:276"><nobr>Heap capacity =</nobr></div>
<div style="position:absolute;top:7048;left:276"><nobr>Physical server total</nobr></div>
<div style="position:absolute;top:7067;left:276"><nobr>RAM &amp; virtual memory</nobr></div>
<div style="position:absolute;top:7086;left:276"><nobr>– Java Heap</nobr></div>
<div style="position:absolute;top:6877;left:463"><nobr>- svmon command</nobr></div>
<div style="position:absolute;top:6877;left:650"><nobr>The C-Heap is storing</nobr></div>
<div style="position:absolute;top:6896;left:650"><nobr>class metadata objects</nobr></div>
<div style="position:absolute;top:6915;left:650"><nobr>including library files,</nobr></div>
<div style="position:absolute;top:6934;left:650"><nobr>other JVM and third</nobr></div>
<div style="position:absolute;top:6953;left:650"><nobr>party native code</nobr></div>
<div style="position:absolute;top:6972;left:650"><nobr>objects.</nobr></div>
<div style="position:absolute;top:7128;left:85"><nobr>As you might noticed, there is no PermGen space for the IBM VM. The PermGen space is only</nobr></div>
<div style="position:absolute;top:7147;left:85"><nobr>applicable to the HotSpot VM. The IBM VM is using the Native Heap for Class metadata related data.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:7198;left:773"><nobr>6 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:7303;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="7"><b>Page 7</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:7389;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:7392;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:7436;left:85"><nobr>Also note that Oracle is also starting to remove the PermGen space for the HotSpot VM, as we will</nobr></div>
<div style="position:absolute;top:7455;left:85"><nobr>discuss in a next section.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:7512;left:85"><nobr><b>Oracle JRockit JVM Memory</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:7567;left:85"><nobr>The JRockit VM memory is split between 2 memory spaces:</nobr></div>
<div style="position:absolute;top:7608;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:7607;left:139"><nobr>The Java Heap (YoungGen and OldGen)</nobr></div>
<div style="position:absolute;top:7629;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:7627;left:139"><nobr>The Native memory space (Classes pool, C-Heap, Threads...)</nobr></div>
<div style="position:absolute;top:7669;left:120"><nobr><b>Memory Space</b></nobr></div>
<div style="position:absolute;top:7669;left:290"><nobr><b>Start-up arguments</b></nobr></div>
<div style="position:absolute;top:7688;left:324"><nobr><b>and tuning</b></nobr></div>
<div style="position:absolute;top:7669;left:469"><nobr><b>Monitoring strategies</b></nobr></div>
<div style="position:absolute;top:7669;left:694"><nobr><b>Description</b></nobr></div>
<div style="position:absolute;top:7715;left:89"><nobr>Java Heap</nobr></div>
<div style="position:absolute;top:7715;left:276"><nobr>-Xmx (maximum Heap</nobr></div>
<div style="position:absolute;top:7734;left:276"><nobr>space)</nobr></div>
<div style="position:absolute;top:7772;left:276"><nobr>-Xms (minimum Heap</nobr></div>
<div style="position:absolute;top:7791;left:276"><nobr>size)</nobr></div>
<div style="position:absolute;top:7829;left:276"><nobr>EX:</nobr></div>
<div style="position:absolute;top:7848;left:276"><nobr>-Xmx1024m</nobr></div>
<div style="position:absolute;top:7867;left:276"><nobr>-Xms1024m</nobr></div>
<div style="position:absolute;top:7715;left:463"><nobr>- verbose GC</nobr></div>
<div style="position:absolute;top:7734;left:463"><nobr>- JMX API</nobr></div>
<div style="position:absolute;top:7753;left:463"><nobr>- JRockit Mission</nobr></div>
<div style="position:absolute;top:7772;left:463"><nobr>Control tools suite</nobr></div>
<div style="position:absolute;top:7715;left:650"><nobr>The JRockit Java Heap</nobr></div>
<div style="position:absolute;top:7734;left:650"><nobr>is typically split between</nobr></div>
<div style="position:absolute;top:7753;left:650"><nobr>the YoungGen (short-</nobr></div>
<div style="position:absolute;top:7772;left:650"><nobr>lived objects), OldGen</nobr></div>
<div style="position:absolute;top:7791;left:650"><nobr>(long-lived objects).</nobr></div>
<div style="position:absolute;top:7914;left:89"><nobr>Native memory space</nobr></div>
<div style="position:absolute;top:7914;left:276"><nobr>Not configurable</nobr></div>
<div style="position:absolute;top:7932;left:276"><nobr>directly.</nobr></div>
<div style="position:absolute;top:7970;left:276"><nobr>For a 32-bit VM, the</nobr></div>
<div style="position:absolute;top:7989;left:276"><nobr>native memory space</nobr></div>
<div style="position:absolute;top:8008;left:276"><nobr>capacity = 2-4 Gig –</nobr></div>
<div style="position:absolute;top:8027;left:276"><nobr>Java Heap</nobr></div>
<div style="position:absolute;top:8065;left:276"><nobr><i>** Process size limit of 2</i></nobr></div>
<div style="position:absolute;top:8084;left:276"><nobr><i>GB, 3 GB or 4 GB</i></nobr></div>
<div style="position:absolute;top:8103;left:276"><nobr><i>depending of your OS</i></nobr></div>
<div style="position:absolute;top:8122;left:276"><nobr><i>**</i></nobr></div>
<div style="position:absolute;top:8160;left:276"><nobr>For a 64-bit VM, the</nobr></div>
<div style="position:absolute;top:8179;left:276"><nobr>native memory space</nobr></div>
<div style="position:absolute;top:8198;left:276"><nobr>capacity = Physical</nobr></div>
<div style="position:absolute;top:8217;left:276"><nobr>server total RAM &amp;</nobr></div>
<div style="position:absolute;top:8236;left:276"><nobr>virtual memory – Java</nobr></div>
<div style="position:absolute;top:8255;left:276"><nobr>Heap</nobr></div>
<div style="position:absolute;top:7914;left:463"><nobr>- Total process size</nobr></div>
<div style="position:absolute;top:7932;left:463"><nobr>check in Windows and</nobr></div>
<div style="position:absolute;top:7952;left:463"><nobr>Linux</nobr></div>
<div style="position:absolute;top:7970;left:463"><nobr>- pmap command on</nobr></div>
<div style="position:absolute;top:7989;left:463"><nobr>Solaris &amp; Linux</nobr></div>
<div style="position:absolute;top:8008;left:463"><nobr>- JRockit JRCMD tool</nobr></div>
<div style="position:absolute;top:7914;left:650"><nobr>The JRockit Native</nobr></div>
<div style="position:absolute;top:7932;left:650"><nobr>memory space is</nobr></div>
<div style="position:absolute;top:7952;left:650"><nobr>storing the Java</nobr></div>
<div style="position:absolute;top:7970;left:650"><nobr>Classes metadata,</nobr></div>
<div style="position:absolute;top:7989;left:650"><nobr>Threads and objects</nobr></div>
<div style="position:absolute;top:8008;left:650"><nobr>such as library files,</nobr></div>
<div style="position:absolute;top:8027;left:650"><nobr>other JVM and third</nobr></div>
<div style="position:absolute;top:8046;left:650"><nobr>party native code</nobr></div>
<div style="position:absolute;top:8065;left:650"><nobr>objects.</nobr></div>
<div style="position:absolute;top:8297;left:85"><nobr>Similar to the IBM VM, there is no PermGen space for the JRockit VM. The PermGen space is only</nobr></div>
<div style="position:absolute;top:8316;left:85"><nobr>applicable to the HotSpot VM. The JRockit VM is using the Native Heap for Class metadata related</nobr></div>
<div style="position:absolute;top:8335;left:85"><nobr>data.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:8386;left:773"><nobr>7 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:8491;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="8"><b>Page 8</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:8577;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:8580;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:8643;left:85"><nobr>The JRockit VM tend to uses more native memory in exchange for better performance. JRockit does</nobr></div>
<div style="position:absolute;top:8662;left:85"><nobr>not have an interpretation mode, compilation only, so due to its additional native memory needs the</nobr></div>
<div style="position:absolute;top:8681;left:85"><nobr>process size tends to use a couple of hundred MB larger than the equivalent Sun JVM size. This</nobr></div>
<div style="position:absolute;top:8700;left:85"><nobr>should not be a big problem unless you are using a 32-bit JRockit with a large Java Heap requirement;</nobr></div>
<div style="position:absolute;top:8719;left:85"><nobr>in this scenario, the risk of OutOfMemoryError due to Native Heap depletion is higher for a JRockit VM</nobr></div>
<div style="position:absolute;top:8738;left:85"><nobr>(e.g. for a 32-bit VM, bigger is the Java Heap, smaller is memory left for the Native Heap).</nobr></div>
<div style="position:absolute;top:8776;left:85"><nobr>Oracle's strategy, being the vendor for both HotSpot and JRockit product lines, is to merge the two</nobr></div>
<div style="position:absolute;top:8795;left:85"><nobr>Vms to a single JVM project that will include the best features of each one. This will also simplify JVM</nobr></div>
<div style="position:absolute;top:8814;left:85"><nobr>tuning since right now failure to understand the differences between these 2 VM's can lead to bad</nobr></div>
<div style="position:absolute;top:8833;left:85"><nobr>tuning recommendations and performance problems.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:8889;left:85"><nobr><b>Tips for proper Java Heap size</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:8945;left:85"><nobr>Determination of proper Java Heap size for a production system is not a straightforward exercise.</nobr></div>
<div style="position:absolute;top:8964;left:85"><nobr>Multiple performance problem can occur due to inadequate Java Heap capacity and tuning. This</nobr></div>
<div style="position:absolute;top:8983;left:85"><nobr>section will provide some tips that can help you determine the optimal Java heap size, as a starting</nobr></div>
<div style="position:absolute;top:9002;left:85"><nobr>point, for your current or new production environment. Some of these tips are also very useful</nobr></div>
<div style="position:absolute;top:9021;left:85"><nobr>regarding the prevention and resolution of OutOfMemoryError problems, including memory leaks.</nobr></div>
<div style="position:absolute;top:9059;left:85"><nobr>Please note that these tips are intended to “help you” determine proper Java Heap size. Since each IT</nobr></div>
<div style="position:absolute;top:9078;left:85"><nobr>environment is unique, you are actually in the best position to determine precisely the required Java</nobr></div>
<div style="position:absolute;top:9096;left:85"><nobr>Heap specifications of your client’s environment.</nobr></div>
<div style="position:absolute;top:9134;left:85"><nobr>#1 - JVM: you always fear what you don't understand</nobr></div>
<div style="position:absolute;top:9172;left:85"><nobr>How can you expect to configure, tune and troubleshoot something that you don't understand? You</nobr></div>
<div style="position:absolute;top:9191;left:85"><nobr>may never have the chance to write and improve Java VM specifications but you are still free to learn</nobr></div>
<div style="position:absolute;top:9210;left:85"><nobr>its foundation in order to improve your knowledge and troubleshooting skills. Some may disagree, but</nobr></div>
<div style="position:absolute;top:9229;left:85"><nobr>from my perspective, the thinking that Java programmers are not required to know the internal JVM</nobr></div>
<div style="position:absolute;top:9248;left:85"><nobr>memory management is an illusion.</nobr></div>
<div style="position:absolute;top:9286;left:85"><nobr>Java Heap tuning and troubleshooting can especially be a challenge for Java &amp; Java EE beginners.</nobr></div>
<div style="position:absolute;top:9305;left:85"><nobr>Find below a typical scenario:</nobr></div>
<div style="position:absolute;top:9346;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:9345;left:139"><nobr>Your client production environment is facing OutOfMemoryError on a regular basis and causing</nobr></div>
<div style="position:absolute;top:9364;left:139"><nobr>lot of business impact. Your support team is under pressure to resolve this problem.</nobr></div>
<div style="position:absolute;top:9386;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:9384;left:139"><nobr>A quick Google search allows you to find examples of similar problems and you now believe</nobr></div>
<div style="position:absolute;top:9403;left:139"><nobr>(and assume) that you are facing the same problem.</nobr></div>
<div style="position:absolute;top:9426;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:9424;left:139"><nobr>You then grab JVM -Xms and -Xmx values from another person OutOfMemoryError problem</nobr></div>
<div style="position:absolute;top:9443;left:139"><nobr>case, hoping to quickly resolve your client's problem.</nobr></div>
<div style="position:absolute;top:9465;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:9463;left:139"><nobr>You then proceed and implement the same tuning to your environment. 2 days later you realize</nobr></div>
<div style="position:absolute;top:9482;left:139"><nobr>problem is still happening (even worse or little better)...the struggle continues...</nobr></div>
<div style="position:absolute;top:9520;left:85"><nobr>What went wrong?</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:9574;left:773"><nobr>8 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:9679;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="9"><b>Page 9</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:9765;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:9768;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:9835;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:9833;left:139"><nobr>You failed to first acquire proper understanding of the root cause of your problem.</nobr></div>
<div style="position:absolute;top:9855;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:9853;left:139"><nobr>You may also have failed to properly understand your production environment at a deeper level</nobr></div>
<div style="position:absolute;top:9872;left:139"><nobr>(specifications, load situation etc.). Web searches is a great way to learn and share knowledge</nobr></div>
<div style="position:absolute;top:9891;left:139"><nobr>but you have to perform your own due diligence and root cause analysis.</nobr></div>
<div style="position:absolute;top:9914;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:9912;left:139"><nobr>You may also be lacking some basic knowledge of the JVM and its internal memory</nobr></div>
<div style="position:absolute;top:9931;left:139"><nobr>management, preventing you to connect all the dots together.</nobr></div>
<div style="position:absolute;top:9969;left:85"><nobr>My #1 tip and recommendation to you is to learn and understand the basic JVM principles along with</nobr></div>
<div style="position:absolute;top:9988;left:85"><nobr>its different memory spaces. Such knowledge is critical as it will allow you to make valid</nobr></div>
<div style="position:absolute;top:10007;left:85"><nobr>recommendations to your clients and properly understand the possible impact and risk associated with</nobr></div>
<div style="position:absolute;top:10026;left:85"><nobr>future tuning considerations.</nobr></div>
<div style="position:absolute;top:10064;left:85"><nobr>As a reminder, the Java VM memory is split up to 3 memory spaces:</nobr></div>
<div style="position:absolute;top:10105;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:10103;left:139"><nobr>The Java Heap: Applicable for all JVM vendors, usually split between YoungGen (nursery) &amp;</nobr></div>
<div style="position:absolute;top:10122;left:139"><nobr>OldGen (tenured) spaces.</nobr></div>
<div style="position:absolute;top:10144;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:10143;left:139"><nobr>The PermGen (permanent generation): Applicable to the Sun HotSpot VM only (PermGen</nobr></div>
<div style="position:absolute;top:10162;left:139"><nobr>space will be removed in future Java updates)</nobr></div>
<div style="position:absolute;top:10184;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:10182;left:139"><nobr>The Native Heap (C-Heap): Applicable for all JVM vendors.</nobr></div>
<div style="position:absolute;top:10220;left:85"><nobr>As you can see, the Java VM memory management is more complex than just setting up the biggest</nobr></div>
<div style="position:absolute;top:10239;left:85"><nobr>value possible via –Xmx. You have to look at all angles, including your native and PermGen space</nobr></div>
<div style="position:absolute;top:10258;left:85"><nobr>requirement along with physical memory availability (and # of CPU cores) from your physical host(s).</nobr></div>
<div style="position:absolute;top:10298;left:85"><nobr>It can get especially tricky for 32-bit JVM since the Java Heap and native Heap are in a race. The</nobr></div>
<div style="position:absolute;top:10317;left:85"><nobr>bigger your Java Heap, the smaller the native Heap. Attempting to setup a large Heap for a 32-bit VM</nobr></div>
<div style="position:absolute;top:10336;left:85"><nobr>e.g .2.5 GB+ increases risk of native OutOfMemoryError depending of your application(s) footprint,</nobr></div>
<div style="position:absolute;top:10355;left:85"><nobr>number of Threads etc. 64-bit JVM resolves this problem but you are still limited to physical resources</nobr></div>
<div style="position:absolute;top:10374;left:85"><nobr>availability and garbage collection overhead (cost of major GC collections go up with size). The bottom</nobr></div>
<div style="position:absolute;top:10393;left:85"><nobr>line is that the bigger is not always the better so please do not assume that you can run all your 20</nobr></div>
<div style="position:absolute;top:10412;left:85"><nobr>Java EE applications on a single 16 GB 64-bit JVM process.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:10762;left:773"><nobr>9 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:10867;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="10"><b>Page 10</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:10953;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:10956;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:11537;left:85"><nobr>#2 - Data and application is king: review your static footprint requirement</nobr></div>
<div style="position:absolute;top:11575;left:85"><nobr>Your application(s) along with its associated data will dictate the Java Heap footprint requirement. By</nobr></div>
<div style="position:absolute;top:11594;left:85"><nobr>static memory, I mean "predictable" memory requirements as per below.</nobr></div>
<div style="position:absolute;top:11635;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:11633;left:139"><nobr>Determine how many different applications you are planning to deploy to a single JVM process</nobr></div>
<div style="position:absolute;top:11652;left:139"><nobr>e.g. number of EAR files, WAR files, jar files etc. The more applications you deploy to a single</nobr></div>
<div style="position:absolute;top:11671;left:139"><nobr>JVM, higher demand on native Heap.</nobr></div>
<div style="position:absolute;top:11693;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:11692;left:139"><nobr>Determine how many Java classes will be potentially loaded at runtime; including third part</nobr></div>
<div style="position:absolute;top:11711;left:139"><nobr>API's. The more class loaders and classes that you load at runtime, higher demand on the</nobr></div>
<div style="position:absolute;top:11730;left:139"><nobr>HotSpot VM PermGen space and internal JIT related optimization objects.</nobr></div>
<div style="position:absolute;top:11752;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:11750;left:139"><nobr>Determine data cache footprint e.g. internal cache data structures loaded by your application</nobr></div>
<div style="position:absolute;top:11769;left:139"><nobr>(and third party API's) such as cached data from a database, data read from a file etc. The</nobr></div>
<div style="position:absolute;top:11788;left:139"><nobr>more data caching that you use, higher demand on the Java Heap OldGen space.</nobr></div>
<div style="position:absolute;top:11810;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:11809;left:139"><nobr>Determine the number of Threads that your middleware is allowed to create. This is very</nobr></div>
<div style="position:absolute;top:11828;left:139"><nobr>important since Java threads require enough native memory or OutOfMemoryError will be</nobr></div>
<div style="position:absolute;top:11847;left:139"><nobr>thrown.</nobr></div>
<div style="position:absolute;top:11885;left:85"><nobr>For example, you will need much more native memory and PermGen space if you are planning to</nobr></div>
<div style="position:absolute;top:11903;left:85"><nobr>deploy 10 separate EAR applications on a single JVM process vs. only 2 or 3. Data caching not</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:11950;left:764"><nobr>10 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:12055;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="11"><b>Page 11</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:12141;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:12144;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:12188;left:85"><nobr>serialized to a disk or database will require extra memory from the OldGen space.</nobr></div>
<div style="position:absolute;top:12226;left:85"><nobr>Try to come up with reasonable estimates of the static memory footprint requirement. This will be very</nobr></div>
<div style="position:absolute;top:12245;left:85"><nobr>useful to setup some starting point JVM capacity figures before your true measurement exercise (e.g.</nobr></div>
<div style="position:absolute;top:12264;left:85"><nobr>tip #4). For 32-bit JVM, I usually do not recommend a Java Heap size high than 2 GB (-Xms2048m,</nobr></div>
<div style="position:absolute;top:12283;left:85"><nobr>-Xmx2048m) since you need enough memory for PermGen and native Heap for your Java EE</nobr></div>
<div style="position:absolute;top:12302;left:85"><nobr>applications and threads.</nobr></div>
<div style="position:absolute;top:12340;left:85"><nobr>This assessment is especially important since too many applications deployed in a single 32-bit JVM</nobr></div>
<div style="position:absolute;top:12359;left:85"><nobr>process can easily lead to native Heap depletion; especially in a multi threads environment.</nobr></div>
<div style="position:absolute;top:12397;left:85"><nobr>For a 64-bit JVM, a Java Heap size of 3 GB or 4 GB per JVM process is usually my recommended</nobr></div>
<div style="position:absolute;top:12416;left:85"><nobr>starting point.</nobr></div>
<div style="position:absolute;top:12454;left:85"><nobr>#3 - Business traffic set the rules: review your dynamic footprint requirement</nobr></div>
<div style="position:absolute;top:12492;left:85"><nobr>Your business traffic will typically dictate your dynamic memory footprint. Concurrent users &amp; requests</nobr></div>
<div style="position:absolute;top:12511;left:85"><nobr>generate the JVM GC "heartbeat" that you can observe from various monitoring tools due to very</nobr></div>
<div style="position:absolute;top:12530;left:85"><nobr>frequent creation and garbage collections of short &amp; long lived objects. As you saw from the above</nobr></div>
<div style="position:absolute;top:12549;left:85"><nobr>JVM diagram, a typical ratio of YoungGen vs. OldGen is 1:3 or 33%.</nobr></div>
<div style="position:absolute;top:12587;left:85"><nobr>For a typical 32-bit JVM, a Java Heap size setup at 2 GB (using generational &amp; concurrent collector)</nobr></div>
<div style="position:absolute;top:12606;left:85"><nobr>will typically allocate 500 MB for YoungGen space and 1.5 GB for the OldGen space.</nobr></div>
<div style="position:absolute;top:12644;left:85"><nobr>Minimizing the frequency of major GC collections is a key aspect for optimal performance so it is very</nobr></div>
<div style="position:absolute;top:12663;left:85"><nobr>important that you understand and estimate how much memory you need during your peak volume.</nobr></div>
<div style="position:absolute;top:12701;left:85"><nobr>Again, your type of application and data will dictate how much memory you need. Shopping cart type</nobr></div>
<div style="position:absolute;top:12720;left:85"><nobr>of applications (long lived objects) involving large and non-serialized session data typically need large</nobr></div>
<div style="position:absolute;top:12738;left:85"><nobr>Java Heap and lot of OldGen space. Stateless and XML processing heavy applications (lot of short</nobr></div>
<div style="position:absolute;top:12758;left:85"><nobr>lived objects) require proper YoungGen space in order to minimize frequency of major collections.</nobr></div>
<div style="position:absolute;top:12795;left:85"><nobr>Example:</nobr></div>
<div style="position:absolute;top:12837;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:12835;left:139"><nobr>You have 5 EAR applications (~2 thousands of Java classes) to deploy (which include</nobr></div>
<div style="position:absolute;top:12854;left:139"><nobr>middleware code as well...).</nobr></div>
<div style="position:absolute;top:12876;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:12875;left:139"><nobr>Your native heap requirement is estimated at 1 GB (has to be large enough to handle Threads</nobr></div>
<div style="position:absolute;top:12893;left:139"><nobr>creation etc.).</nobr></div>
<div style="position:absolute;top:12916;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:12914;left:139"><nobr>Your PermGen space is estimated at 512 MB.</nobr></div>
<div style="position:absolute;top:12936;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:12935;left:139"><nobr>Your internal static data caching is estimated at 500 MB.</nobr></div>
<div style="position:absolute;top:12957;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:12955;left:139"><nobr>Your total forecast traffic is 5000 concurrent users at peak hours.</nobr></div>
<div style="position:absolute;top:12977;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:12976;left:139"><nobr>Each user session data footprint is estimated at 500 K.</nobr></div>
<div style="position:absolute;top:12998;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:12996;left:139"><nobr>Total footprint requirement for session data alone is 2.5 GB under peak volume.</nobr></div>
<div style="position:absolute;top:13034;left:85"><nobr>As you can see, with such requirement, there is no way you can have all this traffic sent to a single</nobr></div>
<div style="position:absolute;top:13053;left:85"><nobr>JVM 32-bit process. A typical solution involves splitting (tip #5) traffic across a few JVM processes and</nobr></div>
<div style="position:absolute;top:13072;left:85"><nobr>/ or physical host (assuming you have enough hardware and CPU cores available).</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:13138;left:765"><nobr>11 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:13243;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="12"><b>Page 12</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:13329;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:13332;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:13376;left:85"><nobr>However, for this example, given the high demand on static memory and to ensure a scalable</nobr></div>
<div style="position:absolute;top:13395;left:85"><nobr>environment in the long run, I would also recommend 64-bit VM but with a smaller Java Heap as a</nobr></div>
<div style="position:absolute;top:13414;left:85"><nobr>starting point such as 3 GB to minimize the GC cost. You definitely want to have extra buffer for the</nobr></div>
<div style="position:absolute;top:13433;left:85"><nobr>OldGen space so I typically recommend up to 50% memory footprint post major collection in order to</nobr></div>
<div style="position:absolute;top:13452;left:85"><nobr>keep the frequency of Full GC low and enough buffer for fail-over scenarios.</nobr></div>
<div style="position:absolute;top:13490;left:85"><nobr>Most of the time, your business traffic will drive most of your memory footprint, unless you need</nobr></div>
<div style="position:absolute;top:13509;left:85"><nobr>significant amount of data caching to achieve proper performance which is typical for portal (media)</nobr></div>
<div style="position:absolute;top:13528;left:85"><nobr>heavy applications. Too much data caching should raise a yellow flag that you may need to revisit</nobr></div>
<div style="position:absolute;top:13547;left:85"><nobr>some design elements sooner than later.</nobr></div>
<div style="position:absolute;top:13585;left:85"><nobr>#4 - Don't guess it, measure it!</nobr></div>
<div style="position:absolute;top:13623;left:85"><nobr>At this point you should:</nobr></div>
<div style="position:absolute;top:13664;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:13662;left:139"><nobr>Understand the basic JVM principles and memory spaces</nobr></div>
<div style="position:absolute;top:13685;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:13683;left:139"><nobr>Have a deep view and understanding of all applications along with their characteristics (size,</nobr></div>
<div style="position:absolute;top:13702;left:139"><nobr>type, dynamic traffic, stateless vs. stateful objects, internal memory caches etc.)</nobr></div>
<div style="position:absolute;top:13724;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:13722;left:139"><nobr>Have a very good view or forecast on the business traffic (# of concurrent users etc.) and for</nobr></div>
<div style="position:absolute;top:13742;left:139"><nobr>each application</nobr></div>
<div style="position:absolute;top:13764;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:13762;left:139"><nobr>Some ideas if you need a 64-bit VM or not and which JVM settings to start with</nobr></div>
<div style="position:absolute;top:13784;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:13783;left:139"><nobr>Some ideas if you need more than one JVM (middleware) processes</nobr></div>
<div style="position:absolute;top:13821;left:85"><nobr>But wait, your work is not done yet. While this above information is crucial and great for you to come</nobr></div>
<div style="position:absolute;top:13839;left:85"><nobr>up with "best guess" Java Heap settings, it is always best and recommended to simulate your</nobr></div>
<div style="position:absolute;top:13859;left:85"><nobr>application(s) behaviour and validate the Java Heap memory requirement via proper profiling, load &amp;</nobr></div>
<div style="position:absolute;top:13877;left:85"><nobr>performance testing.</nobr></div>
<div style="position:absolute;top:13915;left:85"><nobr>You can learn and take advantage of tools such as JProfiler. From my perspective, learning how to</nobr></div>
<div style="position:absolute;top:13934;left:85"><nobr>use a profiler is the best way to properly understand your application memory footprint. Another</nobr></div>
<div style="position:absolute;top:13953;left:85"><nobr>approach I use for existing production environments is heap dump analysis using the Eclipse MAT</nobr></div>
<div style="position:absolute;top:13972;left:85"><nobr>tool. Heap Dump analysis is very powerful and allow you to view and understand the entire memory</nobr></div>
<div style="position:absolute;top:13991;left:85"><nobr>footprint of the Java Heap, including class loader related data and is a must do exercise in any</nobr></div>
<div style="position:absolute;top:14010;left:85"><nobr>memory footprint analysis; especially memory leaks.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:14326;left:764"><nobr>12 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:14431;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="13"><b>Page 13</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:14517;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:14520;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:15142;left:90"><nobr>Java profilers and heap dump analysis tools allow you to understand and validate your application</nobr></div>
<div style="position:absolute;top:15161;left:85"><nobr>memory footprint, including detection and resolution of memory leaks. Load and performance testing</nobr></div>
<div style="position:absolute;top:15180;left:85"><nobr>is also a must since this will allow you to validate your earlier estimates by simulating your forecast</nobr></div>
<div style="position:absolute;top:15199;left:85"><nobr>concurrent users. It will also expose your application bottlenecks and allow you to further fine tune</nobr></div>
<div style="position:absolute;top:15218;left:85"><nobr>your JVM settings. You can use tools such as Apache JMeter which is very easy to learn and use or</nobr></div>
<div style="position:absolute;top:15237;left:85"><nobr>explore other commercial products.</nobr></div>
<div style="position:absolute;top:15275;left:85"><nobr>Finally, I have seen quite often Java EE environments running perfectly fine until the day where one</nobr></div>
<div style="position:absolute;top:15294;left:85"><nobr>piece of the infrastructure start to fail e.g. hardware failure. Suddenly the environment is running at</nobr></div>
<div style="position:absolute;top:15313;left:85"><nobr>reduced capacity (reduced # of JVM processes) and the whole environment goes down. What</nobr></div>
<div style="position:absolute;top:15332;left:85"><nobr>happened?</nobr></div>
<div style="position:absolute;top:15370;left:85"><nobr>There are many scenarios that can lead to domino effects but lack of JVM tuning and capacity to</nobr></div>
<div style="position:absolute;top:15389;left:85"><nobr>handle fail-over (short term extra load) is very common. If your JVM processes are running at 80%+</nobr></div>
<div style="position:absolute;top:15408;left:85"><nobr>OldGen space capacity with frequent garbage collections, how can you expect to handle any fail-over</nobr></div>
<div style="position:absolute;top:15427;left:85"><nobr>scenario?</nobr></div>
<div style="position:absolute;top:15465;left:85"><nobr>Your load and performance testing exercise performed earlier should simulate such scenario and you</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:15514;left:764"><nobr>13 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:15619;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="14"><b>Page 14</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:15705;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:15708;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:15752;left:85"><nobr>should adjust your tuning settings properly so your Java Heap has enough buffer to handle extra load</nobr></div>
<div style="position:absolute;top:15771;left:85"><nobr>(extra objects) at short term. This is mainly applicable for the dynamic memory footprint since fail-over</nobr></div>
<div style="position:absolute;top:15790;left:85"><nobr>means redirecting a certain % of your concurrent users to the available JVM processes (middleware</nobr></div>
<div style="position:absolute;top:15809;left:85"><nobr>instances).</nobr></div>
<div style="position:absolute;top:15847;left:85"><nobr>#5 - Divide and conquer</nobr></div>
<div style="position:absolute;top:15885;left:85"><nobr>At this point you have performed dozens of load testing iterations. You know that your JVM is not</nobr></div>
<div style="position:absolute;top:15904;left:85"><nobr>leaking memory. Your application memory footprint cannot be reduced any further. You tried several</nobr></div>
<div style="position:absolute;top:15923;left:85"><nobr>tuning strategies such as using a large 64-bit Java Heap space of 10 GB+, multiple GC policies but</nobr></div>
<div style="position:absolute;top:15942;left:85"><nobr>still not finding your performance level acceptable?</nobr></div>
<div style="position:absolute;top:15980;left:85"><nobr>In my experience I found that, with current JVM specifications, proper vertical and horizontal scaling</nobr></div>
<div style="position:absolute;top:15999;left:85"><nobr>which involved creating a few JVM processes per physical host and across several hosts will give you</nobr></div>
<div style="position:absolute;top:16018;left:85"><nobr>the throughput and capacity that you are looking for. Your IT environment will also more fault tolerant if</nobr></div>
<div style="position:absolute;top:16037;left:85"><nobr>you break your application list in a few logical silos, with their own JVM process, Threads and tuning</nobr></div>
<div style="position:absolute;top:16056;left:85"><nobr>values.</nobr></div>
<div style="position:absolute;top:16094;left:85"><nobr>This "divide and conquer" strategy involves splitting your application(s) traffic to multiple JVM</nobr></div>
<div style="position:absolute;top:16113;left:85"><nobr>processes and will provide you with:</nobr></div>
<div style="position:absolute;top:16154;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:16152;left:139"><nobr>Reduced Java Heap size per JVM process (both static &amp; dynamic footprint)</nobr></div>
<div style="position:absolute;top:16175;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:16173;left:139"><nobr>Reduced complexity of JVM tuning</nobr></div>
<div style="position:absolute;top:16195;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:16193;left:139"><nobr>Reduced GC elapsed and pause time per JVM process</nobr></div>
<div style="position:absolute;top:16216;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:16214;left:139"><nobr>Increased redundancy and fail-over capabilities</nobr></div>
<div style="position:absolute;top:16236;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:16235;left:139"><nobr>Aligned with latest Cloud and IT virtualization strategies</nobr></div>
<div style="position:absolute;top:16272;left:85"><nobr>The bottom line is that when you find yourself spending too much time in tuning that single elephant </nobr></div>
<div style="position:absolute;top:16291;left:85"><nobr>64-bit JVM process, it is time to revisit your middleware and JVM deployment strategy and take</nobr></div>
<div style="position:absolute;top:16310;left:85"><nobr>advantage of vertical &amp; horizontal scaling. This implementation strategy is more taxing for the</nobr></div>
<div style="position:absolute;top:16329;left:85"><nobr>hardware but will really pay off in the long run.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:16386;left:85"><nobr><b>Java Threading: JVM Retained memory analysis</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:16441;left:85"><nobr>Having discussed the various heap spaces of the JVM, this section will provide you with a tutorial</nobr></div>
<div style="position:absolute;top:16460;left:85"><nobr>allowing you to determine how much and where Java heap space is retained from your active</nobr></div>
<div style="position:absolute;top:16479;left:85"><nobr>application Java threads. A true case study from an Oracle Weblogic 10.0 production environment will</nobr></div>
<div style="position:absolute;top:16498;left:85"><nobr>be presented in order for you to better understand the analysis process.</nobr></div>
<div style="position:absolute;top:16536;left:85"><nobr>We will also attempt to demonstrate that excessive garbage collection or Java heap space memory</nobr></div>
<div style="position:absolute;top:16555;left:85"><nobr>footprint problems are often not caused by true memory leaks but instead due to thread execution</nobr></div>
<div style="position:absolute;top:16574;left:85"><nobr>patterns and high amount of short lived objects.</nobr></div>
<div style="position:absolute;top:16612;left:85"><nobr>Background</nobr></div>
<div style="position:absolute;top:16650;left:85"><nobr>Java threads are part of the JVM fundamentals. Your Java heap space memory footprint is driven not</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:16702;left:764"><nobr>14 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:16807;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="15"><b>Page 15</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:16893;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:16896;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:16940;left:85"><nobr>only by static and long lived objects but also by short lived objects.</nobr></div>
<div style="position:absolute;top:16978;left:85"><nobr>OutOfMemoryError problems are often wrongly assumed to be due to memory leaks. We often</nobr></div>
<div style="position:absolute;top:16997;left:85"><nobr>overlook faulty thread execution patterns and short lived objects they "retain" on the Java heap until</nobr></div>
<div style="position:absolute;top:17016;left:85"><nobr>their executions are completed. In this problematic scenario:</nobr></div>
<div style="position:absolute;top:17057;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:17056;left:139"><nobr>Your "expected" application short lived / stateless objects (XML, JSON data payload etc.)</nobr></div>
<div style="position:absolute;top:17075;left:139"><nobr>become retained by the threads for too long (thread lock contention, huge data payload, slow</nobr></div>
<div style="position:absolute;top:17094;left:139"><nobr>response time from remote system etc.).</nobr></div>
<div style="position:absolute;top:17116;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:17114;left:139"><nobr>Eventually such short lived objects get promoted to the long lived object space e.g.</nobr></div>
<div style="position:absolute;top:17133;left:139"><nobr>OldGen/tenured space by the garbage collector.</nobr></div>
<div style="position:absolute;top:17155;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:17154;left:139"><nobr>As a side effect, this is causing the OldGen space to fill up rapidly, increasing the Full GC</nobr></div>
<div style="position:absolute;top:17173;left:139"><nobr>(major collections) frequency.</nobr></div>
<div style="position:absolute;top:17195;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:17193;left:139"><nobr>Depending of the severity of the situation this can lead to excessive GC garbage collection,</nobr></div>
<div style="position:absolute;top:17212;left:139"><nobr>increased JVM  paused time and ultimately “OutOfMemoryError: Java heap space”.</nobr></div>
<div style="position:absolute;top:17235;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:17233;left:139"><nobr>Your application is now down, you are now puzzled on what is going on.</nobr></div>
<div style="position:absolute;top:17255;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:17253;left:139"><nobr>Finally, you are thinking to either increase the Java heap or look for memory leaks...are you</nobr></div>
<div style="position:absolute;top:17272;left:139"><nobr>really on the right track?</nobr></div>
<div style="position:absolute;top:17310;left:85"><nobr>In the above scenario, you need to look at the thread execution patterns and determine how much</nobr></div>
<div style="position:absolute;top:17329;left:85"><nobr>memory each of them retain at a given time.</nobr></div>
<div style="position:absolute;top:17367;left:85"><nobr>OK I get the picture but what about the thread stack size?</nobr></div>
<div style="position:absolute;top:17405;left:85"><nobr>It is very important to avoid any confusion between thread stack size and Java memory retention. The</nobr></div>
<div style="position:absolute;top:17424;left:85"><nobr>thread stack size is a special memory space used by the JVM to store each method call. When a</nobr></div>
<div style="position:absolute;top:17443;left:85"><nobr>thread calls method A, it "pushes" the call onto the stack. If method A calls method B, it gets also</nobr></div>
<div style="position:absolute;top:17462;left:85"><nobr>pushed onto the stack. Once the method execution completes, the call is "popped" off the stack.</nobr></div>
<div style="position:absolute;top:17500;left:85"><nobr>The Java objects created as a result of such thread method calls are allocated on the Java heap</nobr></div>
<div style="position:absolute;top:17519;left:85"><nobr>space. Increasing the thread stack size will definitely not have any effect. Tuning of the thread stack</nobr></div>
<div style="position:absolute;top:17538;left:85"><nobr>size is normally required when dealing with java.lang.stackoverflowerror or “OutOfMemoryError:</nobr></div>
<div style="position:absolute;top:17557;left:85"><nobr>unable to create new native thread” problems.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:17890;left:764"><nobr>15 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:17995;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="16"><b>Page 16</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:18081;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:18084;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:18544;left:85"><nobr>Case study and problem context</nobr></div>
<div style="position:absolute;top:18582;left:85"><nobr>The following analysis is based on a true production problem we investigated recently.</nobr></div>
<div style="position:absolute;top:18620;left:112"><nobr>1. Severe performance degradation was observed from a Weblogic 10.0 production environment</nobr></div>
<div style="position:absolute;top:18639;left:139"><nobr>following some changes to the user web interface (using Google Web Toolkit and JSON as</nobr></div>
<div style="position:absolute;top:18658;left:139"><nobr>data payload).</nobr></div>
<div style="position:absolute;top:18677;left:112"><nobr>2. Initial analysis did reveal several occurrences of “OutOfMemoryError: Java heap space” errors</nobr></div>
<div style="position:absolute;top:18696;left:139"><nobr>along with excessive garbage collection. Java heap dump files were generated automatically (-</nobr></div>
<div style="position:absolute;top:18715;left:139"><nobr>XX:+HeapDumpOnOutOfMemoryError) following OOM events.</nobr></div>
<div style="position:absolute;top:18734;left:112"><nobr>3. Analysis of the verbose:gc logs did confirm full depletion of the 32-bit HotSpot JVM OldGen</nobr></div>
<div style="position:absolute;top:18753;left:139"><nobr>space (1 GB capacity).</nobr></div>
<div style="position:absolute;top:18772;left:112"><nobr>4. Thread dump snapshots were also generated before and during the problem.</nobr></div>
<div style="position:absolute;top:18791;left:112"><nobr>5. The only problem mitigation available at that time was to restart the affected Weblogic server</nobr></div>
<div style="position:absolute;top:18810;left:139"><nobr>when problem was observed.</nobr></div>
<div style="position:absolute;top:18829;left:112"><nobr>6. A rollback of the changes was eventually performed which did resolve the situation.</nobr></div>
<div style="position:absolute;top:18867;left:85"><nobr>The team first suspected a memory leak problem from the new code introduced.</nobr></div>
<div style="position:absolute;top:18905;left:85"><nobr>Thread dump analysis: looking for suspects</nobr></div>
<div style="position:absolute;top:18943;left:85"><nobr>The first step we took was to perform an analysis of the generated thread dump data. Thread dump</nobr></div>
<div style="position:absolute;top:18962;left:85"><nobr>will often show you the culprit threads allocating memory on the Java heap. It will also reveal any</nobr></div>
<div style="position:absolute;top:18981;left:85"><nobr>hogging or stuck thread attempting to send and receive data payload from a remote system.</nobr></div>
<div style="position:absolute;top:19019;left:85"><nobr>The first pattern we noticed was a good correlation between OOM events and STUCK threads</nobr></div>
<div style="position:absolute;top:19038;left:85"><nobr>observed from the Weblogic managed servers (JVM processes). Find below the primary thread</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:19078;left:764"><nobr>16 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:19183;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="17"><b>Page 17</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:19269;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:19272;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:19316;left:85"><nobr>pattern found:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:20266;left:764"><nobr>17 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:19372;left:101"><nobr>&lt;10-Dec-2012 1:27:59 o'clock PM EST&gt; &lt;Error&gt; &lt;BEA-000337&gt;</nobr></div>
<div style="position:absolute;top:19389;left:101"><nobr>&lt;[STUCK] ExecuteThread: '22' for queue:</nobr></div>
<div style="position:absolute;top:19406;left:101"><nobr>'weblogic.kernel.Default (self-tuning)'</nobr></div>
<div style="position:absolute;top:19423;left:101"><nobr>has been busy for "672" seconds working on the request</nobr></div>
<div style="position:absolute;top:19440;left:101"><nobr>which is more than the configured time of "600" seconds.</nobr></div>
</span></font>

<div style="position:absolute;top:20371;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="18"><b>Page 18</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:20457;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:20460;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:20504;left:85"><nobr>As you can see, the above thread appears to be STUCK or taking very long time to read and receive</nobr></div>
<div style="position:absolute;top:20523;left:85"><nobr>the JSON response from the remote server. Once we found that pattern, the next step was to correlate</nobr></div>
<div style="position:absolute;top:20542;left:85"><nobr>this finding with the JVM heap dump analysis and determine how much memory these stuck threads</nobr></div>
<div style="position:absolute;top:20561;left:85"><nobr>were taking from the Java heap.</nobr></div>
<div style="position:absolute;top:20599;left:85"><nobr>Heap dump analysis: retained objects exposed!</nobr></div>
<div style="position:absolute;top:20637;left:85"><nobr>The Java heap dump analysis was performed using MAT. We will now list the different analysis steps</nobr></div>
<div style="position:absolute;top:20656;left:85"><nobr>which did allow us to pinpoint the retained memory size and source.</nobr></div>
<div style="position:absolute;top:20694;left:85"><nobr>1. Load the HotSpot JVM heap dump</nobr></div>
<div style="position:absolute;top:21227;left:85"><nobr>2. Select the HISTOGRAM view and filter by "ExecuteThread"</nobr></div>
<div style="position:absolute;top:21264;left:85"><nobr><i>* ExecuteThread is the Java class used by the Weblogic kernel for thread creation &amp; execution *</i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:21454;left:764"><nobr>18 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:21559;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="19"><b>Page 19</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:21645;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:21648;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:22167;left:85"><nobr>As you can see, this view was quite revealing. We can see a total of 210 Weblogic threads created.</nobr></div>
<div style="position:absolute;top:22186;left:85"><nobr>The total retained memory footprint from these threads is 806 MB. This is pretty significant for a 32-bit</nobr></div>
<div style="position:absolute;top:22205;left:85"><nobr>JVM process with 1 GB OldGen space. This view alone is telling us that the core of the problem and</nobr></div>
<div style="position:absolute;top:22224;left:85"><nobr>memory retention originates from the threads themselves.</nobr></div>
<div style="position:absolute;top:22262;left:85"><nobr>3. Deep dive into the thread memory footprint analysis</nobr></div>
<div style="position:absolute;top:22299;left:85"><nobr>The next step was to deep dive into the thread memory retention. To do this, simply right click over the</nobr></div>
<div style="position:absolute;top:22318;left:85"><nobr>ExecuteThread class and select: List objects &gt; with outgoing references.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:22642;left:764"><nobr>19 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:22747;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="20"><b>Page 20</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:22833;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:22836;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:23487;left:85"><nobr>As you can see, we were able to correlate STUCK threads from the thread dump analysis with high</nobr></div>
<div style="position:absolute;top:23506;left:85"><nobr>memory retention from the heap dump analysis. The finding was quite surprising.</nobr></div>
<div style="position:absolute;top:23544;left:85"><nobr>4. Thread Java Local variables identification</nobr></div>
<div style="position:absolute;top:23582;left:85"><nobr>The final analysis step did require us to expand a few thread samples and understand the primary</nobr></div>
<div style="position:absolute;top:23601;left:85"><nobr>source of memory retention.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:23830;left:764"><nobr>20 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:23935;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="21"><b>Page 21</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:24021;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:24024;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:24383;left:85"><nobr>As you can see, this last analysis step did reveal huge JSON response data payload at the root cause.</nobr></div>
<div style="position:absolute;top:24402;left:85"><nobr>That pattern was also exposed earlier via the thread dump analysis where we found a few threads</nobr></div>
<div style="position:absolute;top:24421;left:85"><nobr>taking very long time to read &amp; receive the JSON response; a clear symptom of huge data payload</nobr></div>
<div style="position:absolute;top:24440;left:85"><nobr>footprint.</nobr></div>
<div style="position:absolute;top:24478;left:85"><nobr>It is crucial to note that short lived objects created via local method variables will show up in the heap</nobr></div>
<div style="position:absolute;top:24497;left:85"><nobr>dump analysis. However, some of those will only be visible from their parent threads since they are not</nobr></div>
<div style="position:absolute;top:24516;left:85"><nobr>referenced by other objects, like in this case. You will also need to analyze the thread stack trace in</nobr></div>
<div style="position:absolute;top:24535;left:85"><nobr>order to identify the true caller, followed by a code review to confirm the root cause.</nobr></div>
<div style="position:absolute;top:24573;left:85"><nobr>Following this finding, our delivery team was able to determine that the recent JSON faulty code</nobr></div>
<div style="position:absolute;top:24592;left:85"><nobr>changes were generating, under some scenarios, huge JSON data payload up to 45 MB+. Given the</nobr></div>
<div style="position:absolute;top:24611;left:85"><nobr>fact that this environment is using a 32-bit JVM with only 1 GB of OldGen space, you can understand</nobr></div>
<div style="position:absolute;top:24630;left:85"><nobr>that only a few threads were enough to trigger severe performance degradation.</nobr></div>
<div style="position:absolute;top:24668;left:85"><nobr>This case study is clearly showing the importance of proper capacity planning and Java heap analysis,</nobr></div>
<div style="position:absolute;top:24687;left:85"><nobr>including the memory retained from your active application &amp; Java EE container threads.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:24743;left:85"><nobr><b>Java 8: From PermGen to Metaspace</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:24798;left:85"><nobr>Java 8 will introduce some new language and runtime features. One of these features is the complete</nobr></div>
<div style="position:absolute;top:24817;left:85"><nobr>removal of the Permanent Generation (PermGen) space which has been announced by Oracle since</nobr></div>
<div style="position:absolute;top:24836;left:85"><nobr>the release of JDK 7. Interned strings, for example, have already been removed from the PermGen</nobr></div>
<div style="position:absolute;top:24855;left:85"><nobr>space since JDK 7. The JDK 8 release finalizes its decommissioning. In this section, we shall discuss</nobr></div>
<div style="position:absolute;top:24874;left:85"><nobr>the PermGen successor: Metaspace.</nobr></div>
<div style="position:absolute;top:24912;left:85"><nobr>We will also compare the runtime behavior of the HotSpot 1.7 vs. HotSpot 1.8 (b75) when executing a</nobr></div>
<div style="position:absolute;top:24931;left:85"><nobr>Java program “leaking” class metadata objects.</nobr></div>
<div style="position:absolute;top:24969;left:85"><nobr>The final specifications, tuning flags and documentation around Metaspace should be available once</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:25018;left:764"><nobr>21 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:25123;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="22"><b>Page 22</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:25209;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:25212;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:25256;left:85"><nobr>Java 8 is officially released.</nobr></div>
<div style="position:absolute;top:25294;left:85"><nobr>Metaspace: A new memory space is born</nobr></div>
<div style="position:absolute;top:25332;left:85"><nobr>The JDK 8 HotSpot JVM is now using native memory for the representation of class metadata and is</nobr></div>
<div style="position:absolute;top:25351;left:85"><nobr>called Metaspace; similar to the Oracle JRockit and IBM JVM's.</nobr></div>
<div style="position:absolute;top:25389;left:85"><nobr>The good news is that it means no more java.lang.OutOfMemoryError: PermGen space problems and</nobr></div>
<div style="position:absolute;top:25408;left:85"><nobr>no need for you to tune and monitor this memory space anymore…not so fast. While this change is</nobr></div>
<div style="position:absolute;top:25427;left:85"><nobr>invisible by default, we will show you next that you will still need to worry about the class metadata</nobr></div>
<div style="position:absolute;top:25446;left:85"><nobr>memory footprint. Please also keep in mind that this new feature does not magically eliminate class</nobr></div>
<div style="position:absolute;top:25465;left:85"><nobr>and classloader memory leaks. You will need to track down these problems using a different approach</nobr></div>
<div style="position:absolute;top:25484;left:85"><nobr>and by learning the new naming convention.</nobr></div>
<div style="position:absolute;top:25522;left:85"><nobr>In summary:</nobr></div>
<div style="position:absolute;top:25560;left:85"><nobr>PermGen space situation</nobr></div>
<div style="position:absolute;top:25601;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:25599;left:158"><nobr>This memory space is completely removed.</nobr></div>
<div style="position:absolute;top:25622;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:25620;left:158"><nobr>The PermSize and MaxPermSize JVM arguments are ignored and a warning is issued if</nobr></div>
<div style="position:absolute;top:25639;left:158"><nobr>present at start-up.</nobr></div>
<div style="position:absolute;top:25677;left:85"><nobr>Metaspace memory allocation model</nobr></div>
<div style="position:absolute;top:25718;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:25716;left:158"><nobr>Most allocations for the class metadata are now allocated out of native memory.</nobr></div>
<div style="position:absolute;top:25739;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:25737;left:158"><nobr>The classes that were used to describe class metadata have been removed.</nobr></div>
<div style="position:absolute;top:25775;left:85"><nobr>Metaspace capacity</nobr></div>
<div style="position:absolute;top:25816;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:25814;left:158"><nobr>By default class metadata allocation is limited by the amount of available native memory</nobr></div>
<div style="position:absolute;top:25833;left:158"><nobr>(capacity will of course depend if you use a 32-bit JVM vs. 64-bit along with OS virtual</nobr></div>
<div style="position:absolute;top:25852;left:158"><nobr>memory availability).</nobr></div>
<div style="position:absolute;top:25875;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:25873;left:158"><nobr>A new flag is available (MaxMetaspaceSize), allowing you to limit the amount of native</nobr></div>
<div style="position:absolute;top:25892;left:158"><nobr>memory used for class metadata. If you don’t specify this flag, the Metaspace will</nobr></div>
<div style="position:absolute;top:25911;left:158"><nobr>dynamically re-size depending of the application demand at runtime.</nobr></div>
<div style="position:absolute;top:25949;left:85"><nobr>Metaspace garbage collection</nobr></div>
<div style="position:absolute;top:25990;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:25988;left:158"><nobr>Garbage collection of the dead classes and classloaders is triggered once the class</nobr></div>
<div style="position:absolute;top:26007;left:158"><nobr>metadata usage reaches the “MaxMetaspaceSize”.</nobr></div>
<div style="position:absolute;top:26030;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:26028;left:158"><nobr>Proper monitoring &amp; tuning of the Metaspace will obviously be required in order to limit the</nobr></div>
<div style="position:absolute;top:26047;left:158"><nobr>frequency or delay of such garbage collections. Excessive Metaspace garbage collections</nobr></div>
<div style="position:absolute;top:26066;left:158"><nobr>may be a symptom of classes, classloaders memory leak or inadequate sizing for your</nobr></div>
<div style="position:absolute;top:26085;left:158"><nobr>application.</nobr></div>
<div style="position:absolute;top:26123;left:85"><nobr>Java heap space impact</nobr></div>
<div style="position:absolute;top:26161;left:103"><nobr>Some miscellaneous data has been moved to the Java heap space. This means you may observe</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:26206;left:764"><nobr>22 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:26311;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="23"><b>Page 23</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:26397;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:26400;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:26444;left:85"><nobr>an increase of the Java heap space following a future JDK 8 upgrade.</nobr></div>
<div style="position:absolute;top:26482;left:90"><nobr>Metaspace monitoring</nobr></div>
<div style="position:absolute;top:26523;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:26522;left:139"><nobr>Metaspace usage is available from the HotSpot 1.8 verbose GC log output.</nobr></div>
<div style="position:absolute;top:26544;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:26542;left:139"><nobr>Jstat &amp; JVisualVM have not been updated at this point based on our testing with b75 and the</nobr></div>
<div style="position:absolute;top:26561;left:139"><nobr>old PermGen space references are still present.</nobr></div>
<div style="position:absolute;top:26599;left:85"><nobr>Enough theory now, let’s see this new memory space in action via our leaking Java program…</nobr></div>
<div style="position:absolute;top:26637;left:85"><nobr>PermGen vs. Metaspace runtime comparison</nobr></div>
<div style="position:absolute;top:26675;left:85"><nobr>In order to better understand the runtime behavior of the new Metaspace memory space, we created a</nobr></div>
<div style="position:absolute;top:26694;left:85"><nobr>class metadata leaking Java program. You can download the source <a href="https://docs.google.com/file/d/0B6UjfNcYT7yGbjVLNlpJRWlKUWc/edit?usp=sharing"></a><font color="#000080"><a href="https://docs.google.com/file/d/0B6UjfNcYT7yGbjVLNlpJRWlKUWc/edit?usp=sharing">here</a></font><a href="https://docs.google.com/file/d/0B6UjfNcYT7yGbjVLNlpJRWlKUWc/edit?usp=sharing"></a>.</nobr></div>
<div style="position:absolute;top:26732;left:85"><nobr>The following scenarios will be tested:</nobr></div>
<div style="position:absolute;top:26773;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:26772;left:139"><nobr>Run the Java program using JDK 1.7 in order to monitor &amp; deplete the PermGen memory</nobr></div>
<div style="position:absolute;top:26790;left:139"><nobr>space set at 128 MB.</nobr></div>
<div style="position:absolute;top:26813;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:26811;left:139"><nobr>Run the Java program using JDK 1.8 (b75) in order to monitor the dynamic increase and</nobr></div>
<div style="position:absolute;top:26830;left:139"><nobr>garbage collection of the new Metaspace memory space.</nobr></div>
<div style="position:absolute;top:26852;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:26851;left:139"><nobr>Run the Java program using JDK 1.8 (b75) in order to simulate the depletion of the Metaspace</nobr></div>
<div style="position:absolute;top:26870;left:139"><nobr>by setting the MaxMetaspaceSize value at 128 MB.</nobr></div>
<div style="position:absolute;top:26907;left:85"><nobr>JDK 1.7 @64-bit – PermGen depletion</nobr></div>
<div style="position:absolute;top:26949;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:26947;left:139"><nobr>Java program with 50K configured iterations</nobr></div>
<div style="position:absolute;top:26969;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:26968;left:139"><nobr>Java heap space of 1024 MB</nobr></div>
<div style="position:absolute;top:26990;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:26988;left:139"><nobr>Java PermGen space of 128 MB (-XX:MaxPermSize=128m)</nobr></div>
<div style="position:absolute;top:27232;left:85"><nobr>As you can see form JVisualVM, the PermGen depletion was reached after loading about 30K+</nobr></div>
<div style="position:absolute;top:27251;left:85"><nobr>classes. We can also see this depletion from the program and GC output.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:27394;left:764"><nobr>23 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:27499;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="24"><b>Page 24</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:27585;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:27588;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:27898;left:85"><nobr>Now let’s execute the program using the HotSpot JDK 1.8 JRE.</nobr></div>
<div style="position:absolute;top:27936;left:85"><nobr>JDK 1.8 @64-bit – Metaspace dynamic re-size</nobr></div>
<div style="position:absolute;top:27977;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:27975;left:139"><nobr>Java program with 50K configured iterations</nobr></div>
<div style="position:absolute;top:27998;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:27996;left:139"><nobr>Java heap space of 1024 MB</nobr></div>
<div style="position:absolute;top:28018;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:28016;left:139"><nobr>Java Metaspace space: unbounded (default)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:28582;left:764"><nobr>24 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:28687;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="25"><b>Page 25</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:28773;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:28776;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:29312;left:85"><nobr>As you can see from the verbose GC output, the JVM Metaspace did expand dynamically from 20 MB</nobr></div>
<div style="position:absolute;top:29331;left:85"><nobr>up to 328 MB of reserved native memory in order to honor the increased class metadata memory</nobr></div>
<div style="position:absolute;top:29350;left:85"><nobr>footprint from our Java program. We could also observe garbage collection events in the attempt by</nobr></div>
<div style="position:absolute;top:29369;left:85"><nobr>the JVM to destroy any dead class or classloader object. Since our Java program is leaking, the JVM</nobr></div>
<div style="position:absolute;top:29388;left:85"><nobr>had no choice but to dynamically expand the Metaspace memory space.</nobr></div>
<div style="position:absolute;top:29426;left:85"><nobr>The program was able to run its 50K of iterations with no OOM event and loaded 50K+ Classes.</nobr></div>
<div style="position:absolute;top:29463;left:85"><nobr>Let's move to our last testing scenario.</nobr></div>
<div style="position:absolute;top:29501;left:85"><nobr>JDK 1.8 @64-bit – Metaspace depletion</nobr></div>
<div style="position:absolute;top:29543;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:29541;left:139"><nobr>Java program with 50K configured iterations</nobr></div>
<div style="position:absolute;top:29563;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:29561;left:139"><nobr>Java heap space of 1024 MB</nobr></div>
<div style="position:absolute;top:29584;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:29582;left:139"><nobr>Java Metaspace space: 128 MB (-XX:MaxMetaspaceSize=128m)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:29770;left:764"><nobr>25 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:29875;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="26"><b>Page 26</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:29961;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:29964;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:30488;left:85"><nobr>As you can see form JVisualVM, the Metaspace depletion was reached after loading about 30K+</nobr></div>
<div style="position:absolute;top:30507;left:85"><nobr>classes; very similar to the run with the JDK 1.7. We can also see this from the program and GC</nobr></div>
<div style="position:absolute;top:30526;left:85"><nobr>output. Another interesting observation is that the native memory footprint reserved was twice as much</nobr></div>
<div style="position:absolute;top:30545;left:85"><nobr>as the maximum size specified. This may indicate some opportunities to fine tune the Metaspace</nobr></div>
<div style="position:absolute;top:30564;left:85"><nobr>resize policy, if possible, in order to avoid native memory waste.</nobr></div>
<div style="position:absolute;top:30602;left:85"><nobr>Capping the Metaspace at 128 MB like we did for the baseline run with JDK 1.7 did not allow us to</nobr></div>
<div style="position:absolute;top:30621;left:85"><nobr>complete the 50K iterations of our program. A new OOM error was thrown by the JVM. The above</nobr></div>
<div style="position:absolute;top:30640;left:85"><nobr>OOM event was thrown by the JVM from the Metaspace following a memory allocation failure.</nobr></div>
<div style="position:absolute;top:30678;left:85"><nobr>Final Words on Metaspace</nobr></div>
<div style="position:absolute;top:30716;left:85"><nobr>The current observations definitely indicate that proper monitoring &amp; tuning will be required in order to</nobr></div>
<div style="position:absolute;top:30735;left:85"><nobr>stay away from problems such as excessive Metaspace GC or OOM conditions triggered from our last</nobr></div>
<div style="position:absolute;top:30754;left:85"><nobr>testing scenario.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:30810;left:85"><nobr><b>HPROF - Memory leak analysis with Eclipse Memory Analyzer</b></nobr></div>
<div style="position:absolute;top:30838;left:118"><nobr><b>Tool (MAT)</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:30894;left:85"><nobr>In this section, we will show you how you can analyze a JVM memory leak problem by generating and</nobr></div>
<div style="position:absolute;top:30913;left:85"><nobr>analyzing a HotSpot JVM HPROF Heap Dump file.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:30958;left:764"><nobr>26 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:31063;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="27"><b>Page 27</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:31149;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:31152;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:31215;left:85"><nobr>A real life case study will be used for that purpose: Weblogic 9.2 memory leak affecting the Weblogic</nobr></div>
<div style="position:absolute;top:31234;left:85"><nobr>Admin server.</nobr></div>
<div style="position:absolute;top:31272;left:85"><nobr>Environment specifications</nobr></div>
<div style="position:absolute;top:31313;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:31312;left:139"><nobr>Java EE server: Oracle Weblogic Server 9.2 MP1</nobr></div>
<div style="position:absolute;top:31334;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:31332;left:139"><nobr>Middleware OS: Solaris 10</nobr></div>
<div style="position:absolute;top:31354;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:31353;left:139"><nobr>Java VM: Sun HotSpot 1.5.0_22</nobr></div>
<div style="position:absolute;top:31375;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:31373;left:139"><nobr>Platform type: Middle tier</nobr></div>
<div style="position:absolute;top:31411;left:85"><nobr>Monitoring and troubleshooting tools</nobr></div>
<div style="position:absolute;top:31453;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:31451;left:139"><nobr>Quest Foglight (JVM and garbage collection monitoring)</nobr></div>
<div style="position:absolute;top:31473;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:31471;left:139"><nobr>jmap (hprof / Heap Dump generation tool)</nobr></div>
<div style="position:absolute;top:31494;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:31492;left:139"><nobr>Memory Analyzer 1.1 via IBM support assistant (hprof Heap Dump analysis)</nobr></div>
<div style="position:absolute;top:31514;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:31512;left:139"><nobr>Platform type: Middle tier</nobr></div>
<div style="position:absolute;top:31550;left:85"><nobr>Step #1 - WLS 9.2 Admin server JVM monitoring and leak confirmation</nobr></div>
<div style="position:absolute;top:31588;left:85"><nobr>The Quest Foglight Java EE monitoring tool was quite useful to identify a Java Heap leak from our</nobr></div>
<div style="position:absolute;top:31607;left:85"><nobr>Weblogic Admin server. As you can see below, the Java Heap memory is growing over time.</nobr></div>
<div style="position:absolute;top:31645;left:85"><nobr>If you are not using any monitoring tool for your Weblogic environment, my recommendation to you is</nobr></div>
<div style="position:absolute;top:31664;left:85"><nobr>to at least enable verbose:gc of your HotSpot VM. Please visit the Java 7 verbose:gc tutorial below on</nobr></div>
<div style="position:absolute;top:31683;left:85"><nobr>this subject for more detailed instructions.</nobr></div>
<div style="position:absolute;top:32101;left:85"><nobr>Step #2 - Generate a Heap Dump from your leaking JVM</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:32146;left:764"><nobr>27 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:32251;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="28"><b>Page 28</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:32337;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:32340;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:32403;left:85"><nobr>Following the discovery of a JVM memory leak, the goal is to generate a Heap Dump file (binary</nobr></div>
<div style="position:absolute;top:32422;left:85"><nobr>format) by using the Sun JDK jmap utility.</nobr></div>
<div style="position:absolute;top:32460;left:85"><nobr><i>** Please note that jmap Heap Dump generation will cause your JVM to become unresponsive so</i></nobr></div>
<div style="position:absolute;top:32479;left:85"><nobr><i>please ensure that no more traffic is sent to your affected / leaking JVM before running the jmap utility</i></nobr></div>
<div style="position:absolute;top:32498;left:85"><nobr><i>**</i></nobr></div>
<div style="position:absolute;top:32574;left:85"><nobr>This command will generate a Heap Dump binary file (heap.bin) of your leaking JVM. The size of the</nobr></div>
<div style="position:absolute;top:32593;left:85"><nobr>file and elapsed time of the generation process will depend of your JVM size and machine</nobr></div>
<div style="position:absolute;top:32612;left:85"><nobr>specifications / speed.</nobr></div>
<div style="position:absolute;top:32650;left:85"><nobr>For our case study, a binary Heap Dump file of ~2GB was generated in about 1 hour elapsed time.</nobr></div>
<div style="position:absolute;top:32688;left:85"><nobr>Sun HotSpot 1.5/1.6/1.7 Heap Dump file will also be generated automatically as a result of a</nobr></div>
<div style="position:absolute;top:32707;left:85"><nobr>OutOfMemoryError and by adding -XX:+HeapDumpOnOutOfMemoryError in your JVM start-up</nobr></div>
<div style="position:absolute;top:32726;left:85"><nobr>arguments.</nobr></div>
<div style="position:absolute;top:32764;left:85"><nobr>Step #3 - Load your Heap Dump file in Memory Analyzer tool</nobr></div>
<div style="position:absolute;top:32802;left:85"><nobr>It is now time to load your Heap Dump file in the Memory Analyzer tool. The loading process will take</nobr></div>
<div style="position:absolute;top:32821;left:85"><nobr>several minutes depending of the size of your Heap Dump and speed of your machine.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:33334;left:764"><nobr>28 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:32538;left:243"><nobr>&lt;JDK HOME&gt;/bin/jmap -heap:format=b &lt;Java VM PID&gt;</nobr></div>
</span></font>

<div style="position:absolute;top:33439;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="29"><b>Page 29</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:33525;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:33528;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:34522;left:764"><nobr>29 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:34627;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="30"><b>Page 30</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:34713;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:34716;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:35340;left:85"><nobr>Step #4 - Analyze your Heap Dump</nobr></div>
<div style="position:absolute;top:35378;left:85"><nobr>The Memory Analyzer provides you with many features, including a Leak Suspect report. For this case</nobr></div>
<div style="position:absolute;top:35397;left:85"><nobr>study, the Java Heap histogram was used as a starting point to analyze the leaking objects and the</nobr></div>
<div style="position:absolute;top:35416;left:85"><nobr>source.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:35710;left:764"><nobr>30 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:35815;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="31"><b>Page 31</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:35901;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:35904;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:36534;left:85"><nobr>For our case study, java.lang.String and char[] data were found as the leaking Objects. Now question</nobr></div>
<div style="position:absolute;top:36553;left:85"><nobr>is what is the source of the leak e.g. references of those leaking Objects. Simply right click over your</nobr></div>
<div style="position:absolute;top:36572;left:85"><nobr>leaking objects and select &gt;&gt; List Objects &gt; with incoming references.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:36898;left:764"><nobr>31 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:37003;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="32"><b>Page 32</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:37089;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:37092;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:37721;left:85"><nobr>As you can see, javax.management.ObjectName objects were found as the source of the leaking</nobr></div>
<div style="position:absolute;top:37740;left:85"><nobr>String &amp; char[] data. The Weblogic Admin server is communicating and pulling stats from its managed</nobr></div>
<div style="position:absolute;top:37759;left:85"><nobr>servers via MBeans / JMX which create javax.management.ObjectName for any MBean object type.</nobr></div>
<div style="position:absolute;top:37778;left:85"><nobr>Now question is why Weblogic 9.2 is not releasing properly such Objects…</nobr></div>
<div style="position:absolute;top:37816;left:85"><nobr>Root cause: Weblogic javax.management.ObjectName leak!</nobr></div>
<div style="position:absolute;top:37854;left:85"><nobr>Following our Heap Dump analysis, a review of the Weblogic known issues was performed which did</nobr></div>
<div style="position:absolute;top:37873;left:85"><nobr>reveal the following Weblogic 9.2 bug below:</nobr></div>
<div style="position:absolute;top:37914;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:37912;left:139"><nobr>Weblogic Bug ID: <a href="http://download.oracle.com/docs/cd/E11035_01/wls100/issues/known_resolved.html"></a><font color="#000080"><a href="http://download.oracle.com/docs/cd/E11035_01/wls100/issues/known_resolved.html">CR327368</a></font></nobr></div>
<div style="position:absolute;top:37935;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:37933;left:139"><nobr>Description: Memory leak of javax.management.ObjectName objects on the Administration</nobr></div>
<div style="position:absolute;top:37952;left:139"><nobr>Server used to cause OutOfMemory error on the Administration Server.</nobr></div>
<div style="position:absolute;top:37974;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:37972;left:139"><nobr>Affected Weblogic version(s): WLS 9.2</nobr></div>
<div style="position:absolute;top:37995;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:37993;left:139"><nobr>Fixed in: WLS 10 MP1</nobr></div>
<div style="position:absolute;top:38031;left:85"><nobr>This finding was quite conclusive given the perfect match of our Heap Dump analysis, WLS version</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:38086;left:764"><nobr>32 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:38191;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="33"><b>Page 33</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:38277;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:38280;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:38324;left:85"><nobr>and this known problem description.</nobr></div>
<div style="position:absolute;top:38362;left:85"><nobr>Hopefully, this tutorial along with the case study has helped you understand how you can pinpoint the</nobr></div>
<div style="position:absolute;top:38381;left:85"><nobr>source of a Java Heap leak using jmap and the Memory Analyzer tool.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:38437;left:85"><nobr><b>JVM verbose GC output tutorial</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:38493;left:85"><nobr>This section will provide you with a detailed tutorial on how to enable and read Java 7 HotSpot VM</nobr></div>
<div style="position:absolute;top:38512;left:85"><nobr>verbose gc output data.</nobr></div>
<div style="position:absolute;top:38550;left:85"><nobr>I recommend that you compile and run the sample program on your end as well.</nobr></div>
<div style="position:absolute;top:38588;left:85"><nobr>We also recently created a Java verbose GC <a href="http://www.youtube.com/watch?v=7CJCMKNoICE"></a><font color="#000080"><a href="http://www.youtube.com/watch?v=7CJCMKNoICE">tutorial video </a></font>explaining this analysis process.</nobr></div>
<div style="position:absolute;top:38626;left:85"><nobr>Tutorial specifications and tools</nobr></div>
<div style="position:absolute;top:38667;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:38665;left:139"><nobr>OS: Windows 7 - 64-bit</nobr></div>
<div style="position:absolute;top:38688;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:38686;left:139"><nobr>Java VM: Sun Java 7 HotSpot (build 21.0-b17)</nobr></div>
<div style="position:absolute;top:38708;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:38706;left:139"><nobr>IDE: Eclipse Java EE IDE for Web Developer v4.1</nobr></div>
<div style="position:absolute;top:38744;left:85"><nobr>Step #1 - Compile our sample Java program</nobr></div>
<div style="position:absolute;top:38782;left:85"><nobr>We created a sample Java program in order to load the Java Heap and trigger an explicit GC in order</nobr></div>
<div style="position:absolute;top:38801;left:85"><nobr>to generate some interesting verbose GC output. This program is simply loading about 3 million</nobr></div>
<div style="position:absolute;top:38820;left:85"><nobr>instances of java.lang.String in a static Map data structure and triggers an explicit GC (via</nobr></div>
<div style="position:absolute;top:38839;left:85"><nobr>System.gc()) followed by the removal of 2 million instances along with a second explicit GC before</nobr></div>
<div style="position:absolute;top:38858;left:85"><nobr>exiting.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:39274;left:764"><nobr>33 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:39379;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="34"><b>Page 34</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:39465;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:39468;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:40462;left:764"><nobr>34 of 127</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:39527;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.tools.jdk7;</font></nobr></div>
<div style="position:absolute;top:39562;left:101"><nobr><b>import </b><font color="#000000">java.util.Map;</font></nobr></div>
<div style="position:absolute;top:39580;left:101"><nobr><b>import </b><font color="#000000">java.util.HashMap;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:39615;left:101"><nobr>/**</nobr></div>
<div style="position:absolute;top:39632;left:101"><nobr>* JavaHeapVerboseGCTest</nobr></div>
<div style="position:absolute;top:39650;left:101"><nobr>* <b><font color="#7f9fbf">@author </font></b>Pierre<font color="#7f7f9f">-</font>Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:39668;left:101"><nobr>*</nobr></div>
<div style="position:absolute;top:39685;left:101"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:39703;left:101"><nobr><b>public class </b><font color="#000000">JavaHeapVerboseGCTest {</font></nobr></div>
<div style="position:absolute;top:39738;left:124"><nobr><b>private static </b><font color="#000000">Map&lt;String, String&gt; </font><i><font color="#0000c0">mapContainer </font></i><font color="#000000">= </font><b>new </b><font color="#000000">HashMap&lt;String, String&gt;();</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:39773;left:124"><nobr>/**</nobr></div>
<div style="position:absolute;top:39791;left:124"><nobr>* <b><font color="#7f9fbf">@param </font></b>args</nobr></div>
<div style="position:absolute;top:39809;left:124"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:39826;left:124"><nobr><b>public static void </b><font color="#000000">main(String[] args) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:39862;left:143"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Java 7 HotSpot Verbose GC Test Program v1.0"</font>);</nobr></div>
<div style="position:absolute;top:39879;left:143"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Author: Pierre-Hugues Charbonneau"</font>);</nobr></div>
<div style="position:absolute;top:39897;left:143"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"http://javaeesupportpatterns.blogspot.com/"</font>);</nobr></div>
<div style="position:absolute;top:39932;left:143"><nobr>String stringDataPrefix = <font color="#2a00ff">"stringDataPrefix"</font>;</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:39967;left:143"><nobr>// Load Java Heap with 3 M java.lang.String instances</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:39985;left:143"><nobr><b>for </b><font color="#000000">(</font><b>int </b><font color="#000000">i=0; i&lt;3000000; i++) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:40003;left:161"><nobr>String newStringData = stringDataPrefix + i;</nobr></div>
</span></font>
<font size="3" color="#0000c0" face="Times"><span style="font-size:13px;font-family:Times;color:#0000c0">
<div style="position:absolute;top:40021;left:161"><nobr><i>mapContainer</i><font color="#000000">.put(newStringData, newStringData);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:40038;left:143"><nobr>}</nobr></div>
<div style="position:absolute;top:40074;left:143"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"MAP size: "</font>+<i><font color="#0000c0">mapContainer</font></i>.size());</nobr></div>
<div style="position:absolute;top:40091;left:143"><nobr>System.<i>gc</i>(); <font color="#3f7f5f">// Explicit GC!</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:40126;left:143"><nobr>// Remove 2 M out of 3 M</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:40144;left:143"><nobr><b>for </b><font color="#000000">(</font><b>int </b><font color="#000000">i=0; i&lt;2000000; i++) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:40162;left:161"><nobr>String newStringData = stringDataPrefix + i;</nobr></div>
</span></font>
<font size="3" color="#0000c0" face="Times"><span style="font-size:13px;font-family:Times;color:#0000c0">
<div style="position:absolute;top:40180;left:161"><nobr><i>mapContainer</i><font color="#000000">.remove(newStringData);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:40197;left:143"><nobr>}</nobr></div>
<div style="position:absolute;top:40233;left:143"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"MAP size: "</font>+<i><font color="#0000c0">mapContainer</font></i>.size());</nobr></div>
<div style="position:absolute;top:40250;left:143"><nobr>System.<i>gc</i>();</nobr></div>
<div style="position:absolute;top:40268;left:143"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"End of program!"</font>);    </nobr></div>
<div style="position:absolute;top:40303;left:124"><nobr>}</nobr></div>
<div style="position:absolute;top:40321;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:40567;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="35"><b>Page 35</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:40653;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:40656;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:40719;left:85"><nobr>Step #2 - Enable verbose GC via the JVM start-up arguments</nobr></div>
<div style="position:absolute;top:40757;left:85"><nobr>The next step is to enable the verbose GC via the JVM start-up arguments and specify a name and</nobr></div>
<div style="position:absolute;top:40776;left:85"><nobr>location for our GC log file.</nobr></div>
<div style="position:absolute;top:41400;left:85"><nobr>Step #3 - Execute our sample Java program</nobr></div>
<div style="position:absolute;top:41438;left:85"><nobr>At this point, it is now time to execute our sample program and generate the JVM verbose GC output.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:41650;left:764"><nobr>35 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:41755;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="36"><b>Page 36</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:41841;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:41844;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:42140;left:85"><nobr>Verbose GC output high level analysis</nobr></div>
<div style="position:absolute;top:42178;left:85"><nobr>It is now time to review the generated GC output.</nobr></div>
<div style="position:absolute;top:42216;left:85"><nobr>First, let's start with the raw data. As you can see below, the GC output is divided into 3 main sections:</nobr></div>
<div style="position:absolute;top:42257;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:42255;left:139"><nobr>5 Minor collections (YoungGen space collections) identified as PSYoungGen</nobr></div>
<div style="position:absolute;top:42278;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:42276;left:139"><nobr>2 Major collections (triggered by System.gc()) identified as Full GC (System)</nobr></div>
<div style="position:absolute;top:42298;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:42297;left:139"><nobr>A detailed Java Heap breakdown of each memory space</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:42838;left:764"><nobr>36 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:42943;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="37"><b>Page 37</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:43029;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:43032;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:43920;left:85"><nobr>Verbose GC data interpretation and sequence</nobr></div>
<div style="position:absolute;top:43958;left:85"><nobr>As you can see from the verbose GC output, the OldGen space was at 340 MB after the initial loading</nobr></div>
<div style="position:absolute;top:43977;left:85"><nobr>of 3M String instances in our HashMap. It did go down to 126 MB following the removal of 2M String</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:44026;left:764"><nobr>37 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:43091;left:101"><nobr>0.437: [GC [<font color="#4f81bd">PSYoungGen</font>: 262208K-&gt;43632K(305856K)]</nobr></div>
<div style="position:absolute;top:43112;left:106"><nobr>262208K-&gt;137900K(1004928K), 0.1396040 secs]</nobr></div>
<div style="position:absolute;top:43132;left:106"><nobr>[Times: user=0.45 sys=0.01, real=0.14 secs]</nobr></div>
<div style="position:absolute;top:43168;left:101"><nobr>0.785: [GC [<font color="#4f81bd">PSYoungGen</font>: 305840K-&gt;43640K(305856K)]</nobr></div>
<div style="position:absolute;top:43189;left:106"><nobr>400108K-&gt;291080K(1004928K), 0.2197630 secs]</nobr></div>
<div style="position:absolute;top:43210;left:106"><nobr>[Times: user=0.56 sys=0.03, real=0.22 secs]</nobr></div>
<div style="position:absolute;top:43246;left:101"><nobr>1.100: [GC [<font color="#4f81bd">PSYoungGen</font>: 164752K-&gt;43632K(305856K)]</nobr></div>
<div style="position:absolute;top:43267;left:106"><nobr>412192K-&gt;340488K(1004928K), 0.0878209 secs]</nobr></div>
<div style="position:absolute;top:43288;left:106"><nobr>[Times: user=0.37 sys=0.00, real=0.09 secs]</nobr></div>
<div style="position:absolute;top:43324;left:101"><nobr>1.188: [<font color="#ff0000">Full GC (System</font>) [PSYoungGen: 43632K-&gt;0K(305856K)]</nobr></div>
<div style="position:absolute;top:43345;left:106"><nobr>[PSOldGen: 296856K-&gt;340433K(699072K)]</nobr></div>
<div style="position:absolute;top:43366;left:106"><nobr>340488K-&gt;340433K(1004928K)</nobr></div>
<div style="position:absolute;top:43386;left:106"><nobr>[PSPermGen: 1554K-&gt;1554K(16384K)], 0.4053311 secs]</nobr></div>
<div style="position:absolute;top:43407;left:106"><nobr>[Times: user=0.41 sys=0.00, real=0.40 secs]</nobr></div>
<div style="position:absolute;top:43443;left:101"><nobr>1.883: [GC [<font color="#4f81bd">PSYoungGen</font>: 262208K-&gt;16K(305856K)]</nobr></div>
<div style="position:absolute;top:43464;left:106"><nobr>602641K-&gt;340449K(1004928K), 0.0326756 secs]</nobr></div>
<div style="position:absolute;top:43485;left:106"><nobr>[Times: user=0.09 sys=0.00, real=0.03 secs]</nobr></div>
<div style="position:absolute;top:43521;left:101"><nobr>2.004: [GC [<font color="#4f81bd">PSYoungGen</font>: 92122K-&gt;0K(305856K)]</nobr></div>
<div style="position:absolute;top:43542;left:106"><nobr>432556K-&gt;340433K(1004928K), 0.0161477 secs]</nobr></div>
<div style="position:absolute;top:43563;left:106"><nobr>[Times: user=0.06 sys=0.00, real=0.02 secs]</nobr></div>
<div style="position:absolute;top:43599;left:101"><nobr>2.020: [<font color="#ff0000">Full GC (System) </font>[PSYoungGen: 0K-&gt;0K(305856K)]</nobr></div>
<div style="position:absolute;top:43620;left:106"><nobr>[PSOldGen: 340433K-&gt;125968K(699072K)]</nobr></div>
<div style="position:absolute;top:43640;left:106"><nobr>340433K-&gt;125968K(1004928K)</nobr></div>
<div style="position:absolute;top:43661;left:106"><nobr>[PSPermGen: 1555K-&gt;1555K(16384K)], 0.2302415 secs]</nobr></div>
<div style="position:absolute;top:43682;left:106"><nobr>[Times: user=0.23 sys=0.00, real=0.23 secs]</nobr></div>
</span></font>
<font size="3" color="#604a7b" face="Times"><span style="font-size:11px;font-family:Times;color:#604a7b">
<div style="position:absolute;top:43718;left:101"><nobr>Heap</nobr></div>
<div style="position:absolute;top:43733;left:101"><nobr>PSYoungGen total 305856K, used 5244K [0x3dac0000, 0x53010000, 0x53010000)</nobr></div>
<div style="position:absolute;top:43754;left:106"><nobr>eden space 262208K, 2% used [0x3dac0000,0x3dfdf168,0x4dad0000)</nobr></div>
<div style="position:absolute;top:43775;left:106"><nobr>from space 43648K, 0% used [0x4dad0000,0x4dad0000,0x50570000)</nobr></div>
<div style="position:absolute;top:43796;left:106"><nobr>to space 43648K, 0% used [0x50570000,0x50570000,0x53010000)</nobr></div>
<div style="position:absolute;top:43811;left:101"><nobr>PSOldGen total 699072K, used 125968K [0x13010000, 0x3dac0000, 0x3dac0000)</nobr></div>
<div style="position:absolute;top:43832;left:106"><nobr>object space 699072K, 18% used [0x13010000,0x1ab140a8,0x3dac0000)</nobr></div>
<div style="position:absolute;top:43847;left:101"><nobr>PSPermGen total 16384K, used 1560K [0x0f010000, 0x10010000, 0x13010000)</nobr></div>
<div style="position:absolute;top:43868;left:106"><nobr>object space 16384K, 9% used [0x0f010000,0x0f1960b0,0x10010000)</nobr></div>
</span></font>

<div style="position:absolute;top:44131;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="38"><b>Page 38</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:44217;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:44220;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:44264;left:85"><nobr>instances.</nobr></div>
<div style="position:absolute;top:44302;left:85"><nobr>Now find below explanation and snapshots on how you can read the GC output data in more detail for</nobr></div>
<div style="position:absolute;top:44321;left:85"><nobr>each Java Heap space.</nobr></div>
<div style="position:absolute;top:44359;left:85"><nobr>## YoungGen space analysis</nobr></div>
<div style="position:absolute;top:44660;left:85"><nobr>## OldGen space analysis</nobr></div>
<div style="position:absolute;top:45063;left:85"><nobr>## PermGen space analysis</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:45214;left:764"><nobr>38 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:45319;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="39"><b>Page 39</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:45405;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:45408;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:45854;left:85"><nobr>## Java Heap breakdown analysis</nobr></div>
<div style="position:absolute;top:46284;left:85"><nobr>Hopefully this sample Java program and verbose GC output analysis has helped you understand how</nobr></div>
<div style="position:absolute;top:46303;left:85"><nobr>to read and interpret this critical data.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:46402;left:764"><nobr>39 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:46507;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="40"><b>Page 40</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:46593;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:46596;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:46641;left:85"><nobr><b>Analyzing thread dumps</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:46714;left:85"><nobr><i><b>Introduction to thread dump analysis</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:46766;left:85"><nobr>This section will teach you how to analyze a JVM Thread Dump and pinpoint the root cause of your</nobr></div>
<div style="position:absolute;top:46785;left:85"><nobr>problem(s). From my perspective, Thread Dump analysis is the most important skillset to master for</nobr></div>
<div style="position:absolute;top:46804;left:85"><nobr>any individual involved in Java EE production support. The amount of information that you can derive</nobr></div>
<div style="position:absolute;top:46823;left:85"><nobr>from Thread Dump snapshots is often much beyond than what you can think of.</nobr></div>
<div style="position:absolute;top:46861;left:85"><nobr>You may find complementary training videos <a href="http://www.youtube.com/watch?v=YQgmF8I-zhk"></a><font color="#000080"><a href="http://www.youtube.com/watch?v=YQgmF8I-zhk">here </a></font>and <a href="http://youtu.be/3dKufRRT_3E"></a><font color="#000080"><a href="http://youtu.be/3dKufRRT_3E">here</a></font><a href="http://youtu.be/3dKufRRT_3E"></a>.</nobr></div>
<div style="position:absolute;top:46899;left:85"><nobr>Before going deeper into Thread Dump analysis and problem patterns, it is very important that you</nobr></div>
<div style="position:absolute;top:46918;left:85"><nobr>understand the fundamentals.</nobr></div>
<div style="position:absolute;top:46956;left:85"><nobr>Java VM overview</nobr></div>
<div style="position:absolute;top:46994;left:85"><nobr>The Java virtual machine is really the foundation of any Java EE platform. This is where your</nobr></div>
<div style="position:absolute;top:47013;left:85"><nobr>middleware and applications are deployed and active.</nobr></div>
<div style="position:absolute;top:47051;left:85"><nobr>The JVM provides the middleware software and your Java / Java EE program with:</nobr></div>
<div style="position:absolute;top:47092;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:47090;left:139"><nobr>A runtime environment for your Java / Java EE program (bytecode format).</nobr></div>
<div style="position:absolute;top:47113;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:47111;left:139"><nobr>Several program features and utilities (IO facilities, data structure, Threads management,</nobr></div>
<div style="position:absolute;top:47130;left:139"><nobr>security, monitoring etc.).</nobr></div>
<div style="position:absolute;top:47152;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:47150;left:139"><nobr>Dynamic memory allocation and management via the garbage collector.</nobr></div>
<div style="position:absolute;top:47188;left:85"><nobr>Your JVM can reside on many OS (Solaris, AIX, Windows etc.) and depending of your physical server</nobr></div>
<div style="position:absolute;top:47207;left:85"><nobr>specifications, you can install 1...n JVM processes per physical / virtual server.</nobr></div>
<div style="position:absolute;top:47245;left:85"><nobr>JVM and Middleware software interactions</nobr></div>
<div style="position:absolute;top:47283;left:85"><nobr>Find below a diagram showing you a high level interaction view between the JVM, middleware and</nobr></div>
<div style="position:absolute;top:47302;left:85"><nobr>application(s).</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:47590;left:764"><nobr>40 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:47695;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="41"><b>Page 41</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:47781;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:47784;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:48441;left:85"><nobr>This is showing you a typical and simple interaction diagram between the JVM, middleware and</nobr></div>
<div style="position:absolute;top:48460;left:85"><nobr>application. As you can see, the Threads allocation for a standard Java EE application are done</nobr></div>
<div style="position:absolute;top:48479;left:85"><nobr>mainly between the middleware kernel itself and JVM (there are some exceptions when application</nobr></div>
<div style="position:absolute;top:48498;left:85"><nobr>itself or some APIs create Threads directly but this is not common and must be done very carefully).</nobr></div>
<div style="position:absolute;top:48536;left:85"><nobr>Also, please note that certain Threads are managed internally within the JVM itself such as GC</nobr></div>
<div style="position:absolute;top:48555;left:85"><nobr>(garbage collection) Threads in order to handle concurrent garbage collections.</nobr></div>
<div style="position:absolute;top:48593;left:85"><nobr>Since most of the Thread allocations are done by the Java EE container, it is important that you</nobr></div>
<div style="position:absolute;top:48612;left:85"><nobr>understand and recognize the Thread Stack Trace and identify it properly from the Thread Dump data.</nobr></div>
<div style="position:absolute;top:48631;left:85"><nobr>This will allow you to understand quickly the type of request that the Java EE container is attempting</nobr></div>
<div style="position:absolute;top:48650;left:85"><nobr>to execute.</nobr></div>
<div style="position:absolute;top:48688;left:85"><nobr>From a Thread Dump analysis perspective, you will learn how to differentiate between the different</nobr></div>
<div style="position:absolute;top:48707;left:85"><nobr>Thread Pools found from the JVM and identify the request type.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:48778;left:764"><nobr>41 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:48883;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="42"><b>Page 42</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:48969;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:48972;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:49016;left:85"><nobr>JVM Thread Dump - what is it?</nobr></div>
<div style="position:absolute;top:49054;left:85"><nobr>A JVM Thread Dump is a snapshot taken at a given time which provides you with a complete listing of</nobr></div>
<div style="position:absolute;top:49073;left:85"><nobr>all created Java Threads.</nobr></div>
<div style="position:absolute;top:49111;left:85"><nobr>Each individual Java Thread found gives you information such as:</nobr></div>
<div style="position:absolute;top:49149;left:85"><nobr>- Thread name; often used by middleware vendors to identify the Thread Id along with its associated</nobr></div>
<div style="position:absolute;top:49168;left:85"><nobr>Thread Pool name and state (running, stuck etc.)</nobr></div>
<div style="position:absolute;top:49209;left:85"><nobr>- Thread type &amp; priority ex: daemon prio=3 <i>** middleware softwares typically create their Threads</i></nobr></div>
<div style="position:absolute;top:49229;left:85"><nobr><i>as daemon meaning their Threads are running in background; providing services to its user e.g. your</i></nobr></div>
<div style="position:absolute;top:49250;left:85"><nobr><i>Java EE application **</i></nobr></div>
<div style="position:absolute;top:49291;left:85"><nobr>- Java Thread ID ex: tid=0x000000011e52a800 <i>** This is the Java Thread Id obtained via</i></nobr></div>
<div style="position:absolute;top:49312;left:85"><nobr><i>java.lang.Thread.getId() and usually implemented as an auto-incrementing long 1..n**</i></nobr></div>
<div style="position:absolute;top:49353;left:85"><nobr>- Native Thread ID ex: nid=0x251c<i>** Crucial information as this native Thread Id allows you to</i></nobr></div>
<div style="position:absolute;top:49373;left:85"><nobr><i>correlate for example which Threads from an OS perspective are using the most CPU within your JVM</i></nobr></div>
<div style="position:absolute;top:49392;left:85"><nobr><i>etc. **</i></nobr></div>
<div style="position:absolute;top:49433;left:85"><nobr>- Java Thread State and detail ex: <font style="font-size:11px">waiting for monitor entry [0xfffffffea5afb000]</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:49452;left:85"><nobr>java.lang.Thread.State: BLOCKED (on object monitor)</nobr></div>
<div style="position:absolute;top:49472;left:85"><nobr><i>** <font style="font-size:14px">Allows to quickly learn about Thread state and its potential current blocking condition **</font></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:49509;left:85"><nobr>- Java Thread Stack Trace; this is by far the most important data that you will find from the Thread</nobr></div>
<div style="position:absolute;top:49528;left:85"><nobr>Dump. This is also where you will spent most of your analysis time since the Java Stack Trace</nobr></div>
<div style="position:absolute;top:49547;left:85"><nobr>provides you with 90% of the information that you need in order to pinpoint root cause of many</nobr></div>
<div style="position:absolute;top:49566;left:85"><nobr>problem pattern types as you will learn later in the training sessions</nobr></div>
<div style="position:absolute;top:49606;left:85"><nobr>- Java Heap breakdown; starting with HotSpot VM 1.6, you will also find at the bottom of the Thread</nobr></div>
<div style="position:absolute;top:49625;left:85"><nobr>Dump snapshot a breakdown of the HotSpot memory spaces utilization such as your Java Heap</nobr></div>
<div style="position:absolute;top:49644;left:85"><nobr>(YoungGen, OldGen) &amp; PermGen space. This is quite useful when excessive GC is suspected as a</nobr></div>
<div style="position:absolute;top:49663;left:85"><nobr>possible root cause so you can do out-of-the-box correlation with Thread data / patterns found</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:49966;left:764"><nobr>42 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:50071;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="43"><b>Page 43</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:50157;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:50160;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:50565;left:85"><nobr>Thread Dump breakdown overview</nobr></div>
<div style="position:absolute;top:50603;left:85"><nobr>In order for you to better understand, find below a diagram showing you a visual breakdown of a</nobr></div>
<div style="position:absolute;top:50622;left:85"><nobr>HotSpot VM Thread Dump and its common Thread Pools found:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:51154;left:764"><nobr>43 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:50221;left:106"><nobr>Heap</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:50238;left:106"><nobr>PSYoungGen <font color="#000000">total 466944K, used 178734K [0xffffffff45c00000, 0xffffffff70800000,</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:50255;left:106"><nobr>0xffffffff70800000)</nobr></div>
<div style="position:absolute;top:50273;left:109"><nobr>eden space 233472K, 76% used</nobr></div>
<div style="position:absolute;top:50290;left:106"><nobr>[0xffffffff45c00000,0xffffffff50ab7c50,0xffffffff54000000)</nobr></div>
<div style="position:absolute;top:50309;left:109"><nobr>from space 233472K, 0% used</nobr></div>
<div style="position:absolute;top:50326;left:106"><nobr>[0xffffffff62400000,0xffffffff62400000,0xffffffff70800000)</nobr></div>
<div style="position:absolute;top:50344;left:109"><nobr>to space 233472K, 0% used</nobr></div>
<div style="position:absolute;top:50361;left:106"><nobr>[0xffffffff54000000,0xffffffff54000000,0xffffffff62400000)</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:50378;left:106"><nobr>PSOldGen</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:50378;left:214"><nobr>total 1400832K, used 1400831K [0xfffffffef0400000,</nobr></div>
<div style="position:absolute;top:50395;left:106"><nobr>0xffffffff45c00000, 0xffffffff45c00000)</nobr></div>
<div style="position:absolute;top:50414;left:109"><nobr>object space 1400832K, 99% used</nobr></div>
<div style="position:absolute;top:50431;left:106"><nobr>[0xfffffffef0400000,0xffffffff45bfffb8,0xffffffff45c00000)</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:50448;left:106"><nobr>PSPermGen</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:50448;left:223"><nobr>total 262144K, used 248475K [0xfffffffed0400000,</nobr></div>
<div style="position:absolute;top:50465;left:106"><nobr>0xfffffffee0400000, 0xfffffffef0400000)</nobr></div>
<div style="position:absolute;top:50484;left:109"><nobr>object space 262144K, 94% used</nobr></div>
<div style="position:absolute;top:50501;left:106"><nobr>[0xfffffffed0400000,0xfffffffedf6a6f08,0xfffffffee0400000)</nobr></div>
</span></font>

<div style="position:absolute;top:51259;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="44"><b>Page 44</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:51345;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:51348;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:52079;left:85"><nobr>As you can there are several pieces of information that you can find from a HotSpot VM Thread Dump.</nobr></div>
<div style="position:absolute;top:52098;left:85"><nobr>Some of these pieces will be more important than others depending of your problem pattern.</nobr></div>
<div style="position:absolute;top:52138;left:85"><nobr>For now, find below a detailed explanation for each Thread Dump section as per our <a href="http://javaeesupportpatterns.blogspot.com/p/java-ee-forum_25.html"></a><font color="#000080"><a href="http://javaeesupportpatterns.blogspot.com/p/java-ee-forum_25.html">sample </a></font>HotSpot</nobr></div>
<div style="position:absolute;top:52157;left:85"><nobr>Thread Dump:</nobr></div>
<div style="position:absolute;top:52195;left:85"><nobr># Full thread dump identifier</nobr></div>
<div style="position:absolute;top:52214;left:85"><nobr>This is basically the unique keyword that you will find in your middleware / standalong Java standard</nobr></div>
<div style="position:absolute;top:52233;left:85"><nobr>output log once you generate a Thread Dump (ex: via kill -3 &lt;PID&gt; for UNIX). This is the beginning of</nobr></div>
<div style="position:absolute;top:52252;left:85"><nobr>the Thread Dump snapshot data.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:52342;left:764"><nobr>44 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:52288;left:104"><nobr>Full thread dump Java HotSpot(TM) 64-Bit Server VM (20.0-b11 mixed mode):</nobr></div>
</span></font>

<div style="position:absolute;top:52447;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="45"><b>Page 45</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:52533;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:52536;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:52599;left:85"><nobr># Java EE middleware, third party &amp; custom application Threads</nobr></div>
<div style="position:absolute;top:52618;left:85"><nobr>This portion is the core of the Thread Dump and where you will typically spend most of your analysis</nobr></div>
<div style="position:absolute;top:52637;left:85"><nobr>time. The number of Threads found will depend on your middleware software that you use, third party</nobr></div>
<div style="position:absolute;top:52656;left:85"><nobr>libraries (that might have its own Threads) and your application (if creating any custom Thread, which</nobr></div>
<div style="position:absolute;top:52675;left:85"><nobr>is generally not a best practice).</nobr></div>
<div style="position:absolute;top:52713;left:85"><nobr>In our sample Thread Dump, Weblogic is the middleware used. Starting with Weblogic 9.2, a self-</nobr></div>
<div style="position:absolute;top:52732;left:85"><nobr>tuning Thread Pool is used with unique identifier "'weblogic.kernel.Default (self-tuning)"</nobr></div>
<div style="position:absolute;top:52998;left:85"><nobr># HotSpot VM Thread</nobr></div>
<div style="position:absolute;top:53036;left:85"><nobr>This is an internal Thread managed by the HotSpot VM in order to perform internal native operations.</nobr></div>
<div style="position:absolute;top:53055;left:85"><nobr>Typically you should not worry about this one unless you see high CPU (via Thread Dump &amp; prstat /</nobr></div>
<div style="position:absolute;top:53074;left:85"><nobr>native Thread id correlation).</nobr></div>
<div style="position:absolute;top:53195;left:85"><nobr># HotSpot GC Thread</nobr></div>
<div style="position:absolute;top:53233;left:85"><nobr>When using HotSpot parallel GC (quite common these days when using multi physical cores</nobr></div>
<div style="position:absolute;top:53252;left:85"><nobr>hardware), the HotSpot VM create by default or as per your JVM tuning a certain # of GC Threads.</nobr></div>
<div style="position:absolute;top:53271;left:85"><nobr>These GC Threads allow the VM to perform its periodic GC cleanups in a parallel manner, leading to</nobr></div>
<div style="position:absolute;top:53290;left:85"><nobr>an overall reduction of the GC time; at the expense of increased CPU utilization.</nobr></div>
<div style="position:absolute;top:53423;left:85"><nobr>This is crucial data as well since when facing GC related problems such as excessive GC, memory</nobr></div>
<div style="position:absolute;top:53442;left:85"><nobr>leaks etc, you will be able to correlate any high CPU observed from the OS / Java process(es) with</nobr></div>
<div style="position:absolute;top:53461;left:85"><nobr>these Threads using their native id value (nid=0x3).</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:53530;left:764"><nobr>45 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:52784;left:101"><nobr>"[STANDBY] ExecuteThread: '414' for queue: 'weblogic.kernel.Default (self-</nobr></div>
<div style="position:absolute;top:52802;left:101"><nobr>tuning)'" daemon prio=3 tid=0x000000010916a800 nid=0x2613 in Object.wait()</nobr></div>
<div style="position:absolute;top:52819;left:101"><nobr>[0xfffffffe9edff000]</nobr></div>
<div style="position:absolute;top:52837;left:112"><nobr>java.lang.Thread.State: WAITING (on object monitor)</nobr></div>
<div style="position:absolute;top:52856;left:131"><nobr>at java.lang.Object.wait(Native Method)</nobr></div>
<div style="position:absolute;top:52874;left:131"><nobr>- waiting on &lt;0xffffffff27d44de0&gt; (a weblogic.work.ExecuteThread)</nobr></div>
<div style="position:absolute;top:52893;left:131"><nobr>at java.lang.Object.wait(Object.java:485)</nobr></div>
<div style="position:absolute;top:52911;left:131"><nobr>at weblogic.work.ExecuteThread.waitForRequest(ExecuteThread.java:160)</nobr></div>
<div style="position:absolute;top:52930;left:131"><nobr>- locked &lt;0xffffffff27d44de0&gt; (a weblogic.work.ExecuteThread)</nobr></div>
<div style="position:absolute;top:52948;left:131"><nobr>at weblogic.work.ExecuteThread.run(ExecuteThread.java:181)</nobr></div>
<div style="position:absolute;top:53126;left:99"><nobr>"VM Periodic Task Thread" prio=3 tid=0x0000000101238800 nid=0x19 waiting on</nobr></div>
<div style="position:absolute;top:53143;left:99"><nobr>condition</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:53345;left:101"><nobr>"GC task thread#0 (ParallelGC)" prio=3 tid=0x0000000100120000 nid=0x3 runnable</nobr></div>
<div style="position:absolute;top:53362;left:101"><nobr>"GC task thread#1 (ParallelGC)" prio=3 tid=0x0000000100131000 nid=0x4 runnable</nobr></div>
</span></font>

<div style="position:absolute;top:53635;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="46"><b>Page 46</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:53721;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:53724;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:53768;left:85"><nobr># JNI global references count</nobr></div>
<div style="position:absolute;top:53806;left:85"><nobr>JNI (Java Native Interface) global references are basically Object references from the native code to a</nobr></div>
<div style="position:absolute;top:53825;left:85"><nobr>Java object managed by the Java garbage collector. Its role is to prevent collection of an object that is</nobr></div>
<div style="position:absolute;top:53844;left:85"><nobr>still in use by native code but technically with no "live" references in the Java code.</nobr></div>
<div style="position:absolute;top:53882;left:85"><nobr>It is also important to keep an eye on JNI references in order to detect JNI related leaks. This can</nobr></div>
<div style="position:absolute;top:53901;left:85"><nobr>happen if you program use JNI directly or using third party tools like monitoring tools which are prone</nobr></div>
<div style="position:absolute;top:53920;left:85"><nobr>to native memory leaks.</nobr></div>
<div style="position:absolute;top:53996;left:85"><nobr># Java Heap utilization view</nobr></div>
<div style="position:absolute;top:54034;left:85"><nobr>This data was added back to JDK 1 .6 and provides you with a short and fast view of your HotSpot</nobr></div>
<div style="position:absolute;top:54053;left:85"><nobr>Heap. I find it quite useful when troubleshooting GC related problems along with HIGH CPU since you</nobr></div>
<div style="position:absolute;top:54072;left:85"><nobr>get both Thread Dump &amp; Java Heap in a single snapshot allowing you to determine (or to rule out) any</nobr></div>
<div style="position:absolute;top:54091;left:85"><nobr>pressure point in a particular Java Heap memory space along with current Thread computing currently</nobr></div>
<div style="position:absolute;top:54110;left:85"><nobr>being done at that time. As you can see in our sample Thread Dump, the Java Heap OldGen is maxed</nobr></div>
<div style="position:absolute;top:54129;left:85"><nobr>out!</nobr></div>
<div style="position:absolute;top:54498;left:85"><nobr>In order for you to quickly identify a problem pattern from a Thread Dump, you first need to understand</nobr></div>
<div style="position:absolute;top:54517;left:85"><nobr>how to read a Thread Stack Trace and how to get the “story” right. This means that if I ask you to tell</nobr></div>
<div style="position:absolute;top:54536;left:85"><nobr>me what the Thread #38 is doing; you should be able to precisely answer; including if Thread Stack</nobr></div>
<div style="position:absolute;top:54555;left:85"><nobr>Trace is showing a healthy (normal) vs. hang condition.</nobr></div>
<div style="position:absolute;top:54593;left:85"><nobr>Java Stack Trace revisited</nobr></div>
<div style="position:absolute;top:54631;left:85"><nobr>Most of you are familiar with Java stack traces. This is typical data that we find from server and</nobr></div>
<div style="position:absolute;top:54650;left:85"><nobr>application log files when a Java Exception is thrown. In this context, a Java stack trace is giving us</nobr></div>
<div style="position:absolute;top:54669;left:85"><nobr>the code execution path of the Thread that triggered the Java Exception such as a</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:54718;left:764"><nobr>46 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:53954;left:128"><nobr>JNI global references: 1925</nobr></div>
<div style="position:absolute;top:54181;left:101"><nobr>Heap</nobr></div>
<div style="position:absolute;top:54200;left:105"><nobr>PSYoungGen     total 466944K, used 178734K [0xffffffff45c00000,</nobr></div>
<div style="position:absolute;top:54217;left:101"><nobr>0xffffffff70800000, 0xffffffff70800000)</nobr></div>
<div style="position:absolute;top:54235;left:109"><nobr>eden space 233472K, 76% used</nobr></div>
<div style="position:absolute;top:54252;left:101"><nobr>[0xffffffff45c00000,0xffffffff50ab7c50,0xffffffff54000000)</nobr></div>
<div style="position:absolute;top:54271;left:109"><nobr>from space 233472K, 0% used</nobr></div>
<div style="position:absolute;top:54288;left:101"><nobr>[0xffffffff62400000,0xffffffff62400000,0xffffffff70800000)</nobr></div>
<div style="position:absolute;top:54306;left:109"><nobr>to   space 233472K, 0% used</nobr></div>
<div style="position:absolute;top:54323;left:101"><nobr>[0xffffffff54000000,0xffffffff54000000,0xffffffff62400000)</nobr></div>
</span></font>
<font size="3" color="#ff0000" face="Times"><span style="font-size:13px;font-family:Times;color:#ff0000">
<div style="position:absolute;top:54342;left:105"><nobr>PSOldGen</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:54342;left:249"><nobr>total 1400832K, used 1400831K [0xfffffffef0400000,</nobr></div>
<div style="position:absolute;top:54359;left:101"><nobr>0xffffffff45c00000, 0xffffffff45c00000)</nobr></div>
<div style="position:absolute;top:54377;left:109"><nobr>object space <font color="#ff0000">1400832K, 99% used</font></nobr></div>
<div style="position:absolute;top:54395;left:101"><nobr>[0xfffffffef0400000,0xffffffff45bfffb8,0xffffffff45c00000)</nobr></div>
<div style="position:absolute;top:54413;left:105"><nobr>PSPermGen     total 262144K, used 248475K [0xfffffffed0400000,</nobr></div>
<div style="position:absolute;top:54430;left:101"><nobr>0xfffffffee0400000, 0xfffffffef0400000)</nobr></div>
<div style="position:absolute;top:54449;left:109"><nobr>object space 262144K, 94% used</nobr></div>
<div style="position:absolute;top:54466;left:101"><nobr>[0xfffffffed0400000,0xfffffffedf6a6f08,0xfffffffee0400000)</nobr></div>
</span></font>

<div style="position:absolute;top:54823;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="47"><b>Page 47</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:54909;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:54912;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:54956;left:85"><nobr>java.lang.NoClassDefFoundError, java.lang.NullPpointerException etc. Such code execution path</nobr></div>
<div style="position:absolute;top:54975;left:85"><nobr>allows us to see the different layers of code that ultimately lead to the Java Exception.</nobr></div>
<div style="position:absolute;top:55013;left:85"><nobr>Java stack traces must always be read from bottom-up:</nobr></div>
<div style="position:absolute;top:55035;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:55034;left:139"><nobr>The line at the bottom will expose the originator of the request such as a Java / Java EE</nobr></div>
<div style="position:absolute;top:55053;left:139"><nobr>container Thread.</nobr></div>
<div style="position:absolute;top:55075;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:55073;left:139"><nobr>The first line at the top of the stack trace will show you the Java class where that last Exception</nobr></div>
<div style="position:absolute;top:55092;left:139"><nobr>got triggered.</nobr></div>
<div style="position:absolute;top:55130;left:85"><nobr>Let's go through this process via a simple example. We created a sample Java program simply</nobr></div>
<div style="position:absolute;top:55149;left:85"><nobr>executing some Class methods calls and throwing an Exception. The program output generated is as</nobr></div>
<div style="position:absolute;top:55168;left:85"><nobr>per below:</nobr></div>
<div style="position:absolute;top:55399;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:55397;left:139"><nobr>Java program JavaSTSimulator is invoked (via the "main" Thread)</nobr></div>
<div style="position:absolute;top:55420;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:55418;left:139"><nobr>The simulator then invokes method call() from Class1</nobr></div>
<div style="position:absolute;top:55440;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:55439;left:139"><nobr>Class1 method call() then invokes Class2 method call()</nobr></div>
<div style="position:absolute;top:55461;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:55459;left:139"><nobr>Class2 method call()throws a Java Exception: java.lang.IllegalArgumentException</nobr></div>
<div style="position:absolute;top:55481;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:55480;left:139"><nobr>The Java Exception is then displayed in the log / standard output</nobr></div>
<div style="position:absolute;top:55518;left:85"><nobr>As you can see, the code execution path that lead to this Exception is always displayed from bottom-</nobr></div>
<div style="position:absolute;top:55536;left:85"><nobr>up.</nobr></div>
<div style="position:absolute;top:55576;left:85"><nobr>The above analysis process should be well known for any Java programmer. What you will see next is</nobr></div>
<div style="position:absolute;top:55595;left:85"><nobr>that the Thread Dump Thread stack trace analysis process is very similar to above Java stack trace</nobr></div>
<div style="position:absolute;top:55614;left:85"><nobr>analysis.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:55670;left:85"><nobr><i><b>Thread Dump: Thread Stack Trace analysis</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:55722;left:85"><nobr>Thread Dump generated from the JVM provides you with a code level execution snapshot of all the</nobr></div>
<div style="position:absolute;top:55741;left:85"><nobr>"created" Threads of the entire JVM process. Created Threads does not mean that all these Threads</nobr></div>
<div style="position:absolute;top:55760;left:85"><nobr>are actually doing something. In a typical Thread Dump snapshot generated from a Java EE container</nobr></div>
<div style="position:absolute;top:55779;left:85"><nobr>JVM:</nobr></div>
<div style="position:absolute;top:55820;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:55819;left:139"><nobr>Some Threads could be performing raw computing tasks such as XML parsing, IO / disk</nobr></div>
<div style="position:absolute;top:55838;left:139"><nobr>access etc.</nobr></div>
<div style="position:absolute;top:55860;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:55858;left:139"><nobr>Some Threads could be waiting for some blocking IO calls such as a remote Web Service call,</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:55906;left:764"><nobr>47 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:55208;left:101"><nobr>JavaStrackTraceSimulator</nobr></div>
<div style="position:absolute;top:55225;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:55242;left:101"><nobr><a href="http://javaeesupportpatterns.blogspot.com/">http://javaeesupportpatterns.blogspot.com</a></nobr></div>
<div style="position:absolute;top:55276;left:101"><nobr>Exception in thread "main" java.lang.<font color="#c00000">IllegalArgumentException</font>:</nobr></div>
<div style="position:absolute;top:55295;left:120"><nobr>at org.ph.javaee.training.td.<font color="#1f497d">Class2</font>.call(Class2.java:12)</nobr></div>
<div style="position:absolute;top:55313;left:120"><nobr>at org.ph.javaee.training.td.<font color="#1f497d">Class1</font>.call(Class1.java:14)</nobr></div>
<div style="position:absolute;top:55332;left:120"><nobr>at org.ph.javaee.training.td.<font color="#1f497d">JavaSTSimulator</font>.main(JavaSTSimulator.java:20)</nobr></div>
</span></font>

<div style="position:absolute;top:56011;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="48"><b>Page 48</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:56097;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:56100;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:56144;left:139"><nobr>a DB / JDBC query etc.</nobr></div>
<div style="position:absolute;top:56167;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56165;left:139"><nobr>Some Threads could be involved in garbage collection at that time e.g. GC Threads</nobr></div>
<div style="position:absolute;top:56187;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56185;left:139"><nobr>Some Threads will be waiting for some work to do (Threads not doing any work typically go in</nobr></div>
<div style="position:absolute;top:56204;left:139"><nobr>wait() state)</nobr></div>
<div style="position:absolute;top:56227;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56225;left:139"><nobr>Some Threads could be waiting for some other Threads work to complete e.g. Threads waiting</nobr></div>
<div style="position:absolute;top:56244;left:139"><nobr>to acquire a monitor lock (synchronized block{}) on some objects</nobr></div>
<div style="position:absolute;top:56282;left:85"><nobr>A Thread stack trace provides you with a snapshot of its current execution. The first line typically</nobr></div>
<div style="position:absolute;top:56301;left:85"><nobr>includes native information of the Thread such as its name, state, address etc. The current execution</nobr></div>
<div style="position:absolute;top:56320;left:85"><nobr>stack trace has to be read from bottom-up. Please follow the analysis process below. The more</nobr></div>
<div style="position:absolute;top:56339;left:85"><nobr>experience you get with Thread Dump analysis, the faster you will able to read and identify very</nobr></div>
<div style="position:absolute;top:56358;left:85"><nobr>quickly the work performed by each Thread:</nobr></div>
<div style="position:absolute;top:56399;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56397;left:139"><nobr>Start to read the Thread stack trace from the bottom.</nobr></div>
<div style="position:absolute;top:56419;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56418;left:139"><nobr>First, identify the originator (Java EE container Thread, custom Thread, GC Thread, JVM</nobr></div>
<div style="position:absolute;top:56437;left:139"><nobr>internal Thread, standalone Java program "main" Thread etc.).</nobr></div>
<div style="position:absolute;top:56459;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56457;left:139"><nobr>The next step is to identify the type of request the Thread is executing (WebApp, Web Service,</nobr></div>
<div style="position:absolute;top:56476;left:139"><nobr>JMS, Remote EJB (RMI), internal Java EE container etc.).</nobr></div>
<div style="position:absolute;top:56499;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56497;left:139"><nobr>The next step is to identify from the execution stack trace your application module(s) involved </nobr></div>
<div style="position:absolute;top:56516;left:139"><nobr>the actual core work the Thread is trying to perform. The complexity of analysis will depend of</nobr></div>
<div style="position:absolute;top:56535;left:139"><nobr>the layers of abstraction of your middleware environment and application.</nobr></div>
<div style="position:absolute;top:56557;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56555;left:139"><nobr>The next step is to look at the last ~10-20 lines prior to the first line. Identify the protocol or</nobr></div>
<div style="position:absolute;top:56574;left:139"><nobr>work the Thread is involved with e.g. HTTP call, Socket communication, JDBC or raw</nobr></div>
<div style="position:absolute;top:56593;left:139"><nobr>computing tasks such as disk access, class loading etc.</nobr></div>
<div style="position:absolute;top:56616;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56614;left:139"><nobr>The next step is to look at the first line. The first line usually tells a LOT on the Thread state</nobr></div>
<div style="position:absolute;top:56633;left:139"><nobr>since it is the current piece of code executed at the time you took the snapshot.</nobr></div>
<div style="position:absolute;top:56655;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:56653;left:139"><nobr>The combination of the last 2 steps is what will give you the core of information to conclude of</nobr></div>
<div style="position:absolute;top:56672;left:139"><nobr>what work and / or hanging condition the Thread is involved with.</nobr></div>
<div style="position:absolute;top:56710;left:85"><nobr>Now find below a visual breakdown of the above steps using a real example of a Thread Dump Thread</nobr></div>
<div style="position:absolute;top:56729;left:85"><nobr>stack trace captured from a JBoss 5 production environment. In this example, many Threads were</nobr></div>
<div style="position:absolute;top:56748;left:85"><nobr>showing a similar problem pattern of excessive IO when creating new instances of JAX-WS Service</nobr></div>
<div style="position:absolute;top:56767;left:85"><nobr>instances.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:57094;left:764"><nobr>48 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:57199;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="49"><b>Page 49</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:57285;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:57288;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:58083;left:85"><nobr>As you can see, the last 10 lines along with the first line will tell us what hanging or slow condition the</nobr></div>
<div style="position:absolute;top:58103;left:85"><nobr>Thread is involved with, if any. The lines from the bottom will give us detail of the originator and type of</nobr></div>
<div style="position:absolute;top:58121;left:85"><nobr>request.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:58178;left:85"><nobr><b>Java Thread CPU analysis on Windows</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:58233;left:85"><nobr>This section will provide you with a tutorial on how you can quickly pinpoint the Java thread</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:58282;left:764"><nobr>49 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:58387;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="50"><b>Page 50</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:58473;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:58476;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:58520;left:85"><nobr>contributors to a high CPU problem on the Windows OS. Windows, like other OS such as Linux,</nobr></div>
<div style="position:absolute;top:58539;left:85"><nobr>Solaris &amp; AIX allow you to monitor the CPU utilization at the process level but also for individual</nobr></div>
<div style="position:absolute;top:58558;left:85"><nobr>Thread executing a task within a process.</nobr></div>
<div style="position:absolute;top:58598;left:85"><nobr>For this tutorial, we created a simple Java program that will allow you to learn this technique in a step</nobr></div>
<div style="position:absolute;top:58617;left:85"><nobr>by step manner.</nobr></div>
<div style="position:absolute;top:58655;left:85"><nobr>Troubleshooting tools</nobr></div>
<div style="position:absolute;top:58693;left:85"><nobr>The following tools will be used below for this tutorial:</nobr></div>
<div style="position:absolute;top:58734;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:58732;left:139"><nobr>Windows Process Explorer (to pinpoint high CPU Thread contributors)</nobr></div>
<div style="position:absolute;top:58755;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:58753;left:139"><nobr>JVM Thread Dump (for Thread correlation and root cause analysis at code level)</nobr></div>
<div style="position:absolute;top:58791;left:85"><nobr>High CPU simulator Java program</nobr></div>
<div style="position:absolute;top:58829;left:85"><nobr>The simple program below is simply looping and creating new String objects. It will allow us to perform</nobr></div>
<div style="position:absolute;top:58848;left:85"><nobr>this CPU per Thread analysis. I recommend that you import it in an IDE of your choice e.g. Eclipse</nobr></div>
<div style="position:absolute;top:58867;left:85"><nobr>and run it from there. You should observe an increase of CPU on your Windows machine as soon as</nobr></div>
<div style="position:absolute;top:58886;left:85"><nobr>you execute it.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:59470;left:764"><nobr>50 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:59575;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="51"><b>Page 51</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:59661;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:59664;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:60658;left:764"><nobr>51 of 127</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:59723;left:106"><nobr><b>package </b><font color="#000000">org.ph.javaee.tool.cpu;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:59758;left:106"><nobr>/**</nobr></div>
<div style="position:absolute;top:59776;left:121"><nobr>* HighCPUSimulator</nobr></div>
<div style="position:absolute;top:59793;left:121"><nobr>* <b><font color="#7f9fbf">@author </font></b>Pierre<font color="#7f7f9f">-</font>Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:59811;left:121"><nobr>* http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:59829;left:121"><nobr>*</nobr></div>
<div style="position:absolute;top:59847;left:121"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:59865;left:106"><nobr><b>public class </b><font color="#000000">HighCPUSimulator {</font></nobr></div>
<div style="position:absolute;top:59900;left:200"><nobr><b>private final static int </b><i><font color="#0000c0">NB_ITERATIONS </font></i><font color="#000000">= 500000000;</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:59935;left:200"><nobr>// ~1 KB data footprint</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:59952;left:200"><nobr><b>private final static </b><font color="#000000">String </font><i><font color="#0000c0">DATA_PREFIX </font></i><font color="#000000">=</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:59970;left:106"><nobr>"datadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadata</nobr></div>
<div style="position:absolute;top:59988;left:106"><nobr>datadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatad</nobr></div>
<div style="position:absolute;top:60005;left:106"><nobr>atadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatada</nobr></div>
<div style="position:absolute;top:60023;left:106"><nobr>tadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadat</nobr></div>
<div style="position:absolute;top:60040;left:106"><nobr>adatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadata</nobr></div>
<div style="position:absolute;top:60058;left:106"><nobr>datadatadatadatadatadatadatadatadatadatadatadatadata"<font color="#000000">;</font></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:60093;left:200"><nobr><b>public static void </b><font color="#000000">main(String[] args) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:60128;left:290"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"HIGH CPU Simulator 1.0"</font>);</nobr></div>
<div style="position:absolute;top:60146;left:290"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Author: Pierre-Hugues Charbonneau"</font>);</nobr></div>
<div style="position:absolute;top:60181;left:106"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"http://javaeesupportpatterns.blogspot.com/"</font>);</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:60216;left:290"><nobr><b>try </b><font color="#000000">{</font></nobr></div>
<div style="position:absolute;top:60251;left:395"><nobr><b>for </b><font color="#000000">(</font><b>int </b><font color="#000000">i = 0; i &lt; </font><i><font color="#0000c0">NB_ITERATIONS</font></i><font color="#000000">; i++) {</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:60286;left:500"><nobr>// Perform some String manipulations</nobr></div>
<div style="position:absolute;top:60304;left:106"><nobr>to slowdown and expose looping process...</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:60321;left:500"><nobr>String data = <i><font color="#0000c0">DATA_PREFIX </font></i>+ i;    </nobr></div>
<div style="position:absolute;top:60357;left:395"><nobr>}</nobr></div>
<div style="position:absolute;top:60392;left:290"><nobr>} <b><font color="#7f0055">catch </font></b>(Throwable any) {</nobr></div>
<div style="position:absolute;top:60409;left:395"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Unexpected Exception! " </font>+</nobr></div>
<div style="position:absolute;top:60427;left:106"><nobr>any.getMessage()</nobr></div>
<div style="position:absolute;top:60445;left:695"><nobr>+ <font color="#2a00ff">" [" </font>+ any +</nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:60462;left:106"><nobr>"]"<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:60497;left:290"><nobr>}</nobr></div>
<div style="position:absolute;top:60532;left:290"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"HighCPUSimulator done!"</font>);</nobr></div>
<div style="position:absolute;top:60550;left:200"><nobr>}</nobr></div>
<div style="position:absolute;top:60585;left:106"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:60763;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="52"><b>Page 52</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:60849;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:60852;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:60915;left:85"><nobr>Step #1 - Launch Process Explorer</nobr></div>
<div style="position:absolute;top:60953;left:85"><nobr>The Process Explorer tool visually shows the CPU usage dynamically. It is good for live analysis. If</nobr></div>
<div style="position:absolute;top:60972;left:85"><nobr>you need historical data on CPU per Thread then you can also use Windows perfmon with %</nobr></div>
<div style="position:absolute;top:60991;left:85"><nobr>Processor Time &amp; Thread Id data counters. You can download Process Explorer from the link <a href="http://technet.microsoft.com/en-us/sysinternals/bb896653"></a><font color="#000080"><a href="http://technet.microsoft.com/en-us/sysinternals/bb896653">here</a></font><a href="http://technet.microsoft.com/en-us/sysinternals/bb896653"></a>.</nobr></div>
<div style="position:absolute;top:61029;left:85"><nobr>In our example, you can see that the Eclipse javaw.exe process is now using ~25% of total CPU</nobr></div>
<div style="position:absolute;top:61048;left:85"><nobr>utilization following the execution of our sample program.</nobr></div>
<div style="position:absolute;top:61674;left:85"><nobr>Step #2 - Launch Process Explorer Threads view</nobr></div>
<div style="position:absolute;top:61712;left:85"><nobr>The next step is to display the Threads view of the javaw.exe process. Simply right click on the</nobr></div>
<div style="position:absolute;top:61731;left:85"><nobr>javaw.exe process and select Properties. The Threads view will be opened as per below snapshot:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:61846;left:764"><nobr>52 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:61951;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="53"><b>Page 53</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:62037;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:62040;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:62543;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:62541;left:139"><nobr>The first column is the Thread Id (decimal format)</nobr></div>
<div style="position:absolute;top:62563;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:62562;left:139"><nobr>The second column is the CPU utilization % used by each Thread</nobr></div>
<div style="position:absolute;top:62584;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:62582;left:139"><nobr>The third column is also another counter indicating if Thread is running on the CPU</nobr></div>
<div style="position:absolute;top:62620;left:85"><nobr>In our example, we can see our primary culprit is Thread Id #5996 using ~ 25% of CPU.</nobr></div>
<div style="position:absolute;top:62658;left:85"><nobr>Step #3 - Generate a JVM Thread Dump</nobr></div>
<div style="position:absolute;top:62696;left:85"><nobr>At this point, Process Explorer will no longer be useful. The goal was to pinpoint one or multiple Java</nobr></div>
<div style="position:absolute;top:62715;left:85"><nobr>Threads consuming most of the Java process CPU utilization which is what we achieved. In order to</nobr></div>
<div style="position:absolute;top:62734;left:85"><nobr>go the next level in your analysis you will need to capture a JVM Thread Dump. This will allow you to</nobr></div>
<div style="position:absolute;top:62753;left:85"><nobr>correlate the Thread Id with the Thread Stack Trace so you can pinpoint that type of processing is</nobr></div>
<div style="position:absolute;top:62772;left:85"><nobr>consuming such high CPU.</nobr></div>
<div style="position:absolute;top:62810;left:85"><nobr>JVM Thread Dump generation can be done in a few manners. If you are using JRockit VM you can</nobr></div>
<div style="position:absolute;top:62829;left:85"><nobr>simply use the jrcmd tool as per below example:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:63034;left:764"><nobr>53 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:63139;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="54"><b>Page 54</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:63225;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:63228;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:63642;left:85"><nobr>Once you have the Thread Dump data, simply search for the Thread Id and locate the Thread Stack</nobr></div>
<div style="position:absolute;top:63661;left:85"><nobr>Trace that you are interested in.</nobr></div>
<div style="position:absolute;top:63699;left:85"><nobr>For our example, the Thread "Main Thread" which was fired from Eclipse got exposed as the primary</nobr></div>
<div style="position:absolute;top:63718;left:85"><nobr>culprit which is exactly what we wanted to demonstrate.</nobr></div>
<div style="position:absolute;top:63889;left:85"><nobr>Step #4 - Analyze the culprit Thread(s) Stack Trace and determine root cause</nobr></div>
<div style="position:absolute;top:63927;left:85"><nobr>At this point you should have everything that you need to move forward with the root cause analysis.</nobr></div>
<div style="position:absolute;top:63946;left:85"><nobr>You will need to review each Thread Stack Trace and determine what type of problem you are dealing</nobr></div>
<div style="position:absolute;top:63965;left:85"><nobr>with. That final step is typically where you will spend most of your time and problem can be simple</nobr></div>
<div style="position:absolute;top:63984;left:85"><nobr>such as infinite looping or complex such as garbage collection related problems.</nobr></div>
<div style="position:absolute;top:64022;left:85"><nobr>In our example, the Thread Dump did reveal the high CPU originates from our sample Java program</nobr></div>
<div style="position:absolute;top:64040;left:85"><nobr>around line 31. As expected, it did reveal the looping condition that we engineered on purpose for this</nobr></div>
<div style="position:absolute;top:64059;left:85"><nobr>tutorial.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:64116;left:85"><nobr><b>Case Study - Too many open files</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:64171;left:85"><nobr>This case study describes the complete root cause analysis and resolution of a File Descriptor (Too</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:64222;left:764"><nobr>54 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:63770;left:101"><nobr>"Main Thread" id=1 idx=0x4 tid=<font color="#990000">5996 </font>prio=5 alive, native_blocked</nobr></div>
<div style="position:absolute;top:63789;left:116"><nobr>at org/ph/javaee/tool/cpu/HighCPUSimulator.main</nobr></div>
<div style="position:absolute;top:63807;left:135"><nobr>(<font color="#c00000">HighCPUSimulator.java:31</font>)</nobr></div>
<div style="position:absolute;top:63826;left:116"><nobr>at jrockit/vm/RNI.c2java(IIIII)V(Native Method)</nobr></div>
<div style="position:absolute;top:63844;left:116"><nobr>-- end of trace</nobr></div>
</span></font>

<div style="position:absolute;top:64327;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="55"><b>Page 55</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:64413;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:64416;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:64460;left:85"><nobr>many open files) related problem that we faced following a migration from Oracle ALSB 2.6 running on</nobr></div>
<div style="position:absolute;top:64479;left:85"><nobr>Solaris OS to Oracle OSB 11g running on AIX.</nobr></div>
<div style="position:absolute;top:64517;left:85"><nobr>This section will also provide you with proper AIX OS commands you can use to troubleshoot and</nobr></div>
<div style="position:absolute;top:64536;left:85"><nobr>validate the File Descriptor configuration of your Java VM process.</nobr></div>
<div style="position:absolute;top:64574;left:85"><nobr>Environment specifications</nobr></div>
<div style="position:absolute;top:64615;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:64614;left:139"><nobr>Java EE server: Oracle Service Bus 11g</nobr></div>
<div style="position:absolute;top:64636;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:64634;left:139"><nobr>Middleware OS: IBM AIX 6.1</nobr></div>
<div style="position:absolute;top:64656;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:64655;left:139"><nobr>Java VM: IBM JRE 1.6.0 SR9 - 64 bit</nobr></div>
<div style="position:absolute;top:64677;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:64675;left:139"><nobr>Platform type: Service Bus - Middle Tier</nobr></div>
<div style="position:absolute;top:64713;left:85"><nobr>Problem overview</nobr></div>
<div style="position:absolute;top:64751;left:85"><nobr>Problem type: java.net.SocketException: Too many open files error was observed under heavy load</nobr></div>
<div style="position:absolute;top:64770;left:85"><nobr>causing our Oracle OSB managed servers to suddenly hang.</nobr></div>
<div style="position:absolute;top:64808;left:85"><nobr>Such problem was observed only during high load and did require our support team to take corrective</nobr></div>
<div style="position:absolute;top:64827;left:85"><nobr>action e.g. shutdown and restart the affected Weblogic OSB managed servers.</nobr></div>
<div style="position:absolute;top:64865;left:85"><nobr>Gathering and validation of facts</nobr></div>
<div style="position:absolute;top:64903;left:85"><nobr>As usual, a Java EE problem investigation requires gathering of technical and non technical facts so</nobr></div>
<div style="position:absolute;top:64922;left:85"><nobr>we can either derive other facts and/or conclude on the root cause. Before applying a corrective</nobr></div>
<div style="position:absolute;top:64941;left:85"><nobr>measure, the facts below were verified in order to conclude on the root cause:</nobr></div>
<div style="position:absolute;top:64982;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:64980;left:139"><nobr>What is the client impact? <i>HIGH; Full JVM hang</i></nobr></div>
<div style="position:absolute;top:65003;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:65001;left:139"><nobr>Recent change of the affected platform? <i>Yes, recent migration from ALSB 2.6 (Solaris OS) to</i></nobr></div>
<div style="position:absolute;top:65020;left:139"><nobr><i>Oracle OSB 11g (AIX OS)</i></nobr></div>
<div style="position:absolute;top:65042;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:65040;left:139"><nobr>Any recent traffic increase to the affected platform? <i>No</i></nobr></div>
<div style="position:absolute;top:65063;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:65061;left:139"><nobr>What is the health of the Weblogic server? <i>Affected managed servers were no longer</i></nobr></div>
<div style="position:absolute;top:65080;left:139"><nobr><i>responsive along with closure of the Weblogic HTTP (Server Socket) port</i></nobr></div>
<div style="position:absolute;top:65102;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:65101;left:139"><nobr>Did a restart of the Weblogic Integration server resolve the problem? <i>Yes but temporarily only</i></nobr></div>
<div style="position:absolute;top:65139;left:85"><nobr>Conclusion #1: The problem appears to be load related</nobr></div>
<div style="position:absolute;top:65177;left:85"><nobr>Weblogic server log files review</nobr></div>
<div style="position:absolute;top:65214;left:85"><nobr>A quick review of the affected managed servers log did reveal the error below:</nobr></div>
<div style="position:absolute;top:65309;left:85"><nobr>This error indicates that our Java VM process was running out of File Descriptor. This is a severe</nobr></div>
<div style="position:absolute;top:65328;left:85"><nobr>condition that will affect the whole Java VM process and cause Weblogic to close its internal Server</nobr></div>
<div style="position:absolute;top:65347;left:85"><nobr>Socket port (HTTP/HTTPS port) preventing any further inbound &amp; outbound communication to the</nobr></div>
<div style="position:absolute;top:65366;left:85"><nobr>affected managed server(s).</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:65410;left:764"><nobr>55 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:65267;left:111"><nobr>java.net.SocketException: Too many open files</nobr></div>
</span></font>

<div style="position:absolute;top:65515;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="56"><b>Page 56</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:65601;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:65604;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:65667;left:85"><nobr>File Descriptor - Why so important for an Oracle OSB environment?</nobr></div>
<div style="position:absolute;top:65705;left:85"><nobr>The File Descriptor capacity is quite important for your Java VM process. The key concept you must</nobr></div>
<div style="position:absolute;top:65724;left:85"><nobr>understand is that File Descriptors are not only required for pure File Handles but also for inbound and</nobr></div>
<div style="position:absolute;top:65743;left:85"><nobr>outbound Socket communication. Each new Java Socket created to (inbound) or from (outound) your</nobr></div>
<div style="position:absolute;top:65762;left:85"><nobr>Java VM by Weblogic kernel Socket Muxer requires a File Descriptor allocation at the OS level.</nobr></div>
<div style="position:absolute;top:65800;left:85"><nobr>An Oracle OSB environment can require a significant number of Sockets depending how much</nobr></div>
<div style="position:absolute;top:65819;left:85"><nobr>inbound load it receives and how much outbound connections (Java Sockets) it has to create in order</nobr></div>
<div style="position:absolute;top:65838;left:85"><nobr>to send and receive data from external / downstream systems (System End Points).</nobr></div>
<div style="position:absolute;top:65876;left:85"><nobr>For that reason, you must ensure that you allocate enough File Descriptors / Sockets to your Java VM</nobr></div>
<div style="position:absolute;top:65895;left:85"><nobr>process in order to support your daily load; including problematic scenarios such as sudden slowdown</nobr></div>
<div style="position:absolute;top:65914;left:85"><nobr>of external systems which typically increase the demand on the File Descriptor allocation.</nobr></div>
<div style="position:absolute;top:65952;left:85"><nobr>Runtime File Descriptor capacity check for Java VM and AIX OS</nobr></div>
<div style="position:absolute;top:65990;left:85"><nobr>Following the discovery of this error, our technical team did perform a quick review of the current</nobr></div>
<div style="position:absolute;top:66009;left:85"><nobr>observed runtime File Descriptor capacity &amp; utilization of our OSB Java VM processes. This can be</nobr></div>
<div style="position:absolute;top:66028;left:85"><nobr>done easily via the following AIX command:</nobr></div>
<div style="position:absolute;top:66104;left:85"><nobr>## Java VM process File Descriptor total capacity</nobr></div>
<div style="position:absolute;top:66218;left:85"><nobr>## Java VM process File Descriptor current utilization</nobr></div>
<div style="position:absolute;top:66331;left:85"><nobr>As you can see, the current capacity was found at 2000; which is quite low for a medium size Oracle</nobr></div>
<div style="position:absolute;top:66350;left:85"><nobr>OSB environment. The average utilization under heavy load was also found to be quite close to the</nobr></div>
<div style="position:absolute;top:66369;left:85"><nobr>upper limit of 2000.</nobr></div>
<div style="position:absolute;top:66409;left:85"><nobr>The next step was to verify the default AIX OS File Descriptor limit via the command:</nobr></div>
<div style="position:absolute;top:66523;left:85"><nobr>Conclusion #2: The current File Descriptor limit for both OS and OSB Java VM appears to be quite low</nobr></div>
<div style="position:absolute;top:66542;left:85"><nobr>and setup at 2000. The File Descriptor utilization was also found to be quite close to the upper limit</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:66598;left:764"><nobr>56 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:66064;left:111"><nobr>procfiles &lt;Java PID&gt; | grep rlimit &amp; lsof -p &lt;Java PID&gt; | wc -l</nobr></div>
<div style="position:absolute;top:66159;left:123"><nobr>&gt;&gt; procfiles 5425732 | grep rlimit</nobr></div>
<div style="position:absolute;top:66176;left:141"><nobr>Current rlimit: <font color="#c00000">2000 </font>file descriptors</nobr></div>
<div style="position:absolute;top:66273;left:123"><nobr>&gt;&gt; lsof -p &lt;Java PID&gt; | wc -l</nobr></div>
</span></font>
<font size="3" color="#c00000" face="Courier"><span style="font-size:13px;font-family:Courier;color:#c00000">
<div style="position:absolute;top:66290;left:132"><nobr>1920</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:66465;left:111"><nobr>&gt;&gt; ulimit -S -n</nobr></div>
<div style="position:absolute;top:66481;left:129"><nobr>2000</nobr></div>
</span></font>

<div style="position:absolute;top:66703;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="57"><b>Page 57</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:66789;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:66792;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:66836;left:85"><nobr>which explains why so many JVM failures were observed at peak load.</nobr></div>
<div style="position:absolute;top:66874;left:85"><nobr>Weblogic File Descriptor configuration review</nobr></div>
<div style="position:absolute;top:66912;left:85"><nobr>The File Descriptor limit can typically be overwritten when you start your Weblogic Java VM. Such</nobr></div>
<div style="position:absolute;top:66931;left:85"><nobr>configuration is managed by the WLS core layer and script can be found at the following location:</nobr></div>
<div style="position:absolute;top:67045;left:85"><nobr>Root cause: File Descriptor override only working for Solaris OS!</nobr></div>
<div style="position:absolute;top:67083;left:85"><nobr>As you can see with the script screenshot below, the override of the File Descriptor limit via ulimit is</nobr></div>
<div style="position:absolute;top:67102;left:85"><nobr>only applicable for Solaris OS (SunOS) which explains why our current OSB Java VM running on AIX</nobr></div>
<div style="position:absolute;top:67121;left:85"><nobr>OS did end up with the default value of 2000 vs. our older ALSB 2.6 environment running on Solaris</nobr></div>
<div style="position:absolute;top:67140;left:85"><nobr>OS which had a File Descriptor limit of 65536.</nobr></div>
<div style="position:absolute;top:67663;left:85"><nobr>Solution: script tweaking for AIX OS</nobr></div>
<div style="position:absolute;top:67701;left:85"><nobr>The resolution of this problem was done by modifying the Weblogic commEnv script as per below.</nobr></div>
<div style="position:absolute;top:67720;left:85"><nobr>This change did ensure a configuration of 65536 File Descriptor (from 2000); including for the AIX OS:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:67786;left:764"><nobr>57 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:66984;left:158"><nobr>&lt;WL_HOME&gt;/wlserver_10.3/common/bin/commEnv.sh</nobr></div>
</span></font>

<div style="position:absolute;top:67891;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="58"><b>Page 58</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:67977;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:67980;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:68483;left:85"><nobr><i>** Please note that the activation of any change to the Weblogic File Descriptor configuration requires</i></nobr></div>
<div style="position:absolute;top:68502;left:85"><nobr><i>a restart of both the Node Manager (if used) along with the managed servers. **</i></nobr></div>
<div style="position:absolute;top:68542;left:85"><nobr>A runtime validation was also performed following the activation of the new configuration which did</nobr></div>
<div style="position:absolute;top:68561;left:85"><nobr>confirm the new active File Descriptor limit:</nobr></div>
<div style="position:absolute;top:68655;left:85"><nobr>No failure has been observed since then.</nobr></div>
<div style="position:absolute;top:68693;left:85"><nobr>Conclusion and recommendations</nobr></div>
<div style="position:absolute;top:68731;left:85"><nobr>When upgrading your Weblogic Java EE container to a new version, please ensure that you verify</nobr></div>
<div style="position:absolute;top:68750;left:85"><nobr>your current File Descriptor limit as per the above case study. From a capacity planning perspective,</nobr></div>
<div style="position:absolute;top:68769;left:85"><nobr>please ensure that you monitor your File Descriptor utilizaiton on a regular basis in order to identify</nobr></div>
<div style="position:absolute;top:68788;left:85"><nobr>any potential capacity problem, Socket leak etc.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:68845;left:85"><nobr><b>GC overhead limit exceeded – Analysis and Patterns</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:68900;left:85"><nobr>This section will provide you with a description of this new JVM 1.6 HotSpot OutOfMemoryError error</nobr></div>
<div style="position:absolute;top:68919;left:85"><nobr>message and how you should attack this problem until its resolution.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:68974;left:764"><nobr>58 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:68597;left:123"><nobr>&gt;&gt; procfiles 6416839 | grep rlimit</nobr></div>
<div style="position:absolute;top:68614;left:141"><nobr>Current rlimit: 65536 file descriptors</nobr></div>
</span></font>

<div style="position:absolute;top:69079;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="59"><b>Page 59</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:69165;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:69168;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:69233;left:85"><nobr>You can also refer to this post for a <a href="http://javaeesupportpatterns.blogspot.com/2010/12/post-test.html"></a><font color="#000080"><a href="http://javaeesupportpatterns.blogspot.com/2010/12/post-test.html">real case study </a></font>on a Java Heap problem (<i>OutOfMemoryError: GC</i></nobr></div>
<div style="position:absolute;top:69252;left:85"><nobr><i>overhead limit exceeded</i>) affecting a JBoss production system.</nobr></div>
<div style="position:absolute;top:69290;left:85"><nobr>java.lang.OutOfMemoryError: GC overhead limit exceeded - what is it?</nobr></div>
<div style="position:absolute;top:69328;left:85"><nobr>Everyone involved in Java EE production support is familiar with OutOfMemoryError problems since</nobr></div>
<div style="position:absolute;top:69347;left:85"><nobr>they are one of the most common problem type you can face. However, if your environment recently</nobr></div>
<div style="position:absolute;top:69366;left:85"><nobr>upgraded to Java HotSpot 1.6 VM, you may have observed this error message in the logs:</nobr></div>
<div style="position:absolute;top:69385;left:85"><nobr><i>java.lang.OutOfMemoryError: GC overhead limit exceeded</i>.</nobr></div>
<div style="position:absolute;top:69423;left:85"><nobr>GC overhead limit exceeded is a new policy that was added by default for the Java HotSpot VM 1.6</nobr></div>
<div style="position:absolute;top:69442;left:85"><nobr>only. It basically allows the VM to detect potential OutOfMemoryError conditions earlier and before it</nobr></div>
<div style="position:absolute;top:69461;left:85"><nobr>runs out of Java Heap space; allowing the JVM to abort the current Thread(s) processing with this</nobr></div>
<div style="position:absolute;top:69480;left:85"><nobr>OOM error.</nobr></div>
<div style="position:absolute;top:69518;left:85"><nobr>The official Sun statement is provided below:</nobr></div>
<div style="position:absolute;top:69555;left:85"><nobr><i>The parallel / concurrent collector will throw an OutOfMemoryError if too much time is being spent in</i></nobr></div>
<div style="position:absolute;top:69575;left:85"><nobr><i>garbage collection: if more than 98% of the total time is spent in garbage collection and less than 2%</i></nobr></div>
<div style="position:absolute;top:69593;left:85"><nobr><i>of the heap is recovered, an OutOfMemoryError will be thrown. This feature is designed to prevent</i></nobr></div>
<div style="position:absolute;top:69612;left:85"><nobr><i>applications from running for an extended period of time while making little or no progress because</i></nobr></div>
<div style="position:absolute;top:69631;left:85"><nobr><i>the heap is too small. If necessary, this feature can be disabled by adding the option -XX:-</i></nobr></div>
<div style="position:absolute;top:69650;left:85"><nobr><i>UseGCOverheadLimit to the command line.</i></nobr></div>
<div style="position:absolute;top:69688;left:85"><nobr>Is it useful for Java EE production systems?</nobr></div>
<div style="position:absolute;top:69726;left:85"><nobr>I have found on most of my problem cases that this new policy is useful at some level since it is</nobr></div>
<div style="position:absolute;top:69745;left:85"><nobr>preventing a full JVM hang and allowing you to take some actions such as data collection, JVM Heap</nobr></div>
<div style="position:absolute;top:69764;left:85"><nobr>Dump, JVM Thread Dump etc. before the whole JVM becomes unresponsive.</nobr></div>
<div style="position:absolute;top:69802;left:85"><nobr>But don't expect this new feature to fix your Java Heap problem, it is meant to prevent a full JVM hang</nobr></div>
<div style="position:absolute;top:69821;left:85"><nobr>and to abort some big memory allocation etc. you must still perform your own analysis and due</nobr></div>
<div style="position:absolute;top:69840;left:85"><nobr>diligence.</nobr></div>
<div style="position:absolute;top:69878;left:85"><nobr>Is there any scenario where it can cause more harm than good?</nobr></div>
<div style="position:absolute;top:69916;left:85"><nobr>Yes, Java applications dealing with large memory allocations / chunks could see much more frequent</nobr></div>
<div style="position:absolute;top:69935;left:85"><nobr>OOM due to GC overhead limit exceeded. Some applications dealing with a long GC elapsed time but</nobr></div>
<div style="position:absolute;top:69954;left:85"><nobr>healthy overall memory usage could also be affected.</nobr></div>
<div style="position:absolute;top:69992;left:85"><nobr>In the above scenarios, you may want to consider turning OFF this policy and see if it's helping your</nobr></div>
<div style="position:absolute;top:70011;left:85"><nobr>environment stability.</nobr></div>
<div style="position:absolute;top:70049;left:85"><nobr>java.lang.OutOfMemoryError: GC overhead limit exceeded - can I disable it?</nobr></div>
<div style="position:absolute;top:70087;left:85"><nobr>Yes, you can disable this default policy by simply adding this parameter at your JVM start-up:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:70162;left:764"><nobr>59 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:70267;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="60"><b>Page 60</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:70353;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:70356;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:70457;left:85"><nobr>Please keep in mind that this error is very likely to be a symptom of a JVM Heap / tuning problem so</nobr></div>
<div style="position:absolute;top:70476;left:85"><nobr>my recommendation to you is always to focus on the root cause as opposed to the symptom.</nobr></div>
<div style="position:absolute;top:70514;left:85"><nobr>java.lang.OutOfMemoryError: GC overhead limit exceeded - how can I fix it?</nobr></div>
<div style="position:absolute;top:70552;left:85"><nobr>You should not worry too much about the GC overhead limit error itself since it's very likely just a</nobr></div>
<div style="position:absolute;top:70571;left:85"><nobr>symptom / hint. What you must focus on is on your potential Java Heap problem(s) such as Java</nobr></div>
<div style="position:absolute;top:70590;left:85"><nobr>Heap leak, improper Java Heap tuning etc. Find below a list of high level steps to troubleshoot further:</nobr></div>
<div style="position:absolute;top:70631;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:70629;left:139"><nobr>If not done already, enabled verbose GC &gt;&gt; -verbose:gc</nobr></div>
<div style="position:absolute;top:70652;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:70650;left:139"><nobr>Analyze the verbose GC output and determine the memory footprint of the Java Heap;</nobr></div>
<div style="position:absolute;top:70669;left:139"><nobr>including the ratio of Young Gen vs. Old Gen. Having an old gen footprint too high will lead to</nobr></div>
<div style="position:absolute;top:70688;left:139"><nobr>too many frequent Full GC and ultimately to the OOM: GC overhead limit exceeded.</nobr></div>
<div style="position:absolute;top:70710;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:70709;left:139"><nobr>Analyze the verbose GC output or use a tool like JConsole to determine if your Java Heap is</nobr></div>
<div style="position:absolute;top:70728;left:139"><nobr>leaking over time. This can be observed via monitoring of the HotSpot old gen space.</nobr></div>
<div style="position:absolute;top:70750;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:70748;left:139"><nobr>Look at your young Gen requirement as well, if you application generates a lot of short live</nobr></div>
<div style="position:absolute;top:70767;left:139"><nobr>objects then your Java Heap space must be big enough in order for the VM to allocate a bigger</nobr></div>
<div style="position:absolute;top:70786;left:139"><nobr>Young Gen space.</nobr></div>
<div style="position:absolute;top:70808;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:70807;left:139"><nobr>If facing a Java Heap leak and/or if you have concern on your Old Gen footprint then add the</nobr></div>
<div style="position:absolute;top:70826;left:139"><nobr>following parameter to your start-up JVM arguments: -XX:+HeapDumpOnOutOfMemoryError.</nobr></div>
<div style="position:absolute;top:70845;left:139"><nobr>This will generate a Heap Dump (hprof format) on OOM event that you can analyze using a</nobr></div>
<div style="position:absolute;top:70863;left:139"><nobr>tool like Memory Analyzer or Jhat.</nobr></div>
<div style="position:absolute;top:70901;left:85"><nobr>Heap Analysis</nobr></div>
<div style="position:absolute;top:70939;left:85"><nobr>Now we will provide you with a sample program and a tutorial on how to analyze your Java HotSpot</nobr></div>
<div style="position:absolute;top:70958;left:85"><nobr>Heap footprint using Memory Analyzer following an OutOfMemoryError. I highly recommend that you</nobr></div>
<div style="position:absolute;top:70977;left:85"><nobr>execute and analyse the Heap Dump yourself using this tutorial in order to better understand these</nobr></div>
<div style="position:absolute;top:70996;left:85"><nobr>principles.</nobr></div>
<div style="position:absolute;top:71034;left:85"><nobr>Troubleshooting tools</nobr></div>
<div style="position:absolute;top:71072;left:85"><nobr><i>** all these tools can be downloaded for free **</i></nobr></div>
<div style="position:absolute;top:71113;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:71112;left:139"><nobr>Eclipse Indigo Release</nobr></div>
<div style="position:absolute;top:71134;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:71132;left:139"><nobr>Memory Analyzer via IBM Support Assistant 4.1 (HotSpot Heap Dump analysis)</nobr></div>
<div style="position:absolute;top:71155;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:71153;left:139"><nobr>Java VM: Windows HotSpot  JRE 1.6.0_24 64-bit</nobr></div>
<div style="position:absolute;top:71191;left:85"><nobr>Sample Java program</nobr></div>
<div style="position:absolute;top:71229;left:85"><nobr>The simple sample Java program below will be used to triggered an OutOfMemoryError; allowing us to</nobr></div>
<div style="position:absolute;top:71248;left:85"><nobr>analyze the generated HotSpot Heap Dump file. Simply create a new Java class :</nobr></div>
<div style="position:absolute;top:71267;left:85"><nobr>JVMOutOfMemoryErrorSimulator.java to the Eclipse project of your choice and either rename or keep</nobr></div>
<div style="position:absolute;top:71286;left:85"><nobr>the current package as is.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:71350;left:764"><nobr>60 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:14px;font-family:Courier">
<div style="position:absolute;top:70418;left:124"><nobr>-XX:-UseGCOverheadLimit</nobr></div>
</span></font>

<div style="position:absolute;top:71455;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="61"><b>Page 61</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:71541;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:71544;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:71588;left:85"><nobr>This program is basically creating multiple String instances within a Map data structure until the Java</nobr></div>
<div style="position:absolute;top:71607;left:85"><nobr>Heap depletion.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:72538;left:764"><nobr>61 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:72643;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="62"><b>Page 62</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:72729;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:72732;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:73726;left:764"><nobr>62 of 127</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:11px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:72791;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.javaheap;</font></nobr></div>
<div style="position:absolute;top:72822;left:101"><nobr><b>import </b><font color="#000000">java.util.Map;</font></nobr></div>
<div style="position:absolute;top:72838;left:101"><nobr><b>import </b><font color="#000000">java.util.HashMap;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:11px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:72870;left:101"><nobr>/**</nobr></div>
<div style="position:absolute;top:72886;left:105"><nobr>* JVMOutOfMemoryErrorSimulator</nobr></div>
<div style="position:absolute;top:72902;left:105"><nobr>*</nobr></div>
<div style="position:absolute;top:72918;left:105"><nobr>* <b><font color="#7f9fbf">@author </font></b>PH</nobr></div>
<div style="position:absolute;top:72934;left:105"><nobr>*</nobr></div>
<div style="position:absolute;top:72950;left:105"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:11px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:72966;left:101"><nobr><b>public class </b><font color="#000000">JVMOutOfMemoryErrorSimulator {</font></nobr></div>
<div style="position:absolute;top:72997;left:125"><nobr><b>private final static int </b><i><font color="#0000c0">NB_ITERATIONS </font></i><font color="#000000">= 500000;</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:11px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:73029;left:125"><nobr>// ~1 KB data footprint</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:11px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:73045;left:125"><nobr><b>private final static </b><font color="#000000">String </font><i><font color="#0000c0">LEAKING_DATA_PREFIX </font></i><font color="#000000">=</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:11px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:73060;left:101"><nobr>"datadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadat</nobr></div>
<div style="position:absolute;top:73076;left:101"><nobr>adatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadatadat</nobr></div>
<div style="position:absolute;top:73092;left:101"><nobr>adatadatadatadatadatadatadatadatadatadatadatadatadatadatadatada"<font color="#000000">;</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:11px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:73123;left:125"><nobr>// Map used to stored our leaking String instances</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:11px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:73140;left:125"><nobr><b>private static </b><font color="#000000">Map&lt;String, String&gt; </font><i><font color="#0000c0">leakingMap</font></i><font color="#000000">;</font></nobr></div>
<div style="position:absolute;top:73155;left:125"><nobr><b>static </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" color="#0000c0" face="Times"><span style="font-size:11px;font-family:Times;color:#0000c0">
<div style="position:absolute;top:73171;left:148"><nobr><i>leakingMap </i><font color="#000000">= </font><b><font color="#7f0055">new </font></b><font color="#000000">HashMap&lt;String, String&gt;();</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:73187;left:125"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:11px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:73219;left:125"><nobr><b>public static void </b><font color="#000000">main(String[] args) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:73250;left:148"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"JVM OutOfMemoryError Simulator 1.0"</font>);</nobr></div>
<div style="position:absolute;top:73266;left:148"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Author: Pierre-Hugues Charbonneau"</font>);</nobr></div>
<div style="position:absolute;top:73282;left:148"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"http://javaeesupportpatterns.blogspot.com/"</font>);</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:11px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:73314;left:148"><nobr><b>try </b><font color="#000000">{</font></nobr></div>
<div style="position:absolute;top:73345;left:172"><nobr><b>for </b><font color="#000000">(</font><b>int </b><font color="#000000">i = 0; i &lt; </font><i><font color="#0000c0">NB_ITERATIONS</font></i><font color="#000000">; i++) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:73377;left:192"><nobr>String data = <i><font color="#0000c0">LEAKING_DATA_PREFIX </font></i>+ i;</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:11px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:73393;left:192"><nobr>// Add data to our leaking Map data structure...</nobr></div>
</span></font>
<font size="3" color="#0000c0" face="Times"><span style="font-size:11px;font-family:Times;color:#0000c0">
<div style="position:absolute;top:73409;left:192"><nobr><i>leakingMap</i><font color="#000000">.put(data, data);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:73440;left:172"><nobr>}</nobr></div>
<div style="position:absolute;top:73472;left:148"><nobr>} <b><font color="#7f0055">catch </font></b>(Throwable any) {</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:11px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:73488;left:172"><nobr><b>if </b><font color="#000000">(any </font><b>instanceof </b><font color="#000000">java.lang.OutOfMemoryError) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:73504;left:196"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"OutOfMemoryError triggered! "</font></nobr></div>
<div style="position:absolute;top:73520;left:240"><nobr>+ any.getMessage() + <font color="#2a00ff">" [" </font>+ any + <font color="#2a00ff">"]"</font>);</nobr></div>
<div style="position:absolute;top:73551;left:172"><nobr>} <b><font color="#7f0055">else </font></b>{</nobr></div>
<div style="position:absolute;top:73567;left:192"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Unexpected Exception! " </font>+ any.getMessage()</nobr></div>
<div style="position:absolute;top:73583;left:240"><nobr>+ <font color="#2a00ff">" [" </font>+ any + <font color="#2a00ff">"]"</font>);</nobr></div>
<div style="position:absolute;top:73599;left:172"><nobr>}</nobr></div>
<div style="position:absolute;top:73615;left:148"><nobr>}</nobr></div>
<div style="position:absolute;top:73631;left:148"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"simulator done!"</font>);</nobr></div>
<div style="position:absolute;top:73647;left:125"><nobr>}</nobr></div>
<div style="position:absolute;top:73678;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:73831;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="63"><b>Page 63</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:73917;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:73920;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:73964;left:85"><nobr>Step #1 - Setup your JVM start-up arguments</nobr></div>
<div style="position:absolute;top:74002;left:85"><nobr>First, setup your Eclipse Java runtime arguments as per below. For our example, we used an external</nobr></div>
<div style="position:absolute;top:74021;left:85"><nobr>JRE 1.6 outside the Eclipse IDE with a Java Heap maximum capacity of 512 MB.</nobr></div>
<div style="position:absolute;top:74059;left:85"><nobr>The key JVM argument allowing us to generate a Heap Dump is -XX:</nobr></div>
<div style="position:absolute;top:74078;left:85"><nobr>+HeapDumpOnOutOfMemoryError which tells the JVM to generate a Heap Dump following an</nobr></div>
<div style="position:absolute;top:74097;left:85"><nobr>OutOfMemoryError condition.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:74914;left:764"><nobr>63 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:75019;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="64"><b>Page 64</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:75105;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:75108;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:75152;left:85"><nobr>Step #2 - Run the sample Java program</nobr></div>
<div style="position:absolute;top:75190;left:85"><nobr>The next step is to run our Java program. Depending on your computer specs, this program will run</nobr></div>
<div style="position:absolute;top:75209;left:85"><nobr>between 5-30 seconds before exiting with an OutOfMemoryError.</nobr></div>
<div style="position:absolute;top:75534;left:85"><nobr>As you can see, the JVM generated a Heap Dump file java_pid3880.hprof. It is now time to fire the</nobr></div>
<div style="position:absolute;top:75553;left:85"><nobr>Memory Analyzer tool and analyze the JVM Heap Dump.</nobr></div>
<div style="position:absolute;top:75591;left:85"><nobr>Step #3 - Load the Heap Dump</nobr></div>
<div style="position:absolute;top:75629;left:85"><nobr>Analyzing a Heap Dump is an analysis activity that can be simple or very complex. The goal of this</nobr></div>
<div style="position:absolute;top:75648;left:85"><nobr>tutorial is to give you the basics of Heap Dump analysis. For more Heap Dump analysis, please refer</nobr></div>
<div style="position:absolute;top:75667;left:85"><nobr>to the other case studies presented in this handbook.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:76102;left:764"><nobr>64 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:76207;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="65"><b>Page 65</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:76293;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:76296;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:77290;left:764"><nobr>65 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:77395;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="66"><b>Page 66</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:77481;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:77484;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:78032;left:85"><nobr>Step #4 - Analyze Heap Dump</nobr></div>
<div style="position:absolute;top:78070;left:85"><nobr>Below are the snapshots and analysis steps that you can follow to understand the memory leak that</nobr></div>
<div style="position:absolute;top:78089;left:85"><nobr>we simulated in our sample Java program.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:78478;left:764"><nobr>66 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:78583;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="67"><b>Page 67</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:78669;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:78672;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:79666;left:764"><nobr>67 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:79771;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="68"><b>Page 68</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:79857;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:79860;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:80854;left:764"><nobr>68 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:80959;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="69"><b>Page 69</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:81045;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:81048;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:81550;left:85"><nobr>As you can see, the Heap Dump analysis using the Memory Analyzer tool was able to easily identify</nobr></div>
<div style="position:absolute;top:81569;left:85"><nobr>our primary leaking Java class and data structure.</nobr></div>
<div style="position:absolute;top:81607;left:85"><nobr>Conclusion</nobr></div>
<div style="position:absolute;top:81645;left:85"><nobr>I hope this simple Java program and Heap Dump analysis tutorial has helped you understand the</nobr></div>
<div style="position:absolute;top:81664;left:85"><nobr>basic principles of Java Heap analysis using the raw Heap Dump data. This analysis is critical when</nobr></div>
<div style="position:absolute;top:81683;left:85"><nobr>dealing with OutOfMemoryError: GC overhead problems since those are symptoms of either Java</nobr></div>
<div style="position:absolute;top:81702;left:85"><nobr>Heap leak of Java Heap footprint / tuning problem.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:81758;left:85"><nobr><b>Java deadlock troubleshooting and analysis</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:81813;left:85"><nobr>This section will revisit the classic thread problem of deadlocks and summarize some key</nobr></div>
<div style="position:absolute;top:81833;left:85"><nobr>troubleshooting and resolution techniques that can be used.</nobr></div>
<div style="position:absolute;top:81870;left:85"><nobr>Java deadlock: what is it?</nobr></div>
<div style="position:absolute;top:81908;left:85"><nobr>A true Java deadlock can essentially be described as a situation where two or more threads are</nobr></div>
<div style="position:absolute;top:81927;left:85"><nobr>blocked forever, waiting for each other. This situation is very different from other more commons "day-</nobr></div>
<div style="position:absolute;top:81946;left:85"><nobr>to-day" thread problem patterns such as lock contention &amp; thread races, threads waiting on blocking</nobr></div>
<div style="position:absolute;top:81965;left:85"><nobr>IO calls etc. Such lock-ordering deadlock situation can be visualized as presented below:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:82042;left:764"><nobr>69 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:82147;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="70"><b>Page 70</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:82233;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:82236;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:82675;left:85"><nobr>In the above visual example, the attempt by Thread A &amp; Thread B to acquire 2 locks in different orders</nobr></div>
<div style="position:absolute;top:82694;left:85"><nobr>is fatal. Once threads reached the deadlocked state, they can never recover, forcing you to restart the</nobr></div>
<div style="position:absolute;top:82713;left:85"><nobr>affected JVM process.</nobr></div>
<div style="position:absolute;top:82751;left:85"><nobr>There is also another type of deadlock: resource deadlock. This is by far the most common thread</nobr></div>
<div style="position:absolute;top:82770;left:85"><nobr>problem pattern I have seen in my experience with Java EE enterprise system troubleshooting. A</nobr></div>
<div style="position:absolute;top:82789;left:85"><nobr>resource deadlock is essentially a scenario where one or multiple threads are waiting to acquire a</nobr></div>
<div style="position:absolute;top:82808;left:85"><nobr>resource which will never be available such as JDBC Pool depletions.</nobr></div>
<div style="position:absolute;top:82846;left:85"><nobr>Lock-ordering deadlocks</nobr></div>
<div style="position:absolute;top:82884;left:85"><nobr>You should know by now that I am a big fan of JVM thread dump analysis; crucial skill to acquire for</nobr></div>
<div style="position:absolute;top:82903;left:85"><nobr>individuals either involved in Java/Java EE development or production support. The good news is that</nobr></div>
<div style="position:absolute;top:82922;left:85"><nobr>Java-level deadlocks can be easily identified out-of-the-box by most JVM thread dump formats</nobr></div>
<div style="position:absolute;top:82941;left:85"><nobr>(HotSpot, IBM VM...) since they contain a native deadlock detection mechanism which will actually</nobr></div>
<div style="position:absolute;top:82959;left:85"><nobr>show you the threads involved in a true Java-level deadlock scenario along with the execution stack</nobr></div>
<div style="position:absolute;top:82979;left:85"><nobr>trace. JVM thread dump can be captured via the tool of your choice such as JVisualVM, jstack or</nobr></div>
<div style="position:absolute;top:82997;left:85"><nobr>natively such as kill -3 &lt;PID&gt; on Unix-based OS. Find below the JVM Java-level deadlock detection</nobr></div>
<div style="position:absolute;top:83016;left:85"><nobr>section after running lab 1:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:83230;left:764"><nobr>70 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:83335;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="71"><b>Page 71</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:83421;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:83424;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:83814;left:85"><nobr>Now this is the easy part…The core of the root cause analysis effort is to understand why such</nobr></div>
<div style="position:absolute;top:83832;left:85"><nobr>threads are involved in a deadlock situation at the first place. Lock-ordering deadlocks could be</nobr></div>
<div style="position:absolute;top:83852;left:85"><nobr>triggered from your application code but unless you are involved in high concurrency programming,</nobr></div>
<div style="position:absolute;top:83870;left:85"><nobr>chances are that the culprit code is a third part API or framework that you are using or the actual Java</nobr></div>
<div style="position:absolute;top:83889;left:85"><nobr>EE container itself, when applicable.</nobr></div>
<div style="position:absolute;top:83929;left:85"><nobr>Now let’s review below the lock-ordering deadlock resolution strategies presented by Heinz in his</nobr></div>
<div style="position:absolute;top:83949;left:85"><nobr>presentation <font style="font-size:16px">“<a href="https://github.com/kabutz/DeadlockLabJavaOne2012.git"></a></font><font color="#000080"><a href="https://github.com/kabutz/DeadlockLabJavaOne2012.git">HOL6500 - Finding And Solving Java Deadlocks</a></font><font style="font-size:16px"><a href="https://github.com/kabutz/DeadlockLabJavaOne2012.git"></a>”</font>:</nobr></div>
<div style="position:absolute;top:83988;left:85"><nobr># Deadlock resolution by global ordering (see lab1 solution)</nobr></div>
<div style="position:absolute;top:84026;left:85"><nobr>Essentially involves the definition of a global ordering for the locks that would always prevent deadlock</nobr></div>
<div style="position:absolute;top:84045;left:85"><nobr>(please see lab1 solution)</nobr></div>
<div style="position:absolute;top:84083;left:85"><nobr># Deadlock resolution by TryLock (see lab2 solution)</nobr></div>
<div style="position:absolute;top:84124;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:84122;left:139"><nobr>Lock the first lock</nobr></div>
<div style="position:absolute;top:84144;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:84143;left:139"><nobr>Then try to lock the second lock</nobr></div>
<div style="position:absolute;top:84165;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:84163;left:139"><nobr>If you can lock it, you are good to go</nobr></div>
<div style="position:absolute;top:84186;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:84184;left:139"><nobr>If you cannot, wait and try again</nobr></div>
<div style="position:absolute;top:84222;left:85"><nobr>The above strategy can be implemented using Java Lock &amp; ReantrantLock which also gives you also</nobr></div>
<div style="position:absolute;top:84241;left:85"><nobr>flexibility to setup a wait timeout in order to prevent thread starvation in the event the first lock is</nobr></div>
<div style="position:absolute;top:84260;left:85"><nobr>acquired for too long.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:84418;left:764"><nobr>71 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:84523;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="72"><b>Page 72</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:84609;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:84612;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:84865;left:85"><nobr>If you look at the JBoss AS7 implementation, you will notice that Lock &amp; ReantrantLock are widely</nobr></div>
<div style="position:absolute;top:84884;left:85"><nobr>used from core implementation layers such as:</nobr></div>
<div style="position:absolute;top:84925;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:84923;left:139"><nobr>Deployment service</nobr></div>
<div style="position:absolute;top:84946;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:84944;left:139"><nobr>EJB3 implementation (widely used)</nobr></div>
<div style="position:absolute;top:84966;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:84965;left:139"><nobr>Clustering and session management</nobr></div>
<div style="position:absolute;top:84987;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:84985;left:139"><nobr>Internal cache &amp; data structures (LRU, ConcurrentReferenceHashMap...)</nobr></div>
<div style="position:absolute;top:85023;left:85"><nobr>Now and as per Heinz's point, the deadlock resolution strategy #2 can be quite efficient but proper</nobr></div>
<div style="position:absolute;top:85042;left:85"><nobr>care is also required such as releasing all held lock via a finally{} block otherwise you can transform</nobr></div>
<div style="position:absolute;top:85061;left:85"><nobr>your deadlock scenario into a livelock.</nobr></div>
<div style="position:absolute;top:85099;left:85"><nobr>Resource deadlocks</nobr></div>
<div style="position:absolute;top:85137;left:85"><nobr>Now let's move to resource deadlock scenarios. I'm glad that Heinz's lab #3 covered this since from</nobr></div>
<div style="position:absolute;top:85156;left:85"><nobr>my experience this is by far the most common "deadlock" scenario that you will see, especially if you</nobr></div>
<div style="position:absolute;top:85175;left:85"><nobr>are developing and supporting large distributed Java EE production systems.</nobr></div>
<div style="position:absolute;top:85213;left:85"><nobr>Now let's get the facts right.</nobr></div>
<div style="position:absolute;top:85254;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:85252;left:139"><nobr>Resource deadlocks are not true Java-level deadlocks.</nobr></div>
<div style="position:absolute;top:85275;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:85273;left:139"><nobr>The JVM Thread Dump will not magically should you these types of deadlocks. This means</nobr></div>
<div style="position:absolute;top:85292;left:139"><nobr>more work for you to analyze and understand this problem as a starting point.</nobr></div>
<div style="position:absolute;top:85314;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:85312;left:139"><nobr>Thread dump analysis can be especially confusing when you are just starting to learn how to</nobr></div>
<div style="position:absolute;top:85331;left:139"><nobr>read Thread Dump since threads will often show up as RUNNING state vs. BLOCKED state for</nobr></div>
<div style="position:absolute;top:85350;left:139"><nobr>Java-level deadlocks. For now, it is important to keep in mind that thread state is not that</nobr></div>
<div style="position:absolute;top:85369;left:139"><nobr>important for this type of problem e.g. RUNNING state != healthy state.</nobr></div>
<div style="position:absolute;top:85392;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:85390;left:139"><nobr>The analysis approach is very different than Java-level deadlocks. You must take multiple</nobr></div>
<div style="position:absolute;top:85409;left:139"><nobr>thread dump snapshots and identify thread problem/wait patterns between each snapshot. You</nobr></div>
<div style="position:absolute;top:85428;left:139"><nobr>will be able to see threads not moving e.g. threads waiting to acquire a resource from a pool</nobr></div>
<div style="position:absolute;top:85447;left:139"><nobr>and other threads that already acquired such resource and hanging.</nobr></div>
<div style="position:absolute;top:85469;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:85467;left:139"><nobr>Thread Dump analysis is not the only data point/fact important here. You will need to collect</nobr></div>
<div style="position:absolute;top:85486;left:139"><nobr>other facts such statistics on the resource(s) the threads are waiting for, overall middleware or</nobr></div>
<div style="position:absolute;top:85505;left:139"><nobr>environment health etc. The combination of all these facts will allow you to conclude on the</nobr></div>
<div style="position:absolute;top:85524;left:139"><nobr>root cause along with a resolution strategy which may or may not involve code change.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:85606;left:764"><nobr>72 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:84674;left:101"><nobr>public interface Lock {</nobr></div>
<div style="position:absolute;top:84691;left:119"><nobr>void lock();</nobr></div>
<div style="position:absolute;top:84708;left:119"><nobr>void lockInterruptibly() throws InterruptedException;</nobr></div>
<div style="position:absolute;top:84725;left:119"><nobr>boolean tryLock();</nobr></div>
<div style="position:absolute;top:84742;left:119"><nobr>boolean tryLock(long timeout, TimeUnit unit)</nobr></div>
<div style="position:absolute;top:84759;left:137"><nobr>throws InterruptedException;</nobr></div>
<div style="position:absolute;top:84776;left:119"><nobr>void unlock();</nobr></div>
<div style="position:absolute;top:84793;left:119"><nobr>Condition newCondition();</nobr></div>
<div style="position:absolute;top:84810;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:85711;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="73"><b>Page 73</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:85797;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:85800;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:85845;left:85"><nobr><b>Java Thread deadlock - Case Study</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:85900;left:85"><nobr>This section will describe the complete root cause analysis of a recent Java deadlock problem</nobr></div>
<div style="position:absolute;top:85919;left:85"><nobr>observed from a Weblogic 11g production system running on the IBM JVM 1.6. It will also demonstrate</nobr></div>
<div style="position:absolute;top:85938;left:85"><nobr>the importance of mastering Thread Dump analysis skills; including for the IBM JVM Thread Dump</nobr></div>
<div style="position:absolute;top:85957;left:85"><nobr>format.</nobr></div>
<div style="position:absolute;top:85995;left:85"><nobr>Environment specifications</nobr></div>
<div style="position:absolute;top:86036;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86034;left:139"><nobr>Java EE server: Oracle Weblogic Server 11g &amp; Spring 2.0.5</nobr></div>
<div style="position:absolute;top:86057;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86055;left:139"><nobr>OS: AIX 5.3</nobr></div>
<div style="position:absolute;top:86077;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86076;left:139"><nobr>Java VM: IBM JRE 1.6.0</nobr></div>
<div style="position:absolute;top:86098;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86096;left:139"><nobr>Platform type: Portal &amp; ordering application</nobr></div>
<div style="position:absolute;top:86134;left:85"><nobr>Monitoring and troubleshooting tools</nobr></div>
<div style="position:absolute;top:86175;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86174;left:139"><nobr>JVM Thread Dump (IBM JVM format)</nobr></div>
<div style="position:absolute;top:86196;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86194;left:139"><nobr>Compuware Server Vantage (Weblogic JMX monitoring &amp; alerting)</nobr></div>
<div style="position:absolute;top:86232;left:85"><nobr>Problem overview</nobr></div>
<div style="position:absolute;top:86270;left:85"><nobr>A major stuck Threads problem was observed &amp; reported from Compuware Server Vantage and</nobr></div>
<div style="position:absolute;top:86289;left:85"><nobr>affecting 2 of our Weblogic 11g production managed servers causing application impact and timeout</nobr></div>
<div style="position:absolute;top:86308;left:85"><nobr>conditions from our end users.</nobr></div>
<div style="position:absolute;top:86346;left:85"><nobr>Gathering and validation of facts</nobr></div>
<div style="position:absolute;top:86384;left:85"><nobr>As usual, a Java EE problem investigation requires gathering of technical and non-technical facts so</nobr></div>
<div style="position:absolute;top:86403;left:85"><nobr>we can either derived other facts and/or conclude on the root cause. Before applying a corrective</nobr></div>
<div style="position:absolute;top:86422;left:85"><nobr>measure, the facts below were verified in order to conclude on the root cause:</nobr></div>
<div style="position:absolute;top:86463;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86461;left:139"><nobr>What is the client impact? <i>MEDIUM (only 2 managed servers / JVM affected out of 16)</i></nobr></div>
<div style="position:absolute;top:86484;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86482;left:139"><nobr>Recent change of the affected platform? <i>Yes (new JMS related asynchronous component)</i></nobr></div>
<div style="position:absolute;top:86504;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86502;left:139"><nobr>Any recent traffic increase to the affected platform? <i>No</i></nobr></div>
<div style="position:absolute;top:86525;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86523;left:139"><nobr>How does this problem manifest itself? <i>A sudden increase of Threads was observed leading to</i></nobr></div>
<div style="position:absolute;top:86542;left:139"><nobr><i>rapid Thread depletion</i></nobr></div>
<div style="position:absolute;top:86564;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:86562;left:139"><nobr>Did a Weblogic managed server restart resolve the problem? <i>Yes, but problem is returning</i></nobr></div>
<div style="position:absolute;top:86582;left:139"><nobr><i>after few hours (unpredictable &amp; intermittent pattern)</i></nobr></div>
<div style="position:absolute;top:86619;left:85"><nobr>Conclusion #1: The problem is related to an intermittent stuck Threads behaviour affecting only a few</nobr></div>
<div style="position:absolute;top:86638;left:85"><nobr>Weblogic managed servers at the time.</nobr></div>
<div style="position:absolute;top:86657;left:85"><nobr>Conclusion #2: Since problem is intermittent, a global root cause such as a non-responsive</nobr></div>
<div style="position:absolute;top:86676;left:85"><nobr>downstream system is not likely.</nobr></div>
<div style="position:absolute;top:86714;left:85"><nobr>Thread Dump analysis - first pass</nobr></div>
<div style="position:absolute;top:86752;left:85"><nobr>The first thing to do when dealing with stuck Thread problems is to generate a JVM Thread Dump.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:86794;left:764"><nobr>73 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:86899;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="74"><b>Page 74</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:86985;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:86988;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:87032;left:85"><nobr>This is a golden rule regardless of your environment specifications &amp; problem context. A JVM Thread</nobr></div>
<div style="position:absolute;top:87051;left:85"><nobr>Dump snapshot provides you with crucial information about the active Threads and what type of</nobr></div>
<div style="position:absolute;top:87070;left:85"><nobr>processing / tasks they are performing at that time.</nobr></div>
<div style="position:absolute;top:87108;left:85"><nobr>Now back to our case study, an IBM JVM Thread Dump (javacore.xyz format) was generated which</nobr></div>
<div style="position:absolute;top:87127;left:85"><nobr>did reveal the following Java Thread deadlock condition below:</nobr></div>
<div style="position:absolute;top:87553;left:85"><nobr>This deadlock situation can be translated as per below:</nobr></div>
<div style="position:absolute;top:87594;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:87592;left:139"><nobr>Weblogic Thread #8 is waiting to acquire an Object monitor lock owned by Weblogic Thread</nobr></div>
<div style="position:absolute;top:87611;left:139"><nobr>#10</nobr></div>
<div style="position:absolute;top:87633;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:87632;left:139"><nobr>Weblogic Thread #10 is waiting to acquire an Object monitor lock owned by Weblogic Thread</nobr></div>
<div style="position:absolute;top:87651;left:139"><nobr>#8</nobr></div>
<div style="position:absolute;top:87689;left:85"><nobr>Conclusion: Both Weblogic Threads #8 &amp; #10 are waiting on each other; forever!</nobr></div>
<div style="position:absolute;top:87726;left:85"><nobr>Now before going any deeper in this root cause analysis, let me provide you a high level overview on</nobr></div>
<div style="position:absolute;top:87746;left:85"><nobr>Java Thread deadlocks.</nobr></div>
<div style="position:absolute;top:87783;left:85"><nobr>Java Thread deadlock overview</nobr></div>
<div style="position:absolute;top:87821;left:85"><nobr>Most of you are probably familiar with Java Thread deadlock principles but did you really experience a</nobr></div>
<div style="position:absolute;top:87840;left:85"><nobr>true deadlock problem?</nobr></div>
<div style="position:absolute;top:87878;left:85"><nobr>From my experience, true Java deadlocks are rare and I have only seen ~5 occurrences over the last</nobr></div>
<div style="position:absolute;top:87897;left:85"><nobr>10 years. The reason is that most stuck Threads related problems are due to Thread hanging</nobr></div>
<div style="position:absolute;top:87916;left:85"><nobr>conditions (waiting on remote IO call etc.) but not involved in a true deadlock condition with other</nobr></div>
<div style="position:absolute;top:87935;left:85"><nobr>Thread(s).</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:87982;left:764"><nobr>74 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:87180;left:101"><nobr>1LKDEADLOCK    <b><font color="#c00000">Deadlock detected !!!</font></b></nobr></div>
<div style="position:absolute;top:87197;left:101"><nobr>NULL    </nobr></div>
<div style="position:absolute;top:87197;left:236"><nobr>---------------------</nobr></div>
<div style="position:absolute;top:87214;left:101"><nobr>NULL    </nobr></div>
<div style="position:absolute;top:87231;left:101"><nobr>2LKDEADLOCKTHR  Thread "[STUCK] ExecuteThread: '8' for queue:</nobr></div>
<div style="position:absolute;top:87248;left:101"><nobr>'weblogic.kernel.Default (self-tuning)'" (0x000000012CC08B00)</nobr></div>
<div style="position:absolute;top:87265;left:101"><nobr>3LKDEADLOCKWTR    <b><font color="#c00000">is waiting for:</font></b></nobr></div>
<div style="position:absolute;top:87282;left:101"><nobr>4LKDEADLOCKMON     sys_mon_t:0x0000000126171DF8 infl_mon_t:</nobr></div>
<div style="position:absolute;top:87299;left:101"><nobr>0x0000000126171E38:</nobr></div>
<div style="position:absolute;top:87316;left:101"><nobr>4LKDEADLOCKOBJ    </nobr></div>
<div style="position:absolute;top:87333;left:101"><nobr>weblogic/jms/frontend/FESession@0x07000000198048C0/0x07000000198048D8:</nobr></div>
<div style="position:absolute;top:87350;left:101"><nobr>3LKDEADLOCKOWN    <b><font color="#c00000">which is owned by:</font></b></nobr></div>
<div style="position:absolute;top:87367;left:101"><nobr>2LKDEADLOCKTHR  Thread "[STUCK] ExecuteThread: '10' for queue:</nobr></div>
<div style="position:absolute;top:87384;left:101"><nobr>'weblogic.kernel.Default (self-tuning)'" (0x000000012E560500)</nobr></div>
<div style="position:absolute;top:87401;left:101"><nobr>3LKDEADLOCKWTR    which is waiting for:</nobr></div>
<div style="position:absolute;top:87418;left:101"><nobr>4LKDEADLOCKMON     sys_mon_t:0x000000012884CD60 infl_mon_t:</nobr></div>
<div style="position:absolute;top:87435;left:101"><nobr>0x000000012884CDA0:</nobr></div>
<div style="position:absolute;top:87452;left:101"><nobr>4LKDEADLOCKOBJ    </nobr></div>
<div style="position:absolute;top:87469;left:101"><nobr>weblogic/jms/frontend/FEConnection@0x0700000019822F08/0x0700000019822F20:</nobr></div>
<div style="position:absolute;top:87486;left:101"><nobr>3LKDEADLOCKOWN    <b><font color="#c00000">which is owned by:</font></b></nobr></div>
<div style="position:absolute;top:87503;left:101"><nobr>2LKDEADLOCKTHR  Thread "[STUCK] ExecuteThread: '8' for queue:</nobr></div>
<div style="position:absolute;top:87520;left:101"><nobr>'weblogic.kernel.Default (self-tuning)'" (0x000000012CC08B00)</nobr></div>
</span></font>

<div style="position:absolute;top:88087;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="75"><b>Page 75</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:88173;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:88176;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:88239;left:85"><nobr>A Java Thread deadlock is a situation for example where Thread A is waiting to acquire an Object</nobr></div>
<div style="position:absolute;top:88258;left:85"><nobr>monitor lock held by Thread B which is itself waiting to acquire an Object monitor lock held by Thread</nobr></div>
<div style="position:absolute;top:88277;left:85"><nobr>A. Both these Threads will wait for each other forever. This situation can be visualized as per below</nobr></div>
<div style="position:absolute;top:88296;left:85"><nobr>diagram:</nobr></div>
<div style="position:absolute;top:88767;left:85"><nobr>Thread deadlock is confirmed...now what can you do?</nobr></div>
<div style="position:absolute;top:88805;left:85"><nobr>Once the deadlock is confirmed (most JVM Thread Dump implementations will highlight it for you), the</nobr></div>
<div style="position:absolute;top:88824;left:85"><nobr>next step is to perform a deeper dive analysis by reviewing each Thread involved in the deadlock</nobr></div>
<div style="position:absolute;top:88843;left:85"><nobr>situation along with their current task &amp; wait condition.</nobr></div>
<div style="position:absolute;top:88881;left:85"><nobr>Find below the partial Thread Stack Trace from our problem case for each Thread involved in the</nobr></div>
<div style="position:absolute;top:88900;left:85"><nobr>deadlock condition:</nobr></div>
<div style="position:absolute;top:88938;left:85"><nobr><i>** Please note that the real application Java package name was renamed for confidentiality purposes</i></nobr></div>
<div style="position:absolute;top:88956;left:85"><nobr><i>**</i></nobr></div>
<div style="position:absolute;top:88994;left:85"><nobr>Weblogic Thread #8</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:89170;left:764"><nobr>75 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:89275;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="76"><b>Page 76</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:89361;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:89364;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:90358;left:764"><nobr>76 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:89442;left:101"><nobr>"[STUCK] ExecuteThread: '8' for queue: 'weblogic.kernel.Default (self-tuning)'"</nobr></div>
<div style="position:absolute;top:89459;left:101"><nobr>J9VMThread:0x000000012CC08B00, j9thread_t:0x00000001299E5100,</nobr></div>
<div style="position:absolute;top:89476;left:101"><nobr>java/lang/Thread:0x070000001D72EE00, state:B, prio=1</nobr></div>
<div style="position:absolute;top:89493;left:101"><nobr>(native thread ID:0x111200F, native priority:0x1, native policy:UNKNOWN)</nobr></div>
<div style="position:absolute;top:89510;left:101"><nobr>Java callstack:</nobr></div>
<div style="position:absolute;top:89528;left:127"><nobr>at weblogic/jms/frontend/<font color="#c00000">FEConnection</font>.stop(FEConnection.java:671(Compiled</nobr></div>
<div style="position:absolute;top:89545;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:89564;left:127"><nobr>at weblogic/jms/frontend/FEConnection.invoke(FEConnection.java:1685(Compiled</nobr></div>
<div style="position:absolute;top:89581;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:89599;left:127"><nobr>at</nobr></div>
<div style="position:absolute;top:89617;left:101"><nobr>weblogic/messaging/dispatcher/Request.wrappedFiniteStateMachine(Request.java:96</nobr></div>
<div style="position:absolute;top:89633;left:101"><nobr>1(Compiled Code))</nobr></div>
<div style="position:absolute;top:89652;left:127"><nobr>at</nobr></div>
<div style="position:absolute;top:89669;left:101"><nobr>weblogic/messaging/dispatcher/DispatcherImpl.syncRequest(DispatcherImpl.java:18</nobr></div>
<div style="position:absolute;top:89686;left:101"><nobr>4(Compiled Code))</nobr></div>
<div style="position:absolute;top:89705;left:127"><nobr>at</nobr></div>
<div style="position:absolute;top:89722;left:101"><nobr>weblogic/messaging/dispatcher/DispatcherImpl.dispatchSync(DispatcherImpl.java:2</nobr></div>
<div style="position:absolute;top:89739;left:101"><nobr>12(Compiled Code))</nobr></div>
<div style="position:absolute;top:89757;left:127"><nobr>at</nobr></div>
<div style="position:absolute;top:89774;left:101"><nobr>weblogic/jms/dispatcher/DispatcherAdapter.dispatchSync(DispatcherAdapter.java:4</nobr></div>
<div style="position:absolute;top:89791;left:101"><nobr>3(Compiled Code))</nobr></div>
<div style="position:absolute;top:89810;left:127"><nobr>at weblogic/jms/client/JMSConnection.stop(JMSConnection.java:863(Compiled</nobr></div>
<div style="position:absolute;top:89827;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:89845;left:127"><nobr>at weblogic/jms/client/WLConnectionImpl.stop(WLConnectionImpl.java:843)</nobr></div>
<div style="position:absolute;top:89864;left:127"><nobr>at</nobr></div>
<div style="position:absolute;top:89881;left:101"><nobr>org/springframework/jms/connection/SingleConnectionFactory.closeConnection(Sing</nobr></div>
<div style="position:absolute;top:89898;left:101"><nobr>leConnectionFactory.java:342)</nobr></div>
<div style="position:absolute;top:89916;left:127"><nobr>at</nobr></div>
<div style="position:absolute;top:89933;left:101"><nobr>org/springframework/jms/connection/SingleConnectionFactory.<b><font color="#c00000">resetConnection</font></b>(Sing</nobr></div>
<div style="position:absolute;top:89950;left:101"><nobr>leConnectionFactory.java:296)</nobr></div>
<div style="position:absolute;top:89969;left:127"><nobr>at org/app/JMSReceiver.receive()</nobr></div>
<div style="position:absolute;top:89987;left:101"><nobr>……………………………………………………………………</nobr></div>
</span></font>

<div style="position:absolute;top:90463;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="77"><b>Page 77</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:90549;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:90552;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:90596;left:85"><nobr>Weblogic Thread #10</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:91546;left:764"><nobr>77 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:90649;left:101"><nobr>"[STUCK] ExecuteThread: '10' for queue: 'weblogic.kernel.Default (self-tuning)'"</nobr></div>
<div style="position:absolute;top:90664;left:101"><nobr>J9VMThread:0x000000012E560500, j9thread_t:0x000000012E35BCE0,</nobr></div>
<div style="position:absolute;top:90679;left:101"><nobr>java/lang/Thread:0x070000001ECA9200, state:B, prio=1</nobr></div>
<div style="position:absolute;top:90695;left:101"><nobr>(native thread ID:0x4FA027, native priority:0x1, native policy:UNKNOWN)</nobr></div>
<div style="position:absolute;top:90710;left:101"><nobr>Java callstack:</nobr></div>
<div style="position:absolute;top:90731;left:106"><nobr>at weblogic/jms/frontend/<b><font color="#c00000">FEConnection</font></b>.getPeerVersion(FEConnection.java:1381(Compiled</nobr></div>
<div style="position:absolute;top:90746;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:90767;left:106"><nobr>at weblogic/jms/frontend/FESession.setUpBackEndSession(FESession.java:755(Compiled</nobr></div>
<div style="position:absolute;top:90782;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:90803;left:106"><nobr>at weblogic/jms/frontend/FESession.consumerCreate(FESession.java:1025(Compiled Code))</nobr></div>
<div style="position:absolute;top:90824;left:106"><nobr>at weblogic/jms/frontend/FESession.invoke(FESession.java:2995(Compiled Code))</nobr></div>
<div style="position:absolute;top:90845;left:106"><nobr>at</nobr></div>
<div style="position:absolute;top:90860;left:101"><nobr>weblogic/messaging/dispatcher/Request.wrappedFiniteStateMachine(Request.java:961(Compile</nobr></div>
<div style="position:absolute;top:90875;left:101"><nobr>d Code))</nobr></div>
<div style="position:absolute;top:90896;left:106"><nobr>at</nobr></div>
<div style="position:absolute;top:90912;left:101"><nobr>weblogic/messaging/dispatcher/DispatcherImpl.syncRequest(DispatcherImpl.java:184(Compile</nobr></div>
<div style="position:absolute;top:90927;left:101"><nobr>d Code))</nobr></div>
<div style="position:absolute;top:90948;left:106"><nobr>at</nobr></div>
<div style="position:absolute;top:90963;left:101"><nobr>weblogic/messaging/dispatcher/DispatcherImpl.dispatchSync(DispatcherImpl.java:212(Compil</nobr></div>
<div style="position:absolute;top:90978;left:101"><nobr>ed Code))</nobr></div>
<div style="position:absolute;top:90999;left:106"><nobr>at</nobr></div>
<div style="position:absolute;top:91014;left:101"><nobr>weblogic/jms/dispatcher/DispatcherAdapter.dispatchSync(DispatcherAdapter.java:43(Compile</nobr></div>
<div style="position:absolute;top:91030;left:101"><nobr>d Code))</nobr></div>
<div style="position:absolute;top:91051;left:106"><nobr>at weblogic/jms/client/JMSSession.consumerCreate(JMSSession.java:2982(Compiled Code))</nobr></div>
<div style="position:absolute;top:91071;left:106"><nobr>at weblogic/jms/client/JMSSession.setupConsumer(JMSSession.java:2749(Compiled Code))</nobr></div>
<div style="position:absolute;top:91092;left:106"><nobr>at weblogic/jms/client/JMSSession.createConsumer(JMSSession.java:2691(Compiled Code))</nobr></div>
<div style="position:absolute;top:91113;left:106"><nobr>at weblogic/jms/client/JMSSession.createReceiver(JMSSession.java:2596(Compiled Code))</nobr></div>
<div style="position:absolute;top:91134;left:106"><nobr>at weblogic/jms/client/WLSessionImpl.createReceiver(WLSessionImpl.java:991(Compiled</nobr></div>
<div style="position:absolute;top:91149;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:91170;left:106"><nobr>at</nobr></div>
<div style="position:absolute;top:91185;left:101"><nobr>org/springframework/jms/core/JmsTemplate102.createConsumer(JmsTemplate102.java:204(Compi</nobr></div>
<div style="position:absolute;top:91201;left:101"><nobr>led Code))</nobr></div>
<div style="position:absolute;top:91222;left:106"><nobr>at org/springframework/jms/core/JmsTemplate.doReceive(JmsTemplate.java:676(Compiled</nobr></div>
<div style="position:absolute;top:91237;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:91258;left:106"><nobr>at org/springframework/jms/core/JmsTemplate$10.doInJms(JmsTemplate.java:652(Compiled</nobr></div>
<div style="position:absolute;top:91273;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:91294;left:106"><nobr>at org/springframework/jms/core/JmsTemplate.execute(JmsTemplate.java:412(Compiled</nobr></div>
<div style="position:absolute;top:91309;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:91330;left:106"><nobr>at</nobr></div>
<div style="position:absolute;top:91345;left:101"><nobr>org/springframework/jms/core/JmsTemplate.receiveSelected(JmsTemplate.java:650(Compiled</nobr></div>
<div style="position:absolute;top:91361;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:91381;left:106"><nobr>at</nobr></div>
<div style="position:absolute;top:91397;left:101"><nobr>org/springframework/jms/core/JmsTemplate.receiveSelected(JmsTemplate.java:641(Compiled</nobr></div>
<div style="position:absolute;top:91412;left:101"><nobr>Code))</nobr></div>
<div style="position:absolute;top:91433;left:106"><nobr>at org/app/JMSReceiver.receive()</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:91449;left:101"><nobr>……………………………………………………………</nobr></div>
</span></font>

<div style="position:absolute;top:91651;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="78"><b>Page 78</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:91737;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:91740;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:91784;left:89"><nobr>As you can see in the above Thread Strack Traces, such deadlock did originate from our application</nobr></div>
<div style="position:absolute;top:91803;left:85"><nobr>code which is using the Spring framework API for the JMS consumer implementation (very useful</nobr></div>
<div style="position:absolute;top:91822;left:85"><nobr>when not using MDB's). The Stack Traces are quite interesting and revealing that both Threads are in</nobr></div>
<div style="position:absolute;top:91841;left:85"><nobr>a race condition against the same Weblogic JMS consumer session / connection and leading to a</nobr></div>
<div style="position:absolute;top:91860;left:85"><nobr>deadlock situation:</nobr></div>
<div style="position:absolute;top:91901;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:91900;left:139"><nobr>Weblogic Thread #8 is attempting to reset and close the current JMS connection</nobr></div>
<div style="position:absolute;top:91922;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:91920;left:139"><nobr>Weblogic Thread #10 is attempting to use the same JMS Connection / Session in order to</nobr></div>
<div style="position:absolute;top:91939;left:139"><nobr>create a new JMS consumer</nobr></div>
<div style="position:absolute;top:91962;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:91960;left:139"><nobr>Thread deadlock is triggered!</nobr></div>
<div style="position:absolute;top:91998;left:85"><nobr>Root cause: non Thread safe Spring JMS SingleConnectionFactory implementation</nobr></div>
<div style="position:absolute;top:92036;left:85"><nobr>A code review and a quick research from Spring JIRA bug database did reveal the following Thread</nobr></div>
<div style="position:absolute;top:92055;left:85"><nobr>safe defect below with a perfect correlation with the above analysis:</nobr></div>
<div style="position:absolute;top:92093;left:85"><nobr># SingleConnectionFactory's resetConnection is causing deadlocks with underlying OracleAQ's JMS</nobr></div>
<div style="position:absolute;top:92112;left:85"><nobr>connection – <a href="https://jira.springsource.org/browse/SPR-5987"></a><font color="#000080"><a href="https://jira.springsource.org/browse/SPR-5987">Bug Link</a></font></nobr></div>
<div style="position:absolute;top:92150;left:85"><nobr>A patch for Spring SingleConnectionFactory was released back in 2009 which did involve adding</nobr></div>
<div style="position:absolute;top:92168;left:85"><nobr>proper synchronized{} block in order to prevent Thread deadlock in the event of a JMS Connection</nobr></div>
<div style="position:absolute;top:92187;left:85"><nobr>reset operation:</nobr></div>
<div style="position:absolute;top:92434;left:85"><nobr>Solution</nobr></div>
<div style="position:absolute;top:92472;left:85"><nobr>Our team is currently planning to integrate this Spring patch in to our production environment shortly.</nobr></div>
<div style="position:absolute;top:92491;left:85"><nobr>The initial tests performed in our test environment are positive.</nobr></div>
<div style="position:absolute;top:92529;left:85"><nobr>Conclusion</nobr></div>
<div style="position:absolute;top:92567;left:85"><nobr>I hope this case study has helped understand a real-life Java Thread deadlock problem and how</nobr></div>
<div style="position:absolute;top:92586;left:85"><nobr>proper Thread Dump analysis skills can allow you to quickly pinpoint the root cause of stuck Thread</nobr></div>
<div style="position:absolute;top:92605;left:85"><nobr>related problems at the code level.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:92734;left:764"><nobr>78 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:92240;left:101"><nobr>synchronized (connectionMonitor) {</nobr></div>
<div style="position:absolute;top:92258;left:109"><nobr>//if condition added to avoid possible deadlocks when trying to reset the</nobr></div>
<div style="position:absolute;top:92275;left:101"><nobr>target connection</nobr></div>
<div style="position:absolute;top:92294;left:109"><nobr>if (!started) {</nobr></div>
<div style="position:absolute;top:92312;left:116"><nobr>this.target.start();</nobr></div>
<div style="position:absolute;top:92331;left:116"><nobr>started = true;</nobr></div>
<div style="position:absolute;top:92350;left:109"><nobr>}</nobr></div>
<div style="position:absolute;top:92367;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:92839;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="79"><b>Page 79</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:92925;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:92928;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:92973;left:85"><nobr><b>Java concurrency: the hidden thread deadlocks</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:93028;left:85"><nobr>Most Java programmers are familiar with the Java thread deadlock concept. It essentially involves 2</nobr></div>
<div style="position:absolute;top:93047;left:85"><nobr>threads waiting forever for each other. This condition is often the result of flat (synchronized) or</nobr></div>
<div style="position:absolute;top:93066;left:85"><nobr>ReentrantLock (read or write) lock-ordering problems.</nobr></div>
<div style="position:absolute;top:93294;left:85"><nobr>The good news is that the HotSpot JVM is always able to detect this condition for you...or is it?</nobr></div>
<div style="position:absolute;top:93332;left:85"><nobr>A recent thread deadlock problem affecting an Oracle Service Bus production environment has forced</nobr></div>
<div style="position:absolute;top:93351;left:85"><nobr>us to revisit this classic problem and identify the existence of "hidden" deadlock situations.</nobr></div>
<div style="position:absolute;top:93389;left:85"><nobr>This section will demonstrate and replicate via a simple Java program a very special lock-ordering</nobr></div>
<div style="position:absolute;top:93408;left:85"><nobr>deadlock condition which is not detected by the latest HotSpot JVM 1.7. You will also find a video <a href="http://youtu.be/wdS1azOEIgc"></a><font color="#000080"><a href="http://youtu.be/wdS1azOEIgc">here</a></font></nobr></div>
<div style="position:absolute;top:93426;left:85"><nobr>explaining you the Java sample program and the troubleshooting approach used.</nobr></div>
<div style="position:absolute;top:93464;left:85"><nobr>The crime scene</nobr></div>
<div style="position:absolute;top:93502;left:85"><nobr>I usually like to compare major Java concurrency problems to a crime scene where you play the lead</nobr></div>
<div style="position:absolute;top:93521;left:85"><nobr>investigator role. In this context, the "crime" is an actual production outage of your client IT</nobr></div>
<div style="position:absolute;top:93540;left:85"><nobr>environment. Your job is to:</nobr></div>
<div style="position:absolute;top:93582;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:93580;left:139"><nobr>Collect all the evidences, hints &amp; facts (thread dump, logs, business impact, load figures...)</nobr></div>
<div style="position:absolute;top:93602;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:93600;left:139"><nobr>Interrogate the witnesses &amp; domain experts (support team, delivery team, vendor, client...)</nobr></div>
<div style="position:absolute;top:93638;left:85"><nobr>The next step of your investigation is to analyze the collected information and establish a potential list</nobr></div>
<div style="position:absolute;top:93657;left:85"><nobr>of one or many "suspects" along with clear proofs. Eventually, you want to narrow it down to a primary</nobr></div>
<div style="position:absolute;top:93676;left:85"><nobr>suspect or root cause. Obviously the law "innocent until proven guilty" does not apply here, exactly the</nobr></div>
<div style="position:absolute;top:93695;left:85"><nobr>opposite.</nobr></div>
<div style="position:absolute;top:93733;left:85"><nobr>Lack of evidence can prevent you to achieve the above goal. What you will see next is that the lack of</nobr></div>
<div style="position:absolute;top:93752;left:85"><nobr>deadlock detection by the Hotspot JVM does not necessary prove that you are not dealing with this</nobr></div>
<div style="position:absolute;top:93771;left:85"><nobr>problem.</nobr></div>
<div style="position:absolute;top:93809;left:85"><nobr>The suspect</nobr></div>
<div style="position:absolute;top:93847;left:85"><nobr>In this troubleshooting context, the "suspect" is defined as the application or middleware code with the</nobr></div>
<div style="position:absolute;top:93866;left:85"><nobr>following problematic execution pattern.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:93922;left:764"><nobr>79 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:93118;left:101"><nobr>Found one Java-level deadlock:</nobr></div>
<div style="position:absolute;top:93136;left:101"><nobr>=============================</nobr></div>
<div style="position:absolute;top:93152;left:101"><nobr>"pool-1-thread-2":</nobr></div>
<div style="position:absolute;top:93171;left:109"><nobr>waiting to lock monitor 0x0237ada4 (object 0x272200e8, a java.lang.Object),</nobr></div>
<div style="position:absolute;top:93190;left:109"><nobr>which is held by "pool-1-thread-1"</nobr></div>
<div style="position:absolute;top:93207;left:101"><nobr>"pool-1-thread-1":</nobr></div>
<div style="position:absolute;top:93225;left:109"><nobr>waiting to lock monitor 0x0237aa64 (object 0x272200f0, a java.lang.Object),</nobr></div>
<div style="position:absolute;top:93244;left:109"><nobr>which is held by "pool-1-thread-2"</nobr></div>
</span></font>

<div style="position:absolute;top:94027;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="80"><b>Page 80</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:94113;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:94116;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:94183;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:94181;left:139"><nobr>Usage of FLAT lock followed by the usage of ReentrantLock WRITE lock (execution path #1)</nobr></div>
<div style="position:absolute;top:94203;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:94201;left:139"><nobr>Usage of ReentrantLock READ lock followed by the usage of FLAT lock (execution path #2)</nobr></div>
<div style="position:absolute;top:94224;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:94222;left:139"><nobr>Concurrent execution performed by 2 Java threads but via a reversed execution order</nobr></div>
<div style="position:absolute;top:94260;left:85"><nobr>The above lock-ordering deadlock criteria's can be visualized as per below:</nobr></div>
<div style="position:absolute;top:94805;left:85"><nobr>Now let's replicate this problem via our sample Java program and look at the JVM thread dump output.</nobr></div>
<div style="position:absolute;top:94843;left:85"><nobr>Sample Java program</nobr></div>
<div style="position:absolute;top:94881;left:85"><nobr>This above deadlock conditions was first identified from our Oracle OSB problem case. We then re-</nobr></div>
<div style="position:absolute;top:94899;left:85"><nobr>created it via a simple Java program. You can download the entire source code of our program <a href="https://docs.google.com/file/d/0B6UjfNcYT7yGbmllUEVEM2dFWTQ/edit"></a><font color="#000080"><a href="https://docs.google.com/file/d/0B6UjfNcYT7yGbmllUEVEM2dFWTQ/edit">here</a></font><a href="https://docs.google.com/file/d/0B6UjfNcYT7yGbmllUEVEM2dFWTQ/edit"></a>.</nobr></div>
<div style="position:absolute;top:94937;left:85"><nobr>The program is simply creating and firing 2 worker threads. Each of them execute a different execution</nobr></div>
<div style="position:absolute;top:94956;left:85"><nobr>path and attempt to acquire locks on shared objects but in different orders. We also created a</nobr></div>
<div style="position:absolute;top:94975;left:85"><nobr>deadlock detector thread for monitoring and logging purposes.</nobr></div>
<div style="position:absolute;top:95013;left:85"><nobr>For now, find below the Java class implementing the 2 different execution paths.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:95110;left:764"><nobr>80 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:95215;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="81"><b>Page 81</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:95301;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:95304;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:96298;left:764"><nobr>81 of 127</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95363;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.training8;</font></nobr></div>
<div style="position:absolute;top:95393;left:101"><nobr><b>import </b><font color="#000000">java.util.concurrent.locks.ReentrantReadWriteLock;</font></nobr></div>
<div style="position:absolute;top:95423;left:101"><nobr><b>public class </b><font color="#000000">Task {</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:95453;left:123"><nobr>// Object used for FLAT lock</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95468;left:123"><nobr><b>private final </b><font color="#000000">Object </font><font color="#0000c0">sharedObject </font><font color="#000000">= </font><b>new </b><font color="#000000">Object();</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:95483;left:123"><nobr>// ReentrantReadWriteLock used for WRITE &amp; READ locks</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95498;left:123"><nobr><b>private final </b><font color="#000000">ReentrantReadWriteLock </font><font color="#0000c0">lock </font><font color="#000000">= </font><b>new </b><font color="#000000">ReentrantReadWriteLock();</font></nobr></div>
<div style="position:absolute;top:95528;left:123"><nobr><b>public void </b><font color="#000000">executeTask1() {</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:95558;left:143"><nobr>// 1. Attempt to acquire a ReentrantReadWriteLock READ lock</nobr></div>
</span></font>
<font size="3" color="#0000c0" face="Times"><span style="font-size:10px;font-family:Times;color:#0000c0">
<div style="position:absolute;top:95573;left:143"><nobr>lock<font color="#000000">.readLock().lock();</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:95602;left:143"><nobr>// Wait 2 seconds to simulate some work...</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95618;left:143"><nobr><b>try </b><font color="#000000">{ Thread.</font><i><font color="#000000">sleep</font></i><font color="#000000">(2000);}</font><b>catch </b><font color="#000000">(Throwable any) {}</font></nobr></div>
<div style="position:absolute;top:95647;left:143"><nobr><b>try </b><font color="#000000">{    </font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:95663;left:165"><nobr>// 2. Attempt to acquire a Flat lock...</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95678;left:165"><nobr><b>synchronized </b><font color="#000000">(</font><font color="#0000c0">sharedObject</font><font color="#000000">) {}</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:95693;left:143"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:95708;left:143"><nobr>// Remove the READ lock</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95723;left:143"><nobr><b>finally </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" color="#0000c0" face="Times"><span style="font-size:10px;font-family:Times;color:#0000c0">
<div style="position:absolute;top:95738;left:165"><nobr>lock<font color="#000000">.readLock().unlock();</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:95753;left:143"><nobr>}    </nobr></div>
<div style="position:absolute;top:95783;left:143"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"executeTask1() :: Work Done!"</font>);</nobr></div>
<div style="position:absolute;top:95798;left:123"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95828;left:123"><nobr><b>public void </b><font color="#000000">executeTask2() {</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:95858;left:143"><nobr>// 1. Attempt to acquire a Flat lock</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95873;left:143"><nobr><b>synchronized </b><font color="#000000">(</font><font color="#0000c0">sharedObject</font><font color="#000000">) {    </font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:95903;left:165"><nobr>// Wait 2 seconds to simulate some work...</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95918;left:165"><nobr><b>try </b><font color="#000000">{ Thread.</font><i><font color="#000000">sleep</font></i><font color="#000000">(2000);}</font><b>catch </b><font color="#000000">(Throwable any) {}</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:95948;left:165"><nobr>// 2. Attempt to acquire a WRITE lock    </nobr></div>
</span></font>
<font size="3" color="#0000c0" face="Times"><span style="font-size:10px;font-family:Times;color:#0000c0">
<div style="position:absolute;top:95963;left:165"><nobr>lock<font color="#000000">.writeLock().lock();</font></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:95993;left:165"><nobr><b>try </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:96008;left:187"><nobr>// Do nothing</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:96023;left:165"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:96053;left:165"><nobr>// Remove the WRITE lock</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:96068;left:165"><nobr><b>finally </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" color="#0000c0" face="Times"><span style="font-size:10px;font-family:Times;color:#0000c0">
<div style="position:absolute;top:96083;left:187"><nobr>lock<font color="#000000">.writeLock().unlock();</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:96098;left:165"><nobr>}</nobr></div>
<div style="position:absolute;top:96113;left:143"><nobr>}</nobr></div>
<div style="position:absolute;top:96143;left:143"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"executeTask2() :: Work Done!"</font>);</nobr></div>
<div style="position:absolute;top:96158;left:123"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:96188;left:123"><nobr><b>public </b><font color="#000000">ReentrantReadWriteLock getReentrantReadWriteLock() {</font></nobr></div>
<div style="position:absolute;top:96203;left:143"><nobr><b>return </b><font color="#0000c0">lock</font><font color="#000000">;</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:96218;left:123"><nobr>}</nobr></div>
<div style="position:absolute;top:96233;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:96403;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="82"><b>Page 82</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:96489;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:96492;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:96555;left:85"><nobr>As soon ad the deadlock situation was triggered, a JVM thread dump was generated using JvisualVM.</nobr></div>
<div style="position:absolute;top:97421;left:85"><nobr>As you can see from the Java thread dump sample. The JVM did not detect this deadlock condition</nobr></div>
<div style="position:absolute;top:97440;left:85"><nobr>(e.g. no presence of Found one Java-level deadlock) but it is clear these 2 threads are in deadlock</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:97486;left:764"><nobr>82 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:97591;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="83"><b>Page 83</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:97677;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:97680;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:97724;left:85"><nobr>state.</nobr></div>
<div style="position:absolute;top:97762;left:85"><nobr>Root cause: ReetrantLock READ lock behavior</nobr></div>
<div style="position:absolute;top:97800;left:85"><nobr>The main explanation we found at this point is associated with the usage of the ReetrantLock READ</nobr></div>
<div style="position:absolute;top:97819;left:85"><nobr>lock. The read locks are normally <a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6207928"></a><font color="#000080"><a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6207928">not designed </a></font>to have a notion of ownership. Since there is not a</nobr></div>
<div style="position:absolute;top:97838;left:85"><nobr>record of which thread holds a read lock, this appears to prevent the HotSpot JVM deadlock detector</nobr></div>
<div style="position:absolute;top:97857;left:85"><nobr>logic to detect deadlock involving read locks.</nobr></div>
<div style="position:absolute;top:97895;left:85"><nobr>Some improvements were implemented since then but we can see that the JVM still cannot detect this</nobr></div>
<div style="position:absolute;top:97914;left:85"><nobr>special deadlock scenario.</nobr></div>
<div style="position:absolute;top:97952;left:85"><nobr>Now if we replace the read lock (execution pattern #1) in our program by a write lock, the JVM will</nobr></div>
<div style="position:absolute;top:97971;left:85"><nobr>finally detect the deadlock condition but why?</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:98674;left:764"><nobr>83 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:98023;left:101"><nobr>Found one Java-level deadlock:</nobr></div>
<div style="position:absolute;top:98040;left:101"><nobr>=============================</nobr></div>
<div style="position:absolute;top:98057;left:101"><nobr>"pool-1-thread-2":</nobr></div>
<div style="position:absolute;top:98076;left:109"><nobr>waiting for ownable synchronizer 0x272239c0, (a</nobr></div>
<div style="position:absolute;top:98093;left:101"><nobr>java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync),</nobr></div>
<div style="position:absolute;top:98111;left:109"><nobr>which is held by "pool-1-thread-1"</nobr></div>
<div style="position:absolute;top:98129;left:101"><nobr>"pool-1-thread-1":</nobr></div>
<div style="position:absolute;top:98147;left:109"><nobr>waiting to lock monitor 0x025cad3c (object 0x272236d0, a java.lang.Object),</nobr></div>
<div style="position:absolute;top:98166;left:109"><nobr>which is held by "pool-1-thread-2"</nobr></div>
</span></font>

<div style="position:absolute;top:98779;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="84"><b>Page 84</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:98865;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:98868;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:99576;left:89"><nobr>This is because write locks are tracked by the JVM similar to flat locks. This means the HotSpot JVM</nobr></div>
<div style="position:absolute;top:99595;left:85"><nobr>deadlock detector appears to be currently designed to detect:</nobr></div>
<div style="position:absolute;top:99637;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:99635;left:157"><nobr>Deadlock on Object monitors involving FLAT locks</nobr></div>
<div style="position:absolute;top:99657;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:99655;left:157"><nobr>Deadlock involving Locked ownable synchronizers associated with WRITE locks</nobr></div>
<div style="position:absolute;top:99693;left:85"><nobr>The lack of read lock per-thread tracking appears to prevent deadlock detection for this scenario and</nobr></div>
<div style="position:absolute;top:99712;left:85"><nobr>significantly increase the troubleshooting complexity.</nobr></div>
<div style="position:absolute;top:99750;left:85"><nobr>I suggest that you read <a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6207928"></a><font color="#000080"><a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6207928">Doug Lea’s comments </a></font>on this whole issue since concerns were raised back in</nobr></div>
<div style="position:absolute;top:99769;left:85"><nobr>2005 regarding the possibility to add per-thread read-hold tracking due to some potential lock</nobr></div>
<div style="position:absolute;top:99788;left:85"><nobr>overhead.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:99862;left:764"><nobr>84 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:98949;left:101"><nobr>Java stack information for the threads listed above:</nobr></div>
<div style="position:absolute;top:98966;left:101"><nobr>===================================================</nobr></div>
<div style="position:absolute;top:98983;left:101"><nobr>"pool-1-thread-2":</nobr></div>
<div style="position:absolute;top:99000;left:110"><nobr>at sun.misc.Unsafe.park(Native Method)</nobr></div>
<div style="position:absolute;top:99017;left:110"><nobr>- parking to wait for &lt;0x272239c0&gt; (a</nobr></div>
<div style="position:absolute;top:99034;left:101"><nobr>java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync)</nobr></div>
<div style="position:absolute;top:99051;left:110"><nobr>at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)</nobr></div>
<div style="position:absolute;top:99068;left:110"><nobr>at</nobr></div>
<div style="position:absolute;top:99085;left:101"><nobr>java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(Abs</nobr></div>
<div style="position:absolute;top:99102;left:101"><nobr>tractQueuedSynchronizer.java:834)</nobr></div>
<div style="position:absolute;top:99119;left:110"><nobr>at</nobr></div>
<div style="position:absolute;top:99136;left:101"><nobr>java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQue</nobr></div>
<div style="position:absolute;top:99153;left:101"><nobr>uedSynchronizer.java:867)</nobr></div>
<div style="position:absolute;top:99170;left:110"><nobr>at</nobr></div>
<div style="position:absolute;top:99187;left:101"><nobr>java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSyn</nobr></div>
<div style="position:absolute;top:99204;left:101"><nobr>chronizer.java:1197)</nobr></div>
<div style="position:absolute;top:99221;left:110"><nobr>at</nobr></div>
<div style="position:absolute;top:99238;left:101"><nobr>java.util.concurrent.locks.ReentrantReadWriteLock$WriteLock.lock(ReentrantReadW</nobr></div>
<div style="position:absolute;top:99255;left:101"><nobr>riteLock.java:945)</nobr></div>
<div style="position:absolute;top:99272;left:110"><nobr>at org.ph.javaee.training8.Task.executeTask2(Task.java:54)</nobr></div>
<div style="position:absolute;top:99289;left:110"><nobr>- locked &lt;0x272236d0&gt; (a java.lang.Object)</nobr></div>
<div style="position:absolute;top:99306;left:110"><nobr>at org.ph.javaee.training8.WorkerThread2.run(WorkerThread2.java:29)</nobr></div>
<div style="position:absolute;top:99323;left:110"><nobr>at</nobr></div>
<div style="position:absolute;top:99340;left:101"><nobr>java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)</nobr></div>
<div style="position:absolute;top:99357;left:110"><nobr>at</nobr></div>
<div style="position:absolute;top:99374;left:101"><nobr>java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)</nobr></div>
<div style="position:absolute;top:99391;left:110"><nobr>at java.lang.Thread.run(Thread.java:722)</nobr></div>
<div style="position:absolute;top:99408;left:101"><nobr>"pool-1-thread-1":</nobr></div>
<div style="position:absolute;top:99426;left:110"><nobr>at org.ph.javaee.training8.Task.executeTask1(Task.java:31)</nobr></div>
<div style="position:absolute;top:99442;left:110"><nobr>- waiting to lock &lt;0x272236d0&gt; (a java.lang.Object)</nobr></div>
<div style="position:absolute;top:99460;left:110"><nobr>at org.ph.javaee.training8.WorkerThread1.run(WorkerThread1.java:29)</nobr></div>
<div style="position:absolute;top:99477;left:110"><nobr>at</nobr></div>
<div style="position:absolute;top:99494;left:101"><nobr>java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)</nobr></div>
<div style="position:absolute;top:99511;left:110"><nobr>at</nobr></div>
<div style="position:absolute;top:99528;left:101"><nobr>java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)</nobr></div>
<div style="position:absolute;top:99545;left:110"><nobr>at java.lang.Thread.run(Thread.java:722)</nobr></div>
</span></font>

<div style="position:absolute;top:99967;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="85"><b>Page 85</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:100053;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:100056;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:100100;left:85"><nobr>Find below my troubleshooting recommendations if you suspect a hidden deadlock condition involving</nobr></div>
<div style="position:absolute;top:100119;left:85"><nobr>read locks:</nobr></div>
<div style="position:absolute;top:100161;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:100159;left:139"><nobr>Analyze closely the thread call stack trace, it may reveal some code potentially acquiring read</nobr></div>
<div style="position:absolute;top:100178;left:139"><nobr>locks and preventing other threads to acquire write locks.</nobr></div>
<div style="position:absolute;top:100200;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:100198;left:139"><nobr>If you are the owner of the code, keep track of the read lock count via the usage of the</nobr></div>
<div style="position:absolute;top:100217;left:139"><nobr>lock.getReadLockCount() method</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:100273;left:85"><nobr><b>OutOfMemoryError patterns</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:100329;left:85"><nobr>An OutOfMemoryError problem is one of the most frequent and complex problems a Java EE</nobr></div>
<div style="position:absolute;top:100348;left:85"><nobr>application support person can face with a production system. This section will focus on a particular</nobr></div>
<div style="position:absolute;top:100367;left:85"><nobr>OOM flavour: PermGen space depletion of a Java HotSpot VM.</nobr></div>
<div style="position:absolute;top:100405;left:85"><nobr>Find below some of the most common patterns of OutOfMemoryError due to the depletion of the</nobr></div>
<div style="position:absolute;top:100424;left:85"><nobr>PermGen space.</nobr></div>
<div style="position:absolute;top:100466;left:150"><nobr><b>Pattern</b></nobr></div>
<div style="position:absolute;top:100466;left:323"><nobr><b>Symptoms</b></nobr></div>
<div style="position:absolute;top:100466;left:475"><nobr><b>Possible root cause</b></nobr></div>
<div style="position:absolute;top:100485;left:514"><nobr><b>scenarios</b></nobr></div>
<div style="position:absolute;top:100466;left:697"><nobr><b>Resolution</b></nobr></div>
<div style="position:absolute;top:100512;left:89"><nobr>OOM observed during</nobr></div>
<div style="position:absolute;top:100531;left:89"><nobr>or after a migration of a</nobr></div>
<div style="position:absolute;top:100550;left:89"><nobr>Java EE server to</nobr></div>
<div style="position:absolute;top:100569;left:89"><nobr>newer version</nobr></div>
<div style="position:absolute;top:100512;left:276"><nobr>- OOM may be</nobr></div>
<div style="position:absolute;top:100531;left:276"><nobr>observed on server</nobr></div>
<div style="position:absolute;top:100550;left:276"><nobr>start-up at deployment</nobr></div>
<div style="position:absolute;top:100569;left:276"><nobr>time</nobr></div>
<div style="position:absolute;top:100588;left:276"><nobr>- OOM may be</nobr></div>
<div style="position:absolute;top:100607;left:276"><nobr>observed very shortly</nobr></div>
<div style="position:absolute;top:100626;left:276"><nobr>after server start-up and</nobr></div>
<div style="position:absolute;top:100645;left:276"><nobr>after 1 or 2+ hours of</nobr></div>
<div style="position:absolute;top:100664;left:276"><nobr>production traffic</nobr></div>
<div style="position:absolute;top:100512;left:463"><nobr>- Higher PermGen</nobr></div>
<div style="position:absolute;top:100531;left:463"><nobr>capacity is often</nobr></div>
<div style="position:absolute;top:100550;left:463"><nobr>required due to</nobr></div>
<div style="position:absolute;top:100569;left:463"><nobr>increased Java EE</nobr></div>
<div style="position:absolute;top:100588;left:463"><nobr>server vendor code and</nobr></div>
<div style="position:absolute;top:100607;left:463"><nobr>libraries</nobr></div>
<div style="position:absolute;top:100512;left:650"><nobr>- Increase your</nobr></div>
<div style="position:absolute;top:100531;left:650"><nobr>PermGen space</nobr></div>
<div style="position:absolute;top:100550;left:650"><nobr>capacity via</nobr></div>
<div style="position:absolute;top:100569;left:650"><nobr>-XX:MaxPermSize</nobr></div>
<div style="position:absolute;top:100691;left:89"><nobr>OOM observed after a</nobr></div>
<div style="position:absolute;top:100710;left:89"><nobr>certain period of time</nobr></div>
<div style="position:absolute;top:100691;left:276"><nobr>- OOM observed after a</nobr></div>
<div style="position:absolute;top:100710;left:276"><nobr>longer but consistent</nobr></div>
<div style="position:absolute;top:100729;left:276"><nobr>period of time (days)</nobr></div>
<div style="position:absolute;top:100748;left:276"><nobr>- PermGen space</nobr></div>
<div style="position:absolute;top:100767;left:276"><nobr>monitoring will show</nobr></div>
<div style="position:absolute;top:100786;left:276"><nobr>hourly or daily increase</nobr></div>
<div style="position:absolute;top:100805;left:276"><nobr>during your application</nobr></div>
<div style="position:absolute;top:100824;left:276"><nobr>business hours</nobr></div>
<div style="position:absolute;top:100691;left:463"><nobr>- There are many</nobr></div>
<div style="position:absolute;top:100710;left:463"><nobr>possible causes of</nobr></div>
<div style="position:absolute;top:100729;left:463"><nobr>PermGen space</nobr></div>
<div style="position:absolute;top:100748;left:463"><nobr>memory leak. The most</nobr></div>
<div style="position:absolute;top:100767;left:463"><nobr>common is a class</nobr></div>
<div style="position:absolute;top:100786;left:463"><nobr>loader leak: increasing</nobr></div>
<div style="position:absolute;top:100805;left:463"><nobr>number of Class objects</nobr></div>
<div style="position:absolute;top:100824;left:463"><nobr>overtime</nobr></div>
<div style="position:absolute;top:100843;left:463"><nobr>- Improper JVM</nobr></div>
<div style="position:absolute;top:100862;left:463"><nobr>arguments like usage of</nobr></div>
<div style="position:absolute;top:100881;left:463"><nobr>the <font color="#ff0000">Xnoclassgc </font>flag</nobr></div>
<div style="position:absolute;top:100900;left:463"><nobr>(<i>turn OFF Class</i></nobr></div>
<div style="position:absolute;top:100919;left:463"><nobr><i>garbage collection</i>)</nobr></div>
<div style="position:absolute;top:100691;left:650"><nobr>- Review your JVM</nobr></div>
<div style="position:absolute;top:100710;left:650"><nobr>HotSpot start-up</nobr></div>
<div style="position:absolute;top:100729;left:650"><nobr>arguments for any</nobr></div>
<div style="position:absolute;top:100748;left:650"><nobr>obvious problem like</nobr></div>
</span></font>
<font size="3" color="#ff0000" face="Times"><span style="font-size:14px;font-family:Times;color:#ff0000">
<div style="position:absolute;top:100767;left:650"><nobr>Xnoclassgc <font color="#000000">flag</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:100786;left:650"><nobr>- Analyse the JVM</nobr></div>
<div style="position:absolute;top:100805;left:650"><nobr>HotSpot Heap Dump as</nobr></div>
<div style="position:absolute;top:100824;left:650"><nobr>it can provides some</nobr></div>
<div style="position:absolute;top:100843;left:650"><nobr>hints on the source of a</nobr></div>
<div style="position:absolute;top:100862;left:650"><nobr>class loader leak</nobr></div>
<div style="position:absolute;top:100881;left:650"><nobr>- Investigate any third</nobr></div>
<div style="position:absolute;top:100900;left:650"><nobr>party API you are using</nobr></div>
<div style="position:absolute;top:100919;left:650"><nobr>for any potential class</nobr></div>
<div style="position:absolute;top:100938;left:650"><nobr>loader leak defect</nobr></div>
<div style="position:absolute;top:100957;left:650"><nobr>- Investigate your</nobr></div>
<div style="position:absolute;top:100976;left:650"><nobr>application code for any</nobr></div>
<div style="position:absolute;top:100995;left:650"><nobr>improper use of</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:101050;left:764"><nobr>85 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:101155;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="86"><b>Page 86</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:101241;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:101244;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:101292;left:650"><nobr>Reflection API and / or</nobr></div>
<div style="position:absolute;top:101311;left:650"><nobr>dynamic class loading</nobr></div>
<div style="position:absolute;top:101339;left:89"><nobr>OOM observed</nobr></div>
<div style="position:absolute;top:101358;left:89"><nobr>following a redeploy of</nobr></div>
<div style="position:absolute;top:101377;left:89"><nobr>your application code</nobr></div>
<div style="position:absolute;top:101396;left:89"><nobr>(<i>EAR, WAR files...</i>)</nobr></div>
<div style="position:absolute;top:101339;left:276"><nobr>- OOM may be</nobr></div>
<div style="position:absolute;top:101358;left:276"><nobr>observed during or</nobr></div>
<div style="position:absolute;top:101377;left:276"><nobr>shortly after your</nobr></div>
<div style="position:absolute;top:101396;left:276"><nobr>application redeploy</nobr></div>
<div style="position:absolute;top:101415;left:276"><nobr>process</nobr></div>
<div style="position:absolute;top:101339;left:463"><nobr>- Unloading and</nobr></div>
<div style="position:absolute;top:101358;left:463"><nobr>reloading of your</nobr></div>
<div style="position:absolute;top:101377;left:463"><nobr>application code can</nobr></div>
<div style="position:absolute;top:101396;left:463"><nobr>lead to PermGen leak</nobr></div>
<div style="position:absolute;top:101415;left:463"><nobr>(<i>class loader leak</i>) and</nobr></div>
<div style="position:absolute;top:101434;left:463"><nobr>deplete your PermGen</nobr></div>
<div style="position:absolute;top:101453;left:463"><nobr>space fairly quickly</nobr></div>
<div style="position:absolute;top:101339;left:650"><nobr>- Open a ticket with your</nobr></div>
<div style="position:absolute;top:101358;left:650"><nobr>Java EE vendor for any</nobr></div>
<div style="position:absolute;top:101377;left:650"><nobr>known class loader leak</nobr></div>
<div style="position:absolute;top:101396;left:650"><nobr>issue</nobr></div>
<div style="position:absolute;top:101415;left:650"><nobr>- Shutdown and restart</nobr></div>
<div style="position:absolute;top:101434;left:650"><nobr>your server (JVM) post</nobr></div>
<div style="position:absolute;top:101453;left:650"><nobr>deployment to cleanup</nobr></div>
<div style="position:absolute;top:101472;left:650"><nobr>any class loader leak</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:101551;left:85"><nobr><i><b>OutOfMemoryError: Java heap space - what is it?</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:101603;left:85"><nobr>This error message is typically what you will see your middleware server logs (Weblogic, WAS, JBoss</nobr></div>
<div style="position:absolute;top:101622;left:85"><nobr>etc.) following a JVM OutOfMemoryError condition:</nobr></div>
<div style="position:absolute;top:101663;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:101661;left:139"><nobr>It is generated from the actual Java HotSpot VM native code</nobr></div>
<div style="position:absolute;top:101684;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:101682;left:139"><nobr>It is triggered as a result of Java Heap (Young Gen / Old Gen spaces) memory allocation</nobr></div>
<div style="position:absolute;top:101701;left:139"><nobr>failure (due to Java Heap exhaustion)</nobr></div>
<div style="position:absolute;top:101739;left:85"><nobr>Ok, so my application Java Heap is exhausted...how can I monitor and track my application Java</nobr></div>
<div style="position:absolute;top:101758;left:85"><nobr>Heap?</nobr></div>
<div style="position:absolute;top:101796;left:85"><nobr>The simplest way to properly monitor and track the memory footprint of your Java Heap spaces</nobr></div>
<div style="position:absolute;top:101815;left:85"><nobr>(Young Gen &amp; Old Gen spaces) is to enable verbose GC from your HotSpot VM. Please simply add</nobr></div>
<div style="position:absolute;top:101834;left:85"><nobr>the following parameters within your JVM start-up arguments:</nobr></div>
<div style="position:absolute;top:101936;left:85"><nobr>You can then follow my tutorial here in order to understand how to read and analyze your HotSpot</nobr></div>
<div style="position:absolute;top:101955;left:85"><nobr>Java Heap footprint.</nobr></div>
<div style="position:absolute;top:101993;left:85"><nobr>Ok thanks, now I can see that I have a big Java Heap memory problem...but how can I fix it?</nobr></div>
<div style="position:absolute;top:102030;left:85"><nobr>There are multiple scenarios which can lead to Java Heap depletion such as:</nobr></div>
<div style="position:absolute;top:102072;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:102070;left:139"><nobr>Java Heap space too small vs. your application traffic &amp; footprint</nobr></div>
<div style="position:absolute;top:102092;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:102091;left:139"><nobr>Java Heap memory leak (OldGen space slowly growing over time...)</nobr></div>
<div style="position:absolute;top:102113;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:102111;left:139"><nobr>Sudden and / or rogue Thread(s) consuming large amount of memory in short amount of time</nobr></div>
<div style="position:absolute;top:102130;left:139"><nobr>etc.</nobr></div>
<div style="position:absolute;top:102168;left:85"><nobr>Find below a list of high level steps you can follow in order to further troubleshoot:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:102238;left:764"><nobr>86 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:101889;left:102"><nobr>-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:&lt;app</nobr></div>
<div style="position:absolute;top:101906;left:102"><nobr>path&gt;/gc.log</nobr></div>
</span></font>

<div style="position:absolute;top:102343;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="87"><b>Page 87</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:102429;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:102432;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:102480;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:102478;left:139"><nobr>If not done already, enabled verbose GC &gt;&gt; -verbose:gc</nobr></div>
<div style="position:absolute;top:102500;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:102498;left:139"><nobr>Analyze the verbose GC output and determine the memory footprint of the Java Heap for each</nobr></div>
<div style="position:absolute;top:102517;left:139"><nobr>of the Java Heap spaces (YoungGen &amp; OldGen)</nobr></div>
<div style="position:absolute;top:102540;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:102538;left:139"><nobr>Analyze the verbose GC output or use a tool like JConsole to determine if your Java Heap is</nobr></div>
<div style="position:absolute;top:102557;left:139"><nobr>leaking over time. This can be observed via monitoring of the HotSpot old gen space.</nobr></div>
<div style="position:absolute;top:102579;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:102577;left:139"><nobr>Monitor your middleware Threads and generate JVM Thread Dumps on a regular basis,</nobr></div>
<div style="position:absolute;top:102596;left:139"><nobr>especially when a sudden increase of Java Heap utilization is observed. Thread Dump</nobr></div>
<div style="position:absolute;top:102615;left:139"><nobr>analysis will allow you to pinpoint potential long running Thread(s) allocating a lot of objects on</nobr></div>
<div style="position:absolute;top:102634;left:139"><nobr>your Java Heap in a short amount of time; if any</nobr></div>
<div style="position:absolute;top:102657;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:102655;left:139"><nobr>Add the following parameter within your JVM start-up arguments:</nobr></div>
<div style="position:absolute;top:102674;left:139"><nobr>-XX:HeapDumpOnOutOfMemoryError This will allow your HotSpot VM to generate a binary</nobr></div>
<div style="position:absolute;top:102693;left:139"><nobr>Heap Dump (HPROF) format. A binary Heap Dump is a critical data allowing to analyze your</nobr></div>
<div style="position:absolute;top:102712;left:139"><nobr>application memory footprint and / or source(s) of Java Heap memory leak</nobr></div>
<div style="position:absolute;top:102750;left:85"><nobr>From a resolution perspective, my recommendation to you is to analyze your Java Heap memory</nobr></div>
<div style="position:absolute;top:102769;left:85"><nobr>footprint using the generated Heap Dump. The binary Heap Dump (HPROF format) can be analyzed</nobr></div>
<div style="position:absolute;top:102788;left:85"><nobr>using the free Memory Analyzer tool (MAT). This will allow you to understand your java application</nobr></div>
<div style="position:absolute;top:102807;left:85"><nobr>footprint and / or pinpoint source(s) of possible memory leak. Once you have a clear picture of the</nobr></div>
<div style="position:absolute;top:102826;left:85"><nobr>situation, you will be able to resolve your problem by increasing your Java Heap capacity (via -Xms &amp;</nobr></div>
<div style="position:absolute;top:102845;left:85"><nobr>Xmx arguments) or reducing your application memory footprint and / or eliminating the memory leaks</nobr></div>
<div style="position:absolute;top:102864;left:85"><nobr>from your application code. Please note that memory leaks are often found in middleware server code</nobr></div>
<div style="position:absolute;top:102883;left:85"><nobr>and JDK as well.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:102939;left:85"><nobr><i><b>OutOfMemoryError: Out of swap space - Problem Patterns</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:102991;left:85"><nobr>In this section we will revisit a common Java HotSpot VM problem that you probably already</nobr></div>
<div style="position:absolute;top:103010;left:85"><nobr>experienced at some point in your JVM troubleshooting experience on Solaris OS; especially on a 32-</nobr></div>
<div style="position:absolute;top:103029;left:85"><nobr>bit JVM.</nobr></div>
<div style="position:absolute;top:103067;left:85"><nobr>We will provide you with a description of this particular type of OutOfMemoryError, the common</nobr></div>
<div style="position:absolute;top:103086;left:85"><nobr>problem patterns and the recommended resolution approach.</nobr></div>
<div style="position:absolute;top:103124;left:85"><nobr>java.lang.OutOfMemoryError: Out of swap space? - what is it?</nobr></div>
<div style="position:absolute;top:103161;left:85"><nobr>This error message is thrown by the Java HotSpot VM (native code) following a failure to allocate</nobr></div>
<div style="position:absolute;top:103180;left:85"><nobr>native memory from the OS to the HotSpot C-Heap or dynamically expand the Java Heap etc... This</nobr></div>
<div style="position:absolute;top:103199;left:85"><nobr>problem is very different than a standard OutOfMemoryError (normally due to an exhaustion of the</nobr></div>
<div style="position:absolute;top:103218;left:85"><nobr>Java Heap or PermGen space).</nobr></div>
<div style="position:absolute;top:103256;left:85"><nobr>A typically error found in your application / server logs is:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:103426;left:764"><nobr>87 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:103312;left:101"><nobr>Exception in thread "main" java.lang.OutOfMemoryError: requested 53459 bytes</nobr></div>
<div style="position:absolute;top:103329;left:101"><nobr>for ChunkPool::allocate. <font color="#cc0000">Out of swap space</font>?</nobr></div>
</span></font>

<div style="position:absolute;top:103531;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="88"><b>Page 88</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:103617;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:103620;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:103664;left:85"><nobr>Also, please note that depending of the OS that you use (Windows, AIX, Solaris etc.) some</nobr></div>
<div style="position:absolute;top:103683;left:85"><nobr>OutOfMemoryError due to C-Heap exhaustion may not give you detail such as "Out of swap space". In</nobr></div>
<div style="position:absolute;top:103702;left:85"><nobr>this case, you will need to review the OOM error Stack Trace and determine if the computing task that</nobr></div>
<div style="position:absolute;top:103721;left:85"><nobr>triggered the OOM and determine which OutOfMemoryError problem pattern your problem is related</nobr></div>
<div style="position:absolute;top:103740;left:85"><nobr>to (Java Heap, PermGen or Native Heap exhaustion).</nobr></div>
<div style="position:absolute;top:103778;left:85"><nobr>Ok so can I increase the Java Heap via -Xms &amp; -Xmx to fix it?</nobr></div>
<div style="position:absolute;top:103816;left:85"><nobr>Definitely not! This is the last thing you want to do as it will make the problem worse. As you learned,</nobr></div>
<div style="position:absolute;top:103835;left:85"><nobr>the Java HotSpot VM is split between 3 memory spaces (Java Heap, PermGen, C-Heap). For a 32-bit</nobr></div>
<div style="position:absolute;top:103854;left:85"><nobr>VM, all these memory spaces compete between each other for memory. Increasing the Java Heap</nobr></div>
<div style="position:absolute;top:103873;left:85"><nobr>space will further reduce capacity of the C-Heap and reserve more memory from the OS.</nobr></div>
<div style="position:absolute;top:103911;left:85"><nobr>Your first task is to determine if you are dealing with a C-Heap depletion or OS physical / virtual</nobr></div>
<div style="position:absolute;top:103930;left:85"><nobr>memory depletion.</nobr></div>
<div style="position:absolute;top:103968;left:85"><nobr>Now let's see the most common patterns of this problem.</nobr></div>
<div style="position:absolute;top:104006;left:85"><nobr>Common problem patterns</nobr></div>
<div style="position:absolute;top:104044;left:85"><nobr>There are multiple scenarios which can lead to a native OutOfMemoryError. I will share with you what I</nobr></div>
<div style="position:absolute;top:104063;left:85"><nobr>have seen in my past experience as the most common patterns.</nobr></div>
<div style="position:absolute;top:104104;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104102;left:139"><nobr>Native Heap (C-Heap) depletion due to too many Java EE applications deployed on a single</nobr></div>
<div style="position:absolute;top:104121;left:139"><nobr>32-bit JVM (combined with large Java Heap e.g. 2 GB) <i>* most common problem *</i></nobr></div>
<div style="position:absolute;top:104143;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104142;left:139"><nobr>Native Heap (C-Heap) depletion due to a non-optimal Java Heap size e.g. Java Heap too large</nobr></div>
<div style="position:absolute;top:104161;left:139"><nobr>for the application(s) needs on a single 32-bit JVM</nobr></div>
<div style="position:absolute;top:104183;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104181;left:139"><nobr>Native Heap (C-Heap) depletion due to too many created Java Threads e.g. allowing the Java</nobr></div>
<div style="position:absolute;top:104200;left:139"><nobr>EE container to create too many Threads on a single 32-bit JVM</nobr></div>
<div style="position:absolute;top:104223;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104221;left:139"><nobr>OS physical / virtual memory depletion preventing the HotSpot VM to allocate native memory</nobr></div>
<div style="position:absolute;top:104240;left:139"><nobr>to the C-Heap (32-bit or 64-bit VM)</nobr></div>
<div style="position:absolute;top:104262;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104260;left:139"><nobr>OS physical / virtual memory depletion preventing the HotSpot VM to expand its Java Heap or</nobr></div>
<div style="position:absolute;top:104279;left:139"><nobr>PermGen space at runtime (32-bit or 64-bit VM)</nobr></div>
<div style="position:absolute;top:104302;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104300;left:139"><nobr>C-Heap / native memory leak (third party monitoring agent / library, JVM bug etc.)</nobr></div>
<div style="position:absolute;top:104338;left:85"><nobr>Troubleshooting and resolution approach</nobr></div>
<div style="position:absolute;top:104376;left:85"><nobr>Please keep in mind that each HotSpot native memory problem can be unique and requires its own</nobr></div>
<div style="position:absolute;top:104395;left:85"><nobr>troubleshooting &amp; resolution approach.</nobr></div>
<div style="position:absolute;top:104433;left:85"><nobr>Find below a list of high level steps you can follow in order to further troubleshoot:</nobr></div>
<div style="position:absolute;top:104474;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104472;left:139"><nobr>First, determine if the OOM is due to C-Heap exhaustion or OS physical / virtual memory. For</nobr></div>
<div style="position:absolute;top:104491;left:139"><nobr>this task, you will need to perform close monitoring of your OS memory utilization and Java</nobr></div>
<div style="position:absolute;top:104510;left:139"><nobr>process size. For example on Solaris, a 32-bit JVM process size can go to about 3.5 GB</nobr></div>
<div style="position:absolute;top:104529;left:139"><nobr>(technically 4 GB limit) then you can expect some native memory allocation failures. The Java</nobr></div>
<div style="position:absolute;top:104548;left:139"><nobr>process size monitoring will also allow you to determine if you are dealing with a native</nobr></div>
<div style="position:absolute;top:104567;left:139"><nobr>memory leak (growing overtime / several days...).</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:104614;left:764"><nobr>88 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:104719;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="89"><b>Page 89</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:104805;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:104808;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:104856;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104854;left:139"><nobr>The OS vendor and version that you use is important as well. For example, some versions of</nobr></div>
<div style="position:absolute;top:104873;left:139"><nobr>Windows (32-bit) by default support a process size up to 2 GB only (leaving you with minimal</nobr></div>
<div style="position:absolute;top:104892;left:139"><nobr>flexibility for Java Heap and Native Heap allocations). Please review your OS and determine</nobr></div>
<div style="position:absolute;top:104911;left:139"><nobr>what is the maximum process size e.g. 2 GB, 3 GB or 4 GB or more (64-bit OS).</nobr></div>
<div style="position:absolute;top:104933;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104931;left:139"><nobr>Like the OS, it is also important that you review and determine if you are using a 32-bit VM or</nobr></div>
<div style="position:absolute;top:104950;left:139"><nobr>64-bit VM. Native memory depletion for a 64-bit VM typically means that your OS is running out</nobr></div>
<div style="position:absolute;top:104969;left:139"><nobr>of physical / virtual memory.</nobr></div>
<div style="position:absolute;top:104992;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:104990;left:139"><nobr>Review your JVM memory settings. For a 32-bit VM, a Java Heap of 2 GB+ can really start to</nobr></div>
<div style="position:absolute;top:105009;left:139"><nobr>add pressure point on the C-Heap; depending how many applications you have deployed, Java</nobr></div>
<div style="position:absolute;top:105028;left:139"><nobr>Threads etc. In that case, please determine if you can safely reduce your Java Heap by about</nobr></div>
<div style="position:absolute;top:105047;left:139"><nobr>256 MB (as a starting point) and see if it helps improve your JVM memory "balance".</nobr></div>
<div style="position:absolute;top:105069;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:105067;left:139"><nobr>Analyze the verbose GC output or use a tool like JConsole to determine your Java Heap</nobr></div>
<div style="position:absolute;top:105086;left:139"><nobr>footprint. This will allow you to determine if you can reduce your Java Heap in a safe manner</nobr></div>
<div style="position:absolute;top:105105;left:139"><nobr>or not.</nobr></div>
<div style="position:absolute;top:105127;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:105126;left:139"><nobr>When OutOfMemoryError is observed. Generate a JVM Thread Dump and determine how</nobr></div>
<div style="position:absolute;top:105145;left:139"><nobr>many Threads are active in your JVM; the more Threads, the more native memory your JVM</nobr></div>
<div style="position:absolute;top:105164;left:139"><nobr>will use. You will then be able to combine this data with OS, Java process size and verbose</nobr></div>
<div style="position:absolute;top:105183;left:139"><nobr>GC; allowing to determine where the problem is.</nobr></div>
<div style="position:absolute;top:105221;left:85"><nobr>Once you have a clear view of the situation in your environment and root cause, you will be in a better</nobr></div>
<div style="position:absolute;top:105240;left:85"><nobr>position to explore potential solutions as per below:</nobr></div>
<div style="position:absolute;top:105281;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:105279;left:139"><nobr>Reduce the Java Heap (if possible / after close monitoring of the Java Heap) in order to give</nobr></div>
<div style="position:absolute;top:105298;left:139"><nobr>that memory back to the C-Heap / OS.</nobr></div>
<div style="position:absolute;top:105320;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:105319;left:139"><nobr>Increase the physical RAM / virtual memory of your OS (only applicable if depletion of the OS</nobr></div>
<div style="position:absolute;top:105338;left:139"><nobr>memory is observed; especially for a 64-bit OS &amp; VM).</nobr></div>
<div style="position:absolute;top:105360;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:105358;left:139"><nobr>Upgrade your HotSpot VM to 64-bit (for some Java EE applications, a 64-bit VM is more</nobr></div>
<div style="position:absolute;top:105377;left:139"><nobr>appropriate) or segregate your applications to different JVM's (increase demand on your</nobr></div>
<div style="position:absolute;top:105396;left:139"><nobr>hardware but reduce utilization of C-Heap per JVM).</nobr></div>
<div style="position:absolute;top:105418;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:105417;left:139"><nobr>Native memory leak are trickier and requires deeper dive analysis such as analysis of the</nobr></div>
<div style="position:absolute;top:105436;left:139"><nobr>Solaris pmap / AIX svmon data and review of any third party library (e.g. monitoring agents).</nobr></div>
<div style="position:absolute;top:105455;left:139"><nobr>Please also review the <a href="http://bugs.sun.com/"></a><font color="#000080"><a href="http://bugs.sun.com/">Oracle Sun Bug database </a></font>and determine if your HotSpot version you</nobr></div>
<div style="position:absolute;top:105474;left:139"><nobr>use is exposed to known native memory problems.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:105530;left:85"><nobr><i><b>OutOfMemoryError: unable to create new native thread</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:105582;left:85"><nobr>One of the common problems I have observed from Java EE production systems is</nobr></div>
<div style="position:absolute;top:105601;left:85"><nobr>OutOfMemoryError: unable to create new native thread; error thrown when the HotSpot JVM is unable</nobr></div>
<div style="position:absolute;top:105620;left:85"><nobr>to further create a new Java thread.</nobr></div>
<div style="position:absolute;top:105658;left:85"><nobr>This section will revisit this HotSpot VM error and provide you with recommendations and resolution</nobr></div>
<div style="position:absolute;top:105677;left:85"><nobr>strategies.</nobr></div>
<div style="position:absolute;top:105714;left:85"><nobr>OutOfMemoryError: unable to create new native thread - what is it?</nobr></div>
<div style="position:absolute;top:105752;left:85"><nobr>Let's start with a basic explanation. This HotSpot JVM error is thrown when the internal JVM native</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:105802;left:764"><nobr>89 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:105907;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="90"><b>Page 90</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:105993;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:105996;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:106040;left:85"><nobr>code is unable to create a new Java thread. More precisely, it means that the JVM native code was</nobr></div>
<div style="position:absolute;top:106059;left:85"><nobr>unable to create a new "native" thread from the OS (Solaris, Linux, MAC, Windows...). Unfortunately</nobr></div>
<div style="position:absolute;top:106078;left:85"><nobr>at this point you won't get more detail than this error, with no indication of why the JVM is unable to</nobr></div>
<div style="position:absolute;top:106097;left:85"><nobr>create a new thread from the OS.</nobr></div>
<div style="position:absolute;top:106135;left:85"><nobr>HotSpot JVM: 32-bit or 64-bit?</nobr></div>
<div style="position:absolute;top:106173;left:85"><nobr>Before you go any further in the analysis, one fundamental fact that you must determine from your</nobr></div>
<div style="position:absolute;top:106192;left:85"><nobr>Java or Java EE environment is which version of HotSpot VM you are using e.g. 32-bit or 64-bit.</nobr></div>
<div style="position:absolute;top:106230;left:85"><nobr>Why is it so important? What you will learn shortly is that this JVM problem is very often related to</nobr></div>
<div style="position:absolute;top:106249;left:85"><nobr>native memory depletion; either at the JVM process or OS level. For now please keep in mind that:</nobr></div>
<div style="position:absolute;top:106290;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:106289;left:139"><nobr>A 32-bit JVM process is in theory allowed to grow up to 4 GB (even much lower on some older</nobr></div>
<div style="position:absolute;top:106307;left:139"><nobr>32-bit Windows versions).</nobr></div>
<div style="position:absolute;top:106330;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:106328;left:139"><nobr>For a 32-bit JVM process, the C-Heap is in a race with the Java Heap and PermGen space</nobr></div>
<div style="position:absolute;top:106347;left:139"><nobr>e.g. C-Heap capacity = 2-4 GB - Java Heap size (-Xms, -Xmx) - PermGen size (-</nobr></div>
<div style="position:absolute;top:106366;left:139"><nobr>XX:MaxPermSize)</nobr></div>
<div style="position:absolute;top:106388;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:106386;left:139"><nobr>A 64-bit JVM process is in theory allowed to use most of the OS virtual memory available or up</nobr></div>
<div style="position:absolute;top:106406;left:139"><nobr>to 16 EB (16 million TB)</nobr></div>
<div style="position:absolute;top:106443;left:85"><nobr>As you can see, if you allocate a large Java Heap (2 GB+) for a 32-bit JVM process, the native</nobr></div>
<div style="position:absolute;top:106462;left:85"><nobr>memory space capacity will be reduced automatically, opening the door for JVM native memory</nobr></div>
<div style="position:absolute;top:106481;left:85"><nobr>allocation failures.</nobr></div>
<div style="position:absolute;top:106519;left:85"><nobr>For a 64-bit JVM process, your main concern, from a JVM C-Heap perspective, is the capacity and</nobr></div>
<div style="position:absolute;top:106538;left:85"><nobr>availability of the OS physical, virtual and swap memory.</nobr></div>
<div style="position:absolute;top:106576;left:85"><nobr>OK great but how does native memory affect Java threads creation?</nobr></div>
<div style="position:absolute;top:106614;left:85"><nobr>Now back to our primary problem. Another fundamental JVM aspect to understand is that Java</nobr></div>
<div style="position:absolute;top:106633;left:85"><nobr>threads created from the JVM requires native memory from the OS. You should now start to</nobr></div>
<div style="position:absolute;top:106652;left:85"><nobr>understand the source of your problem.</nobr></div>
<div style="position:absolute;top:106690;left:85"><nobr>The high level thread creation process is as per below:</nobr></div>
<div style="position:absolute;top:106731;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:106730;left:139"><nobr>A new Java thread is requested from the Java program &amp; JDK.</nobr></div>
<div style="position:absolute;top:106752;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:106750;left:139"><nobr>The JVM native code then attempt to create a new native thread from the OS.</nobr></div>
<div style="position:absolute;top:106773;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:106771;left:139"><nobr>The OS then attempts to create a new native thread as per attributes which include the thread</nobr></div>
<div style="position:absolute;top:106790;left:139"><nobr>stack size. Native memory is then allocated (reserved) from the OS to the Java process native</nobr></div>
<div style="position:absolute;top:106809;left:139"><nobr>memory space; assuming the process has enough address space (e.g. 32-bit process) to</nobr></div>
<div style="position:absolute;top:106828;left:139"><nobr>honour the request.</nobr></div>
<div style="position:absolute;top:106850;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:106848;left:139"><nobr>The OS will refuse any further native thread &amp; memory allocation if the 32-bit Java process</nobr></div>
<div style="position:absolute;top:106867;left:139"><nobr>size has depleted its memory address space e.g. 2 GB, 3 GB or 4 GB process size limit.</nobr></div>
<div style="position:absolute;top:106890;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:106888;left:139"><nobr>The OS will also refuse any further Thread &amp; native memory allocation if the virtual memory of</nobr></div>
<div style="position:absolute;top:106907;left:139"><nobr>the OS is depleted (including Solaris swap space depletion since thread access to the stack</nobr></div>
<div style="position:absolute;top:106926;left:139"><nobr>can generate a SIGBUS error, crashing the JVM (also see here).</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:106990;left:764"><nobr>90 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:107095;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="91"><b>Page 91</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:107181;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:107184;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:107228;left:85"><nobr>In summary:</nobr></div>
<div style="position:absolute;top:107269;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:107268;left:139"><nobr>Java threads creation require native memory available from the OS; for both 32-bit &amp; 64-bit</nobr></div>
<div style="position:absolute;top:107287;left:139"><nobr>JVM processes</nobr></div>
<div style="position:absolute;top:107309;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:107307;left:139"><nobr>For a 32-bit JVM, Java thread creation also requires memory available from the C-Heap or</nobr></div>
<div style="position:absolute;top:107326;left:139"><nobr>process address space</nobr></div>
<div style="position:absolute;top:107364;left:85"><nobr>Problem diagnostic</nobr></div>
<div style="position:absolute;top:107402;left:85"><nobr>Now that you understand native memory and JVM thread creation a little better, is it now time to look</nobr></div>
<div style="position:absolute;top:107421;left:85"><nobr>at your problem. As a starting point, I suggest that your follow the analysis approach below:</nobr></div>
<div style="position:absolute;top:107462;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:107461;left:139"><nobr>Determine if you are using HotSpot 32-bit or 64-bit JVM</nobr></div>
<div style="position:absolute;top:107483;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:107481;left:139"><nobr>When problem is observed, take a JVM Thread Dump and determine how many Threads are</nobr></div>
<div style="position:absolute;top:107500;left:139"><nobr>active</nobr></div>
<div style="position:absolute;top:107523;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:107521;left:139"><nobr>Monitor closely the Java process size utilization before and during the OOM problem</nobr></div>
<div style="position:absolute;top:107540;left:139"><nobr>replication</nobr></div>
<div style="position:absolute;top:107562;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:107560;left:139"><nobr>Monitor closely the OS virtual memory utilization before and during the OOM problem</nobr></div>
<div style="position:absolute;top:107579;left:139"><nobr>replication; including the swap memory space utilization if using Solaris OS</nobr></div>
<div style="position:absolute;top:107617;left:85"><nobr>Proper data gathering as per above will allow you to collect the proper data points, allowing you to</nobr></div>
<div style="position:absolute;top:107636;left:85"><nobr>perform the first level of investigation. The next step will be to look at the possible problem patterns</nobr></div>
<div style="position:absolute;top:107655;left:85"><nobr>and determine which one is applicable for your problem case.</nobr></div>
<div style="position:absolute;top:107693;left:85"><nobr>Problem pattern #1 - C-Heap depletion (32-bit JVM)</nobr></div>
<div style="position:absolute;top:107731;left:85"><nobr>From my experience, OutOfMemoryError: unable to create new native thread is quite common for 32-</nobr></div>
<div style="position:absolute;top:107750;left:85"><nobr>bit JVM processes. This problem is often observed when too many threads are created vs. C-Heap</nobr></div>
<div style="position:absolute;top:107769;left:85"><nobr>capacity.</nobr></div>
<div style="position:absolute;top:107788;left:85"><nobr>JVM Thread Dump analysis and Java process size monitoring will allow you to determine if this is the</nobr></div>
<div style="position:absolute;top:107807;left:85"><nobr>cause.</nobr></div>
<div style="position:absolute;top:107845;left:85"><nobr>Problem pattern #2 - OS virtual memory depletion (64-bit JVM)</nobr></div>
<div style="position:absolute;top:107883;left:85"><nobr>In this scenario, the OS virtual memory is fully depleted. This could be due to a few 64-bit JVM</nobr></div>
<div style="position:absolute;top:107902;left:85"><nobr>processes taking lot memory e.g. 10 GB+ and / or other high memory footprint rogue processes.</nobr></div>
<div style="position:absolute;top:107921;left:85"><nobr>Again, Java process size &amp; OS virtual memory monitoring will allow you to determine if this is the</nobr></div>
<div style="position:absolute;top:107940;left:85"><nobr>cause.</nobr></div>
<div style="position:absolute;top:107978;left:85"><nobr>Problem pattern #3 - OS virtual memory depletion (32-bit JVM)</nobr></div>
<div style="position:absolute;top:108016;left:85"><nobr>The third scenario is less frequent but can still be observed. The diagnostic can be a bit more complex</nobr></div>
<div style="position:absolute;top:108035;left:85"><nobr>but the key analysis point will be to determine which processes are causing a full OS virtual memory</nobr></div>
<div style="position:absolute;top:108054;left:85"><nobr>depletion. Your 32-bit JVM processes could be either the source or the victim such as rogue</nobr></div>
<div style="position:absolute;top:108073;left:85"><nobr>processes using most of the OS virtual memory and preventing your 32-bit JVM processes to reserve</nobr></div>
<div style="position:absolute;top:108092;left:85"><nobr>more native memory for its thread creation process.</nobr></div>
<div style="position:absolute;top:108129;left:85"><nobr>Please note that this problem can also manifest itself as a full JVM crash (as per below sample) when</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:108178;left:764"><nobr>91 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:108283;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="92"><b>Page 92</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:108369;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:108372;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:108416;left:85"><nobr>running out of OS virtual memory or swap space on Solaris.</nobr></div>
<div style="position:absolute;top:108876;left:85"><nobr>Native memory depletion: symptom or root cause?</nobr></div>
<div style="position:absolute;top:108914;left:85"><nobr>You now understand your problem and know which problem pattern you are dealing with. You are now</nobr></div>
<div style="position:absolute;top:108933;left:85"><nobr>ready to provide recommendations to address the problem... are you?</nobr></div>
<div style="position:absolute;top:108971;left:85"><nobr>Your work is not done yet, please keep in mind that this JVM OOM event is often just a "symptom" of</nobr></div>
<div style="position:absolute;top:108990;left:85"><nobr>the actual root cause of the problem. The root cause is typically much deeper so before providing</nobr></div>
<div style="position:absolute;top:109009;left:85"><nobr>recommendations to your client I recommend that you really perform deeper analysis. The last thing</nobr></div>
<div style="position:absolute;top:109028;left:85"><nobr>you want to do is to simply address and mask the symptoms. Solutions such as increasing OS</nobr></div>
<div style="position:absolute;top:109047;left:85"><nobr>physical / virtual memory or upgrading all your JVM processes to 64-bit should only be considered</nobr></div>
<div style="position:absolute;top:109065;left:85"><nobr>once you have a good view on the root cause and production environment capacity requirements.</nobr></div>
<div style="position:absolute;top:109103;left:85"><nobr>The next fundamental question to answer is how many threads were active at the time of the</nobr></div>
<div style="position:absolute;top:109122;left:85"><nobr>OutOfMemoryError? In my experience with Java EE production systems, the most common root</nobr></div>
<div style="position:absolute;top:109141;left:85"><nobr>cause is actually the application and / or Java EE container attempting to create too many threads at a</nobr></div>
<div style="position:absolute;top:109160;left:85"><nobr>given time when facing non happy paths such as thread stuck in a remote IO call, thread race</nobr></div>
<div style="position:absolute;top:109179;left:85"><nobr>conditions etc. In this scenario, the Java EE container can start creating too many threads when</nobr></div>
<div style="position:absolute;top:109198;left:85"><nobr>attempting to honour incoming client requests, leading to increase pressure point on the C-Heap and</nobr></div>
<div style="position:absolute;top:109217;left:85"><nobr>native memory allocation. Bottom line, before blaming the JVM, please perform your due diligence and</nobr></div>
<div style="position:absolute;top:109236;left:85"><nobr>determine if you are dealing with an application or Java EE container thread tuning problem as the</nobr></div>
<div style="position:absolute;top:109255;left:85"><nobr>root cause.</nobr></div>
<div style="position:absolute;top:109293;left:85"><nobr>Once you understand and address the root cause (source of thread creations), you can then work on</nobr></div>
<div style="position:absolute;top:109312;left:85"><nobr>tuning your JVM and OS memory capacity in order to make it more fault tolerant and better "survive"</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:109366;left:764"><nobr>92 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:108472;left:101"><nobr>#</nobr></div>
<div style="position:absolute;top:108489;left:101"><nobr># A fatal error has been detected by the Java Runtime Environment:</nobr></div>
<div style="position:absolute;top:108506;left:101"><nobr>#</nobr></div>
<div style="position:absolute;top:108523;left:101"><nobr># <font color="#c00000">java.lang.OutOfMemoryError</font>: requested 32756 bytes for ChunkPool::allocate.</nobr></div>
</span></font>
<font size="3" color="#c00000" face="Courier"><span style="font-size:13px;font-family:Courier;color:#c00000">
<div style="position:absolute;top:108540;left:101"><nobr>Out of swap space<font color="#000000">?</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:108557;left:101"><nobr>#</nobr></div>
<div style="position:absolute;top:108574;left:101"><nobr>#  Internal Error (allocation.cpp:166), pid=2290, tid=27</nobr></div>
<div style="position:absolute;top:108591;left:101"><nobr>#  Error: ChunkPool::allocate</nobr></div>
<div style="position:absolute;top:108608;left:101"><nobr>#</nobr></div>
<div style="position:absolute;top:108625;left:101"><nobr># JRE version: 6.0_24-b07</nobr></div>
<div style="position:absolute;top:108642;left:101"><nobr># Java VM: Java HotSpot(TM) Server VM (19.1-b02 mixed mode solaris-sparc )</nobr></div>
<div style="position:absolute;top:108659;left:101"><nobr># If you would like to submit a bug report, please visit:</nobr></div>
<div style="position:absolute;top:108676;left:101"><nobr>#   http://java.sun.com/webapps/bugreport/crash.jsp</nobr></div>
<div style="position:absolute;top:108693;left:101"><nobr>#</nobr></div>
<div style="position:absolute;top:108727;left:101"><nobr>---------------  T H R E A D  ---------------</nobr></div>
<div style="position:absolute;top:108761;left:101"><nobr>Current thread (0x003fa800):  JavaThread "CompilerThread1" daemon</nobr></div>
<div style="position:absolute;top:108778;left:101"><nobr>[_thread_in_native, id=27, stack(0x65380000,0x65400000)]</nobr></div>
<div style="position:absolute;top:108812;left:101"><nobr>Stack: [0x65380000,0x65400000],  sp=0x653fd758,  free space=501k</nobr></div>
<div style="position:absolute;top:108829;left:101"><nobr>Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)</nobr></div>
</span></font>

<div style="position:absolute;top:109471;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="93"><b>Page 93</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:109557;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:109560;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:109604;left:85"><nobr>these sudden thread surge scenarios.</nobr></div>
<div style="position:absolute;top:109642;left:85"><nobr>Recommendations:</nobr></div>
<div style="position:absolute;top:109683;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:109682;left:139"><nobr>First, quickly rule out any obvious OS memory (physical &amp; virtual memory) &amp; process capacity</nobr></div>
<div style="position:absolute;top:109701;left:139"><nobr>(e.g. ulimit) problem.</nobr></div>
<div style="position:absolute;top:109723;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:109721;left:139"><nobr>Perform a JVM Thread Dump analysis and determine the source of all the active threads vs.</nobr></div>
<div style="position:absolute;top:109740;left:139"><nobr>an established baseline. Determine what is causing your Java application or Java EE container</nobr></div>
<div style="position:absolute;top:109759;left:139"><nobr>to create so many threads at the time of the failure.</nobr></div>
<div style="position:absolute;top:109782;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:109780;left:139"><nobr>Please ensure that your monitoring tools closely monitor both your Java VM processes size &amp;</nobr></div>
<div style="position:absolute;top:109799;left:139"><nobr>OS virtual memory. This crucial data will be required in order to perform a full root cause</nobr></div>
<div style="position:absolute;top:109818;left:139"><nobr>analysis. Please remember that a 32-bit Java process size is limited between 2 GB - 4 GB</nobr></div>
<div style="position:absolute;top:109837;left:139"><nobr>depending of your OS.</nobr></div>
<div style="position:absolute;top:109859;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:109857;left:139"><nobr>Look at all running processes and determine if your JVM processes are actually the source of</nobr></div>
<div style="position:absolute;top:109876;left:139"><nobr>the problem or victim of other processes consuming all the virtual memory.</nobr></div>
<div style="position:absolute;top:109899;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:109897;left:139"><nobr>Revisit your Java EE container thread configuration &amp; JVM thread stack size. Determine if the</nobr></div>
<div style="position:absolute;top:109916;left:139"><nobr>Java EE container is allowed to create more threads than your JVM process and / or OS can</nobr></div>
<div style="position:absolute;top:109935;left:139"><nobr>handle.</nobr></div>
<div style="position:absolute;top:109957;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:109955;left:139"><nobr>Determine if the Java Heap size of your 32-bit JVM is too large, preventing the JVM to create</nobr></div>
<div style="position:absolute;top:109974;left:139"><nobr>enough threads to fulfill your client requests. In this scenario, you will have to consider</nobr></div>
<div style="position:absolute;top:109993;left:139"><nobr>reducing your Java Heap size (if possible), vertical scaling or upgrade to a 64-bit JVM.</nobr></div>
<div style="position:absolute;top:110031;left:85"><nobr>Capacity planning analysis to the rescue</nobr></div>
<div style="position:absolute;top:110069;left:85"><nobr>Lack of capacity planning analysis is often the source of the problem. Any comprehensive load and</nobr></div>
<div style="position:absolute;top:110088;left:85"><nobr>performance testing exercise should also properly determine the Java EE container threads, JVM &amp;</nobr></div>
<div style="position:absolute;top:110107;left:85"><nobr>OS native memory requirement for your production environment; including impact measurements of</nobr></div>
<div style="position:absolute;top:110126;left:85"><nobr>"non-happy" paths. This approach will allow your production environment to stay away from this type</nobr></div>
<div style="position:absolute;top:110145;left:85"><nobr>of problem and lead to better system scalability and stability in the long run.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:110201;left:85"><nobr><b>ClassNotFoundException: How to resolve</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:110257;left:85"><nobr>This section will provide you with an overview of this common Java exception, a sample Java program</nobr></div>
<div style="position:absolute;top:110276;left:85"><nobr>to support your learning process and resolution strategies.</nobr></div>
<div style="position:absolute;top:110314;left:85"><nobr>As per the Oracle documentation, <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/ClassNotFoundException.html"></a><font color="#000080"><a href="http://docs.oracle.com/javase/7/docs/api/java/lang/ClassNotFoundException.html">ClassNotFoundException </a></font>is thrown following the failure of a class</nobr></div>
<div style="position:absolute;top:110333;left:85"><nobr>loading call, using its string name, as per below:</nobr></div>
<div style="position:absolute;top:110374;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:110372;left:158"><nobr>The Class.forName method</nobr></div>
<div style="position:absolute;top:110394;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:110393;left:158"><nobr>The ClassLoader.findSystemClass method</nobr></div>
<div style="position:absolute;top:110415;left:131"><nobr>•</nobr></div>
<div style="position:absolute;top:110413;left:158"><nobr>The ClassLoader.loadClass method</nobr></div>
<div style="position:absolute;top:110451;left:85"><nobr>In other words, it means that one particular Java class was not found or could not be loaded at</nobr></div>
<div style="position:absolute;top:110470;left:85"><nobr>"runtime" from your application current context class loader.</nobr></div>
<div style="position:absolute;top:110508;left:85"><nobr>This problem can be particularly confusing for Java beginners. This is why I always recommend to</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:110554;left:764"><nobr>93 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:110659;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="94"><b>Page 94</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:110745;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:110748;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:110792;left:85"><nobr>Java developers to learn and refine their knowledge on <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/ClassLoader.html"></a><font color="#000080"><a href="http://docs.oracle.com/javase/7/docs/api/java/lang/ClassLoader.html">Java class loaders</a></font><a href="http://docs.oracle.com/javase/7/docs/api/java/lang/ClassLoader.html"></a>. Unless you are involved in</nobr></div>
<div style="position:absolute;top:110811;left:85"><nobr>dynamic class loading and using the Java Reflection API, chances are that the</nobr></div>
<div style="position:absolute;top:110830;left:85"><nobr>ClassNotFoundException error you are getting is not from your application code but from a referencing</nobr></div>
<div style="position:absolute;top:110849;left:85"><nobr>API. Another common problem pattern is a wrong packaging of your application code. We will get back</nobr></div>
<div style="position:absolute;top:110868;left:85"><nobr>to the resolution strategies at the end of the section.</nobr></div>
<div style="position:absolute;top:110906;left:85"><nobr>java.lang.ClassNotFoundException: Sample Java program</nobr></div>
<div style="position:absolute;top:110944;left:85"><nobr>Now find below a very simple Java program which simulates the 2 most common</nobr></div>
<div style="position:absolute;top:110963;left:85"><nobr>ClassNotFoundException scenarios via Class.forName() &amp; ClassLoader.loadClass(). Please simply</nobr></div>
<div style="position:absolute;top:110982;left:85"><nobr>copy/paste and run the program with the IDE of your choice (Eclipse IDE was used for this example).</nobr></div>
<div style="position:absolute;top:111020;left:85"><nobr>The Java program allows you to choose between problem scenario #1 or problem scenario #2 as per</nobr></div>
<div style="position:absolute;top:111039;left:85"><nobr>below. Simply change to 1 or 2 depending of the scenario you want to study.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:111742;left:764"><nobr>94 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:111092;left:125"><nobr># Class.forName()</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:111109;left:125"><nobr><b>private static final int </b><i><font color="#0000c0">PROBLEM_SCENARIO </font></i><font color="#000000">= 1;</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:111144;left:125"><nobr># ClassLoader.loadClass()</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:111161;left:125"><nobr><b>private static final int </b><i><font color="#0000c0">PROBLEM_SCENARIO </font></i><font color="#000000">= 2;</font></nobr></div>
</span></font>

<div style="position:absolute;top:111847;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="95"><b>Page 95</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:111933;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:111936;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:112930;left:764"><nobr>95 of 127</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:111995;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.training5;</font></nobr></div>
<div style="position:absolute;top:112023;left:101"><nobr><b>public class </b><font color="#000000">ClassNotFoundExceptionSimulator {</font></nobr></div>
<div style="position:absolute;top:112051;left:104"><nobr><b>private static final </b><font color="#000000">String </font><i><font color="#0000c0">CLASS_TO_LOAD </font></i><font color="#000000">= </font><font color="#2a00ff">"org.ph.javaee.training5.ClassA"</font><font color="#000000">;</font></nobr></div>
<div style="position:absolute;top:112065;left:104"><nobr><b>private static final int </b><i><font color="#0000c0">PROBLEM_SCENARIO </font></i><font color="#000000">= 1;</font></nobr></div>
<div style="position:absolute;top:112094;left:104"><nobr><b>public static void </b><font color="#000000">main(String[] args) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:112122;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"java.lang.ClassNotFoundException Simulator - Training 5"</font>);</nobr></div>
<div style="position:absolute;top:112136;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Author: Pierre-Hugues Charbonneau"</font>);</nobr></div>
<div style="position:absolute;top:112150;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"http://javaeesupportpatterns.blogspot.com"</font>);</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:112178;left:104"><nobr><b>switch</b><font color="#000000">(</font><i><font color="#0000c0">PROBLEM_SCENARIO</font></i><font color="#000000">) {</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:112206;left:104"><nobr>// Scenario #1 - Class.forName()</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:112220;left:104"><nobr><b>case </b><font color="#000000">1:</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:112248;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\n** Problem scenario #1: Class.forName() **\n"</font>);</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:112263;left:104"><nobr><b>try </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:112277;left:104"><nobr>Class&lt;?&gt; newClass = Class.<i>forName</i>(<i><font color="#0000c0">CLASS_TO_LOAD</font></i>);</nobr></div>
<div style="position:absolute;top:112305;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Class "</font>+newClass+<font color="#2a00ff">" found successfully!"</font>);</nobr></div>
<div style="position:absolute;top:112333;left:104"><nobr>} <b><font color="#7f0055">catch </font></b>(ClassNotFoundException ex) {</nobr></div>
<div style="position:absolute;top:112361;left:104"><nobr>ex.printStackTrace();</nobr></div>
<div style="position:absolute;top:112389;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Class "</font>+<i><font color="#0000c0">CLASS_TO_LOAD</font></i>+<font color="#2a00ff">" not found!"</font>);</nobr></div>
<div style="position:absolute;top:112417;left:104"><nobr>} <b><font color="#7f0055">catch </font></b>(Throwable any) {</nobr></div>
<div style="position:absolute;top:112431;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Unexpected error! "</font>+any);</nobr></div>
<div style="position:absolute;top:112446;left:104"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:112474;left:104"><nobr><b>break</b><font color="#000000">;</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:112502;left:104"><nobr>// Scenario #2 - ClassLoader.loadClass()</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:112516;left:104"><nobr><b>case </b><font color="#000000">2:</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:112544;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\n** Problem scenario #2: ClassLoader.loadClass() **\n"</font>);</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:112558;left:104"><nobr><b>try </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:112573;left:104"><nobr>ClassLoader classLoader = Thread.<i>currentThread</i>().getContextClassLoader();</nobr></div>
<div style="position:absolute;top:112587;left:104"><nobr>Class&lt;?&gt; callerClass = classLoader.loadClass(<i><font color="#0000c0">CLASS_TO_LOAD</font></i>);</nobr></div>
<div style="position:absolute;top:112615;left:104"><nobr>Object newClassAInstance = callerClass.newInstance();</nobr></div>
<div style="position:absolute;top:112643;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"SUCCESS!: "</font>+newClassAInstance);</nobr></div>
<div style="position:absolute;top:112657;left:104"><nobr>} <b><font color="#7f0055">catch </font></b>(ClassNotFoundException ex) {</nobr></div>
<div style="position:absolute;top:112685;left:104"><nobr>ex.printStackTrace();</nobr></div>
<div style="position:absolute;top:112713;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Class "</font>+<i><font color="#0000c0">CLASS_TO_LOAD</font></i>+<font color="#2a00ff">" not found!"</font>);</nobr></div>
<div style="position:absolute;top:112741;left:104"><nobr>} <b><font color="#7f0055">catch </font></b>(Throwable any) {</nobr></div>
<div style="position:absolute;top:112756;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Unexpected error! "</font>+any);</nobr></div>
<div style="position:absolute;top:112770;left:104"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:112798;left:104"><nobr><b>break</b><font color="#000000">;</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:112812;left:104"><nobr>}</nobr></div>
<div style="position:absolute;top:112840;left:104"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\nSimulator done!"</font>);</nobr></div>
<div style="position:absolute;top:112854;left:104"><nobr>}</nobr></div>
<div style="position:absolute;top:112869;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:113035;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="96"><b>Page 96</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:113121;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:113124;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:113693;left:85"><nobr>If you run the program as is, you will see the output as per below for each scenario:</nobr></div>
<div style="position:absolute;top:113731;left:85"><nobr>#Scenario 1 output (baseline)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:114118;left:764"><nobr>96 of 127</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:113202;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.training5;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:113237;left:101"><nobr>/**</nobr></div>
<div style="position:absolute;top:113255;left:105"><nobr>* ClassA</nobr></div>
<div style="position:absolute;top:113272;left:105"><nobr>* <b><font color="#7f9fbf">@author </font></b>Pierre<font color="#7f7f9f">-</font>Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:113290;left:105"><nobr>*</nobr></div>
<div style="position:absolute;top:113308;left:105"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:113326;left:101"><nobr><b>public class </b><font color="#000000">ClassA {</font></nobr></div>
<div style="position:absolute;top:113361;left:101"><nobr><b>private final static </b><font color="#000000">Class&lt;ClassA&gt; </font><i><font color="#0000c0">CLAZZ </font></i><font color="#000000">= ClassA.</font><b>class</b><font color="#000000">;</font></nobr></div>
<div style="position:absolute;top:113396;left:127"><nobr><b>static </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:113414;left:150"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Class loading of "</font>+<i><font color="#0000c0">CLAZZ</font></i>+<font color="#2a00ff">" from ClassLoader</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:113431;left:101"><nobr>'"<font color="#000000">+</font><i><font color="#0000c0">CLAZZ</font></i><font color="#000000">.getClassLoader()+</font>"' in progress..."<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:113449;left:127"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:113484;left:127"><nobr><b>public </b><font color="#000000">ClassA() {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:113502;left:150"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Creating a new instance of "</font>+ClassA.<b><font color="#7f0055">class</font></b>.getName()+<font color="#2a00ff">"..."</font>);</nobr></div>
<div style="position:absolute;top:113537;left:150"><nobr>doSomething();</nobr></div>
<div style="position:absolute;top:113555;left:127"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:113590;left:127"><nobr><b>private void </b><font color="#000000">doSomething() {    </font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:113608;left:150"><nobr>// Nothing to do...</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:113625;left:127"><nobr>}</nobr></div>
<div style="position:absolute;top:113643;left:101"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:113768;left:101"><nobr>java.lang.ClassNotFoundException <font color="#000000">Simulator - Training 5</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:113785;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:113802;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:113836;left:101"><nobr>** Problem scenario #1: Class.forName() **</nobr></div>
<div style="position:absolute;top:113870;left:101"><nobr>Class loading of class org.ph.javaee.training5.ClassA from ClassLoader</nobr></div>
<div style="position:absolute;top:113887;left:101"><nobr>'sun.misc.Launcher$AppClassLoader@bfbdb0' in progress...</nobr></div>
<div style="position:absolute;top:113904;left:101"><nobr>Class class org.ph.javaee.training5.ClassA found successfully!</nobr></div>
<div style="position:absolute;top:113938;left:101"><nobr>Simulator done!</nobr></div>
</span></font>

<div style="position:absolute;top:114223;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="97"><b>Page 97</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:114309;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:114312;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:114356;left:85"><nobr>#Scenario 2 output (baseline)</nobr></div>
<div style="position:absolute;top:114641;left:85"><nobr>For the “baseline” run, the Java program is able to load ClassA successfully.</nobr></div>
<div style="position:absolute;top:114683;left:85"><nobr>Now let’s voluntary change the full name of ClassA and re-run the program for each scenario. The</nobr></div>
<div style="position:absolute;top:114704;left:85"><nobr>following output can be observed:</nobr></div>
<div style="position:absolute;top:114742;left:85"><nobr>#ClassA changed to ClassB</nobr></div>
<div style="position:absolute;top:114780;left:85"><nobr>#Scenario 1 output (problem replication)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:115306;left:764"><nobr>97 of 127</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:11px;font-family:Times;color:#000080">
<div style="position:absolute;top:114409;left:101"><nobr>java.lang.ClassNotFoundException <font color="#000000">Simulator - Training 5</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:114424;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:114440;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:114472;left:101"><nobr>** Problem scenario #2: ClassLoader.loadClass() **</nobr></div>
<div style="position:absolute;top:114503;left:101"><nobr>Class loading of class org.ph.javaee.training5.ClassA from ClassLoader</nobr></div>
<div style="position:absolute;top:114519;left:101"><nobr>'sun.misc.Launcher$AppClassLoader@2a340e' in progress...</nobr></div>
<div style="position:absolute;top:114535;left:101"><nobr>Creating a new instance of org.ph.javaee.training5.ClassA...</nobr></div>
<div style="position:absolute;top:114550;left:101"><nobr>SUCCESS!: org.ph.javaee.training5.ClassA@6eb38a</nobr></div>
<div style="position:absolute;top:114582;left:101"><nobr>Simulator done!</nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:114835;left:101"><nobr>java.lang.ClassNotFoundException <font color="#000000">Simulator - Training 5</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:114852;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:114869;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:114903;left:101"><nobr>** Problem scenario #1: Class.forName() **</nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:114937;left:101"><nobr>java.lang.ClassNotFoundException<font color="#ff0000">: org.ph.javaee.training5.ClassB</font></nobr></div>
</span></font>
<font size="3" color="#ff0000" face="Courier"><span style="font-size:13px;font-family:Courier;color:#ff0000">
<div style="position:absolute;top:114954;left:164"><nobr>at java.net.URLClassLoader$1.run(<font color="#000080">URLClassLoader.java:366</font>)</nobr></div>
<div style="position:absolute;top:114971;left:164"><nobr>at java.net.URLClassLoader$1.run(<font color="#000080">URLClassLoader.java:355</font>)</nobr></div>
<div style="position:absolute;top:114988;left:164"><nobr>at java.security.AccessController.doPrivileged(<font color="#000080">Native Method</font>)</nobr></div>
<div style="position:absolute;top:115005;left:164"><nobr>at java.net.URLClassLoader.findClass(<font color="#000080">URLClassLoader.java:354</font>)</nobr></div>
<div style="position:absolute;top:115022;left:164"><nobr>at java.lang.ClassLoader.loadClass(<font color="#000080">ClassLoader.java:423</font>)</nobr></div>
<div style="position:absolute;top:115039;left:164"><nobr>at sun.misc.Launcher$AppClassLoader.loadClass(<font color="#000080">Launcher.java:308</font>)</nobr></div>
<div style="position:absolute;top:115056;left:164"><nobr>at java.lang.ClassLoader.loadClass(<font color="#000080">ClassLoader.java:356</font>)</nobr></div>
<div style="position:absolute;top:115074;left:164"><nobr>at java.lang.Class.forName0(<font color="#000080">Native Method</font>)</nobr></div>
<div style="position:absolute;top:115090;left:164"><nobr>at java.lang.Class.forName(<font color="#000080">Class.java:186</font>)</nobr></div>
<div style="position:absolute;top:115108;left:164"><nobr>at</nobr></div>
<div style="position:absolute;top:115125;left:101"><nobr>org.ph.javaee.training5.ClassNotFoundExceptionSimulator.main(<font color="#000080">ClassNotFoundExcep</font></nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:115142;left:101"><nobr>tionSimulator.java:29<font color="#ff0000">)</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:115159;left:101"><nobr>Class org.ph.javaee.training5.ClassB not found!</nobr></div>
<div style="position:absolute;top:115193;left:101"><nobr>Simulator done!</nobr></div>
</span></font>

<div style="position:absolute;top:115411;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="98"><b>Page 98</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:115497;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:115500;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:115544;left:85"><nobr>#Scenario 2 output (problem replication)</nobr></div>
<div style="position:absolute;top:115953;left:85"><nobr>What happened? Well since we changed the full class name to org.ph.javaee.training5.ClassB, such</nobr></div>
<div style="position:absolute;top:115972;left:85"><nobr>class was not found at runtime (does not exist), causing both Class.forName() and</nobr></div>
<div style="position:absolute;top:115991;left:85"><nobr>ClassLoader.loadClass() calls to fail.</nobr></div>
<div style="position:absolute;top:116029;left:85"><nobr>You can also replicate this problem by packaging each class of this program to its own JAR file and</nobr></div>
<div style="position:absolute;top:116048;left:85"><nobr>then omit ting the jar file containing ClassA.class from the main class path  Please try this and see the</nobr></div>
<div style="position:absolute;top:116067;left:85"><nobr>results for yourself... (hint: NoClassDefFoundError)</nobr></div>
<div style="position:absolute;top:116105;left:85"><nobr>Now let's jump to the resolution strategies.</nobr></div>
<div style="position:absolute;top:116142;left:85"><nobr>java.lang.ClassNotFoundException: Resolution strategies</nobr></div>
<div style="position:absolute;top:116180;left:85"><nobr>Now that you understand this problem, it is now time to resolve it. Resolution can be fairly simple or</nobr></div>
<div style="position:absolute;top:116199;left:85"><nobr>very complex depending of the root cause.</nobr></div>
<div style="position:absolute;top:116241;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:116239;left:139"><nobr>Don't jump on complex root causes too quickly, rule out the simplest causes first.</nobr></div>
<div style="position:absolute;top:116261;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:116259;left:139"><nobr>First review the java.lang.ClassNotFoundException stack trace as per the above and</nobr></div>
<div style="position:absolute;top:116278;left:139"><nobr>determine which Java class was not loaded properly at runtime e.g. application code, third</nobr></div>
<div style="position:absolute;top:116297;left:139"><nobr>party API, Java EE container itself etc.</nobr></div>
<div style="position:absolute;top:116320;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:116318;left:139"><nobr>Identify the caller e.g. Java class you see from the stack trace just before the Class.forName()</nobr></div>
<div style="position:absolute;top:116337;left:139"><nobr>or ClassLoader.loadClass() calls. This will help you understand if your application code is at</nobr></div>
<div style="position:absolute;top:116356;left:139"><nobr>fault vs. a third party API.</nobr></div>
<div style="position:absolute;top:116378;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:116376;left:139"><nobr>Determine if your application code is not packaged properly e.g. missing JAR file(s) from your</nobr></div>
<div style="position:absolute;top:116395;left:139"><nobr>classpath.</nobr></div>
<div style="position:absolute;top:116418;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:116416;left:139"><nobr>If the missing Java class is not from your application code, then identify if it belongs to a third</nobr></div>
<div style="position:absolute;top:116435;left:139"><nobr>party API you are using as per of your Java application. Once you identify it, you will need to</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:116494;left:764"><nobr>98 of 127</nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:115600;left:101"><nobr>java.lang.ClassNotFoundException <font color="#000000">Simulator - Training 5</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:115617;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:115634;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:115668;left:101"><nobr>** Problem scenario #2: ClassLoader.loadClass() **</nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:115702;left:101"><nobr>java.lang.ClassNotFoundException<font color="#ff0000">: org.ph.javaee.training5.ClassB</font></nobr></div>
</span></font>
<font size="3" color="#ff0000" face="Courier"><span style="font-size:13px;font-family:Courier;color:#ff0000">
<div style="position:absolute;top:115719;left:164"><nobr>at java.net.URLClassLoader$1.run(<font color="#000080">URLClassLoader.java:366</font>)</nobr></div>
<div style="position:absolute;top:115736;left:164"><nobr>at java.net.URLClassLoader$1.run(<font color="#000080">URLClassLoader.java:355</font>)</nobr></div>
<div style="position:absolute;top:115753;left:164"><nobr>at java.security.AccessController.doPrivileged(<font color="#000080">Native Method</font>)</nobr></div>
<div style="position:absolute;top:115770;left:164"><nobr>at java.net.URLClassLoader.findClass(<font color="#000080">URLClassLoader.java:354</font>)</nobr></div>
<div style="position:absolute;top:115787;left:164"><nobr>at java.lang.ClassLoader.loadClass(<font color="#000080">ClassLoader.java:423</font>)</nobr></div>
<div style="position:absolute;top:115804;left:164"><nobr>at sun.misc.Launcher$AppClassLoader.loadClass(<font color="#000080">Launcher.java:308</font>)</nobr></div>
<div style="position:absolute;top:115821;left:164"><nobr>at java.lang.ClassLoader.loadClass(<font color="#000080">ClassLoader.java:356</font>)</nobr></div>
<div style="position:absolute;top:115838;left:164"><nobr>at</nobr></div>
<div style="position:absolute;top:115855;left:101"><nobr>org.ph.javaee.training5.ClassNotFoundExceptionSimulator.main(<font color="#000080">ClassNotFoundExcep</font></nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:115872;left:101"><nobr>tionSimulator.java:51<font color="#ff0000">)</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:115889;left:101"><nobr>Class org.ph.javaee.training5.ClassB not found!</nobr></div>
<div style="position:absolute;top:115923;left:101"><nobr>Simulator done!</nobr></div>
</span></font>

<div style="position:absolute;top:116599;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="99"><b>Page 99</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:116685;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:116688;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:116732;left:139"><nobr>add the missing JAR file(s) to your runtime classpath or web application WAR/EAR file.</nobr></div>
<div style="position:absolute;top:116755;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:116753;left:139"><nobr>If still struggling after multiple resolution attempts, this could means a more complex class</nobr></div>
<div style="position:absolute;top:116772;left:139"><nobr>loader hierarchy problem. In this case, please review the NoClassDefFoundError section below</nobr></div>
<div style="position:absolute;top:116791;left:139"><nobr>for more examples and resolution strategies.</nobr></div>
</span></font>
<font size="4" face="Times"><span style="font-size:22px;font-family:Times">
<div style="position:absolute;top:116847;left:85"><nobr><b>NoClassDefFoundError Problem patterns</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:116903;left:85"><nobr>Getting a java.lang.NoClassDefFoundError when supporting a Java EE application is quite common</nobr></div>
<div style="position:absolute;top:116921;left:85"><nobr>and at the same time complicated to resolve.</nobr></div>
<div style="position:absolute;top:116959;left:85"><nobr>The section will provide you with the common problem patterns responsible for</nobr></div>
<div style="position:absolute;top:116978;left:85"><nobr>java.lang.NoClassDefFoundError problems.</nobr></div>
<div style="position:absolute;top:117016;left:85"><nobr>java.lang.NoClassDefFoundError- what is it?</nobr></div>
<div style="position:absolute;top:117054;left:85"><nobr>This runtime error is thrown by the JVM when it tries to load the definition of a Class and when such</nobr></div>
<div style="position:absolute;top:117073;left:85"><nobr>Class definition could not be found in the current Class loader tree.</nobr></div>
<div style="position:absolute;top:117111;left:85"><nobr>This normally means that the compiled version of the reference to this Class was done successfully</nobr></div>
<div style="position:absolute;top:117130;left:85"><nobr>but that such reference at runtime can not be found.</nobr></div>
<div style="position:absolute;top:117168;left:85"><nobr>Sound confusing? Let's have a look at the visual diagram below so you can better understand this</nobr></div>
<div style="position:absolute;top:117187;left:85"><nobr>fundamental problem.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:117682;left:764"><nobr>99 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:117787;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="100"><b>Page 100</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:117873;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:117876;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:118407;left:85"><nobr>Now if you are interested, find below the source code of our sample program along with</nobr></div>
<div style="position:absolute;top:118426;left:85"><nobr>java.lang.NoClassDefFoundError error.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:118870;left:755"><nobr>100 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:118475;left:99"><nobr><b>package </b>com.cgi.tools.java;</nobr></div>
<div style="position:absolute;top:118510;left:99"><nobr><b>public class </b>ClassA {</nobr></div>
<div style="position:absolute;top:118527;left:140"><nobr><b>private </b>ClassB <font color="#92cddc">instanceB </font>= <b>null</b>;</nobr></div>
<div style="position:absolute;top:118545;left:140"><nobr><b>private </b>ClassC <font color="#92cddc">instanceC </font>= <b>null</b>;</nobr></div>
<div style="position:absolute;top:118580;left:140"><nobr><b>public </b>ClassA() {</nobr></div>
</span></font>
<font size="3" color="#92cddc" face="Times"><span style="font-size:13px;font-family:Times;color:#92cddc">
<div style="position:absolute;top:118598;left:190"><nobr>instanceB <font color="#000000">= </font><b><font color="#000000">new </font></b><font color="#000000">ClassB();</font></nobr></div>
<div style="position:absolute;top:118615;left:190"><nobr>instanceC <font color="#000000">= </font><b><font color="#000000">new </font></b><font color="#000000">ClassC();</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:118633;left:140"><nobr>}</nobr></div>
<div style="position:absolute;top:118650;left:99"><nobr>}</nobr></div>
<div style="position:absolute;top:118713;left:99"><nobr>// ClassB.java</nobr></div>
<div style="position:absolute;top:118731;left:99"><nobr><b>package </b>com.cgi.tools.java;</nobr></div>
<div style="position:absolute;top:118766;left:99"><nobr><b>public class </b>ClassB {</nobr></div>
<div style="position:absolute;top:118801;left:99"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:118975;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="101"><b>Page 101</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:119061;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:119064;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:119670;left:85"><nobr>## ProgramA runtime classpath and output – with ClassC.jar</nobr></div>
<div style="position:absolute;top:119809;left:85"><nobr>## ProgramA runtime classpath and output – without ClassC.jar</nobr></div>
<div style="position:absolute;top:119847;left:85"><nobr>// We voluntarily omitted to add ClassC.jar in the System classpath</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:120058;left:755"><nobr>101 of 127</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:119138;left:99"><nobr>// ClassC.java</nobr></div>
<div style="position:absolute;top:119156;left:99"><nobr><b>package </b>com.cgi.tools.java;</nobr></div>
<div style="position:absolute;top:119191;left:99"><nobr><b>public class </b>ClassC {</nobr></div>
<div style="position:absolute;top:119226;left:99"><nobr>}</nobr></div>
<div style="position:absolute;top:119289;left:104"><nobr><b>package </b>com.cgi.tools.java;</nobr></div>
<div style="position:absolute;top:119324;left:104"><nobr><b>public class </b>ProgramA {</nobr></div>
</span></font>
<font size="3" color="#92cddc" face="Times"><span style="font-size:13px;font-family:Times;color:#92cddc">
<div style="position:absolute;top:119359;left:113"><nobr>/**</nobr></div>
<div style="position:absolute;top:119377;left:113"><nobr>* <b>@param </b>args</nobr></div>
<div style="position:absolute;top:119394;left:113"><nobr>*/</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:119412;left:113"><nobr><b>public static void </b>main(String[] args) {</nobr></div>
<div style="position:absolute;top:119447;left:113"><nobr><b>try </b>{</nobr></div>
<div style="position:absolute;top:119465;left:113"><nobr>ClassA instanceA = <b>new </b>ClassA();</nobr></div>
<div style="position:absolute;top:119500;left:113"><nobr>System.<i>out</i>.println("<font color="#92cddc">ClassA instance created properly</font>!");</nobr></div>
<div style="position:absolute;top:119517;left:113"><nobr>}</nobr></div>
<div style="position:absolute;top:119535;left:113"><nobr><b>catch </b>(Throwable any) {</nobr></div>
<div style="position:absolute;top:119552;left:113"><nobr>System.<i>out</i>.println("<font color="#92cddc">Unexpected problem</font>! "+any.getMessage()+" ["+any+"]");</nobr></div>
<div style="position:absolute;top:119570;left:113"><nobr>}</nobr></div>
<div style="position:absolute;top:119587;left:113"><nobr>}</nobr></div>
<div style="position:absolute;top:119623;left:104"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:119723;left:115"><nobr>java -classpath ClassA.jar;ClassB.jar;ClassC.jar;ProgramA.jar</nobr></div>
<div style="position:absolute;top:119740;left:115"><nobr>com.cgi.tools.java.ProgramA</nobr></div>
</span></font>
<font size="3" color="#92cddc" face="Courier"><span style="font-size:13px;font-family:Courier;color:#92cddc">
<div style="position:absolute;top:119775;left:115"><nobr>ClassA instance created properly!</nobr></div>
<div style="position:absolute;top:119901;left:115"><nobr>java -classpath ClassA.jar;ClassB.jar;ProgramA.jar</nobr></div>
<div style="position:absolute;top:119918;left:115"><nobr>com.cgi.tools.java.ProgramA</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:119952;left:115"><nobr>Unexpected problem! com/cgi/tools/java/ClassC</nobr></div>
<div style="position:absolute;top:119986;left:115"><nobr>[java.lang.<font color="#d99594">NoClassDefFoundError</font>: com/cgi/tools/java/<font color="#d99594">ClassC</font>]</nobr></div>
</span></font>

<div style="position:absolute;top:120163;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="102"><b>Page 102</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:120249;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:120252;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:120296;left:85"><nobr>What are the most common scenarios causing NoClassDefFoundError?</nobr></div>
<div style="position:absolute;top:120334;left:85"><nobr>There are a few common scenarios which can lead to NoClassDefFoundError in your Java EE</nobr></div>
<div style="position:absolute;top:120353;left:85"><nobr>environment or standalone Java program.</nobr></div>
<div style="position:absolute;top:120391;left:85"><nobr># Problem pattern #1 - Missing vendor or third party library in System classpath or Java EE App</nobr></div>
<div style="position:absolute;top:120410;left:85"><nobr>classloader</nobr></div>
<div style="position:absolute;top:120448;left:85"><nobr>A missing Java library of your Java EE server itself (Weblogic, WAS, JBoss etc.) or third party</nobr></div>
<div style="position:absolute;top:120467;left:85"><nobr>(Apache, Spring, Hibernate etc.) is the most common program; exactly like our above sample</nobr></div>
<div style="position:absolute;top:120486;left:85"><nobr>program.</nobr></div>
<div style="position:absolute;top:120524;left:85"><nobr># Solution</nobr></div>
<div style="position:absolute;top:120562;left:85"><nobr>Resolution requires proper root cause analysis as per below recommended steps:</nobr></div>
<div style="position:absolute;top:120600;left:112"><nobr>1. Review the NoClassDefFoundError error and identify the missing Java Class</nobr></div>
<div style="position:absolute;top:120619;left:112"><nobr>2. Search through your local development and / or build environment and identify which Jar file</nobr></div>
<div style="position:absolute;top:120638;left:139"><nobr>contains the missing Java Class</nobr></div>
<div style="position:absolute;top:120657;left:112"><nobr>3. Once jar file(s) is / are identified, compare your local / build classpath with your production /</nobr></div>
<div style="position:absolute;top:120676;left:139"><nobr>problematic environment</nobr></div>
<div style="position:absolute;top:120695;left:112"><nobr>4. Resolution may include adding the missing JAR file(s) to the System class path or to your</nobr></div>
<div style="position:absolute;top:120714;left:139"><nobr>application EAR file for example</nobr></div>
<div style="position:absolute;top:120752;left:85"><nobr># Problem pattern #2 - Vendor or third party library version mismatch in System classpath or Java EE</nobr></div>
<div style="position:absolute;top:120771;left:85"><nobr>App classloader</nobr></div>
<div style="position:absolute;top:120809;left:85"><nobr>This problem pattern is less common but trickier to pinpoint the root cause. This is a normally caused</nobr></div>
<div style="position:absolute;top:120828;left:85"><nobr>by using wrong version of a shared third party library like Apache commons logging etc.</nobr></div>
<div style="position:absolute;top:120866;left:85"><nobr># Solution</nobr></div>
<div style="position:absolute;top:120903;left:85"><nobr>The resolution is quite similar to pattern #1:</nobr></div>
<div style="position:absolute;top:120941;left:112"><nobr>1. Review the NoClassDefFoundError error and identify the missing Java Class along with the</nobr></div>
<div style="position:absolute;top:120960;left:139"><nobr>referrer (very important)</nobr></div>
<div style="position:absolute;top:120979;left:112"><nobr>2. Search through your local development and / or build environment and identify which Jar file</nobr></div>
<div style="position:absolute;top:120998;left:139"><nobr>contains the missing Java Class</nobr></div>
<div style="position:absolute;top:121017;left:112"><nobr>3. Search through your local development and / or build environment and identify which Jar file</nobr></div>
<div style="position:absolute;top:121036;left:139"><nobr>contains the referrer Java Class</nobr></div>
<div style="position:absolute;top:121055;left:112"><nobr>4. Once jar file(s) is / are identified, compare your local / build classpath with your production /</nobr></div>
<div style="position:absolute;top:121074;left:139"><nobr>problematic environment</nobr></div>
<div style="position:absolute;top:121093;left:112"><nobr>5. Resolution may include replacing the problematic JAR file(s) with the right version as per the</nobr></div>
<div style="position:absolute;top:121112;left:139"><nobr>third party API documentation; this might include replacement of the JAR file referrer</nobr></div>
<div style="position:absolute;top:121131;left:139"><nobr>depending on your root cause analysis results</nobr></div>
<div style="position:absolute;top:121169;left:85"><nobr># Problem pattern #3 - static{} block code failure</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:121246;left:755"><nobr>102 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:121351;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="103"><b>Page 103</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:121437;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:121440;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:121484;left:85"><nobr>This problem pattern is also quite common and can take some time to pinpoint. Java offers the</nobr></div>
<div style="position:absolute;top:121503;left:85"><nobr>capability to write some code to be executed once in life time of the JVM / Class loader. This is</nobr></div>
<div style="position:absolute;top:121522;left:85"><nobr>achieved via a static{} block, called static initializer, normally located right after the class instance</nobr></div>
<div style="position:absolute;top:121541;left:85"><nobr>variables.</nobr></div>
<div style="position:absolute;top:121579;left:85"><nobr>Unfortunately, proper error handling and "non happy paths" for static initializer code blocks are often</nobr></div>
<div style="position:absolute;top:121598;left:85"><nobr>overlooked which opens the door for problems.</nobr></div>
<div style="position:absolute;top:121636;left:85"><nobr>Any failure such as an uncaught Exception will prevent such Java class to be loaded to its class</nobr></div>
<div style="position:absolute;top:121655;left:85"><nobr>loader.  The pattern is as per below:</nobr></div>
<div style="position:absolute;top:121696;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:121695;left:139"><nobr>the first attempt to load the class will generate a java.lang.ExceptionInInitializerError;</nobr></div>
<div style="position:absolute;top:121713;left:139"><nobr>preventing the class loader to load the referenced class</nobr></div>
<div style="position:absolute;top:121736;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:121734;left:139"><nobr>subsequent calls will then generate a java.lang.NoClassDefFoundError from any other</nobr></div>
<div style="position:absolute;top:121753;left:139"><nobr>referencing classes in a consistent manner until the problem is resolved and the JVM restarted</nobr></div>
<div style="position:absolute;top:121772;left:139"><nobr>(or live redeploy via your Java EE server redeploy task)</nobr></div>
<div style="position:absolute;top:121810;left:85"><nobr># Solution</nobr></div>
<div style="position:absolute;top:121848;left:85"><nobr>Resolution requires proper root cause analysis as per below recommended steps:</nobr></div>
<div style="position:absolute;top:121886;left:112"><nobr>1. Review the NoClassDefFoundError error and identify the affected Java Class</nobr></div>
<div style="position:absolute;top:121905;left:112"><nobr>2. Perform a code review of the affected Java class and see if any static{} initializer block can be</nobr></div>
<div style="position:absolute;top:121924;left:139"><nobr>found</nobr></div>
<div style="position:absolute;top:121943;left:112"><nobr>3. If found, review the error handling and add proper try{} catch{} along with proper logging in</nobr></div>
<div style="position:absolute;top:121962;left:139"><nobr>order to understand the root cause of the static block code failure</nobr></div>
<div style="position:absolute;top:121981;left:112"><nobr>4. Compile, redeploy, retest and confirm problem resolution</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:122035;left:85"><nobr><i><b>NoClassDefFoundError – How to resolve</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:122087;left:85"><nobr>Exception in thread "main" java.lang.NoClassDefFoundError is one of the most common and difficult</nobr></div>
<div style="position:absolute;top:122106;left:85"><nobr>problems that you can face when developing Java EE enterprise or standalone Java applications. The</nobr></div>
<div style="position:absolute;top:122125;left:85"><nobr>complexity of the root cause analysis and resolution process mainly depend of the size of your Java</nobr></div>
<div style="position:absolute;top:122144;left:85"><nobr>EE middleware environment, especially given the high number of class loaders present across the</nobr></div>
<div style="position:absolute;top:122163;left:85"><nobr>various Java EE applications.</nobr></div>
<div style="position:absolute;top:122201;left:85"><nobr>As mentioned before, this runtime error is thrown by the JVM when there is an attempt by a</nobr></div>
<div style="position:absolute;top:122220;left:85"><nobr>ClassLoader to load the definition of a Class (Class referenced in your application code etc.) and</nobr></div>
<div style="position:absolute;top:122239;left:85"><nobr>when such Class definition could not be found within the current ClassLoader tree.</nobr></div>
<div style="position:absolute;top:122277;left:85"><nobr>Basically, this means that such Class definition was found at compiled time but is not found at runtime.</nobr></div>
<div style="position:absolute;top:122315;left:85"><nobr>Java ClassLoader overview</nobr></div>
<div style="position:absolute;top:122353;left:85"><nobr>Before going any further, it is very important that you have a high level of understanding of the Java</nobr></div>
<div style="position:absolute;top:122372;left:85"><nobr>ClassLoader principles. Quite often individuals debugging NoClassDefFoundError problems are</nobr></div>
<div style="position:absolute;top:122391;left:85"><nobr>struggling because they are lacking proper knowledge and understanding of Java ClassLoader</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:122434;left:755"><nobr>103 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:122539;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="104"><b>Page 104</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:122625;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:122628;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:122672;left:85"><nobr>principles; preventing them to pinpoint the root cause.</nobr></div>
<div style="position:absolute;top:122710;left:85"><nobr>A class loader is a Java object responsible for loading classes. Basically a class loader attempts to</nobr></div>
<div style="position:absolute;top:122729;left:85"><nobr>locate or generate data that constitutes a definition for the class. One of the key points to understand</nobr></div>
<div style="position:absolute;top:122748;left:85"><nobr>is that Java class loaders by default use a delegation model to search for classes. Each instance of</nobr></div>
<div style="position:absolute;top:122767;left:85"><nobr>ClassLoader has an associated parent class loader. So let's say that your application class loader</nobr></div>
<div style="position:absolute;top:122786;left:85"><nobr>needs to load class A. The first thing that it will attempt to do is to delegate the search for Class A to its</nobr></div>
<div style="position:absolute;top:122805;left:85"><nobr>parent class loader before attempting to find the Class A itself. You can end up with a large class</nobr></div>
<div style="position:absolute;top:122824;left:85"><nobr>loader chain with many parent class loaders up to the JVM system classpath bootstrap class loader.</nobr></div>
<div style="position:absolute;top:122862;left:85"><nobr>What is the problem? Well if Class A is found from a particular parent class loader then it will be</nobr></div>
<div style="position:absolute;top:122881;left:85"><nobr>loaded by such parent which open the doors for NoClassDefFoundError if you are expecting Class A</nobr></div>
<div style="position:absolute;top:122900;left:85"><nobr>to be loaded by your application (child) class loader. For example, third part JAR file dependencies</nobr></div>
<div style="position:absolute;top:122919;left:85"><nobr>could only be present to your application child class loader.</nobr></div>
<div style="position:absolute;top:122957;left:85"><nobr>Now let’s visualize this whole process in the context of a Java EE enterprise environment so you can</nobr></div>
<div style="position:absolute;top:122976;left:85"><nobr>better understand.</nobr></div>
<div style="position:absolute;top:123533;left:85"><nobr>As you can see, any code loaded by the child class loader (Web application) will first delegate to the</nobr></div>
<div style="position:absolute;top:123552;left:85"><nobr>parent class loader (Java EE App). Such parent class loader will then delegate to the JVM system</nobr></div>
<div style="position:absolute;top:123571;left:85"><nobr>class path class loader. If no such class is found from any parent class loader then the Class will be</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:123622;left:755"><nobr>104 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:123727;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="105"><b>Page 105</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:123813;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:123816;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:123860;left:85"><nobr>loaded by the child class loader (assuming that the class was found). Please note that Java EE</nobr></div>
<div style="position:absolute;top:123879;left:85"><nobr>containers such as Oracle Weblogic have mechanisms to override this default class loader delegation</nobr></div>
<div style="position:absolute;top:123898;left:85"><nobr>behavior.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:123954;left:85"><nobr><i><b>NoClassDefFoundError problem case 1 - missing JAR file</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:124006;left:85"><nobr>The first problem case we will cover is related to a Java program packaging and / or classpath</nobr></div>
<div style="position:absolute;top:124025;left:85"><nobr>problem. A typical Java program can include one or many JAR files created at compile time.</nobr></div>
<div style="position:absolute;top:124044;left:85"><nobr>NoClassDefFoundError can often be observed when you forget to add JAR file(s) containing Java</nobr></div>
<div style="position:absolute;top:124063;left:85"><nobr>classes referenced by your Java or Java EE application.</nobr></div>
<div style="position:absolute;top:124101;left:85"><nobr>This type of problem is normally not hard to resolve once you analyze the Java Exception and missing</nobr></div>
<div style="position:absolute;top:124120;left:85"><nobr>Java class name.</nobr></div>
<div style="position:absolute;top:124158;left:85"><nobr>Sample Java  program</nobr></div>
<div style="position:absolute;top:124196;left:85"><nobr>The following simple Java program is split as per below:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:124239;left:112"><nobr>• <font style="font-size:14px">The main Java program NoClassDefFoundErrorSimulator</font></nobr></div>
<div style="position:absolute;top:124263;left:112"><nobr>• <font style="font-size:14px">The caller Java class CallerClassA</font></nobr></div>
<div style="position:absolute;top:124286;left:112"><nobr>• <font style="font-size:14px">The referencing Java class ReferencingClassA</font></nobr></div>
<div style="position:absolute;top:124310;left:112"><nobr>• <font style="font-size:14px">A util class for ClassLoader and logging related facilities JavaEETrainingUtil</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:124350;left:85"><nobr>This program is simple attempting to create a new instance and execute a method of the Java class</nobr></div>
<div style="position:absolute;top:124370;left:85"><nobr>CallerClassA which is referencing the class ReferencingClassA.It will demonstrate how a</nobr></div>
<div style="position:absolute;top:124390;left:85"><nobr>simple classpath problem can trigger NoClassDefFoundError. The program is also displaying detail on</nobr></div>
<div style="position:absolute;top:124409;left:85"><nobr>the current class loader chain at class loading time in order to help you keep track of this process. This</nobr></div>
<div style="position:absolute;top:124428;left:85"><nobr>will be especially useful for future and more complex problem cases when dealing with larger class</nobr></div>
<div style="position:absolute;top:124447;left:85"><nobr>loader chains.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:124810;left:755"><nobr>105 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:124915;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="106"><b>Page 106</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:125001;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:125004;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:125998;left:755"><nobr>106 of 127</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:125063;left:101"><nobr><b>#### NoClassDefFoundErrorSimulator.java</b></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:125080;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.training1;</font></nobr></div>
<div style="position:absolute;top:125115;left:101"><nobr><b>import </b><font color="#000000">org.ph.javaee.training.util.JavaEETrainingUtil;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:125151;left:101"><nobr>/**</nobr></div>
<div style="position:absolute;top:125168;left:109"><nobr>* NoClassDefFoundErrorTraining1</nobr></div>
<div style="position:absolute;top:125186;left:109"><nobr>* <b><font color="#7f9fbf">@author </font></b>Pierre<font color="#7f7f9f">-</font>Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:125203;left:109"><nobr>*</nobr></div>
<div style="position:absolute;top:125221;left:109"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:125238;left:101"><nobr><b>public class </b><font color="#000000">NoClassDefFoundErrorSimulator {</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:125291;left:167"><nobr>/**</nobr></div>
<div style="position:absolute;top:125308;left:175"><nobr>* <b><font color="#7f9fbf">@param </font></b>args</nobr></div>
<div style="position:absolute;top:125326;left:175"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:125344;left:167"><nobr><b>public static void </b><font color="#000000">main(String[] args) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:125361;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"java.lang.NoClassDefFoundError Simulator - Training</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:125379;left:101"><nobr>1"<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:125396;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Author: Pierre-Hugues Charbonneau"</font>);</nobr></div>
<div style="position:absolute;top:125414;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"http://javaeesupportpatterns.blogspot.com"</font>);</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:125449;left:225"><nobr>// Print current Classloader context</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:125466;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\nCurrent ClassLoader chain:</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:125484;left:101"><nobr>"<font color="#000000">+JavaEETrainingUtil.</font><i><font color="#000000">getCurrentClassloaderDetail</font></i><font color="#000000">());</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:125519;left:225"><nobr>// 1. Create a new instance of CallerClassA</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:125537;left:225"><nobr>CallerClassA caller = <b><font color="#7f0055">new </font></b>CallerClassA();</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:125572;left:225"><nobr>// 2. Execute method of the caller</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:125589;left:225"><nobr>caller.doSomething();</nobr></div>
<div style="position:absolute;top:125624;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"done!"</font>);</nobr></div>
<div style="position:absolute;top:125642;left:167"><nobr>}</nobr></div>
<div style="position:absolute;top:125659;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:126103;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="107"><b>Page 107</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:126189;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:126192;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:127186;left:755"><nobr>107 of 127</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:126289;left:101"><nobr><b>#### CallerClassA.java</b></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:126306;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.training1;</font></nobr></div>
<div style="position:absolute;top:126341;left:101"><nobr><b>import </b><font color="#000000">org.ph.javaee.training.util.JavaEETrainingUtil;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:126376;left:101"><nobr>/**</nobr></div>
<div style="position:absolute;top:126394;left:109"><nobr>* CallerClassA</nobr></div>
<div style="position:absolute;top:126412;left:109"><nobr>* <b><font color="#7f9fbf">@author </font></b>Pierre<font color="#7f7f9f">-</font>Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:126429;left:109"><nobr>*</nobr></div>
<div style="position:absolute;top:126447;left:109"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:126464;left:101"><nobr><b>public class </b><font color="#000000">CallerClassA {</font></nobr></div>
<div style="position:absolute;top:126499;left:167"><nobr><b>private final static </b><font color="#000000">String </font><i><font color="#0000c0">CLAZZ </font></i><font color="#000000">= CallerClassA.</font><b>class</b><font color="#000000">.getName();</font></nobr></div>
<div style="position:absolute;top:126534;left:167"><nobr><b>static </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:126552;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Classloading of "</font>+<i><font color="#0000c0">CLAZZ</font></i>+<font color="#2a00ff">" in</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:126570;left:101"><nobr>progress..."<font color="#000000">+JavaEETrainingUtil.</font><i><font color="#000000">getCurrentClassloaderDetail</font></i><font color="#000000">());</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:126587;left:167"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:126622;left:167"><nobr><b>public </b><font color="#000000">CallerClassA() {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:126640;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Creating a new instance of</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:126657;left:101"><nobr>"<font color="#000000">+CallerClassA.</font><b><font color="#7f0055">class</font></b><font color="#000000">.getName()+</font>"..."<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:126675;left:167"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:126710;left:167"><nobr><b>public void </b><font color="#000000">doSomething() {</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:126745;left:225"><nobr>// Create a new instance of ReferencingClassA</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:126763;left:225"><nobr>ReferencingClassA referencingClass = <b><font color="#7f0055">new </font></b>ReferencingClassA();    </nobr></div>
<div style="position:absolute;top:126780;left:167"><nobr>}</nobr></div>
<div style="position:absolute;top:126798;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:127291;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="108"><b>Page 108</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:127377;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:127380;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:128374;left:755"><nobr>108 of 127</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:127439;left:99"><nobr><b>#### ReferencingClassA.java</b></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:127456;left:99"><nobr><b>package </b><font color="#000000">org.ph.javaee.training1;</font></nobr></div>
<div style="position:absolute;top:127491;left:99"><nobr><b>import </b><font color="#000000">org.ph.javaee.training.util.JavaEETrainingUtil;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:127527;left:99"><nobr>/**</nobr></div>
<div style="position:absolute;top:127544;left:107"><nobr>* ReferencingClassA</nobr></div>
<div style="position:absolute;top:127562;left:107"><nobr>* <b><font color="#7f9fbf">@author </font></b>Pierre<font color="#7f7f9f">-</font>Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:127579;left:107"><nobr>*</nobr></div>
<div style="position:absolute;top:127597;left:107"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:127614;left:99"><nobr><b>public class </b><font color="#000000">ReferencingClassA {</font></nobr></div>
<div style="position:absolute;top:127649;left:165"><nobr><b>private final static </b><font color="#000000">String </font><i><font color="#0000c0">CLAZZ </font></i><font color="#000000">= ReferencingClassA.</font><b>class</b><font color="#000000">.getName();</font></nobr></div>
<div style="position:absolute;top:127684;left:165"><nobr><b>static </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:127702;left:223"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Classloading of "</font>+<i><font color="#0000c0">CLAZZ</font></i>+<font color="#2a00ff">" in</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:127720;left:99"><nobr>progress..."<font color="#000000">+JavaEETrainingUtil.</font><i><font color="#000000">getCurrentClassloaderDetail</font></i><font color="#000000">());</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:127737;left:165"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:127772;left:165"><nobr><b>public </b><font color="#000000">ReferencingClassA() {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:127790;left:223"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Creating a new instance of</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:127807;left:99"><nobr>"<font color="#000000">+ReferencingClassA.</font><b><font color="#7f0055">class</font></b><font color="#000000">.getName()+</font>"..."<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:127825;left:165"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:127860;left:165"><nobr><b>public void </b><font color="#000000">doSomething() {</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:127878;left:223"><nobr>//nothing to do...</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:127895;left:165"><nobr>}</nobr></div>
<div style="position:absolute;top:127913;left:99"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:128479;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="109"><b>Page 109</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:128565;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:128568;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:129562;left:755"><nobr>109 of 127</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:12px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:128645;left:101"><nobr><b>#### JavaEETrainingUtil.java</b></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:12px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:128662;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.training.util;</font></nobr></div>
<div style="position:absolute;top:128695;left:101"><nobr><b>import </b><font color="#000000">java.util.Stack;</font></nobr></div>
<div style="position:absolute;top:128712;left:101"><nobr><b>import </b><font color="#000000">java.lang.ClassLoader;</font></nobr></div>
<div style="position:absolute;top:128746;left:101"><nobr><b>public class </b><font color="#000000">JavaEETrainingUtil {</font></nobr></div>
<div style="position:absolute;top:128779;left:164"><nobr><b>public static </b><font color="#000000">String getCurrentClassloaderDetail() {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:128813;left:219"><nobr>StringBuffer classLoaderDetail = <b><font color="#7f0055">new </font></b>StringBuffer();    </nobr></div>
<div style="position:absolute;top:128829;left:219"><nobr>Stack&lt;ClassLoader&gt; classLoaderStack = <b><font color="#7f0055">new </font></b>Stack&lt;ClassLoader&gt;();</nobr></div>
<div style="position:absolute;top:128863;left:219"><nobr>ClassLoader currentClassLoader =</nobr></div>
<div style="position:absolute;top:128879;left:101"><nobr>Thread.<i>currentThread</i>().getContextClassLoader();</nobr></div>
<div style="position:absolute;top:128930;left:101"><nobr>classLoaderDetail.append(<font color="#2a00ff">"\n---------------------------------------------------------------</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:12px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:128946;left:101"><nobr>--\n"<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:12px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:128980;left:219"><nobr>// Build a Stack of the current ClassLoader chain</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:12px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:128996;left:219"><nobr><b>while </b><font color="#000000">(currentClassLoader != </font><b>null</b><font color="#000000">) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:129030;left:281"><nobr>classLoaderStack.push(currentClassLoader);</nobr></div>
<div style="position:absolute;top:129063;left:281"><nobr>currentClassLoader = currentClassLoader.getParent();</nobr></div>
<div style="position:absolute;top:129080;left:219"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:12px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:129114;left:219"><nobr>// Print ClassLoader parent chain</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:12px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:129130;left:219"><nobr><b>while</b><font color="#000000">(classLoaderStack.size() &gt; 0) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:129164;left:281"><nobr>ClassLoader classLoader = classLoaderStack.pop();</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:12px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:129197;left:281"><nobr>// Print current    </nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:129214;left:281"><nobr>classLoaderDetail.append(classLoader);</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:12px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:129247;left:281"><nobr><b>if </b><font color="#000000">(classLoaderStack.size() &gt; 0) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:129264;left:336"><nobr>classLoaderDetail.append(<font color="#2a00ff">"\n--- delegation ---\n"</font>);    </nobr></div>
<div style="position:absolute;top:129281;left:281"><nobr>} <b><font color="#7f0055">else </font></b>{</nobr></div>
<div style="position:absolute;top:129298;left:336"><nobr>classLoaderDetail.append(<font color="#2a00ff">" **Current ClassLoader**"</font>);</nobr></div>
<div style="position:absolute;top:129314;left:281"><nobr>}</nobr></div>
<div style="position:absolute;top:129331;left:219"><nobr>}</nobr></div>
<div style="position:absolute;top:129381;left:101"><nobr>classLoaderDetail.append(<font color="#2a00ff">"\n---------------------------------------------------------------</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:12px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:129398;left:101"><nobr>--\n"<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:12px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:129431;left:219"><nobr><b>return </b><font color="#000000">classLoaderDetail.toString();</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:129448;left:164"><nobr>}</nobr></div>
<div style="position:absolute;top:129465;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:129667;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="110"><b>Page 110</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:129753;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:129756;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:129819;left:85"><nobr>Problem reproduction</nobr></div>
<div style="position:absolute;top:129857;left:85"><nobr>In order to replicate the problem, we will simply “voluntary” omit one of the JAR files from the</nobr></div>
<div style="position:absolute;top:129876;left:85"><nobr>classpath that contains the referencing Java class ReferencingClassA.</nobr></div>
<div style="position:absolute;top:129917;left:85"><nobr>The Java program is packaged as per below:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:129961;left:112"><nobr>• <font style="font-size:14px">MainProgram.jar (contains NoClassDefFoundErrorSimulator.class and</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:129982;left:139"><nobr>JavaEETrainingUtil.class)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:130004;left:112"><nobr>• <font style="font-size:14px">CallerClassA.jar (contains CallerClassA.class)</font></nobr></div>
<div style="position:absolute;top:130028;left:112"><nobr>• <font style="font-size:14px">ReferencingClassA.jar (contains ReferencingClassA.class)</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:130068;left:85"><nobr>Now, let’s run the program as is:</nobr></div>
<div style="position:absolute;top:130106;left:85"><nobr>## Baseline (normal execution)</nobr></div>
<div style="position:absolute;top:130702;left:85"><nobr>For the initial run (baseline), the main program was able to create a new instance of CallerClassA</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:130750;left:756"><nobr>110 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:130162;left:101"><nobr>..\bin&gt;java -classpath CallerClassA.jar;ReferencingClassA.jar;MainProgram.jar</nobr></div>
<div style="position:absolute;top:130179;left:101"><nobr>org.ph.javaee.training1.NoClassDefFoundErrorSimulator</nobr></div>
<div style="position:absolute;top:130213;left:101"><nobr>java.lang.NoClassDefFoundError Simulator - Training 1</nobr></div>
<div style="position:absolute;top:130230;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:130247;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:130281;left:101"><nobr>Current ClassLoader chain:</nobr></div>
<div style="position:absolute;top:130298;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:130315;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:130332;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:130349;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9 **Current ClassLoader**</nobr></div>
<div style="position:absolute;top:130366;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:130400;left:101"><nobr>Classloading of org.ph.javaee.training1.CallerClassA in progress...</nobr></div>
<div style="position:absolute;top:130417;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:130434;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:130451;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:130468;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9 **Current ClassLoader**</nobr></div>
<div style="position:absolute;top:130485;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:130519;left:101"><nobr>Creating a new instance of org.ph.javaee.training1.CallerClassA...</nobr></div>
<div style="position:absolute;top:130536;left:101"><nobr>Classloading of org.ph.javaee.training1.ReferencingClassA in progress...</nobr></div>
<div style="position:absolute;top:130554;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:130570;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:130588;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:130605;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9 **Current ClassLoader**</nobr></div>
<div style="position:absolute;top:130622;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:130656;left:101"><nobr>Creating a new instance of org.ph.javaee.training1.ReferencingClassA...</nobr></div>
<div style="position:absolute;top:130673;left:101"><nobr>done!</nobr></div>
</span></font>

<div style="position:absolute;top:130855;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="111"><b>Page 111</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:130941;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:130944;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:130988;left:85"><nobr>and execute its method successfully; including successful class loading of the referencing class</nobr></div>
<div style="position:absolute;top:131008;left:85"><nobr>ReferencingClassA.</nobr></div>
<div style="position:absolute;top:131047;left:85"><nobr>## Problem reproduction run (with removal of ReferencingClassA.jar)</nobr></div>
<div style="position:absolute;top:131778;left:85"><nobr>What happened? The removal of the ReferencingClassA.jar, containing ReferencingClassA, did</nobr></div>
<div style="position:absolute;top:131799;left:85"><nobr>prevent the current class loader to locate this referencing Java class at runtime leading to</nobr></div>
<div style="position:absolute;top:131818;left:85"><nobr>ClassNotFoundException and NoClassDefFoundError.</nobr></div>
<div style="position:absolute;top:131858;left:85"><nobr>This is the typical Exception that you will get if you omit JAR file(s) from your Java start-up classpath</nobr></div>
<div style="position:absolute;top:131877;left:85"><nobr>or within an EAR / WAR for Java EE related applications.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:131938;left:757"><nobr>111 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:131102;left:101"><nobr>../bin&gt;java -classpath CallerClassA.jar;MainProgram.jar</nobr></div>
<div style="position:absolute;top:131119;left:101"><nobr>org.ph.javaee.training1.NoClassDefFoundErrorSimulator</nobr></div>
<div style="position:absolute;top:131153;left:101"><nobr>java.lang.NoClassDefFoundError Simulator - Training 1</nobr></div>
<div style="position:absolute;top:131170;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:131187;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:131221;left:101"><nobr>Current ClassLoader chain:</nobr></div>
<div style="position:absolute;top:131238;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:131255;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:131272;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:131289;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9 **Current ClassLoader**</nobr></div>
<div style="position:absolute;top:131306;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:131340;left:101"><nobr>Classloading of org.ph.javaee.training1.CallerClassA in progress...</nobr></div>
<div style="position:absolute;top:131358;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:131374;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:131392;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:131409;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9 **Current ClassLoader**</nobr></div>
<div style="position:absolute;top:131426;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:131460;left:101"><nobr>Creating a new instance of org.ph.javaee.training1.CallerClassA...</nobr></div>
</span></font>
<font size="3" color="#c00000" face="Courier"><span style="font-size:13px;font-family:Courier;color:#c00000">
<div style="position:absolute;top:131477;left:101"><nobr>Exception in thread "main" java.lang.NoClassDefFoundError:</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:131494;left:101"><nobr>org/ph/javaee/training1/ReferencingClassA</nobr></div>
<div style="position:absolute;top:131511;left:173"><nobr>at</nobr></div>
<div style="position:absolute;top:131528;left:101"><nobr>org.ph.javaee.training1.CallerClassA.doSomething(CallerClassA.java:25)</nobr></div>
<div style="position:absolute;top:131545;left:173"><nobr>at</nobr></div>
<div style="position:absolute;top:131562;left:101"><nobr>org.ph.javaee.training1.NoClassDefFoundErrorSimulator.main(NoClassDefFoundError</nobr></div>
<div style="position:absolute;top:131579;left:101"><nobr>Simulator.java:28)</nobr></div>
<div style="position:absolute;top:131596;left:101"><nobr>Caused by: java.lang.ClassNotFoundException:</nobr></div>
<div style="position:absolute;top:131613;left:101"><nobr>org.ph.javaee.training1.ReferencingClassA</nobr></div>
<div style="position:absolute;top:131630;left:173"><nobr>at java.net.URLClassLoader$1.run(Unknown Source)</nobr></div>
<div style="position:absolute;top:131647;left:173"><nobr>at java.net.URLClassLoader$1.run(Unknown Source)</nobr></div>
<div style="position:absolute;top:131664;left:173"><nobr>at java.security.AccessController.doPrivileged(Native Method)</nobr></div>
<div style="position:absolute;top:131681;left:173"><nobr>at java.net.URLClassLoader.findClass(Unknown Source)</nobr></div>
<div style="position:absolute;top:131698;left:173"><nobr>at java.lang.ClassLoader.loadClass(Unknown Source)</nobr></div>
<div style="position:absolute;top:131715;left:173"><nobr>at sun.misc.Launcher$AppClassLoader.loadClass(Unknown Source)</nobr></div>
<div style="position:absolute;top:131732;left:173"><nobr>at java.lang.ClassLoader.loadClass(Unknown Source)</nobr></div>
<div style="position:absolute;top:131749;left:173"><nobr>... 2 more</nobr></div>
</span></font>

<div style="position:absolute;top:132043;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="112"><b>Page 112</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:132129;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:132132;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:132176;left:85"><nobr>ClassLoader view</nobr></div>
<div style="position:absolute;top:132214;left:85"><nobr>Now let’s review the ClassLoader chain so you can properly understand this problem case. As you</nobr></div>
<div style="position:absolute;top:132233;left:85"><nobr>saw from the Java program output logging, the following Java ClassLoaders were found:</nobr></div>
<div style="position:absolute;top:132423;left:85"><nobr><i>** Please note that the Java bootstrap class loader is responsible to load the core JDK classes and is</i></nobr></div>
<div style="position:absolute;top:132442;left:85"><nobr><i>written in native code **</i></nobr></div>
<div style="position:absolute;top:132480;left:85"><nobr>## sun.misc.Launcher$AppClassLoader</nobr></div>
<div style="position:absolute;top:132499;left:85"><nobr>This is the system class loader responsible to load our application code found from the Java classpath</nobr></div>
<div style="position:absolute;top:132518;left:85"><nobr>specified at start-up.</nobr></div>
<div style="position:absolute;top:132556;left:85"><nobr>##sun.misc.Launcher$ExtClassLoader</nobr></div>
<div style="position:absolute;top:132575;left:85"><nobr>This is the extension class loader responsible to load code in the extensions directories</nobr></div>
<div style="position:absolute;top:132594;left:85"><nobr>(&lt;JAVA_HOME&gt;/lib/ext, or any other directory specified by the java.ext.dirs system property).</nobr></div>
<div style="position:absolute;top:132632;left:85"><nobr>As you can see from the Java program logging output, the extension class loader is the actual super</nobr></div>
<div style="position:absolute;top:132651;left:85"><nobr>parent of the system class loader. Our sample Java program was loaded at the system class loader</nobr></div>
<div style="position:absolute;top:132670;left:85"><nobr>level. Please note that this class loader chain is very simple for this problem case since we did not</nobr></div>
<div style="position:absolute;top:132689;left:85"><nobr>create child class loaders at this point.</nobr></div>
<div style="position:absolute;top:132726;left:85"><nobr>Recommendations and resolution strategies</nobr></div>
<div style="position:absolute;top:132764;left:85"><nobr>Now find below my recommendations and resolution strategies for NoClassDefFoundError problem</nobr></div>
<div style="position:absolute;top:132783;left:85"><nobr>case 1:</nobr></div>
<div style="position:absolute;top:132825;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:132823;left:139"><nobr>Review the java.lang.NoClassDefFoundError error and identify the missing Java class</nobr></div>
<div style="position:absolute;top:132845;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:132843;left:139"><nobr>Verify and locate the missing Java class from your compile / build environment</nobr></div>
<div style="position:absolute;top:132866;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:132864;left:139"><nobr>Determine if the missing Java class is from your application code, third part API or even the</nobr></div>
<div style="position:absolute;top:132883;left:139"><nobr>Java EE container itself. Verify where the missing JAR file(s) is / are expected to be found</nobr></div>
<div style="position:absolute;top:132905;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:132904;left:139"><nobr>Once found, verify your runtime environment Java classpath for any typo or missing JAR file(s)</nobr></div>
<div style="position:absolute;top:132926;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:132924;left:139"><nobr>If the problem is triggered from a Java EE application, perform the same above steps but verify</nobr></div>
<div style="position:absolute;top:132943;left:139"><nobr>the packaging of your EAR / WAR file for missing JAR and other library file dependencies such</nobr></div>
<div style="position:absolute;top:132962;left:139"><nobr>as MANIFEST</nobr></div>
<div style="position:absolute;top:133000;left:85"><nobr>Java static initializer revisited</nobr></div>
<div style="position:absolute;top:133038;left:85"><nobr>The Java programming language provides you with the capability to "statically" initialize variables or a</nobr></div>
<div style="position:absolute;top:133057;left:85"><nobr>block of code. This is achieved via the "static" variable identifier or the usage of a static {} block at the</nobr></div>
<div style="position:absolute;top:133076;left:85"><nobr>header of a Java class. Static initializers are guaranteed to be executed only once in the JVM life cycle</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:133126;left:756"><nobr>112 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:132289;left:101"><nobr>Classloading of org.ph.javaee.training1.CallerClassA in progress...</nobr></div>
<div style="position:absolute;top:132306;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:132323;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:132340;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:132357;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9 **Current ClassLoader**</nobr></div>
<div style="position:absolute;top:132374;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
</span></font>

<div style="position:absolute;top:133231;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="113"><b>Page 113</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:133317;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:133320;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:133364;left:85"><nobr>and are Thread safe by design which make their usage quite appealing for static data initialization</nobr></div>
<div style="position:absolute;top:133383;left:85"><nobr>such as internal object caches, loggers etc.</nobr></div>
<div style="position:absolute;top:133421;left:85"><nobr>What is the problem? I will repeat again, static initializers are guaranteed to be executed only once in</nobr></div>
<div style="position:absolute;top:133440;left:85"><nobr>the JVM life cycle...This means that such code is executed at the class loading time and never</nobr></div>
<div style="position:absolute;top:133459;left:85"><nobr>executed again until you restart your JVM. Now what happens if the code executed at that time</nobr></div>
<div style="position:absolute;top:133478;left:85"><nobr>(@Class loading time) terminates with an unhandled Exception?</nobr></div>
<div style="position:absolute;top:133516;left:85"><nobr>Welcome to the java.lang.NoClassDefFoundError problem case #2!</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:133572;left:85"><nobr><i><b>NoClassDefFoundError problem case 2 - static initializer failure</b></i></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:133624;left:85"><nobr>This type of problem is occurring following the failure of static initializer code combined with</nobr></div>
<div style="position:absolute;top:133643;left:85"><nobr>successive attempts to create a new instance of the affected (non-loaded) class.</nobr></div>
<div style="position:absolute;top:133681;left:85"><nobr>Sample Java program</nobr></div>
<div style="position:absolute;top:133719;left:85"><nobr>The following simple Java program is split as per below:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:133761;left:112"><nobr>• <font style="font-size:14px">The main Java program NoClassDefFoundErrorSimulator</font></nobr></div>
<div style="position:absolute;top:133784;left:112"><nobr>• <font style="font-size:14px">The affected Java class ClassA</font></nobr></div>
<div style="position:absolute;top:133807;left:112"><nobr>• <font style="font-size:14px">ClassA provides you with a ON/OFF switch allowing you the replicate the type of problem</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:133827;left:139"><nobr>that you want to study</nobr></div>
<div style="position:absolute;top:133867;left:85"><nobr>This program is simply attempting to create a new instance of ClassA 3 times (one after each</nobr></div>
<div style="position:absolute;top:133887;left:85"><nobr>other). It will demonstrate that an initial failure of either a static variable or static block initializer</nobr></div>
<div style="position:absolute;top:133908;left:85"><nobr>combined with successive attempt to create a new instance of the affected class triggers</nobr></div>
<div style="position:absolute;top:133927;left:85"><nobr>java.lang.NoClassDefFoundError.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:134314;left:756"><nobr>113 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:134419;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="114"><b>Page 114</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:134505;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:134508;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:135502;left:756"><nobr>114 of 127</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:134567;left:101"><nobr><b>#### NoClassDefFoundErrorSimulator.java</b></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:134584;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.tools.jdk7.training2;</font></nobr></div>
<div style="position:absolute;top:134619;left:101"><nobr><b>public class </b><font color="#000000">NoClassDefFoundErrorSimulator {</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:134655;left:167"><nobr>/**</nobr></div>
<div style="position:absolute;top:134672;left:175"><nobr>* <b><font color="#7f9fbf">@param </font></b>args</nobr></div>
<div style="position:absolute;top:134690;left:175"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:134707;left:167"><nobr><b>public static void </b><font color="#000000">main(String[] args) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:134725;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"java.lang.NoClassDefFoundError Simulator - Training</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:134742;left:101"><nobr>2"<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:134760;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Author: Pierre-Hugues Charbonneau"</font>);</nobr></div>
<div style="position:absolute;top:134777;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"http://javaeesupportpatterns.blogspot.com\n\n"</font>);   </nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:134812;left:225"><nobr><b>try </b><font color="#000000">{    </font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:134830;left:291"><nobr>// Create a new instance of ClassA (attempt #1)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:134848;left:291"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"FIRST attempt to create a new instance of</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:134865;left:101"><nobr>ClassA...\n"<font color="#000000">);    </font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:134883;left:291"><nobr>ClassA classA = <b><font color="#7f0055">new </font></b>ClassA();</nobr></div>
<div style="position:absolute;top:134918;left:225"><nobr>} <b><font color="#7f0055">catch </font></b>(Throwable any) {</nobr></div>
<div style="position:absolute;top:134935;left:291"><nobr>any.printStackTrace();</nobr></div>
<div style="position:absolute;top:134953;left:225"><nobr>}    </nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:134988;left:225"><nobr><b>try </b><font color="#000000">{    </font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:135006;left:291"><nobr>// Create a new instance of ClassA (attempt #2)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:135023;left:291"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\nSECOND attempt to create a new instance</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:135041;left:101"><nobr>of ClassA...\n"<font color="#000000">);    </font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:135058;left:291"><nobr>ClassA classA = <b><font color="#7f0055">new </font></b>ClassA();</nobr></div>
<div style="position:absolute;top:135093;left:225"><nobr>} <b><font color="#7f0055">catch </font></b>(Throwable any) {    </nobr></div>
<div style="position:absolute;top:135111;left:291"><nobr>any.printStackTrace();</nobr></div>
<div style="position:absolute;top:135128;left:225"><nobr>}    </nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:135163;left:225"><nobr><b>try </b><font color="#000000">{    </font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:135181;left:291"><nobr>// Create a new instance of ClassA (attempt #3)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:135199;left:291"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\nTHIRD attempt to create a new instance of</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:135216;left:101"><nobr>ClassA...\n"<font color="#000000">);    </font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:135234;left:291"><nobr>ClassA classA = <b><font color="#7f0055">new </font></b>ClassA();</nobr></div>
<div style="position:absolute;top:135269;left:225"><nobr>} <b><font color="#7f0055">catch </font></b>(Throwable any) {    </nobr></div>
<div style="position:absolute;top:135286;left:291"><nobr>any.printStackTrace();</nobr></div>
<div style="position:absolute;top:135304;left:225"><nobr>}    </nobr></div>
<div style="position:absolute;top:135339;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\n\ndone!"</font>);</nobr></div>
<div style="position:absolute;top:135357;left:167"><nobr>}</nobr></div>
<div style="position:absolute;top:135374;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:135607;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="115"><b>Page 115</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:135693;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:135696;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:136633;left:85"><nobr>Problem reproduction</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:136690;left:756"><nobr>115 of 127</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:135793;left:101"><nobr><b>#### ClassA.java</b></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:135810;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.tools.jdk7.training2;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:135845;left:101"><nobr>/**</nobr></div>
<div style="position:absolute;top:135863;left:109"><nobr>* ClassA</nobr></div>
<div style="position:absolute;top:135880;left:109"><nobr>* <b><font color="#7f9fbf">@author </font></b>Pierre<font color="#7f7f9f">-</font>Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:135898;left:109"><nobr>*</nobr></div>
<div style="position:absolute;top:135916;left:109"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:135933;left:101"><nobr><b>public class </b><font color="#000000">ClassA {</font></nobr></div>
<div style="position:absolute;top:135968;left:167"><nobr><b>private final static </b><font color="#000000">String </font><i><font color="#0000c0">CLAZZ </font></i><font color="#000000">= ClassA.</font><b>class</b><font color="#000000">.getName();</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:135986;left:167"><nobr>// Problem replication switch ON/OFF</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:136003;left:167"><nobr><b>private final static boolean </b><i><font color="#0000c0">REPLICATE_PROBLEM1 </font></i><font color="#000000">= </font><b>true</b><font color="#000000">; </font><font color="#3f7f5f">// static variable</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:136021;left:101"><nobr>initializer</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:136038;left:167"><nobr><b>private final static boolean </b><i><font color="#0000c0">REPLICATE_PROBLEM2 </font></i><font color="#000000">= </font><b>false</b><font color="#000000">; </font><font color="#3f7f5f">// static block{}</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:136056;left:101"><nobr>initializer</nobr></div>
<div style="position:absolute;top:136091;left:167"><nobr>// Static variable executed at Class loading time</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:136109;left:167"><nobr><b>private static </b><font color="#000000">String </font><i><font color="#0000c0">staticVariable </font></i><font color="#000000">= </font><i><font color="#000000">initStaticVariable</font></i><font color="#000000">();</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:136144;left:167"><nobr>// Static initializer block executed at Class loading time</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:136161;left:167"><nobr><b>static </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:136196;left:225"><nobr>// Static block code execution...</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:136214;left:225"><nobr><b>if </b><font color="#000000">(</font><i><font color="#0000c0">REPLICATE_PROBLEM2</font></i><font color="#000000">) </font><b>throw new</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:136231;left:101"><nobr>IllegalStateException(<font color="#2a00ff">"ClassA.static{}: Internal Error!"</font>);</nobr></div>
<div style="position:absolute;top:136249;left:167"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:136284;left:167"><nobr><b>public </b><font color="#000000">ClassA() {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:136302;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Creating a new instance of "</font>+ClassA.<b><font color="#7f0055">class</font></b>.getName()</nobr></div>
<div style="position:absolute;top:136319;left:101"><nobr>+<font color="#2a00ff">"..."</font>);</nobr></div>
<div style="position:absolute;top:136337;left:167"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:136372;left:167"><nobr>/**</nobr></div>
<div style="position:absolute;top:136389;left:175"><nobr>*</nobr></div>
<div style="position:absolute;top:136407;left:175"><nobr>* <b><font color="#7f9fbf">@return</font></b></nobr></div>
<div style="position:absolute;top:136425;left:175"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:136442;left:167"><nobr><b>private static </b><font color="#000000">String initStaticVariable() {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:136477;left:225"><nobr>String stringData = <font color="#2a00ff">""</font>;</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:136512;left:225"><nobr><b>if </b><font color="#000000">(</font><i><font color="#0000c0">REPLICATE_PROBLEM1</font></i><font color="#000000">) </font><b>throw new</b></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:136530;left:101"><nobr>IllegalStateException(<font color="#2a00ff">"ClassA.initStaticVariable(): Internal Error!"</font>);</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:136565;left:225"><nobr><b>return </b><font color="#000000">stringData;</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:136582;left:167"><nobr>}</nobr></div>
<div style="position:absolute;top:136600;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:136795;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="116"><b>Page 116</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:136881;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:136884;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:136947;left:85"><nobr>In order to replicate the problem, we will simply "voluntary" trigger a failure of the static initializer code.</nobr></div>
<div style="position:absolute;top:136966;left:85"><nobr>Please simply enable the problem type that you want to study e.g. either static variable or static block</nobr></div>
<div style="position:absolute;top:136985;left:85"><nobr>initializer failure:</nobr></div>
<div style="position:absolute;top:137137;left:85"><nobr>Now, let’s run the program with both switch at OFF (both boolean values at false)</nobr></div>
<div style="position:absolute;top:137175;left:85"><nobr>## Baseline (normal execution)</nobr></div>
<div style="position:absolute;top:137549;left:85"><nobr>For the initial run (baseline), the main program was able to create 3 instances of ClassA successfully</nobr></div>
<div style="position:absolute;top:137570;left:85"><nobr>with no problem.</nobr></div>
<div style="position:absolute;top:137608;left:85"><nobr>## Problem reproduction run (static variable initializer failure)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:137878;left:756"><nobr>116 of 127</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:137057;left:101"><nobr>// Problem replication switch ON (true) / OFF (false)</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:137074;left:101"><nobr><b>private final static boolean </b><i><font color="#0000c0">REPLICATE_PROBLEM1 </font></i><font color="#000000">= </font><b>true</b><font color="#000000">; </font><font color="#3f7f5f">// static variable initializer</font></nobr></div>
<div style="position:absolute;top:137092;left:101"><nobr><b>private final static boolean </b><i><font color="#0000c0">REPLICATE_PROBLEM2 </font></i><font color="#000000">= </font><b>false</b><font color="#000000">; </font><font color="#3f7f5f">// static block{} initializer</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:137230;left:101"><nobr>java.lang.NoClassDefFoundError Simulator - Training 2</nobr></div>
<div style="position:absolute;top:137247;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:137265;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:137316;left:101"><nobr>FIRST attempt to create a new instance of ClassA...</nobr></div>
<div style="position:absolute;top:137350;left:101"><nobr>Creating a new instance of org.ph.javaee.tools.jdk7.training2.ClassA...</nobr></div>
<div style="position:absolute;top:137384;left:101"><nobr>SECOND attempt to create a new instance of ClassA...</nobr></div>
<div style="position:absolute;top:137418;left:101"><nobr>Creating a new instance of org.ph.javaee.tools.jdk7.training2.ClassA...</nobr></div>
<div style="position:absolute;top:137452;left:101"><nobr>THIRD attempt to create a new instance of ClassA...</nobr></div>
<div style="position:absolute;top:137486;left:101"><nobr>Creating a new instance of org.ph.javaee.tools.jdk7.training2.ClassA...</nobr></div>
<div style="position:absolute;top:137520;left:101"><nobr>done!</nobr></div>
</span></font>

<div style="position:absolute;top:137983;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="117"><b>Page 117</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:138069;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:138072;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:138759;left:85"><nobr>## Problem reproduction run (static block initializer failure)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:139066;left:756"><nobr>117 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:138134;left:101"><nobr>java.lang.NoClassDefFoundError Simulator - Training 2</nobr></div>
<div style="position:absolute;top:138151;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:138168;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:138219;left:101"><nobr>FIRST attempt to create a new instance of ClassA...</nobr></div>
</span></font>
<font size="3" color="#ff0000" face="Courier"><span style="font-size:13px;font-family:Courier;color:#ff0000">
<div style="position:absolute;top:138253;left:101"><nobr>java.lang.ExceptionInInitializerError</nobr></div>
<div style="position:absolute;top:138270;left:173"><nobr>at</nobr></div>
<div style="position:absolute;top:138287;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.NoClassDefFoundErrorSimulator.main(<font color="#000080">NoClassDe</font></nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:138304;left:101"><nobr>fFoundErrorSimulator.java:21<font color="#ff0000">)</font></nobr></div>
</span></font>
<font size="3" color="#ff0000" face="Courier"><span style="font-size:13px;font-family:Courier;color:#ff0000">
<div style="position:absolute;top:138321;left:101"><nobr>Caused by: <font color="#000080">java.lang.IllegalStateException</font>: ClassA.initStaticVariable():</nobr></div>
<div style="position:absolute;top:138338;left:101"><nobr>Internal Error!</nobr></div>
<div style="position:absolute;top:138355;left:173"><nobr>at</nobr></div>
<div style="position:absolute;top:138372;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.ClassA.initStaticVariable(<font color="#000080">ClassA.java:37</font>)</nobr></div>
<div style="position:absolute;top:138389;left:173"><nobr>at org.ph.javaee.tools.jdk7.training2.ClassA.&lt;clinit&gt;(<font color="#000080">ClassA.java:16</font>)</nobr></div>
<div style="position:absolute;top:138406;left:173"><nobr>... 1 more</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:138440;left:101"><nobr>SECOND attempt to create a new instance of ClassA...</nobr></div>
</span></font>
<font size="3" color="#ff0000" face="Courier"><span style="font-size:13px;font-family:Courier;color:#ff0000">
<div style="position:absolute;top:138474;left:101"><nobr>java.lang.NoClassDefFoundError: Could not initialize class</nobr></div>
<div style="position:absolute;top:138491;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.ClassA</nobr></div>
<div style="position:absolute;top:138508;left:173"><nobr>at</nobr></div>
<div style="position:absolute;top:138525;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.NoClassDefFoundErrorSimulator.main(<font color="#000080">NoClassDe</font></nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:138542;left:101"><nobr>fFoundErrorSimulator.java:30<font color="#ff0000">)</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:138576;left:101"><nobr>THIRD attempt to create a new instance of ClassA...</nobr></div>
</span></font>
<font size="3" color="#ff0000" face="Courier"><span style="font-size:13px;font-family:Courier;color:#ff0000">
<div style="position:absolute;top:138610;left:101"><nobr>java.lang.NoClassDefFoundError: Could not initialize class</nobr></div>
<div style="position:absolute;top:138628;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.ClassA</nobr></div>
<div style="position:absolute;top:138645;left:173"><nobr>at</nobr></div>
<div style="position:absolute;top:138662;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.NoClassDefFoundErrorSimulator.main(<font color="#000080">NoClassDe</font></nobr></div>
</span></font>
<font size="3" color="#000080" face="Courier"><span style="font-size:13px;font-family:Courier;color:#000080">
<div style="position:absolute;top:138679;left:101"><nobr>fFoundErrorSimulator.java:39<font color="#ff0000">)</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:138730;left:101"><nobr>done!</nobr></div>
</span></font>

<div style="position:absolute;top:139171;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="118"><b>Page 118</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:139257;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:139260;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:140101;left:85"><nobr>What happened? As you can see, the first attempt to create a new instance of ClassA did trigger a</nobr></div>
<div style="position:absolute;top:140121;left:85"><nobr>java.lang.ExceptionInInitializerError. This exception indicates the failure of our static</nobr></div>
<div style="position:absolute;top:140141;left:85"><nobr>initializer for our static variable &amp; bloc which is exactly what we wanted to achieve.</nobr></div>
<div style="position:absolute;top:140180;left:85"><nobr>The key point to understand at this point is that this failure did prevent the whole class loading of</nobr></div>
<div style="position:absolute;top:140200;left:85"><nobr>ClassA. As you can see, attempt #2 and attempt #3 both generated a</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:140254;left:756"><nobr>118 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:139322;left:110"><nobr>java.lang.NoClassDefFoundError Simulator - Training 2</nobr></div>
<div style="position:absolute;top:139348;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:139374;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:139452;left:101"><nobr>FIRST attempt to create a new instance of ClassA...</nobr></div>
<div style="position:absolute;top:139504;left:101"><nobr>java.lang.ExceptionInInitializerError</nobr></div>
<div style="position:absolute;top:139530;left:164"><nobr>at</nobr></div>
<div style="position:absolute;top:139547;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.NoClassDefFoundErrorSimulator.main(NoClassDe</nobr></div>
<div style="position:absolute;top:139564;left:101"><nobr>fFoundErrorSimulator.java:21)</nobr></div>
<div style="position:absolute;top:139590;left:101"><nobr>Caused by: java.lang.IllegalStateException: ClassA.static{}: Internal Error!</nobr></div>
<div style="position:absolute;top:139616;left:164"><nobr>at org.ph.javaee.tools.jdk7.training2.ClassA.&lt;clinit&gt;(ClassA.java:22)</nobr></div>
<div style="position:absolute;top:139642;left:164"><nobr>... 1 more</nobr></div>
<div style="position:absolute;top:139694;left:101"><nobr>SECOND attempt to create a new instance of ClassA...</nobr></div>
<div style="position:absolute;top:139746;left:101"><nobr>java.lang.NoClassDefFoundError: Could not initialize class</nobr></div>
<div style="position:absolute;top:139763;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.ClassA</nobr></div>
<div style="position:absolute;top:139789;left:164"><nobr>at</nobr></div>
<div style="position:absolute;top:139806;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.NoClassDefFoundErrorSimulator.main(NoClassDe</nobr></div>
<div style="position:absolute;top:139823;left:101"><nobr>fFoundErrorSimulator.java:30)</nobr></div>
<div style="position:absolute;top:139875;left:101"><nobr>THIRD attempt to create a new instance of ClassA...</nobr></div>
<div style="position:absolute;top:139927;left:101"><nobr>java.lang.NoClassDefFoundError: Could not initialize class</nobr></div>
<div style="position:absolute;top:139944;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.ClassA</nobr></div>
<div style="position:absolute;top:139971;left:164"><nobr>at</nobr></div>
<div style="position:absolute;top:139987;left:101"><nobr>org.ph.javaee.tools.jdk7.training2.NoClassDefFoundErrorSimulator.main(NoClassDe</nobr></div>
<div style="position:absolute;top:140005;left:101"><nobr>fFoundErrorSimulator.java:39)</nobr></div>
<div style="position:absolute;top:140057;left:101"><nobr>done!</nobr></div>
</span></font>

<div style="position:absolute;top:140359;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="119"><b>Page 119</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:140445;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:140448;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:140494;left:85"><nobr>java.lang.NoClassDefFoundError, why? Well since the first attempt failed, class loading of ClassA</nobr></div>
<div style="position:absolute;top:140515;left:85"><nobr>was prevented. Successive attempts to create a new instance of ClassA within the current</nobr></div>
<div style="position:absolute;top:140537;left:85"><nobr>ClassLoader did generate java.lang.NoClassDefFoundError over and over since ClassA was not</nobr></div>
<div style="position:absolute;top:140558;left:85"><nobr>found within current ClassLoader.</nobr></div>
<div style="position:absolute;top:140597;left:85"><nobr>As you can see, in this problem context, the NoClassDefFoundError is just a <i>symptom </i>or</nobr></div>
<div style="position:absolute;top:140616;left:85"><nobr><i>consequence </i>of another problem. The original problem is the ExceptionInInitializerError triggered</nobr></div>
<div style="position:absolute;top:140635;left:85"><nobr>following the failure of the static initializer code. This clearly demonstrates the importance of proper</nobr></div>
<div style="position:absolute;top:140654;left:85"><nobr>error handling and logging when using Java static initializers.</nobr></div>
<div style="position:absolute;top:140692;left:85"><nobr>Recommendations and resolution strategies</nobr></div>
<div style="position:absolute;top:140730;left:85"><nobr>Now find below my recommendations and resolution strategies for NoClassDefFoundError problem</nobr></div>
<div style="position:absolute;top:140749;left:85"><nobr>case 2:</nobr></div>
<div style="position:absolute;top:140790;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:140789;left:139"><nobr>Review the java.lang.NoClassDefFoundError error and identify the missing Java class</nobr></div>
<div style="position:absolute;top:140811;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:140809;left:139"><nobr>Perform a code walkthrough of the affected class and determine if it contains static initializer</nobr></div>
<div style="position:absolute;top:140828;left:139"><nobr>code (variables &amp; static block)</nobr></div>
<div style="position:absolute;top:140850;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:140849;left:139"><nobr>Review your server and application logs and determine if any error (e.g.</nobr></div>
<div style="position:absolute;top:140868;left:139"><nobr>ExceptionInInitializerError) originates from the static initializer code</nobr></div>
<div style="position:absolute;top:140890;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:140888;left:139"><nobr>Once confirmed, analyze the code further and determine the root cause of the initializer code</nobr></div>
<div style="position:absolute;top:140907;left:139"><nobr>failure. You may need to add some extra logging along with proper error handling to prevent</nobr></div>
<div style="position:absolute;top:140926;left:139"><nobr>and better handle future failures of your static initializer code going forward</nobr></div>
<div style="position:absolute;top:140964;left:85"><nobr>Parent first Classloader</nobr></div>
<div style="position:absolute;top:141002;left:85"><nobr>The following section will describe one common problem pattern when using the default class loader</nobr></div>
<div style="position:absolute;top:141021;left:85"><nobr>delegation model.</nobr></div>
<div style="position:absolute;top:141059;left:85"><nobr>A simple Java program will again be provided in order to help you understand this problem pattern.</nobr></div>
<div style="position:absolute;top:141097;left:85"><nobr>Default JVM Classloader delegation model</nobr></div>
<div style="position:absolute;top:141135;left:85"><nobr>As we saw before, the default class loader delegation model is from bottom-up e.g. parent first. This</nobr></div>
<div style="position:absolute;top:141154;left:85"><nobr>means that the JVM is going up to the class loader chain in order to find and load each of your</nobr></div>
<div style="position:absolute;top:141173;left:85"><nobr>application Java classes. If the class is not found from the parent class loaders, the JVM will then</nobr></div>
<div style="position:absolute;top:141192;left:85"><nobr>attempt to load it from the current Thread context class loader; typically a child class loader.</nobr></div>
<div style="position:absolute;top:141230;left:85"><nobr>NoClassDefFoundError problems can occur, for example, when you wrongly package your application</nobr></div>
<div style="position:absolute;top:141249;left:85"><nobr>(or third part API's) between the parent and child class loaders. Another example is code / JAR files</nobr></div>
<div style="position:absolute;top:141268;left:85"><nobr>injection by the container itself or third party API's deployed at a higher level in the class loader chain.</nobr></div>
<div style="position:absolute;top:141306;left:85"><nobr>In the above scenarios:</nobr></div>
<div style="position:absolute;top:141347;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:141345;left:139"><nobr>The JVM loads one part of the affected code to a parent class loader (SYSTEM or parent class</nobr></div>
<div style="position:absolute;top:141364;left:139"><nobr>loaders)</nobr></div>
<div style="position:absolute;top:141386;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:141385;left:139"><nobr>The JVM loads the other parts of the affected code to a child class loader (Java EE container</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:141442;left:756"><nobr>119 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:141547;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="120"><b>Page 120</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:141633;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:141636;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:141680;left:139"><nobr>or application defined class loader)</nobr></div>
<div style="position:absolute;top:141718;left:85"><nobr>Now what happens when Java classes loaded from the parent attempt to load reference classes</nobr></div>
<div style="position:absolute;top:141737;left:85"><nobr>deployed only to the child classloader? NoClassDefFoundError!</nobr></div>
<div style="position:absolute;top:141756;left:85"><nobr>Please remember that a parent class loader has no visibility or access to child class loaders. This</nobr></div>
<div style="position:absolute;top:141775;left:85"><nobr>means that any referencing code must be found either from the parent class loader chain (bottom-up)</nobr></div>
<div style="position:absolute;top:141794;left:85"><nobr>or at the current Thread context class loader level; otherwise java.lang.NoClassDefFoundError is</nobr></div>
<div style="position:absolute;top:141813;left:85"><nobr>thrown by the JVM.</nobr></div>
<div style="position:absolute;top:141851;left:85"><nobr>This is exactly what the following Java program will demonstrate.</nobr></div>
<div style="position:absolute;top:141889;left:85"><nobr>Sample Java program</nobr></div>
<div style="position:absolute;top:141927;left:85"><nobr>The following simple Java program is split as per below:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:141969;left:112"><nobr>• <font style="font-size:14px">The main Java program NoClassDefFoundErrorSimulator is packaged in</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:141990;left:139"><nobr>MainProgram.jar</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:142013;left:112"><nobr>• <font style="font-size:14px">A logging utility class JavaEETrainingUtil is packaged in MainProgram.jar</font></nobr></div>
<div style="position:absolute;top:142036;left:112"><nobr>• <font style="font-size:14px">The Java class caller CallerClassA is packaged in caller.jar</font></nobr></div>
<div style="position:absolute;top:142060;left:112"><nobr>• <font style="font-size:14px">The referencing Java class ReferencingClassA is packaged in referencer.jar</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:142098;left:85"><nobr>These following tasks are performed:</nobr></div>
<div style="position:absolute;top:142140;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:142138;left:139"><nobr>Create a child class loader (java.net.URLClassLoader)</nobr></div>
<div style="position:absolute;top:142160;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:142158;left:139"><nobr>Assign the caller and referencing Java class jar files to the child class loader</nobr></div>
<div style="position:absolute;top:142181;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:142179;left:139"><nobr>Change the current Thread context ClassLoader to the child ClassLoader</nobr></div>
<div style="position:absolute;top:142201;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:142200;left:139"><nobr>Attempt to load and create a new instance of CallerClassA from the current Thread context</nobr></div>
<div style="position:absolute;top:142219;left:139"><nobr>class loader e.g. child</nobr></div>
<div style="position:absolute;top:142241;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:142239;left:139"><nobr>Proper logging was added in order to help you understand the class loader tree and Thread</nobr></div>
<div style="position:absolute;top:142258;left:139"><nobr>context class loader state</nobr></div>
<div style="position:absolute;top:142296;left:85"><nobr>It will demonstrate that a wrong packaging of the application code is leading to a</nobr></div>
<div style="position:absolute;top:142315;left:85"><nobr>NoClassDefFoundError as per the default class loader delegation model.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:142630;left:755"><nobr>120 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:142735;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="121"><b>Page 121</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:142821;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:142824;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:143818;left:755"><nobr>121 of 127</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:10px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:142883;left:101"><nobr><b>#### NoClassDefFoundErrorSimulator.java</b></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:142898;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.training3;</font></nobr></div>
<div style="position:absolute;top:142927;left:101"><nobr><b>import </b><font color="#000000">java.net.URL;</font></nobr></div>
<div style="position:absolute;top:142942;left:101"><nobr><b>import </b><font color="#000000">java.net.URLClassLoader;</font></nobr></div>
<div style="position:absolute;top:142972;left:101"><nobr><b>import </b><font color="#000000">org.ph.javaee.training.util.JavaEETrainingUtil;</font></nobr></div>
<div style="position:absolute;top:143002;left:101"><nobr><b>public class </b><font color="#000000">NoClassDefFoundErrorSimulator {</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:10px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:143032;left:157"><nobr>/**</nobr></div>
<div style="position:absolute;top:143047;left:164"><nobr>* <b><font color="#7f9fbf">@param </font></b>args</nobr></div>
<div style="position:absolute;top:143062;left:164"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:143077;left:157"><nobr><b>public static void </b><font color="#000000">main(String[] args) {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143107;left:206"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"java.lang.NoClassDefFoundError Simulator - Training 3"</font>);</nobr></div>
<div style="position:absolute;top:143122;left:206"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Author: Pierre-Hugues Charbonneau"</font>);</nobr></div>
<div style="position:absolute;top:143136;left:206"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"http://javaeesupportpatterns.blogspot.com"</font>);</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:143166;left:206"><nobr>// Local variables</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143181;left:206"><nobr>String currentThreadName = Thread.<i>currentThread</i>().getName();</nobr></div>
<div style="position:absolute;top:143196;left:206"><nobr>String callerFullClassName = <font color="#2a00ff">"org.ph.javaee.training3.CallerClassA"</font>;</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:143226;left:206"><nobr>// Print current ClassLoader context &amp; Thread</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143241;left:206"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\nCurrent Thread name: '"</font>+currentThreadName+<font color="#2a00ff">"'"</font>);</nobr></div>
<div style="position:absolute;top:143256;left:206"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Initial ClassLoader chain:</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:10px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:143271;left:101"><nobr>"<font color="#000000">+JavaEETrainingUtil.</font><i><font color="#000000">getCurrentClassloaderDetail</font></i><font color="#000000">());</font></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:10px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:143301;left:206"><nobr><b>try </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:143315;left:263"><nobr>// Location of the application code for our child ClassLoader</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143330;left:262"><nobr>URL[] webAppLibURL = <b><font color="#7f0055">new </font></b>URL[] {<b><font color="#7f0055">new </font></b>URL(<font color="#2a00ff">"file:caller.jar"</font>),<b><font color="#7f0055">new</font></b></nobr></div>
<div style="position:absolute;top:143345;left:101"><nobr>URL(<font color="#2a00ff">"file:referencer.jar"</font>)};</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:143375;left:263"><nobr>// Child ClassLoader instance creation    </nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143390;left:262"><nobr>URLClassLoader childClassLoader = <b><font color="#7f0055">new </font></b>URLClassLoader(webAppLibURL);</nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:10px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:143405;left:263"><nobr>/*** Application code execution... ***/</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:143420;left:263"><nobr>// 1. Change the current Thread ClassLoader to the child ClassLoader</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143435;left:262"><nobr>Thread.<i>currentThread</i>().setContextClassLoader(childClassLoader);</nobr></div>
<div style="position:absolute;top:143450;left:262"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"&gt;&gt; Thread '"</font>+currentThreadName+<font color="#2a00ff">"' Context ClassLoader now</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:10px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:143465;left:101"><nobr>changed to '"<font color="#000000">+childClassLoader+</font>"'"<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143480;left:262"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\nNew ClassLoader chain:</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:10px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:143495;left:101"><nobr>"<font color="#000000">+JavaEETrainingUtil.</font><i><font color="#000000">getCurrentClassloaderDetail</font></i><font color="#000000">());</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:143524;left:263"><nobr>// 2. Load the caller Class within the child ClassLoader...</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143539;left:262"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"&gt;&gt; Loading '"</font>+callerFullClassName+<font color="#2a00ff">"' to child ClassLoader</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:10px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:143554;left:101"><nobr>'"<font color="#000000">+childClassLoader+</font>"'..."<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143569;left:262"><nobr>Class&lt;?&gt; callerClass = childClassLoader.loadClass(callerFullClassName);</nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:10px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:143599;left:263"><nobr>// 3. Create a new instance of CallerClassA</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:143614;left:262"><nobr>Object callerClassInstance = callerClass.newInstance();    </nobr></div>
<div style="position:absolute;top:143644;left:206"><nobr>} <b><font color="#7f0055">catch </font></b>(Throwable any) {</nobr></div>
<div style="position:absolute;top:143659;left:263"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Throwable: "</font>+any);</nobr></div>
<div style="position:absolute;top:143674;left:262"><nobr>any.printStackTrace();</nobr></div>
<div style="position:absolute;top:143689;left:206"><nobr>}</nobr></div>
<div style="position:absolute;top:143719;left:206"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"\nSimulator completed!"</font>);</nobr></div>
<div style="position:absolute;top:143733;left:157"><nobr>}</nobr></div>
<div style="position:absolute;top:143748;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:143923;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="122"><b>Page 122</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:144009;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:144012;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:145006;left:755"><nobr>122 of 127</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:144090;left:101"><nobr><b>#### CallerClassA.java</b></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:144107;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.training3;</font></nobr></div>
<div style="position:absolute;top:144142;left:101"><nobr><b>import </b><font color="#000000">org.ph.javaee.training3.ReferencingClassA;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:144177;left:101"><nobr>/**</nobr></div>
<div style="position:absolute;top:144195;left:109"><nobr>* CallerClassA</nobr></div>
<div style="position:absolute;top:144213;left:109"><nobr>* <b><font color="#7f9fbf">@author </font></b>Pierre<font color="#7f7f9f">-</font>Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:144230;left:109"><nobr>*</nobr></div>
<div style="position:absolute;top:144248;left:109"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:144265;left:101"><nobr><b>public class </b><font color="#000000">CallerClassA {</font></nobr></div>
<div style="position:absolute;top:144300;left:167"><nobr><b>private final static </b><font color="#000000">Class&lt;CallerClassA&gt; </font><i><font color="#0000c0">CLAZZ </font></i><font color="#000000">= CallerClassA.</font><b>class</b><font color="#000000">;</font></nobr></div>
<div style="position:absolute;top:144335;left:167"><nobr><b>static </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:144353;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Class loading of "</font>+<i><font color="#0000c0">CLAZZ</font></i>+<font color="#2a00ff">" from ClassLoader</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:144370;left:101"><nobr>'"<font color="#000000">+</font><i><font color="#0000c0">CLAZZ</font></i><font color="#000000">.getClassLoader()+</font>"' in progress..."<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:144388;left:167"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:144423;left:167"><nobr><b>public </b><font color="#000000">CallerClassA() {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:144441;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Creating a new instance of</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:144458;left:101"><nobr>"<font color="#000000">+CallerClassA.</font><b><font color="#7f0055">class</font></b><font color="#000000">.getName()+</font>"..."<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:144493;left:225"><nobr>doSomething();</nobr></div>
<div style="position:absolute;top:144511;left:167"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:144546;left:167"><nobr><b>private void </b><font color="#000000">doSomething() {</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:144581;left:225"><nobr>// Create a new instance of ReferencingClassA</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:144599;left:225"><nobr>ReferencingClassA referencingClass = <b><font color="#7f0055">new </font></b>ReferencingClassA();    </nobr></div>
<div style="position:absolute;top:144616;left:167"><nobr>}</nobr></div>
<div style="position:absolute;top:144634;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:145111;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="123"><b>Page 123</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:145197;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:145200;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:145749;left:85"><nobr>Problem reproduction</nobr></div>
<div style="position:absolute;top:145787;left:85"><nobr>In order to replicate the problem, we will simply “voluntary” split the packaging of the application code</nobr></div>
<div style="position:absolute;top:145806;left:85"><nobr>(caller &amp; referencing class) between the parent and child class loader.</nobr></div>
<div style="position:absolute;top:145846;left:85"><nobr>For now, let’s run the program with the right JAR files deployment and class loader chain:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:145888;left:112"><nobr>• <font style="font-size:14px">The main program and utility class are deployed at the parent class loader (SYSTEM</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:145906;left:139"><nobr>classpath)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:145929;left:112"><nobr>• <font style="font-size:14px">CallerClassA and ReferencingClassA and both deployed at the child class loader level</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:145968;left:85"><nobr>## Baseline (normal execution)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:146194;left:755"><nobr>123 of 127</nobr></div>
</span></font>
<font size="3" color="#1f497d" face="Times"><span style="font-size:13px;font-family:Times;color:#1f497d">
<div style="position:absolute;top:145278;left:101"><nobr><b>#### ReferencingClassA.java</b></nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:145295;left:101"><nobr><b>package </b><font color="#000000">org.ph.javaee.training3;</font></nobr></div>
</span></font>
<font size="3" color="#3f5fbf" face="Times"><span style="font-size:13px;font-family:Times;color:#3f5fbf">
<div style="position:absolute;top:145330;left:101"><nobr>/**</nobr></div>
<div style="position:absolute;top:145348;left:109"><nobr>* ReferencingClassA</nobr></div>
<div style="position:absolute;top:145365;left:109"><nobr>* <b><font color="#7f9fbf">@author </font></b>Pierre<font color="#7f7f9f">-</font>Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:145383;left:109"><nobr>*</nobr></div>
<div style="position:absolute;top:145401;left:109"><nobr>*/</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:145418;left:101"><nobr><b>public class </b><font color="#000000">ReferencingClassA {</font></nobr></div>
<div style="position:absolute;top:145453;left:167"><nobr><b>private final static </b><font color="#000000">Class&lt;ReferencingClassA&gt; </font><i><font color="#0000c0">CLAZZ </font></i><font color="#000000">= ReferencingClassA.</font><b>class</b><font color="#000000">;</font></nobr></div>
<div style="position:absolute;top:145488;left:167"><nobr><b>static </b><font color="#000000">{</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:145506;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Class loading of "</font>+<i><font color="#0000c0">CLAZZ</font></i>+<font color="#2a00ff">" from ClassLoader</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:145523;left:101"><nobr>'"<font color="#000000">+</font><i><font color="#0000c0">CLAZZ</font></i><font color="#000000">.getClassLoader()+</font>"' in progress..."<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:145541;left:167"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:145576;left:167"><nobr><b>public </b><font color="#000000">ReferencingClassA() {</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:145594;left:225"><nobr>System.<i><font color="#0000c0">out</font></i>.println(<font color="#2a00ff">"Creating a new instance of</font></nobr></div>
</span></font>
<font size="3" color="#2a00ff" face="Times"><span style="font-size:13px;font-family:Times;color:#2a00ff">
<div style="position:absolute;top:145611;left:101"><nobr>"<font color="#000000">+ReferencingClassA.</font><b><font color="#7f0055">class</font></b><font color="#000000">.getName()+</font>"..."<font color="#000000">);</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:145629;left:167"><nobr>}</nobr></div>
</span></font>
<font size="3" color="#7f0055" face="Times"><span style="font-size:13px;font-family:Times;color:#7f0055">
<div style="position:absolute;top:145664;left:167"><nobr><b>public void </b><font color="#000000">doSomething() {</font></nobr></div>
</span></font>
<font size="3" color="#3f7f5f" face="Times"><span style="font-size:13px;font-family:Times;color:#3f7f5f">
<div style="position:absolute;top:145681;left:225"><nobr>//nothing to do...</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:13px;font-family:Times">
<div style="position:absolute;top:145699;left:167"><nobr>}</nobr></div>
<div style="position:absolute;top:145716;left:101"><nobr>}</nobr></div>
</span></font>

<div style="position:absolute;top:146299;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="124"><b>Page 124</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:146385;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:146388;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:147147;left:85"><nobr>For the initial run (baseline), the main program was able to create successfully a new instance of</nobr></div>
<div style="position:absolute;top:147167;left:85"><nobr>CallerClassA from the child class loader (java.net.URLClassLoader) along with its referencing</nobr></div>
<div style="position:absolute;top:147186;left:85"><nobr>class with no problem.</nobr></div>
<div style="position:absolute;top:147226;left:85"><nobr>Now let’s run the program with the wrong application packaging and class loader chain:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:147268;left:112"><nobr>• <font style="font-size:14px">The main program and utility class are deployed at the parent class loader (SYSTEM</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:147288;left:139"><nobr>classpath)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:147311;left:112"><nobr>• <font style="font-size:14px">CallerClassA and ReferencingClassA and both deployed at the child class loader level</font></nobr></div>
<div style="position:absolute;top:147334;left:112"><nobr>• <font style="font-size:14px">CallerClassA (caller.jar) is also deployed at the parent class loader level</font></nobr></div>
<div style="position:absolute;top:147382;left:755"><nobr>124 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:146488;left:101"><nobr>&lt;JDK_HOME&gt;\bin&gt;java -classpath MainProgram.jar</nobr></div>
<div style="position:absolute;top:146505;left:101"><nobr>org.ph.javaee.training3.NoClassDefFoundErrorSimulator</nobr></div>
<div style="position:absolute;top:146539;left:101"><nobr>java.lang.NoClassDefFoundError Simulator - Training 3</nobr></div>
<div style="position:absolute;top:146556;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:146573;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:146607;left:101"><nobr>Current Thread name: 'main'</nobr></div>
<div style="position:absolute;top:146624;left:101"><nobr>Initial ClassLoader chain:</nobr></div>
<div style="position:absolute;top:146641;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:146658;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:146675;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:146692;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9 **Current Thread 'main' Context</nobr></div>
<div style="position:absolute;top:146709;left:101"><nobr>ClassLoader**</nobr></div>
<div style="position:absolute;top:146726;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:146760;left:101"><nobr>&gt;&gt; Thread 'main' Context ClassLoader now changed to</nobr></div>
<div style="position:absolute;top:146777;left:101"><nobr>'java.net.URLClassLoader@6a4d37e5'</nobr></div>
<div style="position:absolute;top:146811;left:101"><nobr>New ClassLoader chain:</nobr></div>
<div style="position:absolute;top:146828;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:146845;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:146862;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:146879;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9</nobr></div>
<div style="position:absolute;top:146896;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:146913;left:101"><nobr>java.net.URLClassLoader@6a4d37e5 **Current Thread 'main' Context ClassLoader**</nobr></div>
<div style="position:absolute;top:146930;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:146964;left:101"><nobr>&gt;&gt; Loading 'org.ph.javaee.training3.CallerClassA' to child ClassLoader</nobr></div>
<div style="position:absolute;top:146982;left:101"><nobr>'java.net.URLClassLoader@6a4d37e5'...</nobr></div>
<div style="position:absolute;top:146998;left:101"><nobr>Class loading of class org.ph.javaee.training3.CallerClassA from ClassLoader</nobr></div>
</span></font>
<font size="3" color="#0070c0" face="Courier"><span style="font-size:13px;font-family:Courier;color:#0070c0">
<div style="position:absolute;top:147016;left:101"><nobr>'java.net.URLClassLoader@6a4d37e5' <font color="#000000">in progress...</font></nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:13px;font-family:Courier">
<div style="position:absolute;top:147033;left:101"><nobr>Creating a new instance of org.ph.javaee.training3.CallerClassA...</nobr></div>
<div style="position:absolute;top:147050;left:101"><nobr>Class loading of class org.ph.javaee.training3.ReferencingClassA from</nobr></div>
<div style="position:absolute;top:147067;left:101"><nobr>ClassLoader <font color="#0070c0">'java.net.URLClassLoader@6a4d37e5' </font>in progress...</nobr></div>
<div style="position:absolute;top:147084;left:101"><nobr>Creating a new instance of org.ph.javaee.training3.ReferencingClassA...</nobr></div>
<div style="position:absolute;top:147118;left:101"><nobr>Simulator completed!</nobr></div>
</span></font>

<div style="position:absolute;top:147487;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="125"><b>Page 125</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:147573;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:147576;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:147639;left:85"><nobr>## Problem reproduction run (static variable initializer failure)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:148570;left:755"><nobr>125 of 127</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:11px;font-family:Courier">
<div style="position:absolute;top:147675;left:101"><nobr>&lt;JDK_HOME&gt;\bin&gt;java -classpath MainProgram.jar;<font color="#c00000">caller.jar</font></nobr></div>
<div style="position:absolute;top:147691;left:101"><nobr>org.ph.javaee.training3.NoClassDefFoundErrorSimulator</nobr></div>
<div style="position:absolute;top:147721;left:101"><nobr>java.lang.NoClassDefFoundError Simulator - Training 3</nobr></div>
<div style="position:absolute;top:147737;left:101"><nobr>Author: Pierre-Hugues Charbonneau</nobr></div>
<div style="position:absolute;top:147752;left:101"><nobr>http://javaeesupportpatterns.blogspot.com</nobr></div>
<div style="position:absolute;top:147783;left:101"><nobr>Current Thread name: 'main'</nobr></div>
<div style="position:absolute;top:147798;left:101"><nobr>Initial ClassLoader chain:</nobr></div>
<div style="position:absolute;top:147813;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:147828;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:147844;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:147859;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9 **Current Thread 'main' Context ClassLoader**</nobr></div>
<div style="position:absolute;top:147874;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:147905;left:101"><nobr>&gt;&gt; Thread 'main' Context ClassLoader now changed to 'java.net.URLClassLoader@6a4d37e5'</nobr></div>
<div style="position:absolute;top:147936;left:101"><nobr>New ClassLoader chain:</nobr></div>
<div style="position:absolute;top:147951;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:147966;left:101"><nobr>sun.misc.Launcher$ExtClassLoader@17c1e333</nobr></div>
<div style="position:absolute;top:147981;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:147997;left:101"><nobr>sun.misc.Launcher$AppClassLoader@214c4ac9</nobr></div>
<div style="position:absolute;top:148012;left:101"><nobr>--- delegation ---</nobr></div>
<div style="position:absolute;top:148027;left:101"><nobr>java.net.URLClassLoader@6a4d37e5 **Current Thread 'main' Context ClassLoader**</nobr></div>
<div style="position:absolute;top:148043;left:101"><nobr>-----------------------------------------------------------------</nobr></div>
<div style="position:absolute;top:148073;left:101"><nobr>&gt;&gt; Loading 'org.ph.javaee.training3.CallerClassA' to child ClassLoader</nobr></div>
<div style="position:absolute;top:148089;left:101"><nobr>'java.net.URLClassLoader@6a4d37e5'...</nobr></div>
<div style="position:absolute;top:148104;left:101"><nobr>Class loading of class org.ph.javaee.training3.CallerClassA from ClassLoader</nobr></div>
</span></font>
<font size="3" color="#c00000" face="Courier"><span style="font-size:11px;font-family:Courier;color:#c00000">
<div style="position:absolute;top:148119;left:101"><nobr>'sun.misc.Launcher$AppClassLoader@214c4ac9' <font color="#000000">in progress...</font><font color="#e36c0a">// Caller is loaded from the</font></nobr></div>
</span></font>
<font size="3" color="#e36c0a" face="Courier"><span style="font-size:11px;font-family:Courier;color:#e36c0a">
<div style="position:absolute;top:148134;left:101"><nobr>parent class loader, why???</nobr></div>
</span></font>
<font size="3" face="Courier"><span style="font-size:11px;font-family:Courier">
<div style="position:absolute;top:148150;left:101"><nobr>Creating a new instance of org.ph.javaee.training3.CallerClassA...</nobr></div>
<div style="position:absolute;top:148165;left:101"><nobr>Throwable: <font color="#c00000">java.lang.NoClassDefFoundError</font>: org/ph/javaee/training3/ReferencingClassA</nobr></div>
<div style="position:absolute;top:148180;left:101"><nobr>java.lang.NoClassDefFoundError: org/ph/javaee/training3/ReferencingClassA</nobr></div>
<div style="position:absolute;top:148196;left:166"><nobr>at org.ph.javaee.training3.CallerClassA.doSomething(CallerClassA.java:27)</nobr></div>
<div style="position:absolute;top:148211;left:166"><nobr>at org.ph.javaee.training3.CallerClassA.&lt;init&gt;(CallerClassA.java:21)</nobr></div>
<div style="position:absolute;top:148226;left:166"><nobr>at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</nobr></div>
<div style="position:absolute;top:148242;left:166"><nobr>at sun.reflect.NativeConstructorAccessorImpl.newInstance(Unknown Source)</nobr></div>
<div style="position:absolute;top:148257;left:166"><nobr>at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(Unknown Source)</nobr></div>
<div style="position:absolute;top:148272;left:166"><nobr>at java.lang.reflect.Constructor.newInstance(Unknown Source)</nobr></div>
<div style="position:absolute;top:148287;left:166"><nobr>at java.lang.Class.newInstance0(Unknown Source)</nobr></div>
<div style="position:absolute;top:148303;left:166"><nobr>at java.lang.Class.newInstance(Unknown Source)</nobr></div>
<div style="position:absolute;top:148318;left:166"><nobr>at</nobr></div>
<div style="position:absolute;top:148333;left:101"><nobr>org.ph.javaee.training3.NoClassDefFoundErrorSimulator.main(NoClassDefFoundErrorSimulator</nobr></div>
<div style="position:absolute;top:148349;left:101"><nobr>.java:51)</nobr></div>
<div style="position:absolute;top:148364;left:101"><nobr>Caused by: <font color="#c00000">java.lang.ClassNotFoundException</font>: org.ph.javaee.training3.ReferencingClassA</nobr></div>
<div style="position:absolute;top:148379;left:166"><nobr>at java.net.URLClassLoader$1.run(Unknown Source)</nobr></div>
<div style="position:absolute;top:148395;left:166"><nobr>at java.net.URLClassLoader$1.run(Unknown Source)</nobr></div>
<div style="position:absolute;top:148410;left:166"><nobr>at java.security.AccessController.doPrivileged(Native Method)</nobr></div>
<div style="position:absolute;top:148425;left:166"><nobr>at java.net.URLClassLoader.findClass(Unknown Source)</nobr></div>
<div style="position:absolute;top:148440;left:166"><nobr>at java.lang.ClassLoader.loadClass(Unknown Source)</nobr></div>
<div style="position:absolute;top:148456;left:166"><nobr>at sun.misc.Launcher$AppClassLoader.loadClass(Unknown Source)</nobr></div>
<div style="position:absolute;top:148471;left:166"><nobr>at java.lang.ClassLoader.loadClass(Unknown Source)</nobr></div>
<div style="position:absolute;top:148486;left:166"><nobr>... 9 more</nobr></div>
<div style="position:absolute;top:148517;left:101"><nobr>Simulator completed!</nobr></div>
</span></font>

<div style="position:absolute;top:148675;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="126"><b>Page 126</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:148761;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:148764;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:148827;left:85"><nobr>What happened?</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:148869;left:112"><nobr>• <font style="font-size:14px">The main program and utility classes were loaded as expected from the parent class loader</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:148889;left:139"><nobr>(<font style="font-size:11px">sun.misc.Launcher$AppClassLoader</font>)</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:148912;left:112"><nobr>• <font style="font-size:14px">The Thread context class loader was changed to child class loader as expected which includes</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:148931;left:139"><nobr>both caller and referencing jar files</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:148954;left:112"><nobr>• <font style="font-size:14px">However, we can see that CallerClassA was actually loaded by the parent class loader</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:148976;left:139"><nobr>(<font style="font-size:11px">sun.misc.Launcher$AppClassLoader</font>) instead of the child class loader</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:148999;left:112"><nobr>• <font style="font-size:14px">Since ReferencingClassA was not deployed to the parent class loader, the class cannot be</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:149018;left:139"><nobr>found from the current class loader chain since the parent class loader has no visibility on the</nobr></div>
<div style="position:absolute;top:149039;left:139"><nobr>child class loader, NoClassDefFoundError is thrown</nobr></div>
<div style="position:absolute;top:149077;left:85"><nobr>The key point to understand at this point is why CallerClassA was loaded by the parent class</nobr></div>
<div style="position:absolute;top:149097;left:85"><nobr>loader. The answer is with the default class loader delegation model. Both child and parent class</nobr></div>
<div style="position:absolute;top:149117;left:85"><nobr>loaders contain the caller JAR files. However, the default delegation model is always parent first which</nobr></div>
<div style="position:absolute;top:149135;left:85"><nobr>is why it was loaded at that level. The problem is that the caller contains a class reference to</nobr></div>
<div style="position:absolute;top:149154;left:85"><nobr>ReferencingClassA which is only deployed to the child class loader; java.lang.NoClassDefFoundError</nobr></div>
<div style="position:absolute;top:149173;left:85"><nobr>condition is met.</nobr></div>
<div style="position:absolute;top:149213;left:85"><nobr>As you can see, a packaging problem of your code or third part API can easily lead to this problem</nobr></div>
<div style="position:absolute;top:149232;left:85"><nobr>due to the default class loader delegation behaviour. It is very important that you review your class</nobr></div>
<div style="position:absolute;top:149251;left:85"><nobr>loader chain and determine if you are at risk of duplicate code or libraries across your parent and child</nobr></div>
<div style="position:absolute;top:149270;left:85"><nobr>class loaders.</nobr></div>
<div style="position:absolute;top:149308;left:85"><nobr>Recommendations and resolution strategies</nobr></div>
<div style="position:absolute;top:149346;left:85"><nobr>Now find below my recommendations and resolution strategies for this problem pattern:</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:149388;left:112"><nobr>• <font style="font-size:14px">Review the java.lang.NoClassDefFoundError error and identify the Java class that the JVM is</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:149407;left:139"><nobr>complaining about</nobr></div>
<div style="position:absolute;top:149430;left:112"><nobr>•</nobr></div>
<div style="position:absolute;top:149428;left:139"><nobr>Review the packaging of the affected application(s), including your Java EE container and third</nobr></div>
<div style="position:absolute;top:149447;left:139"><nobr>part API’s used. The goal is to identify duplicate or wrong deployments of the affected Java</nobr></div>
<div style="position:absolute;top:149466;left:139"><nobr>class at runtime (SYSTEM class path, EAR file, Java EE container itself etc.).</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:149489;left:112"><nobr>• <font style="font-size:14px">Once identified, you will need to remove and / or move the affected library/libraries from the</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:149509;left:139"><nobr>affected class loader (complexity of resolution will depend of the root cause).</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:149532;left:112"><nobr>• <font style="font-size:14px">Enable JVM class verbose e.g. –verbose:class. This JVM debug flag is very useful to monitor</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:149550;left:139"><nobr>the loading of the Java classes and libraries from the Java EE container your applications. It</nobr></div>
<div style="position:absolute;top:149569;left:139"><nobr>can really help you pinpoint duplicate Java class loading across various applications and class</nobr></div>
<div style="position:absolute;top:149589;left:139"><nobr>loaders at runtime</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:149758;left:755"><nobr>126 of 127</nobr></div>
</span></font>

<div style="position:absolute;top:149863;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="127"><b>Page 127</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:19px;font-family:Times">
<div style="position:absolute;top:149949;left:85"><nobr>JVM Troubleshooting Handbook</nobr></div>
</span></font>
<font size="3" color="#000080" face="Times"><span style="font-size:16px;font-family:Times;color:#000080">
<div style="position:absolute;top:149952;left:650"><nobr><a href="http://www.javacodegeeks.com/">www.javacodegeeks.com</a></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:150019;left:89"><nobr><b>ABOUT THE AUTHOR</b></nobr></div>
</span></font>
<font size="3" color="#262626" face="Times"><span style="font-size:14px;font-family:Times;color:#262626">
<div style="position:absolute;top:150047;left:186"><nobr>Pierre-Hugues Charbonneau (nickname P-H) is working for CGI Inc. Canada for the last</nobr></div>
<div style="position:absolute;top:150066;left:186"><nobr>10 years as a senior IT consultant. His primary area of expertise is Java EE,</nobr></div>
<div style="position:absolute;top:150085;left:186"><nobr>middleware &amp; JVM technologies. He is a specialist in production system</nobr></div>
<div style="position:absolute;top:150104;left:186"><nobr>troubleshooting, root cause analysis, middleware, JVM tuning, scalability and capacity</nobr></div>
<div style="position:absolute;top:150123;left:186"><nobr>improvement; including internal processes improvement for IT support teams. P-H is the</nobr></div>
<div style="position:absolute;top:150141;left:186"><nobr>principal author at <a href="http://javaeesupportpatterns.blogspot.com/"></a><font color="#000080"><a href="http://javaeesupportpatterns.blogspot.com/">Java EE Support Patterns</a></font><a href="http://javaeesupportpatterns.blogspot.com/"></a>.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:150251;left:89"><nobr><b>ABOUT THE EDITOR</b></nobr></div>
<div style="position:absolute;top:150278;left:185"><nobr>Ilias is a senior software engineer working in the telecom domain. He is an applications</nobr></div>
<div style="position:absolute;top:150297;left:185"><nobr>developer in a wide variety of applications/services, currently the technical lead in a in-</nobr></div>
<div style="position:absolute;top:150316;left:185"><nobr>house PCRF solution. Particularly interested in multi-tier architecture, middleware</nobr></div>
<div style="position:absolute;top:150335;left:185"><nobr>services and mobile development (<a href="mailto:ilias.tsagklis@javacodegeeks.com"></a><font color="#000080"><a href="mailto:ilias.tsagklis@javacodegeeks.com">contact</a></font><a href="mailto:ilias.tsagklis@javacodegeeks.com"></a>). Ilias Tsagklis is co-founder and Executive</nobr></div>
<div style="position:absolute;top:150354;left:185"><nobr>Editor at <a href="http://www.javacodegeeks.com/"></a><font color="#000080"><a href="http://www.javacodegeeks.com/">Java Code Geeks</a></font><a href="http://www.javacodegeeks.com/"></a>.</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:150946;left:755"><nobr>127 of 127</nobr></div>
</span></font>


</div></body></html>