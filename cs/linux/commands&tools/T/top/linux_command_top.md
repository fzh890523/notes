

# tutorial



## 参数



* 没有找到指定*输出的字段*的参数

* 非交互模式（批量模式） `-b`

* 线程模式（显示线程而不是进程） `-H`

  恶心的是，只打线程id了，看不出线程和进程的关系

* 刷新的时间间隔 `-d ${secs}`

  默认3，以下优先级逐渐提高：

  * `/etc/toprc`中的配置
  * `-d`指定

* 指定排序列 `-o ${field}`

  支持顺序倒序（负号 `-`）

  如`-o -%CPU`

* 显示完整命令（含参数）： `-c`

  默认只显示 命令本身



## 场景



### 查看当前cpu消耗



```shell
top -d 1 -H -b -n 1 -c -o -%CPU
# 当心有些top版本不支持，比如查看到 2.6.32 带的 3.2.8 版本的top就不支持 而 3.10.0 带的 3.3.10 版本的top就支持
```



注意，`-d`不适用于第一次的输出，有说法第一次输出的是自启动以来的load，但：

```c
// -d 5 -n 2
...  // 读取
nanosleep({0, 150000000}, NULL)         = 0  // 150ms
...  // 读取
pselect6(0, NULL, NULL, NULL, {5, 0}, {NULL, 8}) = 0 (Timeout)
...  // 读取  
```

从该strace输出来看，也有可能是150ms内的平均值，具体到底如何要看代码了。

TODO



但无论如何，第一次的输出是不适合作为“当前”负载的。

合适的做法是： `top -d 1 -n 2 -b`。 一个小麻烦是要取出第二次的输出。

```shell
top -d ${cpu_period} -n 2 -b -H | awk 'BEGIN{count=0}{if($1=="top"){count+=1;} if(count>1 && $1 ~ /[0-9]+/){print $0}}'  # 取第二次 并且 去掉summary部分
```



## 小点



### 查看指定进程 `top -p ${pid}`

* `top -p ${pid}` 实时变化

* `top | grep ${pid}` 累计变化







# 问题



## 第一次显示问题





# 实现





`-d`实现

```c
pselect6(0, NULL, NULL, NULL, {5, 0}, {NULL, 8}) = 0 (Timeout)
```









